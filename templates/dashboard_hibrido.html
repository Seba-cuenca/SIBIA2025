<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>SIBIA - Dashboard Completo</title>
    <!-- SIN PERMISOS - SIN USUARIO - TIMESTAMP: 2025-09-24T11:45:00Z - CACH√â LIMPIADO -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css?v={{ timestamp }}" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css?v={{ timestamp }}" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js?v={{ timestamp }}"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js?v={{ timestamp }}"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/voz_navegador.js') }}?v={{ timestamp }}"></script>
    <script src="{{ url_for('static', filename='js/voz_mejorada.js') }}?v={{ timestamp }}"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: #fff;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
        }

        /* Header completamente fijo */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 2000;
            background: linear-gradient(180deg, #16243a 0%, #172a45 100%);
            border-bottom: 1px solid rgba(255,255,255,0.08);
            height: 180px; /* Altura aumentada del header */
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .logo {
            background: #28a745;
            color: #fff;
            padding: 12px 16px;
            border-radius: 8px;
            font-weight: bold;
            font-size: 18px;
            box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
        }

        .app-logo {
            width: 60px !important;
            height: 60px !important;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .nav-tabs {
            display: flex;
            gap: 10px;
        }

        .nav-tab {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 10px 20px;
            color: #fff;
            text-decoration: none;
            transition: all 0.3s ease;
            cursor: pointer;
            font-size: 14px;
        }

        .nav-tab.active {
            background: rgba(0, 212, 255, 0.3);
            border-color: #00d4ff;
        }

        .status-indicator {
            background: #28a745;
            color: white;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* Layout principal */
        .main-container { 
            margin-top: 180px; 
            display: flex;
            min-height: calc(100vh - 180px);
            position: relative;
        }
        
        .sidebar { 
            position: fixed; 
            top: 180px; 
            bottom: 0; 
            width: 220px; 
            overflow-y: auto; 
            background: rgba(0, 0, 0, 0.2);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 1500;
        }
        
        .content-area { 
            margin-left: 220px; 
            flex: 1;
            padding: 0;
            overflow-y: auto;
            padding-bottom: 100px; /* Espacio para las alertas flotantes */
            position: fixed;
            top: 160px;
            right: 0;
            bottom: 0;
            z-index: 1000;
            width: calc(100vw - 220px);
            max-width: none;
        }
        
        /* Contenedor central para tarjetas */
        .cards-container {
            max-width: none;
            margin: 0;
            padding: 10px;
            width: 100%;
        }
        
        /* Grid de tarjetas funcionales */
        .cards-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-bottom: 20px;
            margin-top: 0;
            position: relative;
            z-index: 1;
        }
        
        @media (max-width: 1200px) {
            .header-kpis { grid-template-columns: repeat(2, minmax(100px, 1fr)); max-width: 500px; }
            .header { height: 200px; }
            .main-container { margin-top: 200px; }
            .sidebar { top: 200px; z-index: 1500; }
            .content-area { top: 200px; margin-left: 220px; z-index: 1000; width: calc(100vw - 220px); }
        }
        
        @media (max-width: 768px) {
            .header-kpis { grid-template-columns: 1fr; max-width: 300px; }
            .cards-container { padding: 0 8px; }
            .header { height: 240px; }
            .main-container { margin-top: 240px; }
            .sidebar { top: 240px; width: 200px; z-index: 1500; }
            .content-area { top: 240px; margin-left: 200px; z-index: 1000; width: calc(100vw - 200px); }
        }
        
        /* Vista operativa con padding adicional para evitar solapamiento */
        .operational-view {
            position: relative;
            z-index: 1;
            margin-top: 0;
        }

        .kpi-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: transform 0.3s ease;
        }

        .kpi-card:hover {
            transform: translateY(-5px);
        }

        .kpi-header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 15px;
            font-size: 14px;
            font-weight: 600;
        }

        .kpi-header i {
            color: #00d4ff;
        }

        .kpi-value {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .kpi-trend {
            font-size: 12px;
            opacity: 0.8;
        }

        /* Grid de tarjetas funcionales - CON L√çMITE DE SCROLL */
        .cards-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-bottom: 20px;
            margin-top: 0;
            position: relative;
            z-index: 1;
        }

        .function-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            overflow: hidden;
            transition: all 0.3s ease;
            position: relative;
        }

        .function-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 32px rgba(0, 212, 255, 0.15);
        }
        
        .function-card.expanded {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 10000;
            margin: 0;
            border-radius: 0;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(20px);
            overflow-y: auto;
            padding: 40px;
            transform: none;
        }
        
        .function-card.expanded .card-header {
            position: sticky;
            top: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 10001;
            padding: 20px 0;
            margin-bottom: 20px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
        }
        
        .expand-button {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 12px;
            margin-left: 10px;
        }
        
        .expand-button:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.05);
        }
        
        .close-button {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(220, 53, 69, 0.8);
            border: none;
            color: white;
            font-size: 24px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            display: none;
        }
        
        .function-card.expanded .close-button {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .close-button:hover {
            background: rgba(220, 53, 69, 1);
            transform: scale(1.1);
        }

        .card-header {
            background: rgba(0, 0, 0, 0.2);
            padding: 15px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 16px;
            font-weight: 600;
        }

        .card-title i {
            color: #00d4ff;
        }

        .card-content {
            padding: 20px;
        }

        /* Tarjetas espec√≠ficas */
        .biodigestor-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .biodigestor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            background: #28a745;
            color: white;
        }

        .biodigestor-metrics {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
            margin-bottom: 4px;
        }

        .metric-label {
            font-size: 13px;
            opacity: 0.8;
        }

        .metric-value {
            font-weight: 600;
            font-size: 14px;
        }

        /* Estilos estandarizados para todas las tablas */
        .table-standard {
            background-color: #ffffff !important;
            color: #000000 !important;
        }
        
        .table-standard thead {
            background-color: #f8f9fa !important;
            color: #000000 !important;
        }
        
        .table-standard tbody tr:nth-child(even) {
            background-color: #f8f9fa !important;
        }
        
        .table-standard tbody tr:nth-child(odd) {
            background-color: #ffffff !important;
        }
        
        .table-standard tbody tr:hover {
            background-color: #e9ecef !important;
        }
        
        .table-standard th,
        .table-standard td {
            border-color: #dee2e6 !important;
            color: #000000 !important;
        }

        /* Formularios */
        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .form-control {
            width: 100%;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            padding: 8px 12px;
            color: white;
            font-size: 13px;
        }

        .form-control::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        /* Botones */
        .btn {
            background: rgba(0, 212, 255, 0.2);
            border: 1px solid rgba(0, 212, 255, 0.4);
            border-radius: 6px;
            padding: 8px 16px;
            color: #00d4ff;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 13px;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn:hover {
            background: rgba(0, 212, 255, 0.3);
            transform: translateY(-1px);
        }

        .btn-success {
            background: rgba(40, 167, 69, 0.2);
            border-color: rgba(40, 167, 69, 0.4);
            color: #48bb78;
        }

        .btn-warning {
            background: rgba(255, 193, 7, 0.2);
            border-color: rgba(255, 193, 7, 0.4);
            color: #fbb03b;
        }

        /* Chat IA */
        .ai-chat {
            height: 450px; /* Aumentado de 250px a 450px */
            display: flex;
            flex-direction: column;
        }

        .ai-messages {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .ai-message {
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 13px;
        }

        .ai-message.ai-assistant {
            background: rgba(0, 123, 255, 0.2);
            border-left: 3px solid #007bff;
        }

        .ai-message.ai-user {
            background: rgba(40, 167, 69, 0.2);
            border-left: 3px solid #28a745;
            text-align: right;
        }

        .ai-input {
            display: flex;
            gap: 10px;
        }

        /* Gr√°ficos */
        .chart-container {
            position: relative;
            height: 200px;
            width: 100%;
        }

        .chart-container-medium {
            height: 250px;
        }

        /* Vista de an√°lisis hist√≥rico */
        .analytics-view {
            display: none;
        }

        .analytics-view.active {
            display: block;
        }

        .analytics-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        /* Tabla de datos */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .data-table th,
        .data-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 13px;
        }

        .data-table th {
            background: rgba(0, 0, 0, 0.2);
            color: #00d4ff;
            font-weight: 600;
        }

        .data-table tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        /* Alertas */
        .alert-item {
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 6px;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert-item.alert-info {
            background: rgba(0, 123, 255, 0.2);
            border-left: 3px solid #007bff;
        }

        .alert-item.alert-warning {
            background: rgba(255, 193, 7, 0.2);
            border-left: 3px solid #ffc107;
        }

        .alert-item.alert-danger {
            background: rgba(220, 53, 69, 0.2);
            border-left: 3px solid #dc3545;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .kpi-grid {
                grid-template-columns: repeat(2, 1fr);
                left: 200px;
                right: 20px;
                top: 100px;
            }
            
            .cards-grid {
                grid-template-columns: 1fr;
            }
            
            .content-area {
                padding-top: 280px;
            }
        }

        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: auto;
            }
            
            .kpi-grid {
                grid-template-columns: 1fr;
                position: fixed;
                top: 100px;
                left: 10px;
                right: 10px;
                padding: 10px;
            }
            
            .content-area {
                padding-top: 340px;
            }
        }

        /* Widget de alertas flotante */
        .alerts-floating {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 450px;
            max-height: 60vh;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 20px;
            backdrop-filter: blur(15px);
            z-index: 2000;
            backdrop-filter: blur(10px);
        }

        .alerts-floating-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .alerts-floating-header strong {
            color: #00d4ff;
            font-size: 14px;
        }

        .alerts-counter {
            background: #dc3545;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
            margin-left: auto;
        }

        .alerts-floating-list {
            max-height: 350px;
            overflow-y: auto;
        }

        .alert-floating-item {
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 8px;
            font-size: 14px;
            display: flex;
            align-items: flex-start;
            gap: 8px;
            border-left: 3px solid;
        }

        .alert-floating-item.info {
            background: rgba(0, 123, 255, 0.3);
            border-color: #007bff;
            color: #ffffff;
        }

        .alert-floating-item.warning {
            background: rgba(255, 193, 7, 0.3);
            border-color: #ffc107;
            color: #ffffff;
        }

        .alert-floating-item.danger {
            background: rgba(220, 53, 69, 0.3);
            border-color: #dc3545;
            color: #ffffff;
        }

        .alert-floating-item.success {
            background: rgba(40, 167, 69, 0.3);
            border-color: #28a745;
            color: #ffffff;
        }
        
        /* Estilos para el bot√≥n de cerrar alertas */
        .alert-floating-item {
            display: flex;
            align-items: center;
            position: relative;
        }
        
        .alert-content {
            flex: 1;
        }
        
        .alert-dismiss-btn {
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.7);
            cursor: pointer;
            padding: 4px;
            margin-left: 8px;
            border-radius: 3px;
            transition: all 0.3s ease;
            font-size: 12px;
        }
        
        .alert-dismiss-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            transform: scale(1.1);
        }

        /* Mejorar el contenido para que no se solape */

        /* Asegurar que el sidebar no tenga problemas de scroll */
        .sidebar {
            width: 200px;
            background: rgba(0, 0, 0, 0.2);
            padding: 20px 0;
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            overflow-y: auto;
            position: relative;
        }

        /* Ajustar el z-index del header para que las alertas queden encima */
        .header {
            z-index: 1500;
        }
        
        /* Animaciones para alertas */
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 193, 7, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(255, 193, 7, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 193, 7, 0); }
        }
        
        @keyframes fadeOut {
            0% { opacity: 1; transform: translateX(0); }
            100% { opacity: 0; transform: translateX(100%); }
        }
        
        /* KPIs compactos en el header - Una sola fila horizontal */
        .header-kpis {
            display: grid;
            grid-template-columns: repeat(6, minmax(80px, 1fr));
            gap: 4px;
            align-items: center;
            justify-content: center;
            margin: 4px auto 6px auto;
            max-width: 100%;
            width: 100%;
        }
        .header-kpis .kpi-card { padding: 4px; border-radius: 4px; background: #243449; border: 1px solid rgba(255,255,255,0.08); box-shadow: 0 2px 8px rgba(0,0,0,0.25); }
        .header-kpis .kpi-value { font-size: 12px; }
        .header-kpis .kpi-header { font-size: 8px; }
        .header-kpis .kpi-fecha { display: block; font-size: 6px; opacity: 0.75; margin-top: 1px; }
        .header-kpis .kpi-estado { display: block; font-size: 6px; margin-top: 1px; }
        
        /* Desplazar TODO el contenido por debajo del header */
        
        /* Contenedor central para tarjetas */
        .cards-container {
            max-width: none;
            margin: 0;
            padding: 10px;
            width: 100%;
        }
        
        /* Grid de tarjetas funcionales */
        .cards-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-bottom: 20px;
            margin-top: 0;
            position: relative;
            z-index: 1;
        }
        
        /* KPIs en content-area (desactivado para no duplicar) */
        .kpi-grid { display: none; }
        
        /* Tarjetas y tablas con fondo s√≥lido profesional */
        .function-card { background: #1f2a3a; border: 1px solid rgba(255,255,255,0.06); border-radius: 12px; box-shadow: 0 6px 14px rgba(0,0,0,0.25); }
        .function-card .card-header { background: #243449; border-bottom: 1px solid rgba(255,255,255,0.06); }
        .function-card .card-content { background: #1f2a3a; }
        .data-table th { background: #203247; color: #e3eefb; }
        .data-table td { background: #1f2a3a; color: #e7edf7; }
        
        /* Alertas flotantes aseguradas arriba de todo */
        .alerts-floating { position: fixed; right: 20px; bottom: 20px; z-index: 4000; }
        
        @media (max-width: 1200px) {
            .header-kpis { grid-template-columns: repeat(2, minmax(100px, 1fr)); max-width: 500px; }
            .header { height: 200px; }
            .main-container { margin-top: 200px; }
            .sidebar { top: 200px; z-index: 1500; }
            .content-area { top: 200px; margin-left: 220px; z-index: 1000; width: calc(100vw - 220px); }
        }
        
        @media (max-width: 768px) {
            .header-kpis { grid-template-columns: 1fr; max-width: 300px; }
            .cards-container { padding: 0 8px; }
            .header { height: 240px; }
            .main-container { margin-top: 240px; }
            .sidebar { top: 240px; width: 200px; z-index: 1500; }
            .content-area { top: 240px; margin-left: 200px; z-index: 1000; width: calc(100vw - 200px); }
        }
    </style>
    <style id="theme-overrides">
        :root {
            --bg: #0b1220;
            --panel: #121a26;
            --panel-2: #0f1624;
            --text: #e5e7eb;
            --muted: #9ca3af;
            --border: rgba(148, 163, 184, 0.16);
            --accent: #22d3ee;
            --accent-2: #38bdf8;
            --success: #34d399;
            --warning: #f59e0b;
            --danger: #ef4444;
            --header-h: 160px;
            --sidebar-w: 260px;
            --radius: 12px;
            --shadow: 0 6px 24px rgba(0,0,0,0.35);
        }

        body {
            background: var(--bg) !important;
            color: var(--text) !important;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .header {
            height: var(--header-h) !important;
            background: linear-gradient(180deg, var(--panel-2) 0%, var(--panel) 100%) !important;
            border-bottom: 1px solid var(--border) !important;
            display: flex;
            align-items: center;
            padding: 0 20px;
            gap: 16px;
        }

        .header-left .logo {
            background: #0ea5e9 !important;
            color: #081120 !important;
            font-weight: 800;
            letter-spacing: 0.5px;
        }
        
        .logo-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .app-logo {
            height: 40px;
            width: auto;
            border-radius: 5px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }
        
        .title-container {
            display: flex;
            flex-direction: column;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-left: 20px;
        }
        
        .user-details {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }
        
        .user-name {
            font-weight: 600;
            color: #fff;
            font-size: 14px;
        }
        
        
        
        /* Tema oscuro para tablas */
        .table {
            background-color: #2c3e50 !important;
            color: #ecf0f1 !important;
        }
        
        .table th {
            background-color: #34495e !important;
            color: #ecf0f1 !important;
            border-color: #4a5f7a !important;
        }
        
        .table td {
            background-color: #2c3e50 !important;
            color: #ecf0f1 !important;
            border-color: #4a5f7a !important;
        }
        
        .table-striped tbody tr:nth-of-type(odd) {
            background-color: #34495e !important;
        }
        
        .table-striped tbody tr:nth-of-type(even) {
            background-color: #2c3e50 !important;
        }
        
        .table-hover tbody tr:hover {
            background-color: #4a5f7a !important;
            color: #ecf0f1 !important;
        }
        
        .table-dark {
            background-color: #343a40 !important;
            color: #fff !important;
        }
        
        .table-dark th {
            background-color: #495057 !important;
            color: #fff !important;
        }
        
        .table-dark td {
            background-color: #343a40 !important;
            color: #fff !important;
        }
        
        .table-dark.table-striped tbody tr:nth-of-type(odd) {
            background-color: #343a40 !important;
        }
        
        .table-dark.table-striped tbody tr:nth-of-type(even) {
            background-color: #495057 !important;
        }
        
        /* Tema oscuro para formularios y tarjetas */
        .form-control {
            background-color: #34495e !important;
            color: #ecf0f1 !important;
            border-color: #4a5f7a !important;
        }
        
        .form-control:focus {
            background-color: #2c3e50 !important;
            color: #ecf0f1 !important;
            border-color: #00d4ff !important;
            box-shadow: 0 0 0 0.2rem rgba(0, 212, 255, 0.25) !important;
        }
        
        .form-control::placeholder {
            color: #bdc3c7 !important;
        }
        
        .card {
            background-color: #2c3e50 !important;
            color: #ecf0f1 !important;
            border-color: #4a5f7a !important;
        }
        
        .card-header {
            background-color: #34495e !important;
            color: #ecf0f1 !important;
            border-bottom-color: #4a5f7a !important;
        }
        
        .card-body {
            background-color: #2c3e50 !important;
            color: #ecf0f1 !important;
        }
        
        .alert {
            background-color: #34495e !important;
            color: #ecf0f1 !important;
            border-color: #4a5f7a !important;
        }
        
        .alert-info {
            background-color: #1e3a8a !important;
            color: #ecf0f1 !important;
            border-color: #3b82f6 !important;
        }
        
        .alert-success {
            background-color: #166534 !important;
            color: #ecf0f1 !important;
            border-color: #22c55e !important;
        }
        
        .alert-warning {
            background-color: #a16207 !important;
            color: #ecf0f1 !important;
            border-color: #eab308 !important;
        }
        
        .alert-danger {
            background-color: #991b1b !important;
            color: #ecf0f1 !important;
            border-color: #ef4444 !important;
        }

        .title { font-size: 20px !important; color: var(--text) !important; }

        .header-right .nav-tab {
            background: transparent !important;
            border: 1px solid var(--border) !important;
            color: var(--text) !important;
            border-radius: 8px !important;
        }
        .header-right .nav-tab:hover { border-color: var(--accent-2) !important; color: var(--accent-2) !important; }
        .header-right .nav-tab.active { background: rgba(34, 211, 238, 0.12) !important; border-color: var(--accent) !important; color: var(--accent) !important; }

        .status-indicator { background: rgba(52, 211, 153, 0.15) !important; color: var(--text) !important; border: 1px solid rgba(52, 211, 153, 0.35); }

        .main-container { margin-top: 180px !important; }
        .content-area { margin-top: 0 !important; padding-top: 200px !important; }

        .sidebar {
            position: fixed !important;
            top: 180px !important;
            bottom: 0 !important;
            left: 0 !important;
            width: var(--sidebar-w) !important;
            background: var(--panel) !important;
            border-right: 1px solid var(--border) !important;
            padding: 0 !important;
            overflow: hidden !important; /* el contenido interno se desplaza */
            z-index: 1500 !important;
        }

        .sidebar:before,
        .sidebar:after {
            content: "";
            position: absolute;
            left: 0; right: 0;
            height: 20px;
            z-index: 2;
            pointer-events: none;
        }
        .sidebar:before { top: 0; background: linear-gradient(to bottom, rgba(11,18,32,0.9), rgba(11,18,32,0)); }
        .sidebar:after { bottom: 0; background: linear-gradient(to top, rgba(11,18,32,0.9), rgba(11,18,32,0)); }

        .sidebar-scroll {
            position: absolute;
            top: 0; bottom: 0; left: 0; right: 0;
            padding: 16px 0;
            overflow-y: auto;
            overscroll-behavior: contain;
            scroll-behavior: smooth;
        }
        .sidebar-scroll::-webkit-scrollbar { width: 8px; }
        .sidebar-scroll::-webkit-scrollbar-thumb { background: rgba(148, 163, 184, 0.25); border-radius: 8px; }
        .sidebar-scroll::-webkit-scrollbar-track { background: transparent; }

        .sidebar-controls {
            position: absolute;
            left: 0; right: 0;
            bottom: 10px;
            display: flex;
            justify-content: center;
            gap: 8px;
            z-index: 3;
        }
        .scroll-btn {
            background: rgba(34, 211, 238, 0.12);
            border: 1px solid rgba(34, 211, 238, 0.35);
            color: var(--accent);
            width: 36px; height: 36px;
            border-radius: 8px;
            display: inline-flex; align-items: center; justify-content: center;
            cursor: pointer;
            transition: all .2s ease;
        }
        .scroll-btn:hover { background: rgba(56,189,248,.15); color: var(--accent-2); border-color: rgba(56,189,248,.5); }

        .sidebar .sidebar-title { padding: 8px 20px; color: var(--muted); font-weight: 600; text-transform: uppercase; letter-spacing: .08em; font-size: 11px; }
        .sidebar .sidebar-menu a { display: block; padding: 10px 16px; margin: 4px 12px; border-radius: 8px; color: var(--text); text-decoration: none; border: 1px solid transparent; }
        .sidebar .sidebar-menu a:hover { background: rgba(56, 189, 248, 0.08); border-color: rgba(56, 189, 248, 0.24); color: var(--accent-2); }
        .sidebar .sidebar-menu a.active { background: rgba(34, 211, 238, 0.12); border-color: var(--accent); color: var(--accent); }

        /* Estilos para el acorde√≥n */
        .accordion-header {
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
            user-select: none;
        }
        
        .accordion-header:hover {
            background: rgba(56, 189, 248, 0.05);
            color: var(--accent-2);
        }
        
        .accordion-icon {
            transition: transform 0.3s ease;
            font-size: 10px;
        }
        
        .accordion-header.active .accordion-icon {
            transform: rotate(180deg);
        }
        
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        
        .accordion-content.expanded {
            max-height: 500px; /* Ajusta seg√∫n sea necesario */
        }

        .content-area {
            position: relative !important;
            top: auto !important; right: auto !important; bottom: auto !important;
            margin-left: var(--sidebar-w) !important;
            padding: 0 !important;
            padding-top: 200px !important;
            overflow: visible !important;
            background: linear-gradient(180deg, rgba(17,24,39,0.35), rgba(17,24,39,0.0));
            min-height: calc(100vh - var(--header-h));
            scroll-behavior: smooth !important;
            width: calc(100vw - var(--sidebar-w)) !important;
            max-width: none !important;
        }
        
        /* Asegurar que el contenido siempre est√© centrado */
        .operational-view, .analytics-view {
            scroll-behavior: smooth !important;
        }
        
        /* Centrado autom√°tico del contenido */
        .function-card {
            margin: 0 !important;
            max-width: none !important;
            width: 100% !important;
        }

        .cards-container { 
            max-width: none !important; 
            padding: 10px !important; 
            width: 100% !important;
            margin: 0 !important;
        }
        .cards-grid { 
            grid-template-columns: 1fr !important; 
            gap: 20px !important; 
            width: 100% !important;
        }

        .kpi-card { background: var(--panel) !important; border: 1px solid var(--border) !important; box-shadow: var(--shadow); }
        .kpi-header i { color: var(--accent) !important; }
        .kpi-value { color: #e6f9ff !important; text-shadow: none !important; }

        .function-card { background: var(--panel) !important; border: 1px solid var(--border) !important; border-radius: var(--radius) !important; box-shadow: var(--shadow) !important; }
        .function-card .card-header { background: var(--panel-2) !important; border-bottom: 1px solid var(--border) !important; }
        .function-card .card-title i { color: var(--accent) !important; }
        .function-card .card-content { background: var(--panel) !important; }
        .function-card:hover { box-shadow: 0 10px 28px rgba(0,0,0,0.45) !important; transform: translateY(-2px); }

        .function-card.expanded { background: rgba(10, 14, 24, 0.98) !important; }
        .function-card.expanded .card-header { background: rgba(12, 18, 32, 0.95) !important; }

        .btn { background: rgba(34, 211, 238, 0.12) !important; border: 1px solid rgba(34, 211, 238, 0.35) !important; color: var(--accent) !important; border-radius: 8px !important; }
        .btn:hover { background: rgba(56, 189, 248, 0.15) !important; border-color: rgba(56, 189, 248, 0.5) !important; color: var(--accent-2) !important; }
        .btn-success { background: rgba(52, 211, 153, 0.12) !important; border-color: rgba(52, 211, 153, 0.35) !important; color: var(--success) !important; }
        .btn-warning { background: rgba(245, 158, 11, 0.12) !important; border-color: rgba(245, 158, 11, 0.35) !important; color: var(--warning) !important; }

        .data-table th { background: var(--panel-2) !important; color: #e3eefb !important; }
        .data-table td { background: var(--panel) !important; color: #dbe7f3 !important; }
        .data-table tr:hover { background: rgba(56, 189, 248, 0.06) !important; }
        
        /* Estilos espec√≠ficos para la tabla de gesti√≥n de materiales */
        #tabla-gestion-materiales th { background: #203247 !important; color: #e3eefb !important; }
        #tabla-gestion-materiales td { background: #1f2a3a !important; color: #dbe7f3 !important; }
        #tabla-gestion-materiales .badge { color: #ffffff !important; font-weight: bold; background: #007bff !important; }
        #tabla-gestion-materiales .kw-value { color: #00d4ff !important; font-weight: bold; }
        #tabla-gestion-materiales input, #tabla-gestion-materiales select { color: #000000 !important; background: #ffffff !important; }

        .ai-messages { background: var(--panel-2) !important; border: 1px solid var(--border) !important; }
        .ai-message.ai-assistant { background: rgba(56, 189, 248, 0.14) !important; border-left-color: var(--accent-2) !important; }
        .ai-message.ai-user { background: rgba(52, 211, 153, 0.14) !important; border-left-color: var(--success) !important; }

        .alerts-floating { background: rgba(12, 18, 32, 0.98) !important; border: 1px solid var(--border) !important; box-shadow: var(--shadow); z-index: 4000 !important; }
        .alerts-floating-header strong { color: var(--accent-2) !important; }
        .alerts-counter { background: var(--danger) !important; }
        .alert-floating-item.info { background: rgba(56, 189, 248, 0.14) !important; border-color: var(--accent-2) !important; }
        .alert-floating-item.warning { background: rgba(245, 158, 11, 0.14) !important; border-color: var(--warning) !important; }
        .alert-floating-item.danger { background: rgba(239, 68, 68, 0.14) !important; border-color: var(--danger) !important; }
        .alert-floating-item.success { background: rgba(52, 211, 153, 0.14) !important; border-color: var(--success) !important; }

        .form-control { background: rgba(255,255,255,0.06) !important; border: 1px solid var(--border) !important; color: var(--text) !important; }
        
        /* Estilos para alertas del sistema - fondo blanco con letras negras */
        .editable-alert {
            background: #ffffff !important;
            color: #000000 !important;
            border: 1px solid #cccccc !important;
        }
        
        .editable-alert .alert-text {
            color: #000000 !important;
        }
        
        .editable-alert .form-control {
            background: #ffffff !important;
            color: #000000 !important;
            border: 1px solid #cccccc !important;
        }
        
        .editable-alert .btn {
            background: #007bff !important;
            color: #ffffff !important;
            border: 1px solid #007bff !important;
        }
        
        .editable-alert .btn:hover {
            background: #0056b3 !important;
            border-color: #0056b3 !important;
        }
        .form-control::placeholder { color: rgba(226, 232, 240, 0.6) !important; }
        
        /* Switch de alertas */
        .form-check-input {
            background-color: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.3);
        }
        .form-check-input:checked {
            background-color: #28a745;
            border-color: #28a745;
        }
        .form-check-label {
            color: white !important;
            font-size: 12px;
            margin-left: 5px;
        }

        /* Responsive refinado */
        @media (max-width: 1200px) {
            :root { --sidebar-w: 220px; --header-h: 190px; }
            .cards-grid { grid-template-columns: 1fr 1fr !important; }
        }
        @media (max-width: 900px) {
            .cards-grid { grid-template-columns: 1fr !important; }
        }
        @media (max-width: 768px) {
            :root { --sidebar-w: 200px; --header-h: 230px; }
            .content-area { padding: 16px !important; padding-top: 260px !important; }
        }
        
        /* Estilos espec√≠ficos para la tabla de gesti√≥n de materiales */
        #tabla-gestion-materiales {
            font-size: 14px;
            min-width: 100%;
            background-color: #ffffff !important;
            color: #000000 !important;
        }
        
        #tabla-gestion-materiales input {
            color: #000000 !important;
            background-color: #ffffff !important;
            font-weight: 500;
            font-size: 13px;
            padding: 6px 8px;
            border: 1px solid #ccc !important;
        }
        
        #tabla-gestion-materiales td {
            color: #000000 !important;
            background-color: #ffffff !important;
            font-size: 13px;
            padding: 8px 6px;
            vertical-align: middle;
            border: 1px solid #dee2e6 !important;
        }
        
        #tabla-gestion-materiales th {
            color: #000000 !important;
            background-color: #f8f9fa !important;
            font-weight: bold;
            font-size: 14px;
            padding: 10px 6px;
            border: 1px solid #dee2e6 !important;
        }
        
        #tabla-gestion-materiales .form-control {
            border: 1px solid #ccc !important;
            border-radius: 4px;
            background-color: #ffffff !important;
            color: #000000 !important;
        }
        
        #tabla-gestion-materiales .form-control:focus {
            border-color: #007bff !important;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25) !important;
            background-color: #ffffff !important;
            color: #000000 !important;
        }
        
        #tabla-gestion-materiales select {
            color: #000000 !important;
            background-color: #ffffff !important;
        }
        
        #tabla-gestion-materiales .btn {
            color: #ffffff !important;
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-left">
            <div class="logo-container">
                <img src="/static/icon-192x192.png" alt="SIBIA Logo" class="app-logo" onerror="this.style.display='none'">
            </div>
        </div>
        <div class="header-right">
            <div class="nav-tabs">
                <a href="#" class="nav-tab active" onclick="switchView('operational')">Control Operativo</a>
                <a href="#" class="nav-tab" onclick="openMantenimiento()">Mantenimiento</a>
                <a href="/ml_dashboard" class="nav-tab" target="_blank">üß† ML Monitor</a>
            </div>
            
            
            <!-- Indicador √∫nico de estado del sistema -->
            <div class="status-indicator" id="status-sistema" style="background: rgba(34, 211, 238, 0.2); border: 1px solid #22d3ee; margin-top: 10px;">
                <div style="width: 8px; height: 8px; background: #22d3ee; border-radius: 50%; animation: pulse 2s infinite;"></div>
                <span id="texto-sistema">Sistema Actualizado</span>
            </div>
            
            <div class="form-check form-switch" style="margin-top: 10px;">
                <input class="form-check-input" type="checkbox" id="controlAlertas" checked>
                <label class="form-check-label text-white" for="controlAlertas">Alertas</label>
            </div>
            <div class="consumo-chp-control" style="display: flex; align-items: center; gap: 8px; margin-left: 15px; margin-top: 10px;">
                <label for="consumo-chp-input" class="text-white" style="font-size: 12px; margin: 0;">Consumo CHP:</label>
                <input type="number" id="consumo-chp-input" value="505" min="100" max="1000" step="1" 
                       style="width: 60px; height: 25px; font-size: 11px; padding: 2px 4px; border-radius: 3px; border: 1px solid #ccc;"
                       onchange="actualizarConsumoCHP(this.value)" title="Consumo CHP para c√°lculos KW/TN">
                <span class="text-white" style="font-size: 10px;">kW</span>
            </div>
        </div>
        
        <!-- Objetivos Editables - L√≠nea separada debajo de las nav-tabs -->
        <div class="header-objetivos" style="display: flex; gap: 20px; margin-top: 10px; padding: 8px; background: rgba(255,255,255,0.05); border-radius: 6px; justify-content: flex-start;">
            <div style="display: flex; align-items: center; gap: 8px;">
                <label style="font-size: 12px; opacity: 0.8;">KW Objetivo:</label>
                <input type="number" id="kw-objetivo-header" value="28800" style="width: 80px; padding: 4px; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); color: white; border-radius: 4px; font-size: 12px;" onchange="actualizarObjetivos()">
                <span style="font-size: 12px;">kW</span>
            </div>
            <div style="display: flex; align-items: center; gap: 8px;">
                <label style="font-size: 12px; opacity: 0.8;">Metano Objetivo:</label>
                <input type="number" id="metano-objetivo-header" value="65" style="width: 60px; padding: 4px; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); color: white; border-radius: 4px; font-size: 12px;" onchange="actualizarObjetivos()">
                <span style="font-size: 12px;">%</span>
            </div>
            <div style="display: flex; align-items: center; gap: 8px;">
                <label style="font-size: 12px; opacity: 0.8;">Modo:</label>
                <span id="modo-calculo-header" style="padding: 4px 8px; background: rgba(40, 167, 69, 0.3); color: #28a745; border-radius: 4px; font-size: 12px; font-weight: bold;">‚ö° Energ√©tico</span>
            </div>
        </div>
        
        <div class="header-kpis">
            <!-- Una sola fila horizontal con todos los KPIs -->
            <div class="kpi-card">
                <div class="kpi-header">
                    <i class="fas fa-bolt"></i>
                    <span>Generaci√≥n</span>
                </div>
                <div class="kpi-value" id="kpi-generacion">0.0 kW</div>
                <div class="kpi-fecha" id="kpi-generacion-fecha-header" style="font-size: 10px; opacity: 0.7; margin-top: 5px;">--</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-header">
                    <i class="fas fa-plug"></i>
                    <span>Inyectada</span>
                </div>
                <div class="kpi-value" id="kpi-inyectada">0.0 kW</div>
                <div class="kpi-fecha" id="kpi-inyectada-fecha-header" style="font-size: 10px; opacity: 0.7; margin-top: 5px;">--</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-header">
                    <i class="fas fa-fire"></i>
                    <span>Calidad CH4</span>
                </div>
                <div class="kpi-value" id="kpi-ch4">--%</div>
                <div class="kpi-fecha" id="kpi-ch4-fecha-header" style="font-size: 10px; opacity: 0.7; margin-top: 5px;">--</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-header">
                    <i class="fas fa-bolt"></i>
                    <span>Spot</span>
                </div>
                <div class="kpi-value" id="kpi-spot">0.0 kW</div>
                <div class="kpi-fecha" id="kpi-spot-fecha-header" style="font-size: 10px; opacity: 0.7; margin-top: 5px;">--</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-header">
                    <i class="fas fa-cog"></i>
                    <span>Consumo</span>
                </div>
                <div class="kpi-value" id="kpi-consumo">0.0 kW</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-header">
                    <i class="fas fa-percentage"></i>
                    <span>Eficiencia</span>
                </div>
                <div class="kpi-value" id="kpi-eficiencia">0.0%</div>
            </div>
        </div>
    </header>

    <div class="main-container">
        <aside class="sidebar">
            <div class="sidebar-scroll">
            <!-- Secci√≥n Operativa -->
            <div class="sidebar-section">
                <div class="sidebar-title accordion-header" onclick="toggleAccordion(this)">
                    <span>Control Tiempo Real</span>
                    <i class="fas fa-chevron-down accordion-icon"></i>
                </div>
                <ul class="sidebar-menu accordion-content">
                    <li><a href="#" onclick="showCard('biodigestores')" class="active">Biodigestores</a></li>
                    <li><a href="#" onclick="showCard('calidad-gas')">Calidad Gas Motor</a></li>
                    <li><a href="#" onclick="showCard('seguimiento-horario')">Seguimiento Horario</a></li>
                    <li><a href="#" onclick="showCard('bombas')">Sala Bombas</a></li>
                    <li><a href="#" onclick="showCard('agua')">Agua Caliente (070)</a></li>
                    <li><a href="#" onclick="showCard('otros-sistemas')">Otros Sistemas</a></li>
                </ul>
            </div>

            <!-- Secci√≥n Herramientas -->
            <div class="sidebar-section">
                <div class="sidebar-title accordion-header" onclick="toggleAccordion(this)">
                    <span>Herramientas</span>
                    <i class="fas fa-chevron-down accordion-icon"></i>
                </div>
                <ul class="sidebar-menu accordion-content">
                    <li><a href="#" onclick="showCard('calculadora')">Calculadora R√°pida</a></li>
                    <li><a href="#" onclick="showCard('asistente-ia')">Asistente IA</a></li>
                    <li><a href="#" onclick="showCard('registro-materiales')">Registro Materiales</a></li>
                    <li><a href="#" onclick="showCard('parametros-quimicos')">Par√°metros Qu√≠micos</a></li>
                    <li><a href="#" onclick="showCard('tareas-diarias')">Tareas Diarias</a></li>
                    <li><a href="#" onclick="showCard('gestion-tareas')">Gesti√≥n Tareas</a></li>
                    <li><a href="#" onclick="showCard('stock-actual')">Stock Actual</a></li>
                    <li><a href="#" onclick="showCard('alertas')">Alertas</a></li>
                </ul>
            </div>

            <!-- Secci√≥n Gr√°ficos -->
            <div class="sidebar-section">
                <div class="sidebar-title accordion-header" onclick="toggleAccordion(this)">
                    <span>Monitoreo</span>
                    <i class="fas fa-chevron-down accordion-icon"></i>
                </div>
                <ul class="sidebar-menu accordion-content">
                    <li><a href="#" onclick="showCard('generacion-tiempo-real')">Generaci√≥n Tiempo Real</a></li>
                    <li><a href="#" onclick="showCard('temperaturas')">Temperaturas</a></li>
                    <li><a href="#" onclick="showCard('niveles')">Niveles Biodigestores</a></li>
                    <li><a href="#" onclick="showCard('analisis-historico')">An√°lisis Hist√≥rico</a></li>
                </ul>
            </div>

            <!-- Secci√≥n An√°lisis -->
            <div class="sidebar-section">
                <div class="sidebar-title accordion-header" onclick="toggleAccordion(this)">
                    <span>An√°lisis Hist√≥rico</span>
                    <i class="fas fa-chevron-down accordion-icon"></i>
                </div>
                <ul class="sidebar-menu accordion-content">
                    <li><a href="#" onclick="showAnalytics('kpis')">KPIs Ejecutivos</a></li>
                    <li><a href="#" onclick="showAnalytics('tendencias')">Tendencias</a></li>
                    <li><a href="#" onclick="showAnalytics('materiales')">Rendimiento Materiales</a></li>
                    <li><a href="#" onclick="showAnalytics('eficiencia')">Eficiencia</a></li>
                    <li><a href="#" onclick="showAnalytics('predicciones')">Predicciones IA</a></li>
                    <li><a href="#" onclick="showAnalytics('gestion_materiales')">Gesti√≥n de Materiales</a></li>
                    <li><a href="#" onclick="switchView('reports')">Reportes</a></li>
                </ul>
            </div>
            </div>
        </aside>

        <main class="content-area">
            
            <!-- KPIs Principales siempre visibles -->
            <div class="kpi-grid">
                <div class="kpi-card">
                    <div class="kpi-header">
                        <i class="fas fa-bolt"></i>
                        <span>Generaci√≥n</span>
                    </div>
                    <div class="kpi-value">0.0 kW</div>
                    <div class="kpi-trend" id="kpi-generacion-trend">Sin datos</div>
                    <div class="kpi-fecha" id="kpi-generacion-fecha" style="font-size: 10px; opacity: 0.7; margin-top: 5px;">--</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-header">
                        <i class="fas fa-plug"></i>
                        <span>Inyectada</span>
                    </div>
                    <div class="kpi-value">0.0 kW</div>
                    <div class="kpi-trend" id="kpi-inyectada-trend">Sin datos</div>
                    <div class="kpi-fecha" id="kpi-inyectada-fecha" style="font-size: 10px; opacity: 0.7; margin-top: 5px;">--</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-header">
                        <i class="fas fa-cog"></i>
                        <span>Consumo</span>
                    </div>
                    <div class="kpi-value">0.0 kW</div>
                    <div class="kpi-trend" id="kpi-consumo-trend">Sin datos</div>
                    <div class="kpi-fecha" id="kpi-consumo-fecha" style="font-size: 10px; opacity: 0.7; margin-top: 5px;">--</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-header">
                        <i class="fas fa-percentage"></i>
                        <span>Eficiencia</span>
                    </div>
                    <div class="kpi-value">0.0%</div>
                    <div class="kpi-trend" id="kpi-eficiencia-trend">Sin datos</div>
                    <div class="kpi-fecha" id="kpi-eficiencia-fecha" style="font-size: 10px; opacity: 0.7; margin-top: 5px;">--</div>
                </div>
            </div>
            <div class="kpi-spacer"></div>

            <!-- Vista Operativa -->
            <div id="operational-view" class="operational-view">
                <div class="cards-container">
                <div class="cards-grid">
                    <!-- Biodigestores -->
                    <div class="function-card" id="card-biodigestores">
                        <div class="card-header" onclick="expandCard('card-biodigestores')" style="cursor: pointer;">
                            <div class="card-title">
                                <i class="fas fa-flask"></i>
                                Biodigestores
                                <button class="expand-button" onclick="event.stopPropagation(); expandCard('card-biodigestores')" title="Expandir">
                                    <i class="fas fa-expand"></i>
                                </button>
                            </div>
                        </div>
                        <button class="close-button" onclick="closeCard('card-biodigestores')">
                            <i class="fas fa-times"></i>
                        </button>
                        <div class="card-content">
                            <div class="biodigestor-card">
                                <div class="biodigestor-header">
                                    <h6>Biodigestor 1</h6>
                                    <span class="status-badge">Operativo</span>
                                </div>
                                <div class="biodigestor-timestamp">
                                    <small id="biodigestores-timestamp" style="color: #bdc3c7; font-size: 10px;">√öltima actualizaci√≥n: --</small>
                                </div>
                                <div class="biodigestor-metrics">
                                    <div class="metric">
                                        <span class="metric-label">Nivel</span>
                                        <span class="metric-value" id="nivel-b1">0%</span>
                                    </div>
                                    <div class="metric">
                                        <span class="metric-label">Temperatura</span>
                                        <span class="metric-value" id="temp-b1">0¬∞C</span>
                                    </div>
                                    <div class="metric">
                                        <span class="metric-label">pH</span>
                                        <span class="metric-value" id="ph-b1">0.0</span>
                                    </div>
                                    <div class="metric">
                                        <span class="metric-label">Presi√≥n</span>
                                        <span class="metric-value" id="presion-b1">-- bar</span>
                                    </div>
                                </div>
                            </div>
                            <div class="biodigestor-card">
                                <div class="biodigestor-header">
                                    <h6>Biodigestor 2</h6>
                                    <span class="status-badge">Operativo</span>
                                </div>
                                <div class="biodigestor-timestamp">
                                    <small id="biodigestor2-timestamp" style="color: #bdc3c7; font-size: 10px;">√öltima actualizaci√≥n: --</small>
                                </div>
                                <div class="biodigestor-metrics">
                                    <div class="metric">
                                        <span class="metric-label">Nivel</span>
                                        <span class="metric-value" id="nivel-b2">0%</span>
                                    </div>
                                    <div class="metric">
                                        <span class="metric-label">Temperatura</span>
                                        <span class="metric-value" id="temp-b2">0¬∞C</span>
                                    </div>
                                    <div class="metric">
                                        <span class="metric-label">pH</span>
                                        <span class="metric-value" id="ph-b2">0.0</span>
                                    </div>
                                    <div class="metric">
                                        <span class="metric-label">Presi√≥n</span>
                                        <span class="metric-value" id="presion-b2">-- bar</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Asistente IA -->
                    <div class="function-card" id="card-asistente-ia">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-robot"></i>
                                Asistente IA
                            </div>
                        </div>
                        <div class="card-content">
                            <div class="ai-chat">
                                <div class="ai-messages" id="ai-messages">
                                    <div class="ai-message ai-assistant">
                                        <p>¬°Hola! Soy tu asistente para la planta de biog√°s. ¬øEn qu√© puedo ayudarte?</p>
                                    </div>
                                </div>
                                <div class="ai-input">
                                    <input type="text" class="form-control" id="ai-input" placeholder="Pregunta algo..." onkeypress="if(event.key==='Enter') enviarPregunta()">
                                    <button class="btn" onclick="enviarPregunta()">
                                        <i class="fas fa-paper-plane"></i>
                                    </button>
                                </div>
                                
                                <!-- Botones de Aprendizaje -->
                                <div class="ai-learning-controls" id="ai-learning-controls" style="display: none; margin-top: 10px; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 8px; border: 1px solid rgba(255,255,255,0.1);">
                                    <div class="learning-buttons" style="display: flex; gap: 10px; margin-bottom: 10px;">
                                        <button class="btn btn-success" onclick="aceptarRespuesta()" style="flex: 1;">
                                            <i class="fas fa-check"></i> Aceptar
                                        </button>
                                        <button class="btn btn-warning" onclick="rechazarRespuesta()" style="flex: 1;">
                                            <i class="fas fa-times"></i> Rechazar
                                        </button>
                                    </div>
                                    <div class="learning-input" style="display: none;" id="learning-input">
                                        <textarea class="form-control" id="respuesta-correcta" placeholder="Escribe la respuesta correcta..." rows="3" style="margin-bottom: 10px;"></textarea>
                                        <button class="btn btn-primary" onclick="ense√±arRespuesta()" style="width: 100%;">
                                            <i class="fas fa-graduation-cap"></i> Ense√±ar Respuesta
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Calculadora R√°pida -->
                    <div class="function-card" id="card-calculadora">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-calculator"></i>
                                Calculadora R√°pida
                            </div>
                        </div>
                        <div class="card-content">
                            <div class="form-group">
                                <label>KW Objetivo</label>
                                <input type="number" class="form-control" id="kw-objetivo" value="28800">
                            </div>
                            <div class="form-group">
                                <label>N√∫mero de Biodigestores</label>
                                <select class="form-control" id="num-biodigestores">
                                    <option value="1">1</option>
                                    <option value="2" selected>2</option>
                                    <option value="3">3</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>% Metano Objetivo</label>
                                <input type="number" class="form-control" id="metano-objetivo" value="65">
                            </div>
                            
                            <!-- Controles de porcentaje de s√≥lidos y l√≠quidos -->
                            <div class="form-group">
                                <label><i class="fas fa-cogs"></i> Modo de C√°lculo:</label>
                                <div class="btn-group w-100" role="group">
                                    <input type="radio" class="btn-check" name="modo-calculo" id="modo-energetico" value="energetico" checked>
                                    <label class="btn btn-outline-primary" for="modo-energetico">
                                        <i class="fas fa-bolt"></i> Energ√©tico<br>
                                        <small>% en KW objetivo</small>
                                    </label>
                                    <input type="radio" class="btn-check" name="modo-calculo" id="modo-volumetrico" value="volumetrico">
                                    <label class="btn btn-outline-success" for="modo-volumetrico">
                                        <i class="fas fa-weight"></i> Volum√©trico<br>
                                        <small>% en TN f√≠sicas</small>
                                    </label>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label id="label-solidos">% S√≥lidos (KW)</label>
                                        <input type="number" class="form-control" id="porcentaje-solidos" value="40" min="0" max="100" step="1">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label id="label-liquidos">% L√≠quidos (KW)</label>
                                        <input type="number" class="form-control" id="porcentaje-liquidos" value="40" min="0" max="100" step="1">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label id="label-purin">% Pur√≠n (KW)</label>
                                        <input type="number" class="form-control" id="porcentaje-purin" value="20" min="0" max="100" step="1">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Selector de cantidad de materiales -->
                            <div class="form-group">
                                <label><i class="fas fa-layer-group"></i> Cantidad de Materiales a Usar:</label>
                                <select class="form-control" id="cantidad-materiales">
                                    <option value="3">3 materiales (m√≠nimo)</option>
                                    <option value="5" selected>5 materiales (recomendado)</option>
                                    <option value="8">8 materiales (diversificado)</option>
                                    <option value="10">10 materiales (m√°ximo)</option>
                                    <option value="todos">Todos los disponibles</option>
                                </select>
                                <small class="text-muted">M√°s materiales = mejor diversificaci√≥n pero mayor complejidad</small>
                            </div>
                            
                            <!-- Toggle para incluir/excluir Pur√≠n -->
                            <div class="form-group">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="incluir-purin" checked>
                                    <label class="form-check-label" for="incluir-purin">
                                        <i class="fas fa-tint"></i> Incluir Pur√≠n en el c√°lculo
                                        <small class="text-muted d-block">Desactivar si no se debe usar Pur√≠n</small>
                                    </label>
                                </div>
                            </div>

                            <!-- Recomendaciones de materiales -->
                            <div class="form-group">
                                <button class="btn btn-secondary w-100" onclick="sugerirMateriales()">
                                    <i class="fas fa-magic"></i> Sugerir materiales
                                </button>
                            </div>
                            <div id="recomendaciones-container" class="mt-2" style="display:none">
                                <div class="card p-2" style="background:#13202f;border:1px solid #1f3349">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h6 class="m-0"><i class="fas fa-list"></i> Recomendaciones</h6>
                                        <button class="btn btn-sm btn-primary" onclick="aplicarRecomendaciones()">
                                            <i class="fas fa-check"></i> Aplicar sugeridos
                                        </button>
                                    </div>
                                    <div id="recomendaciones-lista" class="mt-2" style="max-height:180px;overflow:auto"></div>
                                </div>
                            </div>
                            
                            <!-- Informaci√≥n de stock disponible -->
                            <div class="alert alert-info" id="info-stock" style="display: none;">
                                <h6><i class="fas fa-info-circle"></i> Stock Disponible:</h6>
                                <div id="stock-info-content"></div>
                            </div>
                            
                            <button class="btn btn-warning" onclick="calcularMezcla()">
                                <i class="fas fa-magic"></i> Calcular Mezcla
                            </button>
                            <button class="btn btn-info btn-sm mt-2" onclick="depurarValoresSensores()">
                                <i class="fas fa-bug"></i> Depurar Sensores
                            </button>
                            <div id="resultado-calc" style="margin-top: 15px; display: none;"></div>
                        </div>
                    </div>

                    <!-- Registro de Materiales -->
                    <div class="function-card" id="card-registro-materiales">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-truck-loading"></i>
                                Registro de Materiales
                            </div>
                        </div>
                        <div class="card-content">
                            <div class="form-group">
                                <label>Patente</label>
                                <input type="text" class="form-control" id="rm-patente" placeholder="ABC123">
                            </div>
                            <div class="form-group">
                                <label>Material</label>
                                <select class="form-control" id="rm-material">
                                    <option value="">Seleccionar material...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>TN Descargadas</label>
                                <input type="number" class="form-control" id="rm-tn" step="0.01">
                            </div>
                            <div class="form-group">
                                <label>% ST (S√≥lidos Totales)</label>
                                <input type="number" class="form-control" id="rm-st" step="0.01">
                            </div>
                            <div class="form-group">
                                <label>Empresa</label>
                                <input type="text" class="form-control" id="rm-empresa" placeholder="Nombre de la empresa">
                            </div>
                            <div class="form-group">
                                <label>Nombre del Chofer</label>
                                <input type="text" class="form-control" id="rm-chofer" placeholder="Nombre completo del chofer">
                            </div>
                            <div class="form-group">
                                <label>N√∫mero de Remito</label>
                                <input type="text" class="form-control" id="rm-remito" placeholder="N√∫mero de remito del transportista">
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <button class="btn btn-success" onclick="registrarMaterial()">
                                        <i class="fas fa-save"></i> Registrar
                                    </button>
                                </div>
                                <div class="col-md-6">
                                    <button class="btn btn-info" onclick="mostrarFiltrosRegistros()">
                                        <i class="fas fa-search"></i> Buscar Registros
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Registro de Par√°metros Qu√≠micos -->
                    <div class="function-card" id="card-registro-parametros-quimicos">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-flask"></i>
                                Registro de Par√°metros Qu√≠micos
                            </div>
                            <div class="card-subtitle" style="font-size: 12px; color: #00d4ff; margin-top: 5px;">
                                <i class="fas fa-info-circle"></i> FOS/TAC - An√°lisis de hambre bacteriana
                            </div>
                        </div>
                        <div class="card-content">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>FOS (mg/L)</label>
                                        <input type="number" class="form-control" id="rp-fos" step="0.01" placeholder="Concentraci√≥n FOS">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>TAC (mg/L)</label>
                                        <input type="number" class="form-control" id="rp-tac" step="0.01" placeholder="Concentraci√≥n TAC">
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>pH</label>
                                        <input type="number" class="form-control" id="rp-ph" step="0.01" min="0" max="14" placeholder="Valor de pH">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>Biodigestor</label>
                                        <select class="form-control" id="rp-biodigestor">
                                            <option value="">Seleccionar biodigestor...</option>
                                            <option value="bio1">Biodigestor 1</option>
                                            <option value="bio2">Biodigestor 2</option>
                                            <option value="bio3">Biodigestor 3</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Observaciones</label>
                                <textarea class="form-control" id="rp-observaciones" rows="2" placeholder="Observaciones sobre el an√°lisis qu√≠mico"></textarea>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <button class="btn btn-success" onclick="registrarParametrosQuimicos()">
                                        <i class="fas fa-save"></i> Registrar An√°lisis
                                    </button>
                                </div>
                                <div class="col-md-6">
                                    <button class="btn btn-info" onclick="mostrarHistorialParametros()">
                                        <i class="fas fa-history"></i> Ver Historial
                                    </button>
                                </div>
                            </div>
                            <div id="analisis-fos-tac" style="display: none; margin-top: 15px;">
                                <div class="alert alert-info">
                                    <h6><i class="fas fa-brain"></i> An√°lisis de Hambre Bacteriana</h6>
                                    <div id="resultado-analisis-fos-tac"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Generaci√≥n en Tiempo Real -->
                    <div class="function-card" id="card-generacion-tiempo-real">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-chart-line"></i>
                                Generaci√≥n en Tiempo Real
                            </div>
                        </div>
                        <div class="card-content">
                            <div class="mb-3">
                                <div class="row">
                                    <div class="col-md-6">
                                        <label class="form-label">Per√≠odo:</label>
                                        <select id="periodo-generacion" class="form-select form-select-sm">
                                            <option value="1h">√öltima hora</option>
                                            <option value="6h">√öltimas 6 horas</option>
                                            <option value="24h">√öltimas 24 horas</option>
                                            <option value="7d">√öltimos 7 d√≠as</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Actualizaci√≥n:</label>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="auto-update-generacion" checked>
                                            <label class="form-check-label" for="auto-update-generacion">Autom√°tica</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="chart-container" style="position: relative; height: 300px;">
                                <canvas id="chartGeneracion"></canvas>
                            </div>
                            <div class="mt-2 text-center">
                                <button class="btn btn-sm btn-outline-primary" onclick="actualizarGraficoGeneracion()">
                                    <i class="fas fa-sync-alt"></i> Actualizar
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Stock Actual -->
                    <div class="function-card" id="card-stock-actual">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-boxes"></i>
                                Stock Actual
                            </div>
                        </div>
                        <div class="card-content">
                            <div id="stock-list">
                                <div class="text-center">
                                    <i class="fas fa-spinner fa-spin"></i> Cargando stock...
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Gesti√≥n de Materiales -->
                    <div class="function-card" id="card-gestion-materiales">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-table"></i>
                                Gesti√≥n de Materiales
                            </div>
                        </div>
                        <div class="card-content">
                            <div class="form-group">
                                <label>Filtrar por tipo</label>
                                <select class="form-control" id="filtro-tipo-material">
                                    <option value="">Todos</option>
                                    <option value="solido">S√≥lidos</option>
                                    <option value="liquido">L√≠quidos</option>
                                </select>
                            </div>
                            <div id="tabla-materiales-container" style="max-height: 300px; overflow-y: auto;">
                                <div class="text-center">
                                    <i class="fas fa-spinner fa-spin"></i> Cargando materiales...
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Alertas -->
                    <div class="function-card" id="card-alertas">
                        <div class="card-header" onclick="expandCard('card-alertas')" style="cursor: pointer;">
                            <div class="card-title">
                                <i class="fas fa-bell"></i>
                                Alertas del Sistema
                                <button class="expand-button" onclick="event.stopPropagation(); expandCard('card-alertas')" title="Expandir">
                                    <i class="fas fa-expand"></i>
                                </button>
                            </div>
                        </div>
                        <button class="close-button" onclick="closeCard('card-alertas')">
                            <i class="fas fa-times"></i>
                        </button>
                        <div class="card-content">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6>Gesti√≥n de Alertas</h6>
                                <button class="btn btn-success btn-sm" onclick="agregarNuevaAlerta()">
                                    <i class="fas fa-plus"></i> Nueva Alerta
                                </button>
                            </div>
                            
                            <div id="lista-alertas-editables">
                                <div class="alert-item alert-info editable-alert mb-3" data-alert-type="info" style="border: 1px solid #666; padding: 10px; border-radius: 5px;">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div class="alert-content d-flex align-items-center">
                                            <i class="fas fa-info-circle mr-2"></i>
                                            <span class="alert-text" contenteditable="true" style="flex: 1;">Sistema operando normalmente</span>
                                        </div>
                                        <div class="alert-controls d-flex align-items-center ml-3">
                                            <select class="form-control form-control-sm alert-type-selector mr-2" onchange="cambiarTipoAlerta(this)" style="width: 120px;">
                                                <option value="info" selected>Info</option>
                                                <option value="success">√âxito</option>
                                                <option value="warning">Advertencia</option>
                                                <option value="danger">Peligro</option>
                                            </select>
                                            <button class="btn btn-outline-danger btn-sm" onclick="eliminarAlerta(this)" title="Eliminar">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="alert-item alert-warning editable-alert mb-3" data-alert-type="warning" style="border: 1px solid #666; padding: 10px; border-radius: 5px;">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div class="alert-content d-flex align-items-center">
                                            <i class="fas fa-exclamation-triangle mr-2"></i>
                                            <span class="alert-text" contenteditable="true" style="flex: 1;">Temperatura Biodigestor 2 ligeramente elevada</span>
                                        </div>
                                        <div class="alert-controls d-flex align-items-center ml-3">
                                            <select class="form-control form-control-sm alert-type-selector mr-2" onchange="cambiarTipoAlerta(this)" style="width: 120px;">
                                                <option value="info">Info</option>
                                                <option value="success">√âxito</option>
                                                <option value="warning" selected>Advertencia</option>
                                                <option value="danger">Peligro</option>
                                            </select>
                                            <button class="btn btn-outline-danger btn-sm" onclick="eliminarAlerta(this)" title="Eliminar">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mt-3">
                                <button class="btn btn-primary btn-sm" onclick="guardarAlertas()">
                                    <i class="fas fa-save"></i> Guardar Cambios
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Seguimiento Horario -->
                    <div class="function-card" id="card-seguimiento-horario">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-clock"></i>
                                Seguimiento Horario
                            </div>
                        </div>
                        <div class="card-content">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div>
                                    <h6 style="color: #00d4ff; margin-bottom: 10px;">Hora Actual (<span id="hora-actual-display">--:--</span>)</h6>
                                    <div class="metric">
                                        <span class="metric-label">S√≥lidos</span>
                                        <span class="metric-value" id="solidos-actuales">2.45 TN</span>
                                    </div>
                                    <div class="metric">
                                        <span class="metric-label">L√≠quidos</span>
                                        <span class="metric-value" id="liquidos-actuales">1.23 TN</span>
                                    </div>
                                    <button class="btn btn-success btn-sm mt-2" onclick="registrarDosificacionActual()" style="width: 100%;">
                                        <i class="fas fa-plus"></i> Registrar Dosificaci√≥n
                                    </button>
                                    
                                    <!-- Informaci√≥n de objetivos -->
                                    <div id="objetivos-seguimiento"></div>
                                    
                                    <!-- Controles de modo de c√°lculo -->
                                    <div style="background: rgba(255,193,7,0.1); padding: 10px; border-radius: 8px; margin-top: 10px; font-size: 11px;">
                                        <h6 style="color: #ffc107; margin-bottom: 8px;">üìä Modo de C√°lculo</h6>
                                        <div style="display: flex; gap: 15px; margin-bottom: 8px;">
                                            <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                                <input type="radio" name="modo-seguimiento" value="energetico" checked onchange="cambiarModoSeguimiento()">
                                                <span>Energ√©tico</span>
                                            </label>
                                            <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                                <input type="radio" name="modo-seguimiento" value="volumetrico" onchange="cambiarModoSeguimiento()">
                                                <span>Volum√©trico</span>
                                            </label>
                                        </div>
                                        <div style="color: #fff; line-height: 1.4; font-size: 10px;">
                                            <strong>Energ√©tico:</strong> Optimiza por eficiencia KW/TN<br>
                                            <strong>Volum√©trico:</strong> Proporci√≥n 1:1 s√≥lidos/l√≠quidos
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <h6 style="color: #00d4ff; margin-bottom: 10px;">Pr√≥xima Hora</h6>
                                    <div class="metric">
                                        <span class="metric-label">S√≥lidos</span>
                                        <span class="metric-value">2.50 TN</span>
                                    </div>
                                    <div class="metric">
                                        <span class="metric-label">L√≠quidos</span>
                                        <span class="metric-value">1.25 TN</span>
                                    </div>
                                </div>
                            </div>
                            <button class="btn btn-warning" style="width: 100%; margin-top: 15px;" onclick="verSeguimientoCompleto()">
                                <i class="fas fa-clock"></i> Ver Seguimiento Completo
                            </button>
                        </div>
                    </div>

                    <!-- Calidad Gas Motor -->
                    <div class="function-card" id="card-calidad-gas">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-engine"></i>
                                Calidad Gas Motor
                            </div>
                        </div>
                        <div class="card-content">
                            <div style="display: grid; gap: 10px;">
                                <div class="metric">
                                    <span class="metric-label">CH4</span>
                                    <span class="metric-value" id="ch4-motor">--%</span>
                                </div>
                                <div class="metric">
                                    <span class="metric-label">H2S</span>
                                    <span class="metric-value" id="h2s-motor">-- ppm</span>
                                </div>
                                <div class="metric">
                                    <span class="metric-label">O2</span>
                                    <span class="metric-value" id="o2-motor">--%</span>
                                </div>
                                <div class="metric">
                                    <span class="metric-label">CO2</span>
                                    <span class="metric-value" id="co2-motor">--%</span>
                                </div>
                                <div class="metric">
                                    <span class="metric-label">√öltima lectura</span>
                                    <span class="metric-value" id="gas-motor-fecha">--</span>
                                </div>
                            </div>

                            <hr style="border-color: rgba(255,255,255,0.1); margin: 14px 0;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px;">
                                <div class="biodigestor-card">
                                    <div class="biodigestor-header">
                                        <strong>Bio 1</strong>
                                        <small id="bio1-fecha" style="opacity: 0.75;">--</small>
                                    </div>
                                    <div class="biodigestor-metrics">
                                        <div class="metric"><span class="metric-label">CH4</span><span class="metric-value" id="bio1-ch4">--%</span></div>
                                        <div class="metric"><span class="metric-label">H2S</span><span class="metric-value" id="bio1-h2s">-- ppm</span></div>
                                        <div class="metric"><span class="metric-label">CO2</span><span class="metric-value" id="bio1-co2">--%</span></div>
                                        <div class="metric"><span class="metric-label">O2</span><span class="metric-value" id="bio1-o2">--%</span></div>
                                    </div>
                                </div>
                                <div class="biodigestor-card">
                                    <div class="biodigestor-header">
                                        <strong>Bio 2</strong>
                                        <small id="bio2-fecha" style="opacity: 0.75;">--</small>
                                    </div>
                                    <div class="biodigestor-metrics">
                                        <div class="metric"><span class="metric-label">CH4</span><span class="metric-value" id="bio2-ch4">--%</span></div>
                                        <div class="metric"><span class="metric-label">H2S</span><span class="metric-value" id="bio2-h2s">-- ppm</span></div>
                                        <div class="metric"><span class="metric-label">CO2</span><span class="metric-value" id="bio2-co2">--%</span></div>
                                        <div class="metric"><span class="metric-label">O2</span><span class="metric-value" id="bio2-o2">--%</span></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- An√°lisis Hist√≥rico -->
                    <div class="function-card" id="card-analisis-historico">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-chart-line"></i>
                                An√°lisis Hist√≥rico
                            </div>
                        </div>
                        <div class="card-content">
                            <div class="form-group">
                                <label>Per√≠odo de An√°lisis</label>
                                <select class="form-control" id="periodo-analisis">
                                    <option value="7">√öltimos 7 d√≠as</option>
                                    <option value="15">√öltimos 15 d√≠as</option>
                                    <option value="30">√öltimos 30 d√≠as</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Tipo de An√°lisis</label>
                                <select class="form-control" id="tipo-analisis">
                                    <option value="produccion">Producci√≥n Energ√©tica</option>
                                    <option value="calidad">Calidad del Gas</option>
                                    <option value="eficiencia">Eficiencia</option>
                                </select>
                            </div>
                            <button class="btn btn-primary" onclick="cargarAnalisisHistorico()">
                                <i class="fas fa-chart-bar"></i> Generar An√°lisis
                            </button>
                            
                            <div id="grafico-historico-container" style="display: none; margin-top: 15px;">
                                <canvas id="grafico-historico" width="400" height="200"></canvas>
                            </div>
                            
                            <div id="resumen-historico" class="mt-3" style="display: none;">
                                <!-- Resumen de datos hist√≥ricos -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Temperaturas -->
                    <div class="function-card" id="card-temperaturas">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-thermometer-half"></i>
                                Temperaturas
                            </div>
                            <div class="card-subtitle" style="font-size: 12px; color: #00d4ff; margin-top: 5px;">
                                <i class="fas fa-clock"></i> <span id="temperaturas-fecha-hora">Actualizando...</span>
                            </div>
                        </div>
                        <div class="card-content">
                            <div style="display: grid; gap: 10px;">
                                <div class="metric">
                                    <span class="metric-label">Biodigestor 1</span>
                                    <span class="metric-value" id="temp-b1">0¬∞C</span>
                                </div>
                                <div class="metric">
                                    <span class="metric-label">Biodigestor 2</span>
                                    <span class="metric-value" id="temp-b2">0¬∞C</span>
                                </div>
                            </div>
                            <div id="grafico-temperaturas-container" style="margin-top: 15px;">
                                <canvas id="grafico-temperaturas" width="400" height="150"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Niveles Biodigestores -->
                    <div class="function-card" id="card-niveles">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-tint"></i>
                                Niveles Biodigestores
                            </div>
                            <div class="card-subtitle" style="font-size: 12px; color: #00d4ff; margin-top: 5px;">
                                <i class="fas fa-clock"></i> <span id="niveles-fecha-hora">Actualizando...</span>
                            </div>
                        </div>
                        <div class="card-content">
                            <div style="display: grid; gap: 10px;">
                                <div class="metric">
                                    <span class="metric-label">Biodigestor 1</span>
                                    <div class="metric-value">
                                        <span id="nivel-b1-main">0%</span>
                                        <div class="progress-bar-container">
                                            <div class="progress-bar" id="progress-b1-main"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="metric">
                                    <span class="metric-label">Biodigestor 2</span>
                                    <div class="metric-value">
                                        <span id="nivel-b2-main">0%</span>
                                        <div class="progress-bar-container">
                                            <div class="progress-bar" id="progress-b2-main"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div id="grafico-niveles-container" style="margin-top: 15px;">
                                <canvas id="grafico-niveles" width="400" height="150"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Sala de Bombas -->
                    <div class="function-card" id="card-bombas">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-pump"></i>
                                Sala de Bombas
                            </div>
                        </div>
                        <div class="card-content">
                            <div id="sensores-bombas">
                                <div class="text-center">
                                    <i class="fas fa-spinner fa-spin"></i> Cargando sensores...
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Agua Caliente -->
                    <div class="function-card" id="card-agua">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-thermometer-full"></i>
                                Agua Caliente (070)
                            </div>
                        </div>
                        <div class="card-content">
                            <div id="sensores-agua">
                                <div class="text-center">
                                    <i class="fas fa-spinner fa-spin"></i> Cargando sensores...
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Otros Sistemas -->
                    <div class="function-card" id="card-otros-sistemas">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-cogs"></i>
                                Otros Sistemas
                            </div>
                        </div>
                        <div class="card-content">
                            <div id="sensores-otros">
                                <div class="text-center">
                                    <i class="fas fa-spinner fa-spin"></i> Cargando sensores...
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Vista Anal√≠tica -->
            <div id="analytics-view" class="analytics-view">
                <div class="analytics-grid">
                    <!-- Gr√°fico de Tendencias Hist√≥ricas -->
                    <div class="function-card">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-chart-area"></i>
                                Tendencias Hist√≥ricas (30 d√≠as)
                            </div>
                            <div>
                                <button class="btn" onclick="exportData()">
                                    <i class="fas fa-download"></i> Exportar
                                </button>
                            </div>
                        </div>
                        <div class="card-content">
                            <div class="chart-container-medium">
                                <canvas id="trendsChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Predicciones IA -->
                    <div class="function-card">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-brain"></i>
                                Predicciones IA
                            </div>
                        </div>
                        <div class="card-content" id="predicciones-container">
                            <div class="alert-item alert-info">
                                <i class="fas fa-spinner fa-spin"></i> Cargando predicciones IA...
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tabla de Rendimiento por Materiales -->
                <div class="function-card full-width">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-table"></i>
                            Rendimiento por Material (√öltimos 30 d√≠as)
                        </div>
                        <div>
                            <button class="btn" onclick="exportTable()">
                                <i class="fas fa-file-excel"></i> Excel
                            </button>
                            <button class="btn btn-success" onclick="generateReport()">
                                <i class="fas fa-file-pdf"></i> Reporte PDF
                            </button>
                        </div>
                    </div>
                    <div class="card-content">
                        <table class="data-table table-standard">
                            <thead>
                                <tr>
                                    <th>Material</th>
                                    <th>TN Procesadas</th>
                                    <th>kW Generados</th>
                                    <th>kW/TN</th>
                                    <th>Eficiencia</th>
                                    <th>% Metano</th>
                                    <th>Tendencia</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><strong>Esti√©rcol Bovino</strong></td>
                                    <td>456.2</td>
                                    <td>10,675</td>
                                    <td>23.4</td>
                                    <td>89.2%</td>
                                    <td>67.8%</td>
                                    <td style="color: #48bb78;">+2.3%</td>
                                </tr>
                                <tr>
                                    <td><strong>Residuos Org√°nicos</strong></td>
                                    <td>234.1</td>
                                    <td>7,306</td>
                                    <td>31.2</td>
                                    <td>91.5%</td>
                                    <td>69.4%</td>
                                    <td style="color: #48bb78;">+4.1%</td>
                                </tr>
                                <tr>
                                    <td><strong>Pur√≠n Porcino</strong></td>
                                    <td>345.6</td>
                                    <td>6,843</td>
                                    <td>19.8</td>
                                    <td>82.1%</td>
                                    <td>61.2%</td>
                                    <td style="color: #f56565;">-1.5%</td>
                                </tr>
                                <tr>
                                    <td><strong>Lodos Activados</strong></td>
                                    <td>123.4</td>
                                    <td>1,925</td>
                                    <td>15.6</td>
                                    <td>78.3%</td>
                                    <td>58.9%</td>
                                    <td style="color: #48bb78;">+1.2%</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Widget de Alertas flotante (siempre visible) -->
    <div class="alerts-floating" id="alerts-floating">
        <div class="alerts-floating-header" onclick="toggleFloatingAlerts()" style="cursor: pointer;">
            <i class="fas fa-bell"></i>
            <strong>Alertas del Sistema</strong>
            <span id="alerts-counter" class="alerts-counter">3</span>
            <i class="fas fa-chevron-down" id="floating-alerts-toggle" style="margin-left: auto; transition: transform 0.3s;"></i>
        </div>
        <div class="alerts-floating-list" id="alerts-floating-list">
            <div class="alert-floating-item success" data-alert-id="alert-1">
                <i class="fas fa-check-circle"></i>
                <div class="alert-content">
                    <strong>Sistema Operativo</strong><br>
                    <small>Todos los par√°metros dentro del rango normal</small>
                </div>
                <button class="alert-dismiss-btn" onclick="marcarAlertaVista('alert-1')" title="Marcar como visto">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="alert-floating-item warning" data-alert-id="alert-3">
                <i class="fas fa-exclamation-triangle"></i>
                <div class="alert-content">
                    <strong>Temperatura Elevada</strong><br>
                    <small>Biodigestor 2: 45.2¬∞C (objetivo: 40-42¬∞C)</small>
                </div>
                <button class="alert-dismiss-btn" onclick="marcarAlertaVista('alert-3')" title="Marcar como visto">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="alert-floating-item info" data-alert-id="alert-2">
                <i class="fas fa-info-circle"></i>
                <div class="alert-content">
                    <strong>Predicci√≥n IA</strong><br>
                    <small>Posible mantenimiento requerido en 5 d√≠as</small>
                </div>
                <button class="alert-dismiss-btn" onclick="marcarAlertaVista('alert-2')" title="Marcar como visto">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
    </div>

    <script>
        // Configuraci√≥n Chart.js
        Chart.defaults.color = '#e2e8f0';
        Chart.defaults.borderColor = 'rgba(255, 255, 255, 0.1)';

        // Gr√°fico de tendencias hist√≥ricas
        const ctxTrends = document.getElementById('trendsChart');
        if (ctxTrends) {
            const trendsChart = new Chart(ctxTrends.getContext('2d'), {
                type: 'line',
                data: {
                    labels: Array.from({length: 30}, (_, i) => {
                        const date = new Date();
                        date.setDate(date.getDate() - (29 - i));
                        return date.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit' });
                    }),
                    datasets: [
                        {
                            label: 'Generaci√≥n Promedio',
                            data: Array.from({length: 30}, () => 800 + Math.random() * 400),
                            borderColor: '#00d4ff',
                            backgroundColor: 'rgba(0, 212, 255, 0.1)',
                            borderWidth: 2,
                            fill: true
                        },
                        {
                            label: 'Eficiencia (%)',
                            data: Array.from({length: 30}, () => 80 + Math.random() * 15),
                            borderColor: '#48bb78',
                            backgroundColor: 'rgba(72, 187, 120, 0.1)',
                            borderWidth: 2,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { labels: { color: '#e2e8f0' } }
                    },
                    scales: {
                        x: {
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            ticks: { color: '#e2e8f0' }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            ticks: { color: '#e2e8f0' }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            grid: { drawOnChartArea: false },
                            ticks: { color: '#e2e8f0' }
                        }
                    }
                }
            });
        }

        // Funciones para expandir tarjetas
        function expandCard(cardId) {
            console.log('üîç Expandiendo tarjeta:', cardId);
            const card = document.getElementById(cardId);
            if (!card) {
                console.error('‚ùå No se encontr√≥ la tarjeta:', cardId);
                return;
            }
            
            // A√±adir clase expanded
            card.classList.add('expanded');
            
            // Ocultar otras tarjetas
            document.querySelectorAll('.function-card').forEach(otherCard => {
                if (otherCard.id !== cardId) {
                    otherCard.style.display = 'none';
                }
            });
            
            // Ocultar sidebar y header si est√°n visibles
            const sidebar = document.querySelector('.sidebar');
            const header = document.querySelector('header');
            if (sidebar) sidebar.style.display = 'none';
            if (header) header.style.display = 'none';
            
            console.log('‚úÖ Tarjeta expandida:', cardId);
        }
        
        function closeCard(cardId) {
            console.log('üîô Cerrando tarjeta expandida:', cardId);
            const card = document.getElementById(cardId);
            if (!card) return;
            
            // Remover clase expanded
            card.classList.remove('expanded');
            
            // Mostrar todas las tarjetas
            document.querySelectorAll('.function-card').forEach(otherCard => {
                otherCard.style.display = 'block';
            });
            
            // Mostrar sidebar y header
            const sidebar = document.querySelector('.sidebar');
            const header = document.querySelector('header');
            if (sidebar) sidebar.style.display = 'block';
            if (header) header.style.display = 'flex';
            
            console.log('‚úÖ Tarjeta cerrada:', cardId);
        }

        // Funciones de navegaci√≥n
        async function switchView(view) {
            // Actualizar tabs
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            
            // Mostrar/ocultar vistas
            const operationalView = document.getElementById('operational-view');
            const analyticsView = document.getElementById('analytics-view');
            
            if (view === 'operational') {
                operationalView.style.display = 'block';
                analyticsView.style.display = 'none';
            } else if (view === 'analytics') {
                operationalView.style.display = 'none';
                analyticsView.style.display = 'block';
            } else if (view === 'reports') {
                await cargarReportes();
            } else if (view === 'gestion-materiales') {
                operationalView.style.display = 'none';
                analyticsView.style.display = 'block';
                await cargarGestionMaterialesEditable();
            }
            
            // Centrar autom√°ticamente el contenido
            setTimeout(() => {
                const contentArea = document.querySelector('.content-area');
                if (contentArea) {
                    contentArea.scrollTop = 0;
                }
            }, 100);
        }

        function toggleAccordion(header) {
            const content = header.nextElementSibling;
            const icon = header.querySelector('.accordion-icon');
            
            // Toggle la clase active en el header
            header.classList.toggle('active');
            
            // Toggle la clase expanded en el contenido
            content.classList.toggle('expanded');
            
            // Si se est√° expandiendo, cerrar otros acordeones (opcional)
            if (content.classList.contains('expanded')) {
                // Opcional: cerrar otros acordeones
                // document.querySelectorAll('.accordion-content').forEach(otherContent => {
                //     if (otherContent !== content) {
                //         otherContent.classList.remove('expanded');
                //         otherContent.previousElementSibling.classList.remove('active');
                //     }
                // });
            }
        }

        // Inicializar acorde√≥n al cargar la p√°gina
        function initializeAccordion() {
            // Expandir solo la primera secci√≥n por defecto
            const firstSection = document.querySelector('.sidebar-section:first-child');
            if (firstSection) {
                const firstHeader = firstSection.querySelector('.accordion-header');
                const firstContent = firstSection.querySelector('.accordion-content');
                const firstIcon = firstSection.querySelector('.accordion-icon');
                
                if (firstHeader && firstContent && firstIcon) {
                    firstHeader.classList.add('active');
                    firstContent.classList.add('expanded');
                    firstIcon.style.transform = 'rotate(180deg)';
                }
            }
        }

        function showCard(cardId) {
            // Actualizar men√∫
            document.querySelectorAll('.sidebar-menu a').forEach(a => a.classList.remove('active'));
            event.target.classList.add('active');
            
            // Mostrar solo la tarjeta seleccionada
            document.querySelectorAll('.function-card').forEach(card => {
                card.style.display = card.id === `card-${cardId}` ? 'block' : 'none';
            });
            
            // Asegurar que estamos en vista operativa
            document.getElementById('operational-view').style.display = 'block';
            document.getElementById('analytics-view').style.display = 'none';
            
            // Centrar autom√°ticamente el contenido
            setTimeout(() => {
                const contentArea = document.querySelector('.content-area');
                if (contentArea) {
                    contentArea.scrollTop = 0;
                }
            }, 100);
            
            // Cargar datos espec√≠ficos seg√∫n la tarjeta
            switch(cardId) {
                case 'bombas':
                case 'agua':
                case 'otros-sistemas':
                    cargarSensoresSistemas();
                    break;
                case 'temperaturas':
                    cargarTemperaturas();
                    break;
                case 'niveles':
                    cargarNiveles();
                    break;
                case 'biodigestores':
                    cargarDatosBiodigestores();
                    break;
                case 'generacion-tiempo-real':
                    inicializarGraficoGeneracion();
                    break;
                case 'calidad-gas':
                    cargarCalidadGas();
                    break;
                case 'seguimiento-horario':
                    cargarSeguimientoHorario();
                    break;
                case 'generacion-tiempo-real':
                    cargarGeneracionTiempoReal();
                    break;
                case 'analisis-historico':
                    cargarAnalisisHistorico();
                    break;
                case 'registro-materiales':
                    cargarRegistroMateriales();
                    break;
                case 'parametros-quimicos':
                    cargarParametrosQuimicos();
                    break;
                case 'tareas-diarias':
                    cargarTareasDiarias();
                    break;
                case 'gestion-tareas':
                    cargarGestionTareas();
                    break;
            }
        }

        async function showAnalytics(section) {
            // Actualizar men√∫
            document.querySelectorAll('.sidebar-menu a').forEach(a => a.classList.remove('active'));
            event.target.classList.add('active');
            
            // Cambiar a vista anal√≠tica
            document.getElementById('operational-view').style.display = 'none';
            document.getElementById('analytics-view').style.display = 'block';
            
            // Centrar autom√°ticamente el contenido
            setTimeout(() => {
                const contentArea = document.querySelector('.content-area');
                if (contentArea) {
                    contentArea.scrollTop = 0;
                }
            }, 100);
            
            console.log('Mostrando an√°lisis:', section);
            
            // Cargar datos espec√≠ficos seg√∫n la secci√≥n
            switch(section) {
                case 'kpis':
                    await cargarKPIsEjecutivos();
                    break;
                case 'tendencias':
                    await cargarTendenciasHistoricas();
                    break;
                case 'materiales':
                    await cargarRendimientoMateriales();
                    break;
                case 'eficiencia':
                    await cargarAnalisisEficiencia();
                    break;
                case 'predicciones':
                    await cargarPrediccionesIA();
                    break;
                case 'gestion_materiales':
                    await cargarGestionMaterialesEditable();
                    break;
                default:
                    console.log('Secci√≥n no implementada:', section);
            }
        }

        // Funciones de an√°lisis hist√≥rico
        async function cargarKPIsEjecutivos() {
            console.log('üìä Cargando KPIs Ejecutivos...');
            
            const analyticsView = document.getElementById('analytics-view');
            if (!analyticsView) return;
            
            analyticsView.innerHTML = `
                <div class="function-card">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-chart-bar"></i>
                            KPIs Ejecutivos
                        </div>
                    </div>
                    <div class="card-content">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="kpi-card">
                                    <div class="kpi-header">Generaci√≥n Promedio</div>
                                    <div class="kpi-value">1,250 kW</div>
                                    <div class="kpi-trend">+5.2% vs mes anterior</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="kpi-card">
                                    <div class="kpi-header">Eficiencia Promedio</div>
                                    <div class="kpi-value">78.5%</div>
                                    <div class="kpi-trend">+2.1% vs mes anterior</div>
                                </div>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <div class="kpi-card">
                                    <div class="kpi-header">Uptime</div>
                                    <div class="kpi-value">96.8%</div>
                                    <div class="kpi-trend">+0.5% vs mes anterior</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="kpi-card">
                                    <div class="kpi-header">Calidad CH4</div>
                                    <div class="kpi-value">54.2%</div>
                                    <div class="kpi-trend">+1.3% vs mes anterior</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }



        async function cargarAnalisisEficiencia() {
            console.log('‚ö° Cargando An√°lisis de Eficiencia...');
            
            const analyticsView = document.getElementById('analytics-view');
            if (!analyticsView) return;
            
            analyticsView.innerHTML = `
                <div class="function-card">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-tachometer-alt"></i>
                            An√°lisis de Eficiencia
                        </div>
                    </div>
                    <div class="card-content">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="kpi-card">
                                    <div class="kpi-header">Eficiencia Actual</div>
                                    <div class="kpi-value">78.5%</div>
                                    <div class="kpi-trend">+2.1% vs mes anterior</div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="kpi-card">
                                    <div class="kpi-header">Eficiencia Objetivo</div>
                                    <div class="kpi-value">80.0%</div>
                                    <div class="kpi-trend">-1.5% vs objetivo</div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="kpi-card">
                                    <div class="kpi-header">Mejora Necesaria</div>
                                    <div class="kpi-value">1.5%</div>
                                    <div class="kpi-trend">Optimizaci√≥n requerida</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-4">
                            <h6>Factores que Afectan la Eficiencia:</h6>
                            <ul>
                                <li>‚úÖ Temperatura √≥ptima mantenida</li>
                                <li>‚ö†Ô∏è Nivel de pH ligeramente alto</li>
                                <li>‚úÖ Calidad de gas estable</li>
                                <li>‚ö†Ô∏è Mezcla de materiales sub√≥ptima</li>
                            </ul>
                        </div>
                    </div>
                </div>
            `;
        }

        async function cargarPrediccionesIA() {
            console.log('ü§ñ Cargando Predicciones IA Avanzadas...');
            
            const analyticsView = document.getElementById('analytics-view');
            if (!analyticsView) return;
            
            analyticsView.innerHTML = `
                <div class="function-card">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-brain"></i>
                            Predicciones IA - An√°lisis Avanzado
                        </div>
                        <div class="card-subtitle" style="font-size: 12px; color: #00d4ff; margin-top: 5px;">
                            <i class="fas fa-clock"></i> <span id="predicciones-fecha-hora">Actualizando...</span>
                        </div>
                    </div>
                    <div class="card-content">
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <button class="btn btn-primary" onclick="generarPrediccionIA()">
                                    <i class="fas fa-brain"></i> Generar Nueva Predicci√≥n
                                </button>
                            </div>
                            <div class="col-md-6">
                                <button class="btn btn-success" onclick="entrenarModelosML()">
                                    <i class="fas fa-cogs"></i> Entrenar Modelos ML
                                </button>
                            </div>
                        </div>
                        
                        <div id="prediccion-resultado" style="display: none;">
                            <div class="alert alert-info">
                                <h6><i class="fas fa-info-circle"></i> Predicci√≥n IA</h6>
                                <div id="contenido-prediccion"></div>
                            </div>
                        </div>
                        
                        <!-- Panel de an√°lisis ML avanzado -->
                        <div id="analisis-ml-avanzado" style="display: none;">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card mb-3">
                                        <div class="card-header bg-info text-white">
                                            <h6><i class="fas fa-heartbeat"></i> Salud del Sistema</h6>
                                        </div>
                                        <div class="card-body">
                                            <div id="salud-sistema-info"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card mb-3">
                                        <div class="card-header bg-warning text-dark">
                                            <h6><i class="fas fa-tools"></i> Mantenimiento Predicho</h6>
                                        </div>
                                        <div class="card-body">
                                            <div id="mantenimiento-info"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="card mb-3">
                                        <div class="card-header bg-success text-white">
                                            <h6><i class="fas fa-chart-line"></i> An√°lisis de Tendencias</h6>
                                        </div>
                                        <div class="card-body">
                                            <div id="tendencias-info"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Cargar predicci√≥n autom√°ticamente
            await generarPrediccionIA();
        }


        // Funci√≥n para generar predicci√≥n IA
        async function generarPrediccionIA() {
            console.log('ü§ñ Generando predicci√≥n IA avanzada con modelo evolutivo...');
            
            try {
                // Usar el endpoint avanzado que incluye XGBoost + Redes Neuronales
                const response = await fetch('/prediccion_ia_avanzada?t=' + Date.now());
                const data = await response.json();
                
                console.log('üìä Datos de predicci√≥n recibidos:', data);
                
                // Actualizar fecha de actualizaci√≥n
                const fechaElement = document.getElementById('predicciones-fecha-hora');
                if (fechaElement) {
                    fechaElement.textContent = data.fecha_ultima || new Date().toLocaleString('es-ES');
                }
                
                if (data.estado === 'conectado') {
                    const prediccionDiv = document.getElementById('prediccion-resultado');
                    const contenidoDiv = document.getElementById('contenido-prediccion');
                    
                    prediccionDiv.style.display = 'block';
                    contenidoDiv.innerHTML = `
                        <div class="row">
                            <div class="col-md-3">
                                <div class="text-center" style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; margin: 5px;">
                                    <h4 style="color: #00d4ff; font-weight: bold; text-shadow: 1px 1px 2px rgba(0,0,0,0.5);">${data.prediccion_24h} kW</h4>
                                    <small style="color: #fff; font-weight: bold;">Predicci√≥n 24h</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center" style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; margin: 5px;">
                                    <h4 style="color: #00ff88; font-weight: bold; text-shadow: 1px 1px 2px rgba(0,0,0,0.5);">${data.confianza}%</h4>
                                    <small style="color: #fff; font-weight: bold;">Confianza IA</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center" style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; margin: 5px;">
                                    <h4 style="color: #ffd700; font-weight: bold; text-shadow: 1px 1px 2px rgba(0,0,0,0.5);">${data.tendencia}</h4>
                                    <small style="color: #fff; font-weight: bold;">Tendencia</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center" style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; margin: 5px;">
                                    <h4 style="color: #ff6b6b; font-weight: bold; text-shadow: 1px 1px 2px rgba(0,0,0,0.5);">${data.alertas_preventivas ? data.alertas_preventivas.length : 0}</h4>
                                    <small style="color: #fff; font-weight: bold;">Alertas</small>
                                </div>
                            </div>
                        </div>
                        <hr style="border-color: rgba(255,255,255,0.3);">
                        <div style="background: rgba(0,0,0,0.3); padding: 10px; border-radius: 5px; margin-top: 10px;">
                            <p style="color: #fff; margin: 5px 0;"><strong style="color: #00d4ff;">Motor IA:</strong> <span style="color: #fff;">${data.motor_ia || 'ML_AVANZADO'}</span></p>
                            <p style="color: #fff; margin: 5px 0;"><strong style="color: #00d4ff;">Mensaje:</strong> <span style="color: #fff;">${data.mensaje || 'An√°lisis completado'}</span></p>
                        </div>
                    `;
                    
                    // Mostrar an√°lisis ML avanzado si est√° disponible
                    if (data.salud_sistema || data.analisis_tendencias || data.mantenimiento_predicho) {
                        mostrarAnalisisMLAvanzado(data);
                    }
                    
                } else {
                    throw new Error(data.mensaje || 'Error generando predicci√≥n');
                }
            } catch (error) {
                console.error('Error generando predicci√≥n:', error);
                alert('‚ùå Error generando predicci√≥n: ' + error.message);
            }
        }
        
        // Funci√≥n para mostrar an√°lisis ML avanzado
        function mostrarAnalisisMLAvanzado(data) {
            const analisisDiv = document.getElementById('analisis-ml-avanzado');
            if (!analisisDiv) return;
            
            analisisDiv.style.display = 'block';
            
            // Mostrar salud del sistema
            if (data.salud_sistema) {
                const saludDiv = document.getElementById('salud-sistema-info');
                if (saludDiv) {
                    const salud = data.salud_sistema;
                    const colorClass = salud.color === 'success' ? 'text-success' : 
                                     salud.color === 'warning' ? 'text-warning' : 
                                     salud.color === 'danger' ? 'text-danger' : 'text-info';
                    
                    saludDiv.innerHTML = `
                        <div class="text-center mb-3">
                            <h3 class="${colorClass}" style="font-weight: bold; text-shadow: 1px 1px 2px rgba(0,0,0,0.5);">${salud.score_general}/100</h3>
                            <h5 class="${colorClass}" style="font-weight: bold; text-shadow: 1px 1px 2px rgba(0,0,0,0.5);">${salud.estado}</h5>
                        </div>
                        <div class="row">
                            <div class="col-6">
                                <small style="color: #fff; font-weight: bold; background: rgba(0,0,0,0.3); padding: 2px 5px; border-radius: 3px;">Temperatura: ${salud.scores_individuales?.temperatura || 'N/A'}/100</small>
                            </div>
                            <div class="col-6">
                                <small style="color: #fff; font-weight: bold; background: rgba(0,0,0,0.3); padding: 2px 5px; border-radius: 3px;">Nivel: ${salud.scores_individuales?.nivel || 'N/A'}/100</small>
                            </div>
                            <div class="col-6">
                                <small style="color: #fff; font-weight: bold; background: rgba(0,0,0,0.3); padding: 2px 5px; border-radius: 3px;">Calidad Gas: ${salud.scores_individuales?.calidad_gas || 'N/A'}/100</small>
                            </div>
                            <div class="col-6">
                                <small style="color: #fff; font-weight: bold; background: rgba(0,0,0,0.3); padding: 2px 5px; border-radius: 3px;">Eficiencia: ${salud.scores_individuales?.eficiencia || 'N/A'}/100</small>
                            </div>
                        </div>
                    `;
                }
            }
            
            // Mostrar mantenimiento predicho
            if (data.mantenimiento_predicho) {
                const mantenimientoDiv = document.getElementById('mantenimiento-info');
                if (mantenimientoDiv) {
                    const mantenimiento = data.mantenimiento_predicho;
                    mantenimientoDiv.innerHTML = `
                        <div class="text-center mb-3">
                            <h4 style="color: #fff; font-weight: bold; text-shadow: 1px 1px 2px rgba(0,0,0,0.5);">${mantenimiento.mantenimientos_pendientes || 0}</h4>
                            <small style="color: #fff; font-weight: bold; background: rgba(0,0,0,0.3); padding: 2px 5px; border-radius: 3px;">Mantenimientos Pendientes</small>
                        </div>
                        ${mantenimiento.proximo_mantenimiento ? `
                            <div class="alert alert-warning" style="background: rgba(255,193,7,0.9); border: 1px solid #ffc107; color: #000;">
                                <strong style="color: #000;">Pr√≥ximo:</strong> <span style="color: #000;">${mantenimiento.proximo_mantenimiento.descripcion}</span><br>
                                <small style="color: #000; font-weight: bold;">Prioridad: ${mantenimiento.proximo_mantenimiento.prioridad} | 
                                D√≠as: ${mantenimiento.proximo_mantenimiento.dias_estimados}</small>
                            </div>
                        ` : '<p style="color: #fff; background: rgba(0,0,0,0.3); padding: 5px; border-radius: 3px;">No hay mantenimientos urgentes</p>'}
                    `;
                }
            }
            
            // Mostrar an√°lisis de tendencias
            if (data.analisis_tendencias) {
                const tendenciasDiv = document.getElementById('tendencias-info');
                if (tendenciasDiv) {
                    const tendencias = data.analisis_tendencias;
                        tendenciasDiv.innerHTML = `
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="text-center" style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px; margin: 5px;">
                                        <i class="fas fa-thermometer-half fa-2x mb-2" style="color: #fff;"></i>
                                        <h6 style="color: #fff; font-weight: bold;">Temperatura</h6>
                                        <span class="badge bg-${tendencias.temperatura === 'ascendente_critica' ? 'danger' : 
                                                               tendencias.temperatura === 'ascendente' ? 'warning' : 'success'}" style="font-size: 12px; font-weight: bold;">
                                            ${tendencias.temperatura}
                                        </span>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center" style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px; margin: 5px;">
                                        <i class="fas fa-tint fa-2x mb-2" style="color: #fff;"></i>
                                        <h6 style="color: #fff; font-weight: bold;">Nivel</h6>
                                        <span class="badge bg-${tendencias.nivel === 'alto' || tendencias.nivel === 'bajo' ? 'warning' : 'success'}" style="font-size: 12px; font-weight: bold;">
                                            ${tendencias.nivel}
                                        </span>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center" style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px; margin: 5px;">
                                        <i class="fas fa-wind fa-2x mb-2" style="color: #fff;"></i>
                                        <h6 style="color: #fff; font-weight: bold;">Calidad Gas</h6>
                                        <span class="badge bg-${tendencias.calidad_gas === 'excelente' ? 'success' : 
                                                               tendencias.calidad_gas === 'buena' ? 'info' : 
                                                               tendencias.calidad_gas === 'regular' ? 'warning' : 'danger'}" style="font-size: 12px; font-weight: bold;">
                                            ${tendencias.calidad_gas}
                                        </span>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center" style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px; margin: 5px;">
                                        <i class="fas fa-chart-line fa-2x mb-2" style="color: #fff;"></i>
                                        <h6 style="color: #fff; font-weight: bold;">Eficiencia</h6>
                                        <span class="badge bg-${tendencias.eficiencia === 'excelente' ? 'success' : 
                                                               tendencias.eficiencia === 'buena' ? 'info' : 
                                                               tendencias.eficiencia === 'regular' ? 'warning' : 'danger'}" style="font-size: 12px; font-weight: bold;">
                                            ${tendencias.eficiencia}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        `;
                }
            }
        }
        
        // Funci√≥n para cargar el formulario de registro de materiales
        function cargarRegistroMateriales() {
            // Mostrar en vista operativa, no anal√≠tica
            const operationalView = document.getElementById('operational-view');
            if (!operationalView) return;
            
            // Ocultar todas las tarjetas existentes
            document.querySelectorAll('.function-card').forEach(card => {
                card.style.display = 'none';
            });
            
            operationalView.innerHTML = `
                <div class="function-card">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-truck-loading"></i>
                            Registro de Materiales
                        </div>
                    </div>
                    <div class="card-content">
                        <div class="form-group">
                            <label>Patente</label>
                            <input type="text" class="form-control" id="rm-patente" placeholder="ABC123">
                        </div>
                        <div class="form-group">
                            <label>Material</label>
                            <select class="form-control" id="rm-material">
                                <option value="">Seleccionar material...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>TN Descargadas</label>
                            <input type="number" class="form-control" id="rm-tn" step="0.01">
                        </div>
                        <div class="form-group">
                            <label>% ST (S√≥lidos Totales)</label>
                            <input type="number" class="form-control" id="rm-st" step="0.01">
                        </div>
                        <div class="form-group">
                            <label>Empresa</label>
                            <input type="text" class="form-control" id="rm-empresa" placeholder="Nombre de la empresa">
                        </div>
                        <div class="form-group">
                            <label>Nombre del Chofer</label>
                            <input type="text" class="form-control" id="rm-chofer" placeholder="Nombre completo del chofer">
                        </div>
                        <div class="form-group">
                            <label>N√∫mero de Remito</label>
                            <input type="text" class="form-control" id="rm-remito" placeholder="N√∫mero de remito del transportista">
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <button class="btn btn-success" onclick="registrarMaterial()">
                                    <i class="fas fa-save"></i> Registrar
                                </button>
                            </div>
                            <div class="col-md-6">
                                <button class="btn btn-info" onclick="mostrarFiltrosRegistros()">
                                    <i class="fas fa-search"></i> Buscar Registros
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Cargar opciones de materiales
            cargarMaterialesBase();
        }
        
        // Funci√≥n para cargar par√°metros qu√≠micos
        function cargarParametrosQuimicos() {
            // Mostrar en vista operativa, no anal√≠tica
            const operationalView = document.getElementById('operational-view');
            if (!operationalView) return;
            
            // Ocultar todas las tarjetas existentes
            document.querySelectorAll('.function-card').forEach(card => {
                card.style.display = 'none';
            });
            
            operationalView.innerHTML = `
                <div class="function-card">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-flask"></i>
                            Registro de Par√°metros Qu√≠micos
                        </div>
                        <div class="card-subtitle" style="font-size: 12px; color: #00d4ff; margin-top: 5px;">
                            <i class="fas fa-info-circle"></i> FOS/TAC - An√°lisis de hambre bacteriana
                        </div>
                    </div>
                    <div class="card-content">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>FOS (mg/L)</label>
                                    <input type="number" class="form-control" id="rp-fos" step="0.01" placeholder="Concentraci√≥n FOS">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>TAC (mg/L)</label>
                                    <input type="number" class="form-control" id="rp-tac" step="0.01" placeholder="Concentraci√≥n TAC">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>pH</label>
                                    <input type="number" class="form-control" id="rp-ph" step="0.01" min="0" max="14" placeholder="Valor de pH">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Biodigestor</label>
                                    <select class="form-control" id="rp-biodigestor">
                                        <option value="">Seleccionar biodigestor...</option>
                                        <option value="bio1">Biodigestor 1</option>
                                        <option value="bio2">Biodigestor 2</option>
                                        <option value="bio3">Biodigestor 3</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Observaciones</label>
                            <textarea class="form-control" id="rp-observaciones" rows="2" placeholder="Observaciones sobre el an√°lisis qu√≠mico"></textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <button class="btn btn-success" onclick="registrarParametrosQuimicos()">
                                    <i class="fas fa-save"></i> Registrar An√°lisis
                                </button>
                            </div>
                            <div class="col-md-6">
                                <button class="btn btn-info" onclick="mostrarHistorialParametros()">
                                    <i class="fas fa-history"></i> Ver Historial
                                </button>
                            </div>
                        </div>
                        <div id="analisis-fos-tac" style="display: none; margin-top: 15px;">
                            <div class="alert alert-info">
                                <h6><i class="fas fa-brain"></i> An√°lisis de Hambre Bacteriana</h6>
                                <div id="resultado-analisis-fos-tac"></div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Funci√≥n para cargar tareas diarias
        function cargarTareasDiarias() {
            // Mostrar en vista operativa, no anal√≠tica
            const operationalView = document.getElementById('operational-view');
            if (!operationalView) return;
            
            // Ocultar todas las tarjetas existentes
            document.querySelectorAll('.function-card').forEach(card => {
                card.style.display = 'none';
            });
            
            operationalView.innerHTML = `
                <div class="function-card">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-tasks"></i>
                            Tareas Diarias
                        </div>
                        <div class="card-subtitle" style="font-size: 12px; color: #00d4ff; margin-top: 5px;">
                            <i class="fas fa-calendar-day"></i> <span id="fecha-tareas">${new Date().toLocaleDateString('es-ES')}</span>
                        </div>
                    </div>
                    <div class="card-content">
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label>Seleccionar Fecha</label>
                                    <input type="date" class="form-control" id="fecha-seleccionada" 
                                           value="${new Date().toISOString().split('T')[0]}">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <button class="btn btn-primary" onclick="cargarTareasDelDia()">
                                    <i class="fas fa-refresh"></i> Actualizar
                                </button>
                            </div>
                            <div class="col-md-4">
                                <button class="btn btn-success" onclick="mostrarFormularioNuevaTarea()">
                                    <i class="fas fa-plus"></i> Nueva Tarea
                                </button>
                            </div>
                        </div>
                        
                        <div id="progreso-tareas" style="display: none;">
                            <div class="alert alert-info">
                                <h6><i class="fas fa-chart-pie"></i> Progreso del D√≠a</h6>
                                <div id="barra-progreso"></div>
                            </div>
                        </div>
                        
                        <div id="lista-tareas">
                            <div class="text-center">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Cargando...</span>
                                </div>
                                <p class="mt-2">Cargando tareas...</p>
                            </div>
                        </div>
                        
                        <!-- Formulario para nueva tarea (oculto inicialmente) -->
                        <div id="formulario-nueva-tarea" style="display: none;" class="mt-4">
                            <div class="card">
                                <div class="card-header">
                                    <h6><i class="fas fa-plus"></i> Nueva Tarea</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-group mb-3">
                                                <label>Nombre de la Tarea *</label>
                                                <input type="text" class="form-control" id="nueva-tarea-nombre" 
                                                       placeholder="Ej: Limpieza de Biodigestor 1">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-group mb-3">
                                                <label>Prioridad *</label>
                                                <select class="form-control" id="nueva-tarea-prioridad">
                                                    <option value="alta">Alta</option>
                                                    <option value="media">Media</option>
                                                    <option value="baja">Baja</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-group mb-3">
                                        <label>Descripci√≥n *</label>
                                        <textarea class="form-control" id="nueva-tarea-descripcion" rows="3" 
                                                  placeholder="Describe detalladamente la tarea a realizar"></textarea>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-4">
                                            <div class="form-group mb-3">
                                                <label>Hora de Inicio *</label>
                                                <input type="time" class="form-control" id="nueva-tarea-hora" value="08:00">
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="form-group mb-3">
                                                <label>Duraci√≥n (minutos) *</label>
                                                <input type="number" class="form-control" id="nueva-tarea-duracion" 
                                                       placeholder="60" min="1" max="480">
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="form-group mb-3">
                                                <label>Tipo de Tarea</label>
                                                <select class="form-control" id="nueva-tarea-tipo">
                                                    <option value="diaria">Diaria</option>
                                                    <option value="semanal">Semanal</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-group mb-3">
                                        <label>Operario Asignado</label>
                                        <select class="form-control" id="nueva-tarea-operario">
                                            <option value="operario1">Operario 1 - Turno Ma√±ana</option>
                                            <option value="operario2">Operario 2 - Turno Tarde</option>
                                            <option value="operario3">Operario 3 - Turno Noche</option>
                                            <option value="todos">Todos los Operarios</option>
                                        </select>
                                    </div>
                                    <div class="text-end">
                                        <button class="btn btn-secondary me-2" onclick="ocultarFormularioNuevaTarea()">
                                            <i class="fas fa-times"></i> Cancelar
                                        </button>
                                        <button class="btn btn-success" onclick="crearNuevaTarea()">
                                            <i class="fas fa-save"></i> Crear Tarea
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Cargar tareas autom√°ticamente
            cargarTareasDelDia();
        }
        
        // Funci√≥n para cargar tareas del d√≠a seleccionado
        async function cargarTareasDelDia() {
            try {
                const fecha = document.getElementById('fecha-seleccionada').value;
                const response = await fetch(`/api/tareas?fecha=${fecha}`);
                const data = await response.json();
                
                if (data.success) {
                    mostrarTareas(data.tareas, data.progreso);
                } else {
                    mostrarErrorTareas(data.message || 'Error cargando tareas');
                }
            } catch (error) {
                console.error('Error cargando tareas:', error);
                mostrarErrorTareas('Error de conexi√≥n');
            }
        }
        
        // Funci√≥n para mostrar las tareas
        function mostrarTareas(tareas, progreso) {
            const listaDiv = document.getElementById('lista-tareas');
            const progresoDiv = document.getElementById('progreso-tareas');
            
            // Mostrar progreso
            if (progreso) {
                progresoDiv.style.display = 'block';
                const barraProgreso = document.getElementById('barra-progreso');
                barraProgreso.innerHTML = `
                    <div class="d-flex justify-content-between mb-2">
                        <span>Tareas Completadas: ${progreso.completadas}/${progreso.total_tareas}</span>
                        <span>${progreso.porcentaje}%</span>
                    </div>
                    <div class="progress" style="height: 20px;">
                        <div class="progress-bar" role="progressbar" style="width: ${progreso.porcentaje}%">
                            ${progreso.porcentaje}%
                        </div>
                    </div>
                `;
            }
            
            // Mostrar tareas
            if (tareas.length === 0) {
                listaDiv.innerHTML = `
                    <div class="alert alert-info text-center">
                        <i class="fas fa-info-circle"></i>
                        <p class="mb-0">No hay tareas programadas para esta fecha</p>
                    </div>
                `;
                return;
            }
            
            let html = '<div class="row">';
            
            tareas.forEach(tarea => {
                const prioridadClass = tarea.prioridad === 'alta' ? 'danger' : 
                                     tarea.prioridad === 'media' ? 'warning' : 'success';
                
                html += `
                    <div class="col-md-6 mb-3">
                        <div class="card h-100">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">${tarea.nombre}</h6>
                                <span class="badge bg-${prioridadClass}">${tarea.prioridad.toUpperCase()}</span>
                            </div>
                            <div class="card-body">
                                <p class="card-text">${tarea.descripcion}</p>
                                <div class="row">
                                    <div class="col-6">
                                        <small class="text-muted">
                                            <i class="fas fa-clock"></i> ${tarea.hora_inicio}
                                        </small>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted">
                                            <i class="fas fa-hourglass-half"></i> ${tarea.duracion_minutos} min
                                        </small>
                                    </div>
                                </div>
                                ${tarea.operario ? `
                                <div class="row mt-2">
                                    <div class="col-12">
                                        <small class="text-info">
                                            <i class="fas fa-user"></i> Asignado a: ${tarea.operario}
                                        </small>
                                    </div>
                                </div>
                                ` : ''}
                                <div class="mt-3">
                                    <button class="btn btn-success btn-sm" onclick="completarTarea('${tarea.id}')">
                                        <i class="fas fa-check"></i> Completar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            listaDiv.innerHTML = html;
        }
        
        // Funci√≥n para mostrar error en tareas
        function mostrarErrorTareas(mensaje) {
            const listaDiv = document.getElementById('lista-tareas');
            listaDiv.innerHTML = `
                <div class="alert alert-danger text-center">
                    <i class="fas fa-exclamation-triangle"></i>
                    <p class="mb-0">${mensaje}</p>
                </div>
            `;
        }
        
        // Funci√≥n para completar una tarea
        async function completarTarea(tareaId) {
            try {
                const observaciones = prompt('Observaciones (opcional):') || '';
                const fecha = document.getElementById('fecha-seleccionada').value;
                
                const response = await fetch('/api/tareas/completar', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        tarea_id: tareaId,
                        fecha: fecha,
                        observaciones: observaciones
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('‚úÖ Tarea completada exitosamente');
                    // Recargar tareas
                    cargarTareasDelDia();
                } else {
                    alert('‚ùå Error: ' + data.message);
                }
            } catch (error) {
                console.error('Error completando tarea:', error);
                alert('‚ùå Error completando tarea: ' + error.message);
            }
        }
        
        // Funci√≥n para cargar gesti√≥n de tareas (solo admin)
        function cargarGestionTareas() {
            // Mostrar en vista operativa, no anal√≠tica
            const operationalView = document.getElementById('operational-view');
            if (!operationalView) return;
            
            // Ocultar todas las tarjetas existentes
            document.querySelectorAll('.function-card').forEach(card => {
                card.style.display = 'none';
            });
            
            operationalView.innerHTML = `
                <div class="function-card">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-tasks"></i>
                            Gesti√≥n de Tareas - Administrador
                        </div>
                        <div class="card-subtitle" style="font-size: 12px; color: #00d4ff; margin-top: 5px;">
                            <i class="fas fa-chart-bar"></i> An√°lisis de cumplimiento de operarios
                        </div>
                    </div>
                    <div class="card-content">
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label>Fecha Desde</label>
                                    <input type="date" class="form-control" id="fecha-desde-gestion" 
                                           value="${new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]}">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label>Fecha Hasta</label>
                                    <input type="date" class="form-control" id="fecha-hasta-gestion" 
                                           value="${new Date().toISOString().split('T')[0]}">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label>Operario</label>
                                    <select class="form-control" id="operario-gestion">
                                        <option value="">Todos los operarios</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-primary" onclick="analizarCumplimientoTareas()">
                                    <i class="fas fa-search"></i> Analizar
                                </button>
                            </div>
                        </div>
                        
                        <div id="estadisticas-cumplimiento" style="display: none;">
                            <div class="row mb-4">
                                <div class="col-md-3">
                                    <div class="card bg-success text-white">
                                        <div class="card-body text-center">
                                            <h5 id="total-tareas">0</h5>
                                            <small>Total Tareas</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card bg-primary text-white">
                                        <div class="card-body text-center">
                                            <h5 id="tareas-completadas">0</h5>
                                            <small>Completadas</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card bg-warning text-white">
                                        <div class="card-body text-center">
                                            <h5 id="tareas-pendientes">0</h5>
                                            <small>Pendientes</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card bg-info text-white">
                                        <div class="card-body text-center">
                                            <h5 id="porcentaje-cumplimiento">0%</h5>
                                            <small>Cumplimiento</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div id="tabla-cumplimiento" style="display: none;">
                            <h6><i class="fas fa-table"></i> An√°lisis por Operario</h6>
                            <div class="table-responsive">
                                <table class="table table-striped table-hover" style="background: #fff; color: #333;">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>Operario</th>
                                            <th>Fecha</th>
                                            <th>Tarea</th>
                                            <th>Hora Programada</th>
                                            <th>Hora Completada</th>
                                            <th>Estado</th>
                                            <th>Observaciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tbody-cumplimiento">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div id="grafico-cumplimiento" style="display: none;">
                            <h6><i class="fas fa-chart-pie"></i> Gr√°fico de Cumplimiento</h6>
                            <canvas id="chart-cumplimiento" width="400" height="200"></canvas>
                        </div>
                        
                        <div id="loading-gestion" class="text-center" style="display: none;">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Cargando...</span>
                            </div>
                            <p class="mt-2">Analizando cumplimiento...</p>
                        </div>
                        
                        <!-- Formulario para nueva tarea -->
                        <div id="formulario-nueva-tarea" style="display: none;">
                            <div class="card">
                                <div class="card-header">
                                    <h6><i class="fas fa-plus"></i> Crear Nueva Tarea</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label>Nombre de la Tarea</label>
                                                <input type="text" class="form-control" id="nueva-tarea-nombre" 
                                                       placeholder="Ej: Limpieza de equipos">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label>Prioridad</label>
                                                <select class="form-control" id="nueva-tarea-prioridad">
                                                    <option value="alta">Alta</option>
                                                    <option value="media">Media</option>
                                                    <option value="baja">Baja</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label>Hora de Inicio</label>
                                                <input type="time" class="form-control" id="nueva-tarea-hora" 
                                                       value="08:00">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label>Duraci√≥n (minutos)</label>
                                                <input type="number" class="form-control" id="nueva-tarea-duracion" 
                                                       placeholder="60" min="1">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label>Descripci√≥n</label>
                                        <textarea class="form-control" id="nueva-tarea-descripcion" rows="3" 
                                                  placeholder="Describe qu√© debe hacer el operario..."></textarea>
                                    </div>
                                    <div class="form-group">
                                        <label>Tipo de Tarea</label>
                                        <select class="form-control" id="nueva-tarea-tipo">
                                            <option value="diaria">Diaria</option>
                                            <option value="semanal">Semanal</option>
                                        </select>
                                    </div>
                                    <div class="text-right">
                                        <button class="btn btn-secondary" onclick="ocultarFormularioNuevaTarea()">
                                            <i class="fas fa-times"></i> Cancelar
                                        </button>
                                        <button class="btn btn-success" onclick="crearNuevaTarea()">
                                            <i class="fas fa-save"></i> Crear Tarea
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Cargar operarios
            cargarOperariosGestion();
        }
        
        // Funci√≥n para cargar operarios en el select
        async function cargarOperariosGestion() {
            try {
                const response = await fetch('/api/usuarios');
                const data = await response.json();
                
                if (data.success) {
                    const select = document.getElementById('operario-gestion');
                    select.innerHTML = '<option value="">Todos los operarios</option>';
                    
                    data.usuarios.forEach(usuario => {
                        if (usuario.rol === 'operario' && usuario.activo) {
                            const option = document.createElement('option');
                            option.value = usuario.username;
                            option.textContent = usuario.nombre;
                            select.appendChild(option);
                        }
                    });
                }
            } catch (error) {
                console.error('Error cargando operarios:', error);
            }
        }
        
        // Funci√≥n para analizar cumplimiento de tareas
        async function analizarCumplimientoTareas() {
            const fechaDesde = document.getElementById('fecha-desde-gestion').value;
            const fechaHasta = document.getElementById('fecha-hasta-gestion').value;
            const operario = document.getElementById('operario-gestion').value;
            
            if (!fechaDesde || !fechaHasta) {
                alert('Por favor selecciona las fechas');
                return;
            }
            
            // Mostrar loading
            document.getElementById('loading-gestion').style.display = 'block';
            document.getElementById('estadisticas-cumplimiento').style.display = 'none';
            document.getElementById('tabla-cumplimiento').style.display = 'none';
            document.getElementById('grafico-cumplimiento').style.display = 'none';
            
            try {
                const response = await fetch('/api/analisis-cumplimiento', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        fecha_desde: fechaDesde,
                        fecha_hasta: fechaHasta,
                        operario: operario
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    mostrarAnalisisCumplimiento(data);
                } else {
                    alert('Error: ' + data.message);
                }
            } catch (error) {
                console.error('Error analizando cumplimiento:', error);
                alert('Error analizando cumplimiento: ' + error.message);
            } finally {
                document.getElementById('loading-gestion').style.display = 'none';
            }
        }
        
        // Funci√≥n para mostrar an√°lisis de cumplimiento
        function mostrarAnalisisCumplimiento(data) {
            // Mostrar estad√≠sticas
            document.getElementById('total-tareas').textContent = data.estadisticas.total_tareas;
            document.getElementById('tareas-completadas').textContent = data.estadisticas.completadas;
            document.getElementById('tareas-pendientes').textContent = data.estadisticas.pendientes;
            document.getElementById('porcentaje-cumplimiento').textContent = data.estadisticas.porcentaje_cumplimiento + '%';
            
            document.getElementById('estadisticas-cumplimiento').style.display = 'block';
            
            // Mostrar tabla
            const tbody = document.getElementById('tbody-cumplimiento');
            tbody.innerHTML = '';
            
            data.detalle.forEach(item => {
                const row = document.createElement('tr');
                row.style.backgroundColor = '#fff';
                row.style.color = '#333';
                
                const estadoClass = item.completada ? 'success' : 'danger';
                const estadoText = item.completada ? 'Completada' : 'Pendiente';
                const horaCompletada = item.hora_completada || '--';
                
                row.innerHTML = `
                    <td>${item.operario}</td>
                    <td>${item.fecha}</td>
                    <td>${item.tarea}</td>
                    <td>${item.hora_programada}</td>
                    <td>${horaCompletada}</td>
                    <td><span class="badge bg-${estadoClass}">${estadoText}</span></td>
                    <td>${item.observaciones || '--'}</td>
                `;
                
                tbody.appendChild(row);
            });
            
            document.getElementById('tabla-cumplimiento').style.display = 'block';
            
            // Mostrar gr√°fico
            mostrarGraficoCumplimiento(data.estadisticas);
        }
        
        // Funci√≥n para mostrar gr√°fico de cumplimiento
        function mostrarGraficoCumplimiento(estadisticas) {
            const ctx = document.getElementById('chart-cumplimiento').getContext('2d');
            
            // Destruir gr√°fico anterior si existe
            if (window.chartCumplimiento) {
                window.chartCumplimiento.destroy();
            }
            
            window.chartCumplimiento = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Completadas', 'Pendientes'],
                    datasets: [{
                        data: [estadisticas.completadas, estadisticas.pendientes],
                        backgroundColor: ['#28a745', '#dc3545'],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#333',
                                font: {
                                    size: 14
                                }
                            }
                        }
                    }
                }
            });
            
            document.getElementById('grafico-cumplimiento').style.display = 'block';
        }
        
        // Funci√≥n para mostrar formulario de nueva tarea
        function mostrarFormularioNuevaTarea() {
            document.getElementById('formulario-nueva-tarea').style.display = 'block';
        }
        
        // Funci√≥n para ocultar formulario de nueva tarea
        function ocultarFormularioNuevaTarea() {
            document.getElementById('formulario-nueva-tarea').style.display = 'none';
            // Limpiar formulario
            document.getElementById('nueva-tarea-nombre').value = '';
            document.getElementById('nueva-tarea-descripcion').value = '';
            document.getElementById('nueva-tarea-hora').value = '08:00';
            document.getElementById('nueva-tarea-duracion').value = '';
            document.getElementById('nueva-tarea-prioridad').value = 'alta';
            document.getElementById('nueva-tarea-tipo').value = 'diaria';
        }
        
        // Funci√≥n para crear nueva tarea
        async function crearNuevaTarea() {
            const nombre = document.getElementById('nueva-tarea-nombre').value.trim();
            const descripcion = document.getElementById('nueva-tarea-descripcion').value.trim();
            const hora = document.getElementById('nueva-tarea-hora').value;
            const duracion = parseInt(document.getElementById('nueva-tarea-duracion').value);
            const prioridad = document.getElementById('nueva-tarea-prioridad').value;
            const tipo = document.getElementById('nueva-tarea-tipo').value;
            const operario = document.getElementById('nueva-tarea-operario').value;
            
            if (!nombre || !descripcion || !hora || !duracion) {
                alert('Por favor completa todos los campos obligatorios');
                return;
            }
            
            try {
                const tareaData = {
                    nombre: nombre,
                    descripcion: descripcion,
                    hora_inicio: hora,
                    duracion_minutos: duracion,
                    prioridad: prioridad,
                    tipo: tipo,
                    operario: operario,
                    activa: true
                };
                
                const response = await fetch('/api/crear-tarea', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(tareaData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('‚úÖ Tarea creada exitosamente');
                    ocultarFormularioNuevaTarea();
                    cargarTareasDelDia(); // Recargar la lista
                } else {
                    alert('‚ùå Error: ' + result.message);
                }
            } catch (error) {
                console.error('Error creando tarea:', error);
                alert('‚ùå Error creando tarea: ' + error.message);
            }
        }
        
        // Funci√≥n para mostrar filtros de b√∫squeda de registros
        function mostrarFiltrosRegistros() {
            console.log('üîç Mostrando filtros de b√∫squeda de registros...');
            
            // Cambiar a vista anal√≠tica
            document.getElementById('operational-view').style.display = 'none';
            document.getElementById('analytics-view').style.display = 'block';
            
            const analyticsView = document.getElementById('analytics-view');
            if (!analyticsView) {
                console.error('‚ùå analytics-view no encontrado');
                return;
            }
            
            // Obtener valores actuales del formulario
            const materialActual = document.getElementById('rm-material')?.value || '';
            const empresaActual = document.getElementById('rm-empresa')?.value || '';
            const remitoActual = document.getElementById('rm-remito')?.value || '';
            
            console.log('üìã Valores actuales:', { materialActual, empresaActual, remitoActual });
            
            analyticsView.innerHTML = `
                <div class="function-card">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-search"></i>
                            B√∫squeda de Registros de Materiales
                        </div>
                    </div>
                    <div class="card-content">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i> 
                            Los filtros se han pre-llenado con los datos del formulario actual
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label>Filtrar por Material</label>
                                    <select class="form-control" id="filtro-material">
                                        <option value="">Todos los materiales</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label>Filtrar por Empresa</label>
                                    <input type="text" class="form-control" id="filtro-empresa" placeholder="Nombre de empresa" value="${empresaActual}">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label>Filtrar por N√∫mero de Remito</label>
                                    <input type="text" class="form-control" id="filtro-remito" placeholder="N√∫mero de remito" value="${remitoActual}">
                                </div>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Fecha Desde</label>
                                    <input type="date" class="form-control" id="filtro-fecha-desde">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Fecha Hasta</label>
                                    <input type="date" class="form-control" id="filtro-fecha-hasta">
                                </div>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-12">
                                <button class="btn btn-primary" onclick="buscarRegistros()">
                                    <i class="fas fa-search"></i> Buscar
                                </button>
                                <button class="btn btn-secondary" onclick="exportarRegistros()">
                                    <i class="fas fa-download"></i> Exportar
                                </button>
                                <button class="btn btn-info" onclick="cargarRegistroMateriales()">
                                    <i class="fas fa-arrow-left"></i> Volver al Registro
                                </button>
                            </div>
                        </div>
                        <div id="resultados-busqueda" style="display: none;">
                            <h6>Resultados de la B√∫squeda:</h6>
                            <div id="tabla-resultados"></div>
                        </div>
                    </div>
                </div>
            `;
            
            // Cargar opciones de materiales y preseleccionar el material actual
            cargarOpcionesMateriales().then(() => {
                if (materialActual) {
                    const select = document.getElementById('filtro-material');
                    if (select) {
                        select.value = materialActual;
                    }
                }
            });
        }
        
        // Funci√≥n para cargar opciones de materiales en el filtro
        async function cargarOpcionesMateriales() {
            try {
                const response = await fetch('/obtener_materiales');
                const data = await response.json();
                
                const select = document.getElementById('filtro-material');
                if (select && data.materiales) {
                    data.materiales.forEach(material => {
                        const option = document.createElement('option');
                        option.value = material;
                        option.textContent = material;
                        select.appendChild(option);
                    });
                }
                return data;
            } catch (error) {
                console.error('Error cargando materiales:', error);
                return null;
            }
        }
        
        // Funci√≥n para buscar registros
        async function buscarRegistros() {
            try {
                console.log('üîç Iniciando b√∫squeda de registros...');
                
                const filtros = {
                    material: document.getElementById('filtro-material').value,
                    empresa: document.getElementById('filtro-empresa').value,
                    remito: document.getElementById('filtro-remito').value,
                    fecha_desde: document.getElementById('filtro-fecha-desde').value,
                    fecha_hasta: document.getElementById('filtro-fecha-hasta').value
                };
                
                console.log('üìã Filtros aplicados:', filtros);
                
                const response = await fetch('/buscar_registros', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(filtros)
                });
                
                console.log('üì° Respuesta del servidor:', response.status);
                
                const data = await response.json();
                console.log('üìä Datos recibidos:', data);
                
                if (data.status === 'success') {
                    mostrarResultadosBusqueda(data.registros);
                } else {
                    alert('Error en la b√∫squeda: ' + data.mensaje);
                }
            } catch (error) {
                console.error('Error buscando registros:', error);
                alert('Error en la b√∫squeda: ' + error.message);
            }
        }
        
        // Funci√≥n para mostrar resultados de b√∫squeda
        function mostrarResultadosBusqueda(registros) {
            const resultadosDiv = document.getElementById('resultados-busqueda');
            const tablaDiv = document.getElementById('tabla-resultados');
            
            resultadosDiv.style.display = 'block';
            
            if (registros.length === 0) {
                tablaDiv.innerHTML = '<p class="text-muted">No se encontraron registros con los filtros aplicados.</p>';
                return;
            }
            
            let tablaHTML = `
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>Fecha</th>
                                <th>Hora</th>
                                <th>Material</th>
                                <th>TN</th>
                                <th>% ST</th>
                                <th>Empresa</th>
                                <th>Chofer</th>
                                <th>Remito</th>
                                <th>Patente</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            registros.forEach(registro => {
                const fecha = new Date(registro.timestamp).toLocaleDateString('es-ES');
                const hora = new Date(registro.timestamp).toLocaleTimeString('es-ES');
                
                tablaHTML += `
                    <tr>
                        <td>${fecha}</td>
                        <td>${hora}</td>
                        <td>${registro.material}</td>
                        <td>${registro.tn_descargadas}</td>
                        <td>${registro.st_analizado}%</td>
                        <td>${registro.empresa}</td>
                        <td>${registro.operario}</td>
                        <td>${registro.numero_remito || 'N/A'}</td>
                        <td>${registro.patente}</td>
                    </tr>
                `;
            });
            
            tablaHTML += `
                        </tbody>
                    </table>
                </div>
                <p class="text-muted">Total de registros encontrados: ${registros.length}</p>
            `;
            
            tablaDiv.innerHTML = tablaHTML;
        }
        
        // Funci√≥n para exportar registros
        async function exportarRegistros() {
            try {
                const filtros = {
                    material: document.getElementById('filtro-material').value,
                    empresa: document.getElementById('filtro-empresa').value,
                    remito: document.getElementById('filtro-remito').value,
                    fecha_desde: document.getElementById('filtro-fecha-desde').value,
                    fecha_hasta: document.getElementById('filtro-fecha-hasta').value
                };
                
                const response = await fetch('/exportar_registros', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(filtros)
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `registros_materiales_${new Date().toISOString().split('T')[0]}.xlsx`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                } else {
                    alert('Error exportando registros');
                }
            } catch (error) {
                console.error('Error exportando registros:', error);
                alert('Error exportando registros: ' + error.message);
            }
        }
        
        // Funci√≥n para registrar par√°metros qu√≠micos
        async function registrarParametrosQuimicos() {
            try {
                const fos = parseFloat(document.getElementById('rp-fos').value);
                const tac = parseFloat(document.getElementById('rp-tac').value);
                const ph = parseFloat(document.getElementById('rp-ph').value);
                const biodigestor = document.getElementById('rp-biodigestor').value;
                const observaciones = document.getElementById('rp-observaciones').value;
                
                if (!fos || !tac || !ph || !biodigestor) {
                    alert('Por favor completa todos los campos obligatorios');
                    return;
                }
                
                const response = await fetch('/registrar_parametros_quimicos', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        fos: fos,
                        tac: tac,
                        ph: ph,
                        biodigestor: biodigestor,
                        observaciones: observaciones
                    })
                });
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    alert('‚úÖ Par√°metros qu√≠micos registrados correctamente');
                    
                    // Mostrar an√°lisis de hambre bacteriana
                    mostrarAnalisisFOSTAC(fos, tac, ph, biodigestor);
                    
                    // Limpiar formulario
                    document.getElementById('rp-fos').value = '';
                    document.getElementById('rp-tac').value = '';
                    document.getElementById('rp-ph').value = '';
                    document.getElementById('rp-biodigestor').value = '';
                    document.getElementById('rp-observaciones').value = '';
                } else {
                    alert('‚ùå Error: ' + data.mensaje);
                }
            } catch (error) {
                console.error('Error registrando par√°metros qu√≠micos:', error);
                alert('‚ùå Error registrando par√°metros qu√≠micos: ' + error.message);
            }
        }
        
        // Funci√≥n para mostrar an√°lisis de hambre bacteriana
        function mostrarAnalisisFOSTAC(fos, tac, ph, biodigestor) {
            const analisisDiv = document.getElementById('analisis-fos-tac');
            const resultadoDiv = document.getElementById('resultado-analisis-fos-tac');
            
            // Calcular ratio FOS/TAC
            const ratioFOSTAC = fos / tac;
            
            // An√°lisis de hambre bacteriana
            let estadoHambre = '';
            let colorEstado = '';
            let recomendaciones = [];
            
            if (ratioFOSTAC < 0.3) {
                estadoHambre = 'SOBRECARGA - Exceso de materia org√°nica';
                colorEstado = 'danger';
                recomendaciones = [
                    'Reducir la carga de alimentaci√≥n',
                    'Aumentar el tiempo de retenci√≥n',
                    'Verificar la mezcla de materiales'
                ];
            } else if (ratioFOSTAC > 0.7) {
                estadoHambre = 'FALTA DE CARGA - Hambre bacteriana';
                colorEstado = 'warning';
                recomendaciones = [
                    'Aumentar la carga de alimentaci√≥n',
                    'Verificar la calidad del material',
                    'Revisar la temperatura del proceso'
                ];
            } else {
                estadoHambre = '√ìPTIMO - Balance adecuado';
                colorEstado = 'success';
                recomendaciones = [
                    'Mantener las condiciones actuales',
                    'Continuar monitoreo regular'
                ];
            }
            
            // An√°lisis de pH
            let estadoPH = '';
            let colorPH = '';
            
            if (ph < 6.5) {
                estadoPH = 'pH BAJO - Riesgo de acidificaci√≥n';
                colorPH = 'danger';
            } else if (ph > 8.5) {
                estadoPH = 'pH ALTO - Condiciones alcalinas';
                colorPH = 'warning';
            } else {
                estadoPH = 'pH √ìPTIMO';
                colorPH = 'success';
            }
            
            resultadoDiv.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>An√°lisis FOS/TAC</h6>
                        <p><strong>FOS:</strong> ${fos} mg/L</p>
                        <p><strong>TAC:</strong> ${tac} mg/L</p>
                        <p><strong>Ratio FOS/TAC:</strong> ${ratioFOSTAC.toFixed(2)}</p>
                        <span class="badge bg-${colorEstado}">${estadoHambre}</span>
                    </div>
                    <div class="col-md-6">
                        <h6>An√°lisis de pH</h6>
                        <p><strong>pH:</strong> ${ph}</p>
                        <span class="badge bg-${colorPH}">${estadoPH}</span>
                    </div>
                </div>
                <hr>
                <div class="row">
                    <div class="col-md-12">
                        <h6>Recomendaciones:</h6>
                        <ul>
                            ${recomendaciones.map(rec => `<li>${rec}</li>`).join('')}
                        </ul>
                    </div>
                </div>
            `;
            
            analisisDiv.style.display = 'block';
        }
        
        // Funci√≥n para mostrar historial de par√°metros qu√≠micos
        function mostrarHistorialParametros() {
            const analyticsView = document.getElementById('analytics-view');
            if (!analyticsView) return;
            
            analyticsView.innerHTML = `
                <div class="function-card">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-history"></i>
                            Historial de Par√°metros Qu√≠micos
                        </div>
                    </div>
                    <div class="card-content">
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label>Filtrar por Biodigestor</label>
                                    <select class="form-control" id="filtro-bio-parametros">
                                        <option value="">Todos los biodigestores</option>
                                        <option value="bio1">Biodigestor 1</option>
                                        <option value="bio2">Biodigestor 2</option>
                                        <option value="bio3">Biodigestor 3</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label>Fecha Desde</label>
                                    <input type="date" class="form-control" id="filtro-fecha-desde-parametros">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label>Fecha Hasta</label>
                                    <input type="date" class="form-control" id="filtro-fecha-hasta-parametros">
                                </div>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-12">
                                <button class="btn btn-primary" onclick="buscarParametrosQuimicos()">
                                    <i class="fas fa-search"></i> Buscar
                                </button>
                                <button class="btn btn-secondary" onclick="exportarParametrosQuimicos()">
                                    <i class="fas fa-download"></i> Exportar
                                </button>
                                <button class="btn btn-info" onclick="cargarRegistroMateriales()">
                                    <i class="fas fa-arrow-left"></i> Volver al Registro
                                </button>
                            </div>
                        </div>
                        <div id="resultados-parametros" style="display: none;">
                            <h6>Resultados del An√°lisis:</h6>
                            <div id="tabla-parametros"></div>
                        </div>
                    </div>
                </div>
            `;
            
            // Cargar datos autom√°ticamente
            buscarParametrosQuimicos();
        }
        
        // Funci√≥n para buscar par√°metros qu√≠micos
        async function buscarParametrosQuimicos() {
            try {
                const filtros = {
                    biodigestor: document.getElementById('filtro-bio-parametros').value,
                    fecha_desde: document.getElementById('filtro-fecha-desde-parametros').value,
                    fecha_hasta: document.getElementById('filtro-fecha-hasta-parametros').value
                };
                
                const response = await fetch('/buscar_parametros_quimicos', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(filtros)
                });
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    mostrarResultadosParametros(data.parametros);
                } else {
                    alert('Error en la b√∫squeda: ' + data.mensaje);
                }
            } catch (error) {
                console.error('Error buscando par√°metros:', error);
                alert('Error en la b√∫squeda: ' + error.message);
            }
        }
        
        // Funci√≥n para mostrar resultados de par√°metros qu√≠micos
        function mostrarResultadosParametros(parametros) {
            const resultadosDiv = document.getElementById('resultados-parametros');
            const tablaDiv = document.getElementById('tabla-parametros');
            
            resultadosDiv.style.display = 'block';
            
            if (parametros.length === 0) {
                tablaDiv.innerHTML = '<p class="text-muted">No se encontraron registros con los filtros aplicados.</p>';
                return;
            }
            
            let tablaHTML = `
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>Fecha</th>
                                <th>Hora</th>
                                <th>Biodigestor</th>
                                <th>FOS (mg/L)</th>
                                <th>TAC (mg/L)</th>
                                <th>Ratio FOS/TAC</th>
                                <th>pH</th>
                                <th>Estado</th>
                                <th>Observaciones</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            parametros.forEach(parametro => {
                const fecha = new Date(parametro.timestamp).toLocaleDateString('es-ES');
                const hora = new Date(parametro.timestamp).toLocaleTimeString('es-ES');
                const ratio = parametro.fos / parametro.tac;
                
                let estado = '';
                let colorEstado = '';
                
                if (ratio < 0.3) {
                    estado = 'SOBRECARGA';
                    colorEstado = 'danger';
                } else if (ratio > 0.7) {
                    estado = 'FALTA CARGA';
                    colorEstado = 'warning';
                } else {
                    estado = '√ìPTIMO';
                    colorEstado = 'success';
                }
                
                tablaHTML += `
                    <tr>
                        <td>${fecha}</td>
                        <td>${hora}</td>
                        <td>${parametro.biodigestor.toUpperCase()}</td>
                        <td>${parametro.fos}</td>
                        <td>${parametro.tac}</td>
                        <td>${ratio.toFixed(2)}</td>
                        <td>${parametro.ph}</td>
                        <td><span class="badge bg-${colorEstado}">${estado}</span></td>
                        <td>${parametro.observaciones || 'N/A'}</td>
                    </tr>
                `;
            });
            
            tablaHTML += `
                        </tbody>
                    </table>
                </div>
                <p class="text-muted">Total de registros encontrados: ${parametros.length}</p>
            `;
            
            tablaDiv.innerHTML = tablaHTML;
        }
        
        // Funci√≥n para exportar par√°metros qu√≠micos
        async function exportarParametrosQuimicos() {
            try {
                const filtros = {
                    biodigestor: document.getElementById('filtro-bio-parametros').value,
                    fecha_desde: document.getElementById('filtro-fecha-desde-parametros').value,
                    fecha_hasta: document.getElementById('filtro-fecha-hasta-parametros').value
                };
                
                const response = await fetch('/exportar_parametros_quimicos', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(filtros)
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `parametros_quimicos_${new Date().toISOString().split('T')[0]}.xlsx`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                } else {
                    alert('Error exportando par√°metros qu√≠micos');
                }
            } catch (error) {
                console.error('Error exportando par√°metros qu√≠micos:', error);
                alert('Error exportando par√°metros qu√≠micos: ' + error.message);
            }
        }
        
        // Funci√≥n para entrenar modelos ML
        async function entrenarModelosML() {
            console.log('ü§ñ Entrenando modelos ML...');
            
            try {
                const response = await fetch('/entrenar_ml_predicciones', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const data = await response.json();
                
                if (data.estado === 'exitoso') {
                    alert('‚úÖ Modelos ML entrenados correctamente');
                    // Recargar predicci√≥n despu√©s del entrenamiento
                    await generarPrediccionIA();
                } else {
                    throw new Error(data.mensaje || 'Error entrenando modelos');
                }
            } catch (error) {
                console.error('Error entrenando modelos ML:', error);
                alert('‚ùå Error entrenando modelos ML: ' + error.message);
            }
        }

        // Funci√≥n para convertir base64 a blob para reproducir audio
        function base64ToBlob(base64, mimeType) {
            const byteCharacters = atob(base64);
            const byteNumbers = new Array(byteCharacters.length);
            for (let i = 0; i < byteCharacters.length; i++) {
                byteNumbers[i] = byteCharacters.charCodeAt(i);
            }
            const byteArray = new Uint8Array(byteNumbers);
            return new Blob([byteArray], {type: mimeType});
        }

        // Funciones de las tarjetas (tus funciones existentes)
        async function enviarPregunta() {
            const input = document.getElementById('ai-input');
            const pregunta = input.value.trim();
            if (!pregunta) {
                mostrarAlerta('warning', 'Por favor, escribe una pregunta.');
                return;
            }
            
            const messagesContainer = document.getElementById('ai-messages');
            
            // Mostrar mensaje del usuario
            messagesContainer.innerHTML += `
                <div class="ai-message ai-user">
                    <p>${pregunta}</p>
                </div>
                <div class="ai-message ai-assistant" id="typing-indicator">
                    <p><i class="fas fa-spinner fa-spin"></i> Procesando tu consulta...</p>
                </div>
            `;
            
            input.value = '';
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            try {
                const response = await fetch('/ask_assistant', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        pregunta: pregunta,
                        sintetizar: false
                    })
                });
                
                const data = await response.json();
                
                // Remover indicador de escritura
                document.getElementById('typing-indicator').remove();
                
                if (data.respuesta) {
                    const respuesta = data.respuesta;
                    const motor = data.motor || 'UNKNOWN';
                    const latencia = data.latencia_ms || 0;
                    const confianza = data.confianza || 0;
                    const eficiencia = data.eficiencia || 0;
                    const aprendizaje = data.aprendizaje_iteracion || 0;
                    const modelos_ml = data.modelos_ml || motor;
                    
                    // Crear etiqueta del motor usado con informaci√≥n detallada
                    const tipoLabel = motor === 'SALUDO_INSTANTANEO' ? '‚ö° Saludo Instant√°neo' :
                                     motor === 'CAIN_SIBIA' ? 'üß† CAIN Ultrarr√°pido' :
                                     motor === 'SIBIA_INSTANTANEO' ? '‚ö° SIBIA Instant√°neo' :
                                     motor === 'ML_CALCULO_ENERGIA' ? 'üéØ ML C√°lculo Energ√≠a' :
                                     motor === 'CONOCIMIENTO_EXPERTO' ? 'üìö Conocimiento Experto' :
                                     motor === 'LLAMA_FALLBACK' ? 'ü¶ô Llama Fallback' :
                                     motor === 'HIBRIDO_ULTRARRAPIDO_SALUDO_INSTANTANEO' ? '‚ö° Saludo Instant√°neo' :
                                     motor === 'HIBRIDO_ULTRARRAPIDO_CAIN_SIBIA' ? 'üß† CAIN Ultrarr√°pido' :
                                     motor === 'HIBRIDO_ULTRARRAPIDO_SIBIA_INSTANTANEO' ? '‚ö° SIBIA Instant√°neo' :
                                     motor === 'HIBRIDO_ULTRARRAPIDO_ML_CALCULO_ENERGIA' ? 'üéØ ML C√°lculo Energ√≠a' :
                                     motor === 'HIBRIDO_ULTRARRAPIDO_CONOCIMIENTO_EXPERTO' ? 'üìö Conocimiento Experto' :
                                     motor === 'HIBRIDO_ULTRARRAPIDO_ERROR' ? '‚ùå Error en Procesamiento' :
                                     motor === 'FALLBACK_SALUDO' ? 'üîÑ Fallback Saludo' :
                                     motor === 'FALLBACK_AYUDA' ? 'üîÑ Fallback Ayuda' :
                                     motor === 'FALLBACK_EXPERTO_SIBIA_EXPERTO' ? 'üéØ Asistente Experto' :
                                     motor === 'STOCK' ? 'üì¶ Consulta Stock' :
                                     motor === 'MEZCLA_CACHE' ? 'üîÑ Mezcla Cache' :
                                     motor === 'MEZCLA_CALCULADA' ? 'üßÆ Mezcla Calculada' :
                                     motor;
                    
                    // Crear ID √∫nico para este mensaje
                    const mensajeId = 'msg_' + Date.now();
                    
                    // Crear informaci√≥n detallada del modelo
                    let infoModelo = `
                        <div class="model-info" style="background: linear-gradient(135deg, rgba(79, 70, 229, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%); padding: 15px; border-radius: 12px; margin-top: 15px; font-size: 13px; border: 1px solid rgba(79, 70, 229, 0.2);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <strong style="color: #4f46e5; font-size: 14px;">ü§ñ Modelo IA Utilizado</strong>
                                <span style="background: rgba(79, 70, 229, 0.2); padding: 4px 8px; border-radius: 6px; font-size: 11px;">${tipoLabel}</span>
                            </div>
                            <div style="margin-bottom: 10px; padding: 8px; background: rgba(16, 185, 129, 0.1); border-radius: 6px; border-left: 3px solid #10b981;">
                                <strong style="color: #10b981;">üß† Modelos ML Espec√≠ficos:</strong><br>
                                <span style="color: #059669; font-weight: bold; font-size: 12px;">${modelos_ml}</span>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <div>
                                    <strong>‚ö° Velocidad:</strong><br>
                                    <span style="color: ${latencia < 100 ? '#10b981' : latencia < 500 ? '#f59e0b' : '#ef4444'}; font-weight: bold;">${latencia}ms</span>
                                </div>
                                <div>
                                    <strong>üéØ Confianza:</strong><br>
                                    <span style="color: ${confianza > 0.9 ? '#10b981' : confianza > 0.7 ? '#f59e0b' : '#ef4444'}; font-weight: bold;">${(confianza * 100).toFixed(1)}%</span>
                                </div>
                                <div>
                                    <strong>üìà Eficiencia:</strong><br>
                                    <span style="color: ${eficiencia > 0.9 ? '#10b981' : eficiencia > 0.7 ? '#f59e0b' : '#ef4444'}; font-weight: bold;">${(eficiencia * 100).toFixed(1)}%</span>
                                </div>
                                <div>
                                    <strong>üß† Aprendizaje:</strong><br>
                                    <span style="color: #8b5cf6; font-weight: bold;">${(aprendizaje * 100).toFixed(2)}%</span>
                                </div>
                            </div>
                            <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(79, 70, 229, 0.2); text-align: center;">
                                <small style="color: #6b7280;">üïí ${new Date().toLocaleTimeString()}</small>
                            </div>
                        </div>
                    `;
                    
                    messagesContainer.innerHTML += `
                        <div class="ai-message ai-assistant" id="${mensajeId}">
                            <p>${respuesta}</p>
                            ${infoModelo}
                        </div>
                    `;
                    
                    // Mostrar botones de aprendizaje para respuestas que podr√≠an necesitar mejora
                    if (motor === 'LLAMA_FALLBACK' || motor === 'CONOCIMIENTO_EXPERTO' || 
                        motor.includes('FALLBACK') || motor.includes('HIBRIDO') || 
                        motor.includes('EXPERTO') || motor.includes('ML') ||
                        motor.includes('STOCK') || motor.includes('MEZCLA') ||
                        motor.includes('CALCULO') || motor.includes('ERROR')) {
                        mostrarBotonesAprendizaje(pregunta, respuesta, mensajeId);
                    }
                    
                    // Scroll hacia abajo para ver la respuesta
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    
                } else {
                    messagesContainer.innerHTML += `
                        <div class="ai-message ai-assistant">
                            <p>‚ùå Error: ${data.mensaje || 'No se pudo procesar la consulta'}</p>
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('Error enviando pregunta:', error);
                document.getElementById('typing-indicator').remove();
                messagesContainer.innerHTML += `
                    <div class="ai-message ai-assistant">
                        <p>‚ùå Error de conexi√≥n. Por favor, intenta nuevamente.</p>
                    </div>
                `;
            }
            
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Funci√≥n para sincronizar porcentajes de s√≥lidos y l√≠quidos
        function sincronizarPorcentajes() {
            const porcentajeSolidos = document.getElementById('porcentaje-solidos');
            const porcentajeLiquidos = document.getElementById('porcentaje-liquidos');
            
            porcentajeSolidos.addEventListener('input', function() {
                const valorSolidos = parseInt(this.value) || 0;
                const valorLiquidos = Math.max(0, 100 - valorSolidos);
                porcentajeLiquidos.value = valorLiquidos;
            });
            
            porcentajeLiquidos.addEventListener('input', function() {
                const valorLiquidos = parseInt(this.value) || 0;
                const valorSolidos = Math.max(0, 100 - valorLiquidos);
                porcentajeSolidos.value = valorSolidos;
            });
        }
        
        // Funci√≥n para cambiar las etiquetas seg√∫n el modo de c√°lculo
        function configurarModoCalculo() {
            const modoEnergetico = document.getElementById('modo-energetico');
            const modoVolumetrico = document.getElementById('modo-volumetrico');
            const labelSolidos = document.getElementById('label-solidos');
            const labelLiquidos = document.getElementById('label-liquidos');
            
            function actualizarEtiquetas() {
                if (modoEnergetico.checked) {
                    labelSolidos.textContent = '% S√≥lidos (KW)';
                    labelLiquidos.textContent = '% L√≠quidos (KW)';
                } else {
                    labelSolidos.textContent = '% S√≥lidos (TN)';
                    labelLiquidos.textContent = '% L√≠quidos (TN)';
                }
            }
            
            modoEnergetico.addEventListener('change', actualizarEtiquetas);
            modoVolumetrico.addEventListener('change', actualizarEtiquetas);
            
            // Configurar inicialmente
            actualizarEtiquetas();
        }
        
        // Funci√≥n para validar stock disponible

        // Funci√≥n para inicializar la calculadora
        function inicializarCalculadora() {
            console.log('üßÆ Inicializando calculadora...');
            
            // Verificar que el elemento resultado-calc existe
            let resultado = document.getElementById('resultado-calc');
            if (!resultado) {
                console.warn('‚ö†Ô∏è Creando elemento resultado-calc...');
                resultado = document.createElement('div');
                resultado.id = 'resultado-calc';
                resultado.style.marginTop = '15px';
                resultado.style.display = 'none';
                
                // Buscar el bot√≥n de calcular y insertar despu√©s
                const botonCalcular = document.querySelector('button[onclick="calcularMezcla()"]');
                if (botonCalcular && botonCalcular.parentNode) {
                    botonCalcular.parentNode.insertBefore(resultado, botonCalcular.nextSibling);
                    console.log('‚úÖ Elemento resultado-calc creado');
                }
            } else {
                console.log('‚úÖ Elemento resultado-calc ya existe');
            }
        }

        async function calcularMezcla() {
            console.log('üßÆ Iniciando c√°lculo de mezcla...');
            
            try {
                // Verificar que todos los elementos existan
                const kwObjetivoEl = document.getElementById('kw-objetivo');
                const numBiosEl = document.getElementById('num-biodigestores');
                const metanoEl = document.getElementById('metano-objetivo');
                const porcentajeSolidosEl = document.getElementById('porcentaje-solidos');
                const porcentajeLiquidosEl = document.getElementById('porcentaje-liquidos');
                const modoEnergeticoEl = document.getElementById('modo-energetico');
                
                if (!kwObjetivoEl || !numBiosEl || !metanoEl || !porcentajeSolidosEl || !porcentajeLiquidosEl || !modoEnergeticoEl) {
                    console.error('‚ùå Elementos no encontrados:', {
                        kwObjetivo: !!kwObjetivoEl,
                        numBios: !!numBiosEl,
                        metano: !!metanoEl,
                        porcentajeSolidos: !!porcentajeSolidosEl,
                        porcentajeLiquidos: !!porcentajeLiquidosEl,
                        modoEnergetico: !!modoEnergeticoEl
                    });
                    alert('Error: No se encontraron todos los elementos del formulario');
                    return;
                }
                
                const kwObjetivo = kwObjetivoEl.value;
                const numBios = numBiosEl.value;
                const metano = metanoEl.value;
                const porcentajeSolidos = parseFloat(porcentajeSolidosEl.value) || 0;
                const porcentajeLiquidos = parseFloat(porcentajeLiquidosEl.value) || 0;
                const modoEnergetico = modoEnergeticoEl.checked;
            
                const modoCalculo = modoEnergetico ? 'energetico' : 'volumetrico';
                console.log('üìä Par√°metros del c√°lculo:', { kwObjetivo, numBios, metano, porcentajeSolidos, porcentajeLiquidos, modo: modoCalculo });
                console.log('üîÑ Modo seleccionado:', modoCalculo, '| Checkbox energ√©tico:', modoEnergetico);
                
                // Actualizar indicador del modo en el header
                actualizarIndicadorModo(modoCalculo);
                
                let resultado = document.getElementById('resultado-calc');
                if (!resultado) {
                    console.warn('‚ö†Ô∏è No se encontr√≥ el elemento resultado-calc, cre√°ndolo...');
                    // Crear el elemento si no existe
                    resultado = document.createElement('div');
                    resultado.id = 'resultado-calc';
                    resultado.style.marginTop = '15px';
                    resultado.style.display = 'none';
                    
                    // Buscar el bot√≥n de calcular y insertar despu√©s
                    const botonCalcular = document.querySelector('button[onclick="calcularMezcla()"]');
                    if (botonCalcular && botonCalcular.parentNode) {
                        botonCalcular.parentNode.insertBefore(resultado, botonCalcular.nextSibling);
                        console.log('‚úÖ Elemento resultado-calc creado y agregado al DOM');
                    } else {
                        console.error('‚ùå No se pudo encontrar el bot√≥n de calcular para insertar el elemento');
                        alert('Error: No se pudo crear el elemento de resultado. Recarga la p√°gina e intenta nuevamente.');
                        return;
                    }
                }
                
                resultado.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Calculando...</div>';
                resultado.style.display = 'block';
                
                console.log('üîÑ Enviando petici√≥n al servidor...');
                
                const response = await fetch('/calcular_mezcla_automatica', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        kw_objetivo: parseFloat(kwObjetivo),
                        num_biodigestores: parseInt(numBios),
                        objetivo_metano: parseFloat(metano),
                        porcentaje_solidos: porcentajeSolidos,
                        porcentaje_liquidos: porcentajeLiquidos,
                        modo_calculo: modoEnergetico ? 'energetico' : 'volumetrico'
                    })
                });
                
                console.log('üì° Respuesta del servidor recibida:', response.status, response.statusText);
                
                if (!response.ok) {
                    throw new Error(`Error del servidor: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('üìà Respuesta del servidor:', data);
                
                if (data.status === 'success') {
                    // Verificar diferentes estructuras posibles de materiales
                    const materiales = data.resultado.materiales || data.resultado || {};
                    console.log('üì¶ Materiales calculados:', materiales);
                    console.log('üì¶ Estructura completa resultado:', data.resultado);
                    let materialesHtml = '';
                    
                    // Buscar materiales s√≥lidos en diferentes ubicaciones
                    const materialesSolidos = materiales.materiales_solidos || data.resultado.materiales_solidos || {};
                    const materialesLiquidos = materiales.materiales_liquidos || data.resultado.materiales_liquidos || {};
                    const materialesPurin = materiales.materiales_purin || data.resultado.materiales_purin || {};
                    console.log('üü§ Materiales s√≥lidos encontrados:', materialesSolidos);
                    console.log('üîµ Materiales l√≠quidos encontrados:', materialesLiquidos);
                    console.log('üê∑ Materiales Pur√≠n encontrados:', materialesPurin);
                    
                    if (materialesSolidos && Object.keys(materialesSolidos).length > 0) {
                        materialesHtml += '<h6>üì¶ Materiales S√≥lidos:</h6><ul>';
                        Object.entries(materialesSolidos).forEach(([material, datos]) => {
                            const cantidad = typeof datos === 'number' ? datos : (datos.cantidad_tn || datos.cantidad || datos.total_tn || datos.total || 0);
                            if (cantidad > 0) {
                                const cantidadReal = cantidad / 1000;
                                let stPorcentaje = 0;
                                if (datos.st_porcentaje) {
                                    stPorcentaje = datos.st_porcentaje;
                                } else if (datos.st_usado !== undefined) {
                                    stPorcentaje = datos.st_usado * 100;
                                } else if (datos.total_solido && datos.total_tn) {
                                    stPorcentaje = (datos.total_solido / datos.total_tn) * 100;
                                }
                                // Obtener KW aportados
                                const kwAportados = datos.kw_aportados || datos.kw_aportado || 0;
                                materialesHtml += `<li>‚Ä¢ ${material}: ${cantidadReal.toFixed(2)} TN <small>ST ${stPorcentaje.toFixed(2)}%</small> <strong>(${kwAportados.toFixed(1)} KW)</strong></li>`;
                            }
                        });
                        materialesHtml += '</ul>';
                    }
                    
                    // Usar materiales l√≠quidos ya declarados
                    console.log('üîµ Materiales l√≠quidos encontrados:', materialesLiquidos);
                    
                    if (materialesLiquidos && Object.keys(materialesLiquidos).length > 0) {
                        materialesHtml += '<h6>üîµ Materiales L√≠quidos:</h6><ul>';
                        Object.entries(materialesLiquidos).forEach(([material, datos]) => {
                            const cantidad = typeof datos === 'number' ? datos : (datos.cantidad_tn || datos.cantidad || datos.total_tn || datos.total || 0);
                            if (cantidad > 0) {
                                const cantidadReal = cantidad / 1000;
                                let stPorcentaje = 0;
                                if (datos.st_porcentaje) {
                                    stPorcentaje = datos.st_porcentaje;
                                } else if (datos.st_usado !== undefined) {
                                    stPorcentaje = datos.st_usado * 100;
                                } else if (datos.total_solido && datos.total_tn) {
                                    stPorcentaje = (datos.total_solido / datos.total_tn) * 100;
                                }
                                // Obtener KW aportados
                                const kwAportados = datos.kw_aportados || datos.kw_aportado || 0;
                                materialesHtml += `<li>‚Ä¢ ${material}: ${cantidadReal.toFixed(2)} TN <small>ST ${stPorcentaje.toFixed(2)}%</small> <strong>(${kwAportados.toFixed(1)} KW)</strong></li>`;
                            }
                        });
                        materialesHtml += '</ul>';
                    }
                    
                    // Usar materiales Pur√≠n ya declarados
                    console.log('üü´ Materiales pur√≠n encontrados:', materialesPurin);
                    
                    if (materialesPurin && Object.keys(materialesPurin).length > 0) {
                        materialesHtml += '<h6>üí© Materiales Pur√≠n:</h6><ul>';
                        Object.entries(materialesPurin).forEach(([material, datos]) => {
                            const cantidad = typeof datos === 'number' ? datos : (datos.cantidad_tn || datos.cantidad || datos.total_tn || datos.total || 0);
                            if (cantidad > 0) {
                                const cantidadReal = cantidad / 1000;
                                let stPorcentaje = 0;
                                if (datos.st_porcentaje) {
                                    stPorcentaje = datos.st_porcentaje;
                                } else if (datos.st_usado !== undefined) {
                                    stPorcentaje = datos.st_usado * 100;
                                } else if (datos.total_solido && datos.total_tn) {
                                    stPorcentaje = (datos.total_solido / datos.total_tn) * 100;
                                }
                                // Obtener KW aportados
                                const kwAportados = datos.kw_aportados || datos.kw_aportado || 0;
                                materialesHtml += `<li>‚Ä¢ ${material}: ${cantidadReal.toFixed(2)} TN <small>ST ${stPorcentaje.toFixed(2)}%</small> <strong>(${kwAportados.toFixed(1)} KW)</strong></li>`;
                            }
                        });
                        materialesHtml += '</ul>';
                    }
                    
            // Obtener totales de diferentes ubicaciones posibles
                    const totales = data.resultado.totales || data.resultado;
                    const kwTotal = totales.kw_total_generado || totales.kw_generado || data.resultado.kw_total_generado || 0;
                    const metanoTotal = totales.porcentaje_metano || data.resultado.porcentaje_metano || 0;
                    const solidosTotal = totales.tn_solidos || data.resultado.tn_solidos || 0;
                    let liquidosTotal = totales.tn_liquidos || data.resultado.tn_liquidos || 0;
                    
                    // Incluir pur√≠n en el total de l√≠quidos
                    const purinTotal = totales.tn_purin || data.resultado.tn_purin || 0;
                    liquidosTotal += purinTotal;
                    
                    console.log('üìä Totales:', { kwTotal, metanoTotal, solidosTotal, liquidosTotal });
                    
                    // Obtener los porcentajes utilizados
                    const porcentajeSolidosUsado = document.getElementById('porcentaje-solidos').value;
                    const porcentajeLiquidosUsado = document.getElementById('porcentaje-liquidos').value;
                    const porcentajePurinUsado = document.getElementById('porcentaje-purin').value;
                    const modoEnergetico = document.getElementById('modo-energetico').checked;
                    const modoCalculo = modoEnergetico ? 'energetico' : 'volumetrico';
                    
                    // Calcular distribuci√≥n de KW
                    const kwObjetivoTotal = parseFloat(kwObjetivo);
                    const kwObjetivoSolidos = kwObjetivoTotal * (parseFloat(porcentajeSolidosUsado) / 100);
                    const kwObjetivoLiquidos = kwObjetivoTotal * (parseFloat(porcentajeLiquidosUsado) / 100);
                    const kwObjetivoPurin = kwObjetivoTotal * (parseFloat(porcentajePurinUsado) / 100);
                    
                    // Obtener KW reales generados por categor√≠a
                    const kwSolidosGenerados = totales.kw_solidos || 0;
                    const kwLiquidosGenerados = totales.kw_liquidos || 0;
                    const kwPurinGenerados = totales.kw_purin || 0;
                    
                    resultado.innerHTML = `
                        <div style="background: rgba(40, 167, 69, 0.2); border: 1px solid rgba(40, 167, 69, 0.4); border-radius: 6px; padding: 15px; font-size: 13px;">
                            <h6>‚úÖ Mezcla Calculada</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <p><strong>KW Objetivo Total:</strong> ${kwObjetivoTotal.toFixed(0)} KW</p>
                                    <p><strong>KW Generado Total:</strong> ${kwTotal.toFixed(2)} KW</p>
                            <p><strong>% Metano:</strong> ${metanoTotal.toFixed(2)}%</p>
                                </div>
                                <div class="col-md-6">
                                    <p><strong>% S√≥lidos Solicitado:</strong> ${porcentajeSolidosUsado}%</p>
                                    <p><strong>% L√≠quidos Solicitado:</strong> ${porcentajeLiquidosUsado}%</p>
                                    <p><strong>Biodigestores:</strong> ${numBios}</p>
                                </div>
                            </div>
                            <hr style="margin: 10px 0; border-color: rgba(40, 167, 69, 0.3);">
                            <h6><i class="fas fa-chart-pie"></i> Distribuci√≥n de KW por Categor√≠a:</h6>
                            <div class="row">
                                <div class="col-md-4">
                                    <div style="background: rgba(255, 193, 7, 0.1); padding: 8px; border-radius: 4px; margin: 2px;">
                                        <p><strong>S√≥lidos:</strong></p>
                                        <p>Objetivo: ${kwObjetivoSolidos.toFixed(0)} KW</p>
                                        <p>Generado: ${kwSolidosGenerados.toFixed(0)} KW</p>
                                        <p>Cantidad: ${(solidosTotal / 1000).toFixed(2)} TN</p>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div style="background: rgba(0, 123, 255, 0.1); padding: 8px; border-radius: 4px; margin: 2px;">
                                        <p><strong>L√≠quidos:</strong></p>
                                        <p>Objetivo: ${kwObjetivoLiquidos.toFixed(0)} KW</p>
                                        <p>Generado: ${kwLiquidosGenerados.toFixed(0)} KW</p>
                                        <p>Cantidad: ${(liquidosTotal / 1000).toFixed(2)} TN</p>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div style="background: rgba(108, 117, 125, 0.1); padding: 8px; border-radius: 4px; margin: 2px;">
                                        <p><strong>Pur√≠n:</strong></p>
                                        <p>Generado: ${kwPurinGenerados.toFixed(0)} KW</p>
                                        <p>Cantidad: ${(totales.tn_purin / 1000 * 100).toFixed(2)} TN</p>
                                    </div>
                                </div>
                            </div>
                            <div class="alert alert-info mt-3" style="font-size: 12px;">
                                <strong><i class="fas fa-info-circle"></i> Explicaci√≥n:</strong><br>
                                ${modoCalculo === 'energetico' ? 
                                    `Modo <strong>Energ√©tico</strong>: Los porcentajes (${porcentajeSolidosUsado}%/${porcentajeLiquidosUsado}%) se refieren a la distribuci√≥n de KW objetivo, no a las cantidades en TN. Los materiales l√≠quidos tienen menor densidad energ√©tica, por eso necesitas m√°s TN para generar los mismos KW.` :
                                    `Modo <strong>Volum√©trico</strong>: Los porcentajes (${porcentajeSolidosUsado}%/${porcentajeLiquidosUsado}%) se aplican directamente a las cantidades f√≠sicas en TN. Esto puede resultar en menos KW generados que el objetivo, pero respeta exactamente las proporciones volum√©tricas solicitadas.`
                                }
                            </div>
                            
                            <!-- Secci√≥n de Modelos ML -->
                            <div class="alert alert-success mt-3" style="font-size: 11px; background: rgba(40, 167, 69, 0.15); border: 1px solid rgba(40, 167, 69, 0.3);">
                                <strong><i class="fas fa-brain"></i> Modelos de Machine Learning Activos:</strong><br>
                                <div class="row mt-2">
                                    <div class="col-md-6">
                                        <div style="background: rgba(255,255,255,0.1); padding: 8px; border-radius: 4px; margin-bottom: 5px;">
                                            <strong>üß† Red Neuronal (MLPRegressor):</strong><br>
                                            <small>Capas: (100,50,25) | ReLU | Adam | Predicci√≥n de generaci√≥n</small>
                                        </div>
                                        <div style="background: rgba(255,255,255,0.1); padding: 8px; border-radius: 4px; margin-bottom: 5px;">
                                            <strong>üå≤ Random Forest:</strong><br>
                                            <small>100 √°rboles | Profundidad: 15 | Eficiencia y clasificaci√≥n</small>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div style="background: rgba(255,255,255,0.1); padding: 8px; border-radius: 4px; margin-bottom: 5px;">
                                            <strong>üîç SVM (Support Vector Machine):</strong><br>
                                            <small>Kernel RBF | Detecci√≥n de anomal√≠as</small>
                                        </div>
                                        <div style="background: rgba(255,255,255,0.1); padding: 8px; border-radius: 4px; margin-bottom: 5px;">
                                            <strong>üîÑ Optimizaci√≥n ML:</strong><br>
                                            <small>Algoritmo iterativo | An√°lisis eficiencia KW/TN | M√°x 5 iteraciones</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Secci√≥n de Sistema Evolutivo Gen√©tico -->
                            <div class="alert alert-info mt-3" style="font-size: 11px; background: rgba(23, 162, 184, 0.15); border: 1px solid rgba(23, 162, 184, 0.3);">
                                <strong><i class="fas fa-dna"></i> Sistema Evolutivo Gen√©tico:</strong><br>
                                <div class="row mt-2">
                                    <div class="col-md-6">
                                        <div style="background: rgba(255,255,255,0.1); padding: 8px; border-radius: 4px; margin-bottom: 5px;">
                                            <strong>üß¨ Algoritmo Gen√©tico:</strong><br>
                                            <small>Poblaci√≥n: 20 individuos | Mutaci√≥n: 30% | Cruce: 70%</small>
                                        </div>
                                        <div style="background: rgba(255,255,255,0.1); padding: 8px; border-radius: 4px; margin-bottom: 5px;">
                                            <strong>üìà Aprendizaje Continuo:</strong><br>
                                            <small>Mejora con cada c√°lculo | Fitness adaptativo | Evoluci√≥n autom√°tica</small>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div style="background: rgba(255,255,255,0.1); padding: 8px; border-radius: 4px; margin-bottom: 5px;">
                                            <strong>üéØ Optimizaci√≥n Inteligente:</strong><br>
                                            <small>Par√°metros evolutivos | Selecci√≥n natural | Convergencia adaptativa</small>
                                        </div>
                                        <div style="background: rgba(255,255,255,0.1); padding: 8px; border-radius: 4px; margin-bottom: 5px;">
                                            <strong>üíæ Memoria Evolutiva:</strong><br>
                                            <small>Conocimiento persistente | Mejora acumulativa | Adaptaci√≥n inteligente</small>
                                        </div>
                                    </div>
                                </div>
                                {% if stats_evolutivas %}
                                <div class="mt-2" style="background: rgba(255,255,255,0.1); padding: 8px; border-radius: 4px;">
                                    <strong>üìä Estado Actual:</strong><br>
                                    <small>
                                        Fitness: {{ "%.3f"|format(stats_evolutivas.get('mejor_fitness', 0)) }} | 
                                        C√°lculos: {{ stats_evolutivas.get('total_calculos', 0) }} | 
                                        Tendencia: {{ stats_evolutivas.get('tendencia', 'N/A') }}
                                    </small>
                                </div>
                                {% endif %}
                                
                                <!-- Informe de Funcionalidades Confirmadas -->
                                <div class="mt-3" style="background: rgba(40, 167, 69, 0.1); border: 1px solid rgba(40, 167, 69, 0.3); border-radius: 8px; padding: 12px;">
                                    <strong><i class="fas fa-check-circle text-success"></i> Funcionalidades Confirmadas del Sistema Evolutivo:</strong>
                                    <div class="row mt-2">
                                        <div class="col-md-6">
                                            <div style="background: rgba(255,255,255,0.1); padding: 6px; border-radius: 4px; margin-bottom: 4px; font-size: 10px;">
                                                <strong>üß¨ Algoritmo Gen√©tico:</strong><br>
                                                <small>Poblaci√≥n: 20 individuos | Mutaci√≥n: 30% | Cruce: 70%</small>
                                            </div>
                                            <div style="background: rgba(255,255,255,0.1); padding: 6px; border-radius: 4px; margin-bottom: 4px; font-size: 10px;">
                                                <strong>üìà Aprendizaje Adaptativo:</strong><br>
                                                <small>Fitness: KW (70%) + Eficiencia (20%) + Metano (10%)</small>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div style="background: rgba(255,255,255,0.1); padding: 6px; border-radius: 4px; margin-bottom: 4px; font-size: 10px;">
                                                <strong>üéØ Optimizaci√≥n ML:</strong><br>
                                                <small>Iteraciones: M√°x 8 | Tolerancia: 25 KW | Estrategia inteligente</small>
                                            </div>
                                            <div style="background: rgba(255,255,255,0.1); padding: 6px; border-radius: 4px; margin-bottom: 4px; font-size: 10px;">
                                                <strong>üíæ Memoria Persistente:</strong><br>
                                                <small>Conocimiento guardado | Mejora acumulativa | Adaptaci√≥n inteligente</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mt-2" style="background: rgba(255,255,255,0.1); padding: 6px; border-radius: 4px; font-size: 10px;">
                                        <strong>‚úÖ Capacidades Demostradas:</strong><br>
                                        <small>
                                            ‚Ä¢ Alcanza 100% objetivo KW en todos los casos<br>
                                            ‚Ä¢ Optimizaci√≥n ML iterativa (2 iteraciones promedio)<br>
                                            ‚Ä¢ Sistema evolutivo se adapta a cada objetivo<br>
                                            ‚Ä¢ Memoria persistente entre sesiones<br>
                                            ‚Ä¢ Fitness adaptativo multi-criterio
                                        </small>
                                    </div>
                                </div>
                            </div>
                            ${materialesHtml}
                            <div class="mt-3">
                                <button class="btn btn-warning btn-sm" onclick="verSeguimientoCompleto()">
                                    <i class="fas fa-clock"></i> Ver Seguimiento Completo
                                </button>
                            </div>
                </div>
            `;
                } else if (data.status === 'warning') {
                    // Mostrar advertencia con porcentajes utilizados
                    const porcentajeSolidosUsado = document.getElementById('porcentaje-solidos').value;
                    const porcentajeLiquidosUsado = document.getElementById('porcentaje-liquidos').value;
                    
                    resultado.innerHTML = `
                        <div style="background: rgba(255, 193, 7, 0.2); border: 1px solid rgba(255, 193, 7, 0.4); border-radius: 6px; padding: 15px; font-size: 13px;">
                            <h6>‚ö†Ô∏è Advertencia</h6>
                            <p><strong>Mensaje:</strong> ${data.mensaje}</p>
                            <p><strong>Detalle:</strong> ${data.detalle}</p>
                            <hr style="margin: 10px 0; border-color: rgba(255, 193, 7, 0.3);">
                            <div class="row">
                                <div class="col-md-6">
                                    <p><strong>% S√≥lidos Solicitado:</strong> ${porcentajeSolidosUsado}%</p>
                                </div>
                                <div class="col-md-6">
                                    <p><strong>% L√≠quidos Solicitado:</strong> ${porcentajeLiquidosUsado}%</p>
                                </div>
                            </div>
                </div>
            `;
                } else {
                    throw new Error(data.mensaje || 'Error en el c√°lculo');
                }
            } catch (error) {
                console.error('Error calculando mezcla:', error);
                const porcentajeSolidosUsado = document.getElementById('porcentaje-solidos').value;
                const porcentajeLiquidosUsado = document.getElementById('porcentaje-liquidos').value;
                
                document.getElementById('resultado-calc').innerHTML = `
                    <div style="background: rgba(220, 53, 69, 0.2); border: 1px solid rgba(220, 53, 69, 0.4); border-radius: 6px; padding: 10px; font-size: 13px;">
                        <h6>‚ùå Error en el C√°lculo</h6>
                        <p><strong>Error:</strong> ${error.message}</p>
                        <hr style="margin: 10px 0; border-color: rgba(220, 53, 69, 0.3);">
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>% S√≥lidos Solicitado:</strong> ${porcentajeSolidosUsado}%</p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>% L√≠quidos Solicitado:</strong> ${porcentajeLiquidosUsado}%</p>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        async function registrarMaterial() {
            try {
                const patente = document.getElementById('rm-patente').value;
                const material = document.getElementById('rm-material').value;
                const tn = document.getElementById('rm-tn').value;
                const st = document.getElementById('rm-st').value;
                const empresa = document.getElementById('rm-empresa').value;
                const chofer = document.getElementById('rm-chofer').value;
                const remito = document.getElementById('rm-remito').value;
                
                if (!patente || !material || !tn || !st || !empresa || !chofer || !remito) {
                    alert('Por favor completa todos los campos incluyendo el n√∫mero de remito');
                    return;
                }
                
                const response = await fetch('/registrar_material', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        patente: patente,
                        material: material,
                        tn_descargadas: parseFloat(tn),
                        st_analizado: parseFloat(st),
                        empresa: empresa,
                        operario: chofer,
                        numero_remito: remito
                    })
                });
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    alert('‚úÖ Material registrado correctamente');
                    
                    // Limpiar formulario
                    document.getElementById('rm-patente').value = '';
                    document.getElementById('rm-tn').value = '';
                    document.getElementById('rm-st').value = '';
                    document.getElementById('rm-empresa').value = '';
                    document.getElementById('rm-chofer').value = '';
                    
                    // üîÑ ACTUALIZAR STOCK Y TABLA DE GESTI√ìN AUTOM√ÅTICAMENTE
                    console.log('üîÑ Actualizando stock y tabla de gesti√≥n despu√©s del registro...');
                    setTimeout(async () => {
                        // Actualizar stock (usando la funci√≥n correcta)
                        cargarStockActual();
                        
                        // Actualizar solo los datos de la tabla de gesti√≥n (sin recrear)
                        await actualizarDatosGestionMateriales();
                        
                        console.log('‚úÖ Actualizaci√≥n autom√°tica completada');
                    }, 1000);
                    
                } else {
                    throw new Error(data.mensaje || 'Error al registrar material');
                }
            } catch (error) {
                console.error('Error registrando material:', error);
                alert('‚ùå Error: ' + error.message);
            }
        }

        async function verSeguimientoCompleto() {
            try {
                const response = await fetch('/seguimiento_horario');
                const data = await response.json();
                
                if (!data.biodigestores) {
                    alert('No hay datos de seguimiento horario disponibles');
                    return;
                }
                
                const biodigestorId = Object.keys(data.biodigestores)[0];
                const biodigestor = data.biodigestores[biodigestorId];
                const plan24h = biodigestor.plan_24_horas;
                
                // Crear modal para mostrar el seguimiento horario
                const modalHtml = `
                    <div class="modal fade" id="seguimientoModal" tabindex="-1" role="dialog" style="z-index: 10000;">
                        <div class="modal-dialog modal-xl" role="document">
                            <div class="modal-content" style="background-color: #2c3e50; color: white; border: 1px solid #34495e;">
                                <div class="modal-header" style="border-bottom: 1px solid #34495e;">
                                    <h5 class="modal-title">
                                        <i class="fas fa-clock"></i> Seguimiento Horario - Dosificaci√≥n (${data.fecha})
                                    </h5>
                                    <button type="button" class="btn-close btn-close-white" onclick="cerrarModal('seguimientoModal')" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer;">
                                        &times;
                                    </button>
                                </div>
                                <div class="modal-body">
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <div class="card" style="background-color: #34495e; border: 1px solid #4a5f7a;">
                                                <div class="card-body" style="background-color: #34495e; color: white;">
                                                    <h6 class="card-title" style="color: white;">Progreso S√≥lidos</h6>
                                                    <div class="progress">
                                                        <div class="progress-bar" style="width: ${biodigestor.progreso_diario.porcentaje_solidos}%">
                                                            ${biodigestor.progreso_diario.porcentaje_solidos.toFixed(1)}%
                                                        </div>
                                                    </div>
                                                    <small style="color: #bdc3c7;">${biodigestor.progreso_diario.real_solidos_tn.toFixed(2)} / ${biodigestor.progreso_diario.objetivo_solidos_tn.toFixed(2)} TN</small>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="card" style="background-color: #34495e; border: 1px solid #4a5f7a;">
                                                <div class="card-body" style="background-color: #34495e; color: white;">
                                                    <h6 class="card-title" style="color: white;">Progreso L√≠quidos</h6>
                                                    <div class="progress">
                                                        <div class="progress-bar bg-info" style="width: ${biodigestor.progreso_diario.porcentaje_liquidos}%">
                                                            ${biodigestor.progreso_diario.porcentaje_liquidos.toFixed(1)}%
                                                        </div>
                                                    </div>
                                                    <small style="color: #bdc3c7;">${biodigestor.progreso_diario.real_liquidos_tn.toFixed(2)} / ${biodigestor.progreso_diario.objetivo_liquidos_tn.toFixed(2)} TN</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="table-responsive">
                                        <table class="table table-sm table-dark">
                                            <thead>
                                                <tr>
                                                    <th>Hora</th>
                                                    <th>S√≥lidos Obj.</th>
                                                    <th>S√≥lidos Real</th>
                                                    <th>L√≠quidos Obj.</th>
                                                    <th>L√≠quidos Real</th>
                                                    <th>Acci√≥n</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${Object.entries(plan24h).map(([hora, datos]) => `
                                                    <tr>
                                                        <td>${hora.padStart(2, '0')}:00</td>
                                                        <td>${(datos.objetivo_ajustado?.total_solidos || 0).toFixed(3)} TN</td>
                                                        <td>${(datos.real?.total_solidos || 0).toFixed(3)} TN</td>
                                                        <td>${(datos.objetivo_ajustado?.total_liquidos || 0).toFixed(3)} TN</td>
                                                        <td>${(datos.real?.total_liquidos || 0).toFixed(3)} TN</td>
                                                        <td>
                                                            <button class="btn btn-success btn-sm" onclick="registrarDosificacion('${biodigestorId}', '${hora}')">
                                                                <i class="fas fa-edit"></i> Registrar
                                                            </button>
                                                        </td>
                                                    </tr>
                                                `).join('')}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                
                // Mostrar modal usando Bootstrap nativo
                const modal = new bootstrap.Modal(document.getElementById('seguimientoModal'));
                modal.show();
                
            } catch (error) {
                console.error('Error cargando seguimiento horario:', error);
                alert('‚ùå Error cargando seguimiento horario: ' + error.message);
            }
        }

        function exportData() {
            alert('Exportando datos hist√≥ricos...');
        }
        
        function cerrarModal(modalId) {
            try {
                const modalElement = document.getElementById(modalId);
                if (modalElement) {
                    // Intentar cerrar con Bootstrap primero
                    try {
                        const modal = bootstrap.Modal.getInstance(modalElement);
                        if (modal) {
                            modal.hide();
                            // Remover el modal del DOM despu√©s de que se oculte
                            modalElement.addEventListener('hidden.bs.modal', function() {
                                modalElement.remove();
                            }, { once: true });
                        } else {
                            // Si no hay instancia de Bootstrap, remover directamente
                            modalElement.remove();
                        }
                    } catch (bootstrapError) {
                        console.log('Bootstrap modal no disponible, removiendo directamente');
                        modalElement.remove();
                    }
                    
                    // Limpiar backdrop si existe
                    const backdrop = document.querySelector('.modal-backdrop');
                    if (backdrop) {
                        backdrop.remove();
                    }
                    
                    // Restaurar scroll del body
                    document.body.classList.remove('modal-open');
                    document.body.style.overflow = '';
                    document.body.style.paddingRight = '';
                }
            } catch (error) {
                console.error('Error cerrando modal:', error);
                // Fallback: forzar limpieza
                const modalElement = document.getElementById(modalId);
                if (modalElement) {
                    modalElement.remove();
                }
                // Limpiar todo lo relacionado con modales
                document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
                document.body.classList.remove('modal-open');
                document.body.style.overflow = '';
                document.body.style.paddingRight = '';
            }
        }
        
        function registrarDosificacion(biodigestor, hora) {
            console.log(`üìù Registrando dosificaci√≥n para biodigestor ${biodigestor}, hora ${hora}`);
            
            const modalHtml = `
                <div class="modal fade" id="registroModal" tabindex="-1" role="dialog">
                    <div class="modal-dialog" role="document">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">
                                    <i class="fas fa-edit"></i> Registrar Dosificaci√≥n - Hora ${hora.padStart(2, '0')}:00
                                </h5>
                                <button type="button" class="close" onclick="cerrarModal('registroModal')">
                                    <span>&times;</span>
                                </button>
                            </div>
                            <div class="modal-body">
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle"></i> 
                                    <strong>Registra la dosificaci√≥n real para la hora ${hora.padStart(2, '0')}:00</strong>
                                    <br><small>El sistema recalcular√° autom√°ticamente las horas restantes si hay diferencias.</small>
                                </div>
                                <form id="formRegistro">
                                    <div class="form-group">
                                        <label for="solidosReal">
                                            <i class="fas fa-cubes"></i> S√≥lidos Dosificados (TN):
                                        </label>
                                        <input type="number" class="form-control" id="solidosReal" step="0.001" min="0" 
                                               placeholder="Ej: 2.500" required>
                                        <small class="form-text text-muted">Cantidad real de materiales s√≥lidos dosificados</small>
                                    </div>
                                    <div class="form-group">
                                        <label for="liquidosReal">
                                            <i class="fas fa-tint"></i> L√≠quidos Dosificados (TN):
                                        </label>
                                        <input type="number" class="form-control" id="liquidosReal" step="0.001" min="0" 
                                               placeholder="Ej: 1.200" required>
                                        <small class="form-text text-muted">Cantidad real de materiales l√≠quidos dosificados</small>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" onclick="cerrarModal('registroModal')">Cancelar</button>
                                <button type="button" class="btn btn-primary" onclick="guardarDosificacion('${biodigestor}', '${hora}')">
                                    <i class="fas fa-save"></i> Guardar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            const modal = new bootstrap.Modal(document.getElementById('registroModal'));
            modal.show();
        }
        
        async function guardarDosificacion(biodigestor, hora) {
            try {
                const solidos = parseFloat(document.getElementById('solidosReal').value);
                const liquidos = parseFloat(document.getElementById('liquidosReal').value);
                
                if (isNaN(solidos) || isNaN(liquidos)) {
                    alert('Por favor ingresa valores v√°lidos');
                    return;
                }
                
                const response = await fetch('/actualizar_seguimiento_horario', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        biodigestor: biodigestor,
                        hora: hora,
                        solidos: solidos,
                        liquidos: liquidos
                    })
                });
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    alert('‚úÖ Dosificaci√≥n registrada correctamente');
                    cerrarModal('registroModal');
                    // Recargar el modal de seguimiento
                    cerrarModal('seguimientoModal');
                    setTimeout(() => verSeguimientoCompleto(), 500);
                } else {
                    throw new Error(data.mensaje || 'Error al registrar dosificaci√≥n');
                }
            } catch (error) {
                console.error('Error guardando dosificaci√≥n:', error);
                alert('‚ùå Error: ' + error.message);
            }
        }

        function exportTable() {
            alert('Exportando tabla a Excel...');
        }
        
        // Cargar generaci√≥n en tiempo real
        async function cargarGeneracionTiempoReal() {
            try {
                console.log('‚ö° Cargando generaci√≥n en tiempo real...');
                
                // Obtener datos de generaci√≥n actual
                const response = await fetch('/obtener_generacion_actual');
                console.log('üì° Respuesta del servidor:', response.status, response.statusText);
                
                const data = await response.json();
                console.log('üìä Datos de generaci√≥n recibidos:', data);
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                if (data.status !== 'success') {
                    throw new Error('Estado de respuesta no exitoso: ' + data.status);
                }
                
                // Crear o actualizar gr√°fico
                const ctx = document.getElementById('chartGeneracion');
                if (!ctx) {
                    console.error('‚ùå No se encontr√≥ el canvas chartGeneracion');
                    return;
                }
                
                // Destruir gr√°fico anterior si existe
                if (window.graficoGeneracion) {
                    window.graficoGeneracion.destroy();
                    window.graficoGeneracion = null;
                }
                
                // Limpiar el canvas
                const context = ctx.getContext('2d');
                context.clearRect(0, 0, ctx.width, ctx.height);
                
                // Crear nuevo gr√°fico
                window.graficoGeneracion = new Chart(context, {
                    type: 'line',
                    data: {
                        labels: data.fechas || [],
                        datasets: [
                            {
                                label: 'Generaci√≥n Actual (kW)',
                                data: data.generacion_actual || [],
                                borderColor: '#00d4ff',
                                backgroundColor: 'rgba(0, 212, 255, 0.1)',
                                tension: 0.4,
                                fill: true
                            },
                            {
                                label: 'Objetivo Diario (kW)',
                                data: data.objetivo_diario || [],
                                borderColor: '#ff6b6b',
                                backgroundColor: 'rgba(255, 107, 107, 0.1)',
                                tension: 0.4,
                                borderDash: [5, 5]
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Generaci√≥n de Energ√≠a en Tiempo Real',
                                color: '#ffffff',
                                font: {
                                    size: 16,
                                    weight: 'bold'
                                }
                            },
                            legend: {
                                labels: {
                                    color: '#ffffff'
                                }
                            }
                        },
                        scales: {
                            x: {
                                ticks: {
                                    color: '#ffffff'
                                },
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                }
                            },
                            y: {
                                ticks: {
                                    color: '#ffffff'
                                },
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                }
                            }
                        },
                        animation: {
                            duration: 1000,
                            easing: 'easeInOutQuart'
                        }
                    }
                });
                
                console.log('‚úÖ Gr√°fico de generaci√≥n en tiempo real creado');
                
            } catch (error) {
                console.error('‚ùå Error cargando generaci√≥n en tiempo real:', error);
                
                // Mostrar mensaje de error en el canvas
                const ctx = document.getElementById('chartGeneracion');
                if (ctx) {
                    const container = ctx.parentElement;
                    container.innerHTML = `
                        <div class="text-center text-danger">
                            <h4>Error cargando generaci√≥n en tiempo real</h4>
                            <p>${error.message}</p>
                            <button class="btn btn-outline-primary" onclick="cargarGeneracionTiempoReal()">
                                <i class="fas fa-redo"></i> Reintentar
                            </button>
                        </div>
                    `;
                }
            }
        }
        
        // Cargar an√°lisis hist√≥rico
        async function cargarAnalisisHistorico() {
            try {
                const periodo = document.getElementById('periodo-analisis').value;
                const tipo = document.getElementById('tipo-analisis').value;
                
                console.log('üìä Cargando an√°lisis hist√≥rico:', { periodo, tipo });
                
                const response = await fetch(`/obtener_datos_historicos/${periodo}`);
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                console.log('üìä Datos hist√≥ricos recibidos:', data);
                
                // Mostrar contenedor del gr√°fico
                const container = document.getElementById('grafico-historico-container');
                const resumen = document.getElementById('resumen-historico');
                container.style.display = 'block';
                resumen.style.display = 'block';
                
                // Crear gr√°fico seg√∫n el tipo
                const ctx = document.getElementById('grafico-historico').getContext('2d');
                
                // Destruir gr√°fico anterior si existe
                if (window.graficoHistorico) {
                    window.graficoHistorico.destroy();
                }
                
                let chartData, chartOptions;
                
                switch(tipo) {
                    case 'produccion':
                        chartData = {
                            labels: data.fechas,
                            datasets: [
                                {
                                    label: 'kW Objetivo',
                                    data: data.produccion_energetica.kw_objetivo,
                                    borderColor: '#ff6b6b',
                                    backgroundColor: 'rgba(255, 107, 107, 0.1)',
                                    tension: 0.4
                                },
                                {
                                    label: 'kW Planificado',
                                    data: data.produccion_energetica.kw_planificado,
                                    borderColor: '#4ecdc4',
                                    backgroundColor: 'rgba(78, 205, 196, 0.1)',
                                    tension: 0.4
                                },
                                {
                                    label: 'kW Generado Real',
                                    data: data.produccion_energetica.kw_generado_real,
                                    borderColor: '#45b7d1',
                                    backgroundColor: 'rgba(69, 183, 209, 0.1)',
                                    tension: 0.4
                                },
                                {
                                    label: 'kW Inyectado Real',
                                    data: data.produccion_energetica.kw_inyectado_real,
                                    borderColor: '#96ceb4',
                                    backgroundColor: 'rgba(150, 206, 180, 0.1)',
                                    tension: 0.4
                                }
                            ]
                        };
                        break;
                        
                    case 'calidad':
                        chartData = {
                            labels: data.fechas,
                            datasets: [
                                {
                                    label: '% Metano Planificado',
                                    data: data.calidad_biogas.metano_planificado,
                                    borderColor: '#ff9ff3',
                                    backgroundColor: 'rgba(255, 159, 243, 0.1)',
                                    tension: 0.4
                                },
                                {
                                    label: '% Metano Real',
                                    data: data.calidad_biogas.metano_actual_grafana,
                                    borderColor: '#f368e0',
                                    backgroundColor: 'rgba(243, 104, 224, 0.1)',
                                    tension: 0.4
                                },
                                {
                                    label: 'H2S (ppm)',
                                    data: data.calidad_biogas.h2s_actual_grafana,
                                    borderColor: '#ff6348',
                                    backgroundColor: 'rgba(255, 99, 72, 0.1)',
                                    tension: 0.4,
                                    yAxisID: 'y1'
                                }
                            ]
                        };
                        break;
                        
                    case 'eficiencia':
                        chartData = {
                            labels: data.fechas,
                            datasets: [
                                {
                                    label: 'Eficiencia Energ√©tica (%)',
                                    data: data.rendimiento.eficiencia_energetica,
                                    borderColor: '#2ecc71',
                                    backgroundColor: 'rgba(46, 204, 113, 0.1)',
                                    tension: 0.4
                                },
                                {
                                    label: 'Diferencia vs Planificado (kW)',
                                    data: data.rendimiento.diferencia_vs_planificado,
                                    borderColor: '#e74c3c',
                                    backgroundColor: 'rgba(231, 76, 60, 0.1)',
                                    tension: 0.4,
                                    yAxisID: 'y1'
                                }
                            ]
                        };
                        break;
                }
                
                chartOptions = {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: '#fff' }
                        },
                        title: {
                            display: true,
                            text: `An√°lisis Hist√≥rico - ${tipo.charAt(0).toUpperCase() + tipo.slice(1)} (${periodo} d√≠as)`,
                            color: '#fff'
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#fff' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        y: {
                            ticks: { color: '#fff' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            ticks: { color: '#fff' },
                            grid: { drawOnChartArea: false }
                        }
                    }
                };
                
                window.graficoHistorico = new Chart(ctx, {
                    type: 'line',
                    data: chartData,
                    options: chartOptions
                });
                
                // Mostrar resumen
                mostrarResumenHistorico(data, tipo);
                
            } catch (error) {
                console.error('‚ùå Error cargando an√°lisis hist√≥rico:', error);
                alert('Error cargando an√°lisis hist√≥rico: ' + error.message);
            }
        }
        
        function mostrarResumenHistorico(data, tipo) {
            const resumen = document.getElementById('resumen-historico');
            let html = '<div class="row">';
            
            if (tipo === 'produccion') {
                const ultimo = data.produccion_energetica.kw_generado_real.slice(-1)[0];
                const promedio = data.produccion_energetica.kw_generado_real.reduce((a, b) => a + b, 0) / data.produccion_energetica.kw_generado_real.length;
                const objetivo = data.produccion_energetica.kw_objetivo.slice(-1)[0];
                
                html += `
                    <div class="col-md-4">
                        <div class="card bg-success">
                            <div class="card-body text-center">
                                <h5>Generaci√≥n Actual</h5>
                                <h3>${ultimo.toFixed(0)} kW</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-info">
                            <div class="card-body text-center">
                                <h5>Promedio ${data.fechas.length} d√≠as</h5>
                                <h3>${promedio.toFixed(0)} kW</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-warning">
                            <div class="card-body text-center">
                                <h5>Objetivo</h5>
                                <h3>${objetivo.toFixed(0)} kW</h3>
                            </div>
                        </div>
                    </div>
                `;
            } else if (tipo === 'calidad') {
                const metanoActual = data.calidad_biogas.metano_actual_grafana.slice(-1)[0];
                const h2sActual = data.calidad_biogas.h2s_actual_grafana.slice(-1)[0];
                const metanoPromedio = data.calidad_biogas.metano_actual_grafana.reduce((a, b) => a + b, 0) / data.calidad_biogas.metano_actual_grafana.length;
                
                html += `
                    <div class="col-md-4">
                        <div class="card bg-primary">
                            <div class="card-body text-center">
                                <h5>Metano Actual</h5>
                                <h3>${metanoActual.toFixed(1)}%</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-info">
                            <div class="card-body text-center">
                                <h5>Metano Promedio</h5>
                                <h3>${metanoPromedio.toFixed(1)}%</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-warning">
                            <div class="card-body text-center">
                                <h5>H2S Actual</h5>
                                <h3>${h2sActual.toFixed(0)} ppm</h3>
                            </div>
                        </div>
                    </div>
                `;
            } else if (tipo === 'eficiencia') {
                const eficienciaActual = data.rendimiento.eficiencia_energetica.slice(-1)[0];
                const eficienciaPromedio = data.rendimiento.eficiencia_energetica.reduce((a, b) => a + b, 0) / data.rendimiento.eficiencia_energetica.length;
                const diferenciaActual = data.rendimiento.diferencia_vs_planificado.slice(-1)[0];
                
                html += `
                    <div class="col-md-4">
                        <div class="card bg-success">
                            <div class="card-body text-center">
                                <h5>Eficiencia Actual</h5>
                                <h3>${eficienciaActual.toFixed(1)}%</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-info">
                            <div class="card-body text-center">
                                <h5>Eficiencia Promedio</h5>
                                <h3>${eficienciaPromedio.toFixed(1)}%</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card ${diferenciaActual >= 0 ? 'bg-success' : 'bg-danger'}">
                            <div class="card-body text-center">
                                <h5>Diferencia vs Plan</h5>
                                <h3>${diferenciaActual >= 0 ? '+' : ''}${diferenciaActual.toFixed(0)} kW</h3>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            html += '</div>';
            resumen.innerHTML = html;
        }

        function generateReport() {
            alert('Generando reporte PDF...');
        }
        
        // Funci√≥n para ocultar/mostrar paneles
        // Estado de paneles colapsados
        let panelesColapsados = {
            'card-alertas': false
        };
        
        // Definir funci√≥n globalmente para que sea accesible desde onclick
        window.togglePanel = function(panelId) {
            console.log('üîÑ Ejecutando togglePanel para:', panelId);
            const panel = document.getElementById(panelId);
            const content = panel.querySelector('.card-content');
            const icon = panel.querySelector('.toggle-icon');
            
            console.log('üìã Elementos encontrados:', { panel: !!panel, content: !!content, icon: !!icon });
            
            if (!panel || !content || !icon) {
                console.error('‚ùå Panel no encontrado:', panelId);
                return;
            }
            
            if (content.style.display === 'none') {
                // Mostrar panel
                content.style.display = 'block';
                icon.style.transform = 'rotate(0deg)';
                panelesColapsados[panelId] = false;
                console.log('üìã Panel mostrado:', panelId);
            } else {
                // Ocultar panel
                content.style.display = 'none';
                icon.style.transform = 'rotate(-90deg)';
                panelesColapsados[panelId] = true;
                console.log('üìã Panel ocultado:', panelId);
            }
            
            // Si es el panel de alertas, marcar como visto
            if (panelId === 'card-alertas') {
                marcarAlertasVistas();
            }
        };
        
        // Funci√≥n para marcar alertas como vistas
        function marcarAlertasVistas() {
            // Aqu√≠ se puede implementar l√≥gica para marcar alertas como le√≠das
            console.log('‚úÖ Alertas marcadas como vistas');
        }
        
        // Funci√≥n para mostrar alertas cuando hay nuevas
        function mostrarAlertasSiHayNuevas() {
            if (!alertasHabilitadas) return; // No mostrar si alertas est√°n desactivadas
            
            const panelAlertas = document.getElementById('card-alertas');
            const content = panelAlertas?.querySelector('.card-content');
            const icon = panelAlertas?.querySelector('.toggle-icon');
            
            // Solo mostrar si est√° colapsado y hay nuevas alertas cr√≠ticas
            if (panelesColapsados['card-alertas'] && hayAlertasCriticas()) {
                content.style.display = 'block';
                icon.style.transform = 'rotate(0deg)';
                panelesColapsados['card-alertas'] = false;
                
                // Agregar efecto visual para llamar la atenci√≥n
                panelAlertas.style.animation = 'pulse 1s ease-in-out 3';
                setTimeout(() => {
                    panelAlertas.style.animation = '';
                }, 3000);
                
                console.log('üö® Panel de alertas mostrado autom√°ticamente por nueva alerta cr√≠tica');
            }
        }
        
        // Funci√≥n para verificar si hay alertas cr√≠ticas
        function hayAlertasCriticas() {
            // Verificar si hay alertas tipo danger o warning
            const alertasCriticas = document.querySelectorAll('#card-alertas .alert-danger, #card-alertas .alert-warning');
            return alertasCriticas.length > 0;
        }
        
        // Estado del panel flotante de alertas
        let alertasFlotantesOcultas = false;
        
        // Funci√≥n para alternar la visibilidad del panel flotante de alertas
        window.toggleFloatingAlerts = function() {
            console.log('üîî Alternando visibilidad del panel de alertas...');
            const alertsContainer = document.getElementById('alerts-floating');
            const alertsList = document.getElementById('alerts-floating-list');
            const toggleIcon = document.getElementById('floating-alerts-toggle');
            
            if (!alertsContainer) {
                console.error('‚ùå No se encontr√≥ el panel flotante');
                return;
            }
            
            // Si el panel est√° oculto, mostrarlo
            if (alertsContainer.style.display === 'none') {
                alertsContainer.style.display = 'block';
                alertsList.style.display = 'block';
                toggleIcon.style.transform = 'rotate(180deg)';
                alertasFlotantesOcultas = false;
                console.log('‚úÖ Panel de alertas mostrado');
            } else {
                // Si el panel est√° visible, marcar todas las alertas como vistas y ocultarlo
            marcarTodasAlertasVistas();
                ocultarAlertasFlotantes();
                console.log('‚úÖ Alertas reconocidas y panel ocultado');
            }
        };
        
        // Funci√≥n para mostrar alertas flotantes cuando hay alertas cr√≠ticas
        function mostrarAlertasFlotantes() {
            if (!alertasHabilitadas) return; // No mostrar si alertas est√°n desactivadas
            
            const alertsContainer = document.getElementById('alerts-floating');
            if (alertsContainer && alertasFlotantesOcultas) {
                alertsContainer.style.display = 'block';
                alertasFlotantesOcultas = false;
                console.log('üîî Alertas flotantes mostradas debido a alertas cr√≠ticas');
            }
        }
        
        // Funci√≥n para reiniciar el sistema de alertas flotantes
        function reiniciarAlertasFlotantes() {
            console.log('üîÑ Reiniciando sistema de alertas flotantes...');
            
            const alertsContainer = document.getElementById('alerts-floating');
            const alertsList = document.getElementById('alerts-floating-list');
            const toggleIcon = document.getElementById('floating-alerts-toggle');
            
            if (alertsContainer) {
                // Asegurar que el panel est√© visible
                alertsContainer.style.display = 'block';
                alertasFlotantesOcultas = false;
                
                // Asegurar que la lista est√© expandida por defecto
                if (alertsList) {
                    alertsList.style.display = 'block';
                }
                
                // Resetear el √≠cono de toggle
                if (toggleIcon) {
                    toggleIcon.style.transform = 'rotate(180deg)';
                }
                
                console.log('‚úÖ Sistema de alertas flotantes reiniciado');
            }
        }
        
        // Estado de alertas vistas (persistente en localStorage)
        let alertasVistas = JSON.parse(localStorage.getItem('alertasVistas') || '[]');
        
        // Funci√≥n para marcar una alerta individual como vista
        window.marcarAlertaVista = function(alertId) {
            console.log('‚úÖ Marcando alerta como vista:', alertId);
            
            // Agregar a la lista de alertas vistas
            if (!alertasVistas.includes(alertId)) {
                alertasVistas.push(alertId);
                localStorage.setItem('alertasVistas', JSON.stringify(alertasVistas));
            }
            
            // Remover la alerta del DOM
            const alertElement = document.querySelector(`[data-alert-id="${alertId}"]`);
            if (alertElement) {
                alertElement.style.animation = 'fadeOut 0.3s ease-out';
                setTimeout(() => {
                    alertElement.remove();
                    actualizarContadorAlertas();
                    verificarSiOcultarPanel();
                }, 300);
            }
        };
        
        // Funci√≥n para marcar todas las alertas como vistas
        function marcarTodasAlertasVistas() {
            console.log('‚úÖ Marcando todas las alertas como vistas');
            const todasLasAlertas = document.querySelectorAll('.alert-floating-item[data-alert-id]');
            
            todasLasAlertas.forEach(alerta => {
                const alertId = alerta.getAttribute('data-alert-id');
                if (!alertasVistas.includes(alertId)) {
                    alertasVistas.push(alertId);
                }
            });
            
            localStorage.setItem('alertasVistas', JSON.stringify(alertasVistas));
        }
        
        // Funci√≥n para marcar una alerta individual como vista
        function marcarAlertaVista(alertId) {
            console.log('‚úÖ Marcando alerta individual como vista:', alertId);
            if (!alertasVistas.includes(alertId)) {
                alertasVistas.push(alertId);
                localStorage.setItem('alertasVistas', JSON.stringify(alertasVistas));
                
                // Eliminar la alerta espec√≠fica del DOM
                const alerta = document.querySelector(`[data-alert-id="${alertId}"]`);
                if (alerta) {
                    alerta.remove();
                    console.log('üóëÔ∏è Alerta eliminada del DOM:', alertId);
                }
                
                // Actualizar contador
                actualizarContadorAlertas();
                
                // Verificar si todas las alertas est√°n reconocidas
                mostrarAlertasFlotantesSiEsCritico();
            }
        }
        
        // Funci√≥n para actualizar el contador de alertas
        function actualizarContadorAlertas() {
            const alertasVisibles = document.querySelectorAll('.alert-floating-item[data-alert-id]').length;
            const contador = document.getElementById('alerts-counter');
            
            if (contador) {
                contador.textContent = alertasVisibles;
            }
        }
        
        // Funci√≥n para verificar si se debe ocultar el panel completamente
        function verificarSiOcultarPanel() {
            const alertasVisibles = document.querySelectorAll('.alert-floating-item[data-alert-id]').length;
            
            if (alertasVisibles === 0) {
                console.log('üì≠ No hay m√°s alertas, ocultando panel');
                const alertsContainer = document.getElementById('alerts-floating');
                if (alertsContainer) {
                    alertsContainer.style.display = 'none';
                    alertasFlotantesOcultas = true;
                }
            }
        }
        
        // Funci√≥n para mostrar alertas flotantes si hay nuevas alertas cr√≠ticas
        function mostrarAlertasFlotantesSiEsCritico() {
            if (!alertasHabilitadas) return; // No mostrar si alertas est√°n desactivadas
            
            // Verificar TODAS las alertas en el panel principal de alertas
            const todasLasAlertas = document.querySelectorAll('#card-alertas .alert-danger, #card-alertas .alert-warning, #card-alertas .alert-success, #card-alertas .alert-info');
            const alertasFlotantes = document.querySelectorAll('.alert-floating-item[data-alert-id]');
            
            // Contar alertas no reconocidas (todas las que no sean vistas)
            let alertasNoReconocidas = 0;
            todasLasAlertas.forEach(alerta => {
                const alertId = alerta.getAttribute('data-alert-id') || alerta.id;
                if (!alertasVistas.includes(alertId)) {
                    alertasNoReconocidas++;
                }
            });
            
            // Si hay alertas no reconocidas y el panel est√° oculto, mostrarlo
            if (alertasNoReconocidas > 0 && alertasFlotantesOcultas) {
                console.log(`üîî ${alertasNoReconocidas} alertas no reconocidas, mostrando panel flotante`);
                mostrarAlertasFlotantes();
                    
                    // Efecto visual de atenci√≥n
                const alertsContainer = document.getElementById('alerts-floating');
                if (alertsContainer) {
                    alertsContainer.style.animation = 'pulse 1s ease-in-out 3';
                    setTimeout(() => {
                        alertsContainer.style.animation = '';
                    }, 3000);
                }
                
                // Actualizar contador
                const counter = document.getElementById('alerts-counter');
                if (counter) {
                    counter.textContent = alertasNoReconocidas;
                    counter.style.backgroundColor = '#dc3545';
                }
            } else if (alertasNoReconocidas === 0 && !alertasFlotantesOcultas) {
                // Si no hay alertas no reconocidas, ocultar el panel
                console.log('‚úÖ Todas las alertas han sido reconocidas, ocultando panel');
                ocultarAlertasFlotantes();
            }
        }
        
        // Funci√≥n para ocultar alertas flotantes
        function ocultarAlertasFlotantes() {
            const alertsContainer = document.getElementById('alerts-floating');
            if (alertsContainer) {
                alertsContainer.style.display = 'none';
                alertasFlotantesOcultas = true;
                console.log('üì¶ Panel de alertas ocultado');
            }
        }
        
        // Funci√≥n para agregar nueva alerta (simulaci√≥n)
        function agregarNuevaAlerta(tipo, titulo, mensaje, alertId) {
            const alertsList = document.getElementById('alerts-floating-list');
            const alertsContainer = document.getElementById('alerts-floating');
            
            if (!alertasVistas.includes(alertId)) {
                const iconos = {
                    'success': 'fas fa-check-circle',
                    'info': 'fas fa-info-circle',
                    'warning': 'fas fa-exclamation-triangle',
                    'danger': 'fas fa-exclamation-circle'
                };
                
                const nuevaAlerta = document.createElement('div');
                nuevaAlerta.className = `alert-floating-item ${tipo}`;
                nuevaAlerta.setAttribute('data-alert-id', alertId);
                nuevaAlerta.innerHTML = `
                    <i class="${iconos[tipo]}"></i>
                    <div class="alert-content">
                        <strong>${titulo}</strong><br>
                        <small>${mensaje}</small>
                    </div>
                    <button class="alert-dismiss-btn" onclick="marcarAlertaVista('${alertId}')" title="Marcar como visto">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                
                alertsList.appendChild(nuevaAlerta);
                actualizarContadorAlertas();
                
                // Mostrar panel si estaba oculto
                if (alertasFlotantesOcultas) {
                    alertsContainer.style.display = 'block';
                    alertasFlotantesOcultas = false;
                    
                    // Efecto visual
                    alertsContainer.style.animation = 'pulse 1s ease-in-out 3';
                    setTimeout(() => {
                        alertsContainer.style.animation = '';
                    }, 3000);
                }
            }
        }
        
        // Funci√≥n para cargar gesti√≥n de materiales
        async function cargarGestionMateriales() {
            console.log('üìã Cargando gesti√≥n de materiales...');
            try {
                const response = await fetch('/obtener_materiales_base_json');
                const materiales = await response.json();
                
                console.log('üìä Materiales base cargados:', materiales);
                
                const container = document.getElementById('tabla-materiales-container');
                const filtro = document.getElementById('filtro-tipo-material');
                
                function renderizarTabla(filtroTipo = '') {
                    let html = `
                        <table class="table table-sm table-dark table-striped">
                            <thead>
                                <tr>
                                    <th>Material</th>
                                    <th>ST (%)</th>
                                    <th>SV (%)</th>
                                    <th>KW/TN</th>
                                    <th>Tipo</th>
                                    <th>Metano (%)</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;
                    
                    const materialesFiltrados = Object.entries(materiales).filter(([nombre, datos]) => {
                        if (!filtroTipo) return true;
                        return datos.tipo === filtroTipo;
                    });
                    
                    materialesFiltrados
                        .sort(([, a], [, b]) => (b['kw/tn'] || 0) - (a['kw/tn'] || 0)) // Ordenar por KW/TN desc
                        .forEach(([nombre, datos]) => {
                            const st = ((datos.st || 0) * 100).toFixed(1);
                            const sv = ((datos.sv || 0) * 100).toFixed(1);
                            const kwTn = (datos['kw/tn'] || 0).toFixed(4);
                            const tipo = datos.tipo || 'N/A';
                            const metano = (datos.porcentaje_metano || 0).toFixed(1);
                            
                            // Color por rendimiento energ√©tico
                            let colorKw = '';
                            const kwValue = parseFloat(kwTn);
                            if (kwValue > 1.0) colorKw = 'color: #28a745; font-weight: bold;'; // Verde para alto rendimiento
                            else if (kwValue > 0.5) colorKw = 'color: #ffc107;'; // Amarillo para medio
                            else if (kwValue > 0.1) colorKw = 'color: #fd7e14;'; // Naranja para bajo
                            else colorKw = 'color: #dc3545;'; // Rojo para muy bajo
                            
                            html += `
                                <tr>
                                    <td style="font-weight: 500;">${nombre}</td>
                                    <td>${st}%</td>
                                    <td>${sv}%</td>
                                    <td style="${colorKw}">${kwTn}</td>
                                    <td>
                                        <span class="badge ${tipo === 'solido' ? 'badge-warning' : 'badge-info'}">
                                            ${tipo === 'solido' ? 'üü§ S√≥lido' : 'üíß L√≠quido'}
                                        </span>
                                    </td>
                                    <td>${metano}%</td>
                                </tr>
                            `;
                        });
                    
                    html += `
                            </tbody>
                        </table>
                        <div class="mt-2">
                            <small class="text-muted">
                                <span style="color: #28a745;">‚óè</span> >1.0 KW/TN: Alto rendimiento |
                                <span style="color: #ffc107;">‚óè</span> 0.5-1.0: Medio |
                                <span style="color: #fd7e14;">‚óè</span> 0.1-0.5: Bajo |
                                <span style="color: #dc3545;">‚óè</span> <0.1: Muy bajo
                            </small>
                        </div>
                    `;
                    
                    container.innerHTML = html;
                }
                
                // Renderizar tabla inicial
                renderizarTabla();
                
                // Event listener para filtro
                filtro.addEventListener('change', function() {
                    renderizarTabla(this.value);
                });
                
                console.log('‚úÖ Gesti√≥n de materiales cargada correctamente');
                
            } catch (error) {
                console.error('‚ùå Error cargando gesti√≥n de materiales:', error);
                document.getElementById('tabla-materiales-container').innerHTML = 
                    '<div class="text-center text-danger">Error cargando materiales</div>';
            }
        }
        
        // Funci√≥n para gesti√≥n de materiales editable
        async function cargarGestionMaterialesEditable() {
            console.log('üß™ Cargando gesti√≥n de materiales editable...');
            
            const analyticsView = document.getElementById('analytics-view');
            if (!analyticsView) return;
            
            analyticsView.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Cargando gesti√≥n de materiales...</div>';
            
            try {
                const response = await fetch('/obtener_materiales_base_json');
                const data = await response.json();
                
                if (data.status === 'success') {
                    const materiales = data.materiales || {};
                    console.log('üìä Materiales cargados para edici√≥n:', Object.keys(materiales).length, 'materiales');
                    
                    let html = `
                    <div class="management-panel">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h3><i class="fas fa-flask"></i> Gesti√≥n de Materiales - Datos de Laboratorio</h3>
                            <div>
                                <button class="btn btn-info btn-sm me-2" onclick="sincronizarStockTabla()" title="Sincronizar con stock">
                                    <i class="fas fa-sync"></i> Sincronizar Stock
                                </button>
                                <button class="btn btn-warning btn-sm me-2" onclick="recalcularTodaLaTabla()" title="Recalcular todas las f√≥rmulas">
                                    <i class="fas fa-calculator"></i> Recalcular F√≥rmulas
                                </button>
                                <button class="btn btn-success btn-sm" onclick="agregarNuevoMaterial()">
                                    <i class="fas fa-plus"></i> Nuevo Material
                                </button>
                                <button class="btn btn-primary btn-sm ml-2" onclick="guardarCambiosMateriales()">
                                    <i class="fas fa-save"></i> Guardar Cambios
                                </button>
                            </div>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table table-striped table-standard" id="tabla-gestion-materiales">
                                <thead>
                                    <tr>
                                        <th style="min-width: 200px;">Material</th>
                                        <th>ST (%)</th>
                                        <th>SV (%)</th>
                                        <th>Toneladas</th>
                                        <th>M¬≥/TN SV</th>
                                        <th>CH4 (%)</th>
                                        <th>Carbohidrato (%) <small>(Lab)</small></th>
                                        <th>L√≠pido (%) <small>(Lab)</small></th>
                                        <th>Prote√≠na (%) <small>(Lab)</small></th>
                                        <th>Carbohidrato (%) <small>(Calc)</small></th>
                                        <th>L√≠pido (%) <small>(Calc)</small></th>
                                        <th>Prote√≠na (%) <small>(Calc)</small></th>
                                        <th>Tipo</th>
                                        <th>Densidad <small>(kg/L)</small></th>
                                        <th>KW/TN <small>(calc.)</small></th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                Object.entries(materiales).forEach(([nombre, datos]) => {
                    const st = ((datos.st || 0) * 100).toFixed(2);
                    const sv = ((datos.sv || 0) * 100).toFixed(2);
                    const toneladas = "1.00"; // Siempre 1 para calcular KW/TN
                    const m3_tnsv = (datos.m3_tnsv || 0).toFixed(2);
                    const metano = ((datos.ch4 || 0) * 100).toFixed(2);
                    
                    // Valores de laboratorio (editables) - mostrar como porcentajes
                    const carbohidrato_lab = ((datos.carbohidratos || 0) * 100).toFixed(2);
                    const lipido_lab = ((datos.lipidos || 0) * 100).toFixed(2);
                    const proteina_lab = ((datos.proteinas || 0) * 100).toFixed(2);
                    
                    // CORREGIDO: Valores calculados autom√°ticamente basados en TNSV
                    const st_decimal = datos.st || 0;
                    const sv_decimal = datos.sv || 0;
                    const tnsv = sv_decimal * st_decimal; // TNSV = SV Lab √ó ST Analizado (toneladas = 1)
                    
                    // Calcular composici√≥n qu√≠mica basada en TNSV
                    // Los valores calculados son los valores de laboratorio multiplicados por TNSV
                    const carbohidrato_calc = ((datos.carbohidratos || 0) * tnsv * 100).toFixed(2); // Convertir a porcentaje para mostrar
                    const lipido_calc = ((datos.lipidos || 0) * tnsv * 100).toFixed(2);               // Convertir a porcentaje para mostrar
                    const proteina_calc = ((datos.proteinas || 0) * tnsv * 100).toFixed(2);           // Convertir a porcentaje para mostrar
                    
                    const tipo = datos.tipo || 'N/A';
                    const densidad = (datos.densidad || 1.0).toFixed(2);
                    const kwTn = (datos['kw/tn'] || 0).toFixed(4);
                    
                    // Color por rendimiento energ√©tico
                    let colorKw = '';
                    const kwValue = parseFloat(kwTn);
                    if (kwValue > 1.0) colorKw = 'color: #28a745; font-weight: bold;';
                    else if (kwValue > 0.5) colorKw = 'color: #ffc107;';
                    else if (kwValue > 0.1) colorKw = 'color: #fd7e14;';
                    else colorKw = 'color: #dc3545;';
                    
                    html += `
                        <tr data-material="${nombre}">
                            <td>
                                <input type="text" class="form-control form-control-sm bg-white text-dark border-secondary" 
                                       value="${nombre}" onchange="actualizarNombreMaterial(this, '${nombre}')" style="color: black !important;">
                            </td>
                            <td>
                                <input type="number" class="form-control form-control-sm bg-white text-dark border-secondary" 
                                       value="${st}" step="0.01" onchange="recalcularKW('${nombre}')" onkeypress="if(event.key==='Enter') recalcularKW('${nombre}')" style="color: black !important;">
                            </td>
                            <td>
                                <input type="number" class="form-control form-control-sm bg-white text-dark border-secondary" 
                                       value="${sv}" step="0.01" onchange="recalcularKW('${nombre}')" onkeypress="if(event.key==='Enter') recalcularKW('${nombre}')">
                            </td>
                            <td>
                                <input type="number" class="form-control form-control-sm bg-light text-dark border-secondary" 
                                       value="${toneladas}" step="0.01" readonly style="background-color: #f8f9fa !important;">
                            </td>
                            <td>
                                <span class="m3-tnsv-calculado" onclick="toggleFormula(this)" style="cursor: pointer; font-weight: bold; color: #007bff;" 
                                      title="Haz clic para ver la f√≥rmula">${m3_tnsv}</span>
                                <br><small class="formula-explicacion" style="display: none; color: #666;">(TN CH√ó750 + TN Lip√ó1440 + TN Prot√ó980) √∑ TNSV</small>
                            </td>
                            <td>
                                <span class="ch4-calculado" onclick="toggleFormula(this)" style="cursor: pointer; font-weight: bold;" 
                                      title="Haz clic para ver la f√≥rmula">${metano}%</span>
                                <br><small class="formula-explicacion" style="display: none; color: #666;">((Prot√ó0.71) + (Lip√ó0.68) + (Carb√ó0.5)) √∑ Total Biog√°s</small>
                            </td>
                            <td>
                                <input type="number" class="form-control form-control-sm bg-white text-dark border-secondary" 
                                       value="${carbohidrato_lab}" step="0.01" onchange="recalcularKW('${nombre}')" onkeypress="if(event.key==='Enter') recalcularKW('${nombre}')">
                            </td>
                            <td>
                                <input type="number" class="form-control form-control-sm bg-white text-dark border-secondary" 
                                       value="${lipido_lab}" step="0.01" onchange="recalcularKW('${nombre}')" onkeypress="if(event.key==='Enter') recalcularKW('${nombre}')">
                            </td>
                            <td>
                                <input type="number" class="form-control form-control-sm bg-white text-dark border-secondary" 
                                       value="${proteina_lab}" step="0.01" onchange="recalcularKW('${nombre}')" onkeypress="if(event.key==='Enter') recalcularKW('${nombre}')">
                            </td>
                            <td>
                                <span class="badge badge-info" onclick="toggleFormula(this)" style="font-size: 0.8em; cursor: pointer;" title="Haz clic para ver la f√≥rmula">${carbohidrato_calc}%</span>
                                <br><small class="formula-explicacion" style="display: none; color: #666;">TNSV √ó Carbohidratos Lab</small>
                            </td>
                            <td>
                                <span class="badge badge-info" onclick="toggleFormula(this)" style="font-size: 0.8em; cursor: pointer;" title="Haz clic para ver la f√≥rmula">${lipido_calc}%</span>
                                <br><small class="formula-explicacion" style="display: none; color: #666;">TNSV √ó L√≠pidos Lab</small>
                            </td>
                            <td>
                                <span class="badge badge-info" onclick="toggleFormula(this)" style="font-size: 0.8em; cursor: pointer;" title="Haz clic para ver la f√≥rmula">${proteina_calc}%</span>
                                <br><small class="formula-explicacion" style="display: none; color: #666;">TNSV √ó Prote√≠nas Lab</small>
                            </td>
                            <td>
                                <select class="form-control form-control-sm bg-white text-dark border-secondary" onchange="recalcularKW('${nombre}')">
                                    <option value="solido" ${tipo === 'solido' ? 'selected' : ''}>S√≥lido</option>
                                    <option value="liquido" ${tipo === 'liquido' ? 'selected' : ''}>L√≠quido</option>
                                </select>
                            </td>
                            <td>
                                <input type="number" class="form-control form-control-sm bg-white text-dark border-secondary" 
                                       value="${densidad}" step="0.01" min="0.1" max="2.0" onchange="recalcularKW('${nombre}')">
                            </td>
                            <td style="${colorKw}">
                                <span class="kw-calculado" onclick="toggleFormula(this)" style="cursor: pointer;" title="Haz clic para ver la f√≥rmula">${kwTn}</span>
                                <br><small class="formula-explicacion" style="display: none; color: #666;">(ST √ó SV √ó M¬≥/TN SV) √∑ Consumo CHP</small>
                            </td>
                            <td>
                                <button class="btn btn-outline-danger btn-sm" onclick="eliminarMaterial('${nombre}')" title="Eliminar">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                html += `
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="mt-3">
                            <div class="alert alert-info">
                                <h6><i class="fas fa-calculator"></i> F√≥rmula de C√°lculo KW/TN:</h6>
                                <p><strong>KW/TN = (ST/100) √ó (SV/100) √ó (M¬≥/TN SV) √ó (CH4%/100) √ó 3.5 (factor conversi√≥n)</strong></p>
                                <small>
                                    ‚Ä¢ ST: S√≥lidos Totales | SV: S√≥lidos Vol√°tiles | M¬≥/TN SV: Metros c√∫bicos por tonelada de s√≥lidos vol√°tiles<br>
                                    ‚Ä¢ CH4: Porcentaje de metano | Factor 3.5: Conversi√≥n energ√©tica promedio kW por m¬≥ de metano
                                </small>
                            </div>
                        </div>
                    </div>
                `;
                
                    analyticsView.innerHTML = html;
                    console.log('‚úÖ Gesti√≥n de materiales editable cargada');
                } else {
                    throw new Error(data.mensaje || 'Error cargando materiales');
                }
                
            } catch (error) {
                console.error('‚ùå Error cargando gesti√≥n de materiales:', error);
                analyticsView.innerHTML = '<div class="text-center text-danger">Error cargando gesti√≥n de materiales</div>';
            }
        }

        // === Recomendaciones de materiales ===
        async function sugerirMateriales() {
            try {
                const kwObjetivo = parseFloat(document.getElementById('kw-objetivo').value || '0');
                const incluirPurin = document.getElementById('incluir-purin').checked;
                const body = {
                    kw_objetivo: kwObjetivo,
                    objetivo_metano: parseFloat(document.getElementById('metano-objetivo').value || '65'),
                    incluir_purin: incluirPurin,
                    max_solidos: 6,
                    max_liquidos: 4
                };
                const resp = await fetch('/recomendaciones_materiales', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                const data = await resp.json();
                if (data.status !== 'success') throw new Error(data.mensaje || 'Error');
                const lista = data.datos.recomendaciones || [];
                const cont = document.getElementById('recomendaciones-container');
                const ul = document.getElementById('recomendaciones-lista');
                cont.style.display = 'block';
                ul.innerHTML = lista.length ? '<ul class="mb-0">' + lista.map(r => {
                    return `<li>${r.material} ‚Äî ${r.tn_sugeridas} TN ¬∑ ${r.kw_estimados} KW ¬∑ CH4 ${r.ch4_ref}% (stock ${r.stock_tn} TN)</li>`;
                }).join('') + '</ul>' : '<div class="text-muted">Sin sugerencias</div>';
                ul.dataset.recomendaciones = JSON.stringify(lista);
            } catch (e) {
                console.error('Error recomendaciones:', e);
                alert('No se pudieron obtener recomendaciones');
            }
        }

        async function aplicarRecomendaciones() {
            try {
                const ul = document.getElementById('recomendaciones-lista');
                const lista = JSON.parse(ul.dataset.recomendaciones || '[]');
                if (!lista.length) return;
                // Disparar c√°lculo con los materiales sugeridos: forzamos energ√©tico para asegurar llegada
                const kwObjetivo = parseFloat(document.getElementById('kw-objetivo').value || '0');
                const incluirPurin = document.getElementById('incluir-purin').checked;
                const body = {
                    kw_objetivo: kwObjetivo,
                    porcentaje_solidos: parseFloat(document.getElementById('porcentaje-solidos').value || '50'),
                    porcentaje_liquidos: parseFloat(document.getElementById('porcentaje-liquidos').value || '50'),
                    modo_energetico: document.getElementById('modo-energetico').checked,
                    incluir_purin: incluirPurin
                };
                const resp = await fetch('/calcular_mezcla', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body)
                });
                const data = await resp.json();
                if (data.status !== 'success') throw new Error(data.mensaje || 'Error');
                alert('Sugeridos aplicados. Revisa la mezcla calculada.');
            } catch (e) {
                console.error('Error aplicando sugerencias:', e);
                alert('No se pudieron aplicar las sugerencias');
            }
        }
        
        // Funci√≥n para recalcular KW cuando se cambian valores - MEJORADA
        function recalcularKW(materialNombre) {
            console.log(`üîÑ Recalculando KW para: ${materialNombre}`);
            
            const row = document.querySelector(`[data-material="${materialNombre}"]`);
            if (!row) {
                console.error(`‚ùå No se encontr√≥ la fila para ${materialNombre}`);
                return;
            }
            
            const inputs = row.querySelectorAll('input[type="number"]');
            console.log(`üìä Inputs encontrados: ${inputs.length}`);
            
            // CORREGIDO: Mapeo correcto seg√∫n la estructura de la tabla
            // Tabla: Material | ST | SV | Toneladas | M¬≥/TN SV | CH4 | Carb Lab | Lip Lab | Prot Lab | Carb Calc | Lip Calc | Prot Calc | Tipo | Densidad | KW/TN | Acciones
            const st = parseFloat(inputs[1].value) / 100;  // ST % (posici√≥n 1)
            const sv = parseFloat(inputs[2].value) / 100;  // SV % (posici√≥n 2)
            const m3_tnsv = parseFloat(inputs[4].value);   // M¬≥/TN SV (posici√≥n 4)
            const carbohidratos_lab = parseFloat(inputs[6].value) || 0;  // Carbohidratos Lab (posici√≥n 6)
            const lipidos_lab = parseFloat(inputs[7].value) || 0;        // L√≠pidos Lab (posici√≥n 7)
            const proteinas_lab = parseFloat(inputs[8].value) || 0;      // Prote√≠nas Lab (posici√≥n 8)
            
            console.log(`üìä Valores le√≠dos:`);
            console.log(`   ST: ${inputs[1].value}% ‚Üí ${st} (decimal)`);
            console.log(`   SV: ${inputs[2].value}% ‚Üí ${sv} (decimal)`);
            console.log(`   Carbohidratos Lab: ${inputs[6].value}%`);
            console.log(`   L√≠pidos Lab: ${inputs[7].value}%`);
            console.log(`   Prote√≠nas Lab: ${inputs[8].value}%`);
            
            // Obtener tipo de material del select
            const tipoSelect = row.querySelector('select');
            const tipo_material = tipoSelect ? tipoSelect.value : 'solido';
            
            // Calcular densidad seg√∫n el tipo de material
            let densidad = 1.0; // Valor por defecto para s√≥lidos
            if (tipo_material === 'liquido') {
                if (materialNombre.toLowerCase().includes('purin')) {
                    densidad = 1.05;
                } else if (materialNombre.toLowerCase().includes('suero') || materialNombre.toLowerCase().includes('lactosa')) {
                    densidad = 1.03;
                } else {
                    densidad = 1.02;
                }
            }
            
            // Actualizar el campo de densidad
            const densidadInput = row.querySelector('input[type="number"]:last-of-type');
            if (densidadInput) {
                densidadInput.value = densidad.toFixed(2);
            }
            
            // Calcular TNSV = SV Lab √ó ST Analizado (toneladas = 1)
            const tnsv_calc = sv * st;
            
            // CORREGIDO: Calcular valores reales basados en TNSV
            // Los valores de laboratorio ya vienen como porcentajes, convertirlos a decimales
            const carbohidratos_reales = tnsv_calc * (carbohidratos_lab / 100);  // TNSV √ó Carbohidratos Lab %
            const lipidos_reales = tnsv_calc * (lipidos_lab / 100);              // TNSV √ó L√≠pidos Lab %
            const proteinas_reales = tnsv_calc * (proteinas_lab / 100);          // TNSV √ó Prote√≠nas Lab %
            
            // Calcular CH4% usando los valores reales: ((Prot√ó0,71)+(Lip√ó0,68)+(Carb√ó0,5))√∑TotalBiog√°s
            const totalBiogas = carbohidratos_reales + lipidos_reales + proteinas_reales;
            let ch4Porcentaje = 0.65; // Valor por defecto
            
            if (totalBiogas > 0) {
                ch4Porcentaje = ((proteinas_reales * 0.71) + (lipidos_reales * 0.68) + (carbohidratos_reales * 0.5)) / totalBiogas;
            }
            
            // CORREGIDO: Actualizar las columnas calculadas (badges)
            const badges = row.querySelectorAll('.badge');
            if (badges.length >= 3) {
                badges[0].textContent = (carbohidratos_reales * 100).toFixed(2) + '%';  // Convertir a porcentaje para mostrar
                badges[1].textContent = (lipidos_reales * 100).toFixed(2) + '%';       // Convertir a porcentaje para mostrar
                badges[2].textContent = (proteinas_reales * 100).toFixed(2) + '%';      // Convertir a porcentaje para mostrar
            }
            
            // Actualizar CH4% calculado
            const ch4Element = row.querySelector('.ch4-calculado');
            if (ch4Element) {
                ch4Element.textContent = (ch4Porcentaje * 100).toFixed(2) + '%';
            }
            
            // CORREGIDO: Calcular M¬≥/TN SV usando valores de laboratorio
            // Para 1 TN de material, calcular TN s√≥lidos
            const tn_solidos = 1.0 * st;
            
            // Calcular TN de cada componente nutricional usando valores de laboratorio
            const tn_carbohidratos = tn_solidos * (carbohidratos_lab / 100);
            const tn_lipidos = tn_solidos * (lipidos_lab / 100);
            const tn_proteinas = tn_solidos * (proteinas_lab / 100);
            
            // Calcular m¬≥ de biog√°s de cada componente
            const m3_biogas_carbohidratos = tn_carbohidratos * 750;
            const m3_biogas_lipidos = tn_lipidos * 1440;
            const m3_biogas_proteinas = tn_proteinas * 980;
            
            // Sumar todo el biog√°s
            const m3_biogas_total = m3_biogas_carbohidratos + m3_biogas_lipidos + m3_biogas_proteinas;
            
            // Calcular M¬≥/TNSV
            // CORREGIDO: Usar el valor existente de M¬≥/TN SV en lugar de recalcularlo
            const m3_tnsv_existente = parseFloat(inputs[4].value) || 0;
            
            // CORREGIDO: F√≥rmula correcta KW/TN = (ST √ó SV √ó M¬≥/TN SV √ó CH4%) / Consumo CHP
            // Usar la misma f√≥rmula que temp_functions.py (CON CH4)
            const consumoCHP = parseFloat(document.getElementById('consumo-chp-input').value) || 505;
            const kwTn = (st * sv * m3_tnsv_existente * ch4Porcentaje) / consumoCHP;
            
            // Actualizar CH4 calculado
            const ch4Display = row.querySelector('.ch4-calculado');
            if (ch4Display) {
                ch4Display.textContent = (ch4Porcentaje * 100).toFixed(2) + '%';
                
                // Actualizar color del CH4
                let ch4Color = '';
                if (ch4Porcentaje > 0.6) ch4Color = '#28a745';      // >60% - Verde
                else if (ch4Porcentaje > 0.5) ch4Color = '#ffc107';  // 50-60% - Amarillo
                else if (ch4Porcentaje > 0.4) ch4Color = '#fd7e14';  // 40-50% - Naranja
                else ch4Color = '#dc3545';                           // <40% - Rojo
                
                ch4Display.parentElement.style.color = ch4Color;
                ch4Display.parentElement.style.fontWeight = ch4Porcentaje > 0.6 ? 'bold' : 'normal';
            }
            
            // Actualizar KW/TN calculado
            const kwDisplay = row.querySelector('.kw-calculado');
            if (kwDisplay) {
                kwDisplay.textContent = kwTn.toFixed(4);
                
                // Actualizar color del KW/TN
                let kwColor = '';
                if (kwTn > 1.0) kwColor = '#28a745';
                else if (kwTn > 0.5) kwColor = '#ffc107';
                else if (kwTn > 0.1) kwColor = '#fd7e14';
                else kwColor = '#dc3545';
                
                kwDisplay.parentElement.style.color = kwColor;
                kwDisplay.parentElement.style.fontWeight = kwTn > 1.0 ? 'bold' : 'normal';
            }
            
            console.log(`üîÑ Recalculado para ${materialNombre}:`);
            console.log(`   TNSV: ${tnsv_calc.toFixed(4)}`);
            console.log(`   M¬≥/TN SV: ${m3_tnsv_calculado.toFixed(3)}`);
            console.log(`   CH4%: ${(ch4Porcentaje*100).toFixed(2)}%`);
            console.log(`   KW/TN: ${kwTn.toFixed(4)}`);
            console.log(`‚úÖ Rec√°lculo completado para ${materialNombre}`);
            
            // Guardar cambios autom√°ticamente despu√©s del rec√°lculo
            console.log(`üíæ Guardando cambios autom√°ticamente...`);
            setTimeout(() => {
                guardarCambiosMateriales();
            }, 500); // Peque√±o delay para asegurar que la UI se actualice
        }
        
        // Funci√≥n para reinicializar materiales con datos del Excel
        async function reinicializarMateriales() {
            if (!confirm('¬øEst√°s seguro de que quieres reinicializar todos los materiales con los datos del Excel? Esto sobrescribir√° los datos actuales.')) {
                return;
            }
            
            try {
                console.log('üîÑ Reinicializando materiales con datos del Excel...');
                
                const response = await fetch('/reinicializar_materiales', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    alert(`‚úÖ ${data.mensaje}`);
                    // ELIMINADO: Recarga autom√°tica que causaba p√©rdida de datos
                    // cargarGestionMaterialesEditable();
                } else {
                    alert('‚ùå Error: ' + data.mensaje);
                }
            } catch (error) {
                console.error('‚ùå Error reinicializando materiales:', error);
                alert('‚ùå Error al reinicializar materiales');
            }
        }
        
        // Funci√≥n para mostrar/ocultar f√≥rmula con resaltado de colores
        function toggleFormula(elemento) {
            const row = elemento.closest('tr');
            const materialNombre = row.getAttribute('data-material');
            
            // Determinar el tipo de f√≥rmula
            let formulaData = {};
            if (elemento.classList.contains('kw-calculado')) {
                formulaData = {
                    titulo: 'F√≥rmula KW/TN',
                    formula: '(ST √ó SV √ó M¬≥/TN SV √ó CH4%) √∑ Consumo CHP',
                    descripcion: 'F√≥rmula para calcular kilovatios por tonelada',
                    inputs: ['ST', 'SV', 'M¬≥/TN SV', 'CH4%']
                };
            } else if (elemento.classList.contains('ch4-calculado')) {
                formulaData = {
                    titulo: 'F√≥rmula CH4%',
                    formula: '((Prot√ó0.71) + (Lip√ó0.68) + (Carb√ó0.5)) √∑ Total Biog√°s',
                    descripcion: 'F√≥rmula para calcular el porcentaje de metano',
                    inputs: ['Carbohidratos Lab', 'L√≠pidos Lab', 'Prote√≠nas Lab']
                };
            } else if (elemento.classList.contains('m3-tnsv-calculado')) {
                formulaData = {
                    titulo: 'F√≥rmula M¬≥/TN SV',
                    formula: '(TN Carbohidratos √ó 750 + TN L√≠pidos √ó 1440 + TN Prote√≠nas √ó 980) √∑ TNSV',
                    descripcion: 'F√≥rmula para calcular metros c√∫bicos de biog√°s por tonelada de s√≥lidos vol√°tiles',
                    inputs: ['ST', 'SV', 'Carbohidratos Lab', 'L√≠pidos Lab', 'Prote√≠nas Lab'],
                    pasos: [
                        'TNSV = ST √ó SV',
                        'TN S√≥lidos = 1 TN √ó ST',
                        'TN Carbohidratos = TN S√≥lidos √ó (Carbohidratos Lab / 100)',
                        'TN L√≠pidos = TN S√≥lidos √ó (L√≠pidos Lab / 100)',
                        'TN Prote√≠nas = TN S√≥lidos √ó (Prote√≠nas Lab / 100)',
                        'M¬≥ Biog√°s CH = TN Carbohidratos √ó 750',
                        'M¬≥ Biog√°s Lip = TN L√≠pidos √ó 1440',
                        'M¬≥ Biog√°s Prot = TN Prote√≠nas √ó 980',
                        'M¬≥ Biog√°s Total = M¬≥ CH + M¬≥ Lip + M¬≥ Prot',
                        'M¬≥/TN SV = M¬≥ Biog√°s Total √∑ TNSV'
                    ]
                };
            } else if (elemento.classList.contains('badge')) {
                const badgeText = elemento.textContent;
                if (badgeText.includes('Carbohidrato')) {
                    formulaData = {
                        titulo: 'F√≥rmula Carbohidratos Calculados',
                        formula: 'TNSV √ó Carbohidratos Lab',
                        descripcion: 'F√≥rmula para calcular carbohidratos reales',
                        inputs: ['ST', 'SV', 'Carbohidratos Lab']
                    };
                } else if (badgeText.includes('L√≠pido')) {
                    formulaData = {
                        titulo: 'F√≥rmula L√≠pidos Calculados',
                        formula: 'TNSV √ó L√≠pidos Lab',
                        descripcion: 'F√≥rmula para calcular l√≠pidos reales',
                        inputs: ['ST', 'SV', 'L√≠pidos Lab']
                    };
                } else if (badgeText.includes('Prote√≠na')) {
                    formulaData = {
                        titulo: 'F√≥rmula Prote√≠nas Calculadas',
                        formula: 'TNSV √ó Prote√≠nas Lab',
                        descripcion: 'F√≥rmula para calcular prote√≠nas reales',
                        inputs: ['ST', 'SV', 'Prote√≠nas Lab']
                    };
                }
            }
            
            // Mostrar modal con f√≥rmula editable
            showFormulaModal(formulaData, row, elemento);
        }
        
        // Funci√≥n para resaltar las casillas relacionadas con la f√≥rmula
        function highlightFormulaInputs(row, elemento) {
            // Limpiar resaltados previos
            clearHighlights(row);
            
            // Obtener todos los inputs de la fila (excluyendo el de toneladas que es readonly)
            const inputs = row.querySelectorAll('input[type="number"]:not([readonly])');
            
            if (elemento.classList.contains('kw-calculado')) {
                // F√≥rmula KW/TN: (ST √ó SV √ó M¬≥/TN SV √ó CH4%) √∑ Consumo CHP
                // inputs[0] = ST, inputs[1] = SV, inputs[2] = M¬≥/TN SV
                if (inputs[0]) {
                    inputs[0].style.setProperty('background-color', '#ffeb3b', 'important'); // ST - Amarillo
                    inputs[0].classList.add('formula-highlight');
                }
                if (inputs[1]) {
                    inputs[1].style.setProperty('background-color', '#4caf50', 'important'); // SV - Verde
                    inputs[1].classList.add('formula-highlight');
                }
                if (inputs[2]) {
                    inputs[2].style.setProperty('background-color', '#2196f3', 'important'); // M¬≥/TN SV - Azul
                    inputs[2].classList.add('formula-highlight');
                }
                // CH4% se resalta con el elemento mismo
                elemento.style.backgroundColor = '#ff9800'; // CH4% - Naranja
            } else if (elemento.classList.contains('ch4-calculado')) {
                // F√≥rmula CH4%: ((Prot√ó0.71) + (Lip√ó0.68) + (Carb√ó0.5)) √∑ Total Biog√°s
                // inputs[3] = Carbohidratos Lab, inputs[4] = L√≠pidos Lab, inputs[5] = Prote√≠nas Lab
                if (inputs[3]) {
                    inputs[3].style.setProperty('background-color', '#e91e63', 'important'); // Carbohidratos Lab - Rosa
                    inputs[3].classList.add('formula-highlight');
                }
                if (inputs[4]) {
                    inputs[4].style.setProperty('background-color', '#9c27b0', 'important'); // L√≠pidos Lab - P√∫rpura
                    inputs[4].classList.add('formula-highlight');
                }
                if (inputs[5]) {
                    inputs[5].style.setProperty('background-color', '#3f51b5', 'important'); // Prote√≠nas Lab - √çndigo
                    inputs[5].classList.add('formula-highlight');
                }
            } else if (elemento.classList.contains('badge')) {
                // F√≥rmulas de valores calculados: TNSV √ó Valor Lab
                if (inputs[0]) {
                    inputs[0].style.setProperty('background-color', '#ffeb3b', 'important'); // ST - Amarillo
                    inputs[0].classList.add('formula-highlight');
                }
                if (inputs[1]) {
                    inputs[1].style.setProperty('background-color', '#4caf50', 'important'); // SV - Verde
                    inputs[1].classList.add('formula-highlight');
                }
                
                // Resaltar el valor de laboratorio correspondiente
                const badgeText = elemento.textContent;
                if (badgeText.includes('Carbohidrato')) {
                    if (inputs[3]) {
                        inputs[3].style.setProperty('background-color', '#e91e63', 'important'); // Carbohidratos Lab
                        inputs[3].classList.add('formula-highlight');
                    }
                } else if (badgeText.includes('L√≠pido')) {
                    if (inputs[4]) {
                        inputs[4].style.setProperty('background-color', '#9c27b0', 'important'); // L√≠pidos Lab
                        inputs[4].classList.add('formula-highlight');
                    }
                } else if (badgeText.includes('Prote√≠na')) {
                    if (inputs[5]) {
                        inputs[5].style.setProperty('background-color', '#3f51b5', 'important'); // Prote√≠nas Lab
                        inputs[5].classList.add('formula-highlight');
                    }
                }
            }
        }
        
        // Funci√≥n para limpiar los resaltados
        function clearHighlights(row) {
            const inputs = row.querySelectorAll('input[type="number"]');
            inputs.forEach(input => {
                input.style.removeProperty('background-color');
                input.classList.remove('formula-highlight');
            });
            
            const badges = row.querySelectorAll('.kw-calculado, .ch4-calculado, .badge');
            badges.forEach(badge => {
                badge.style.backgroundColor = '';
            });
        }
        
        // Funci√≥n para hacer el modal arrastrable
        function makeModalDraggable() {
            const modal = document.getElementById('formulaModal');
            const modalDialog = modal.querySelector('.modal-dialog');
            const modalHeader = document.getElementById('formulaModalHeader');
            
            if (!modal || !modalDialog || !modalHeader) return;
            
            let isDragging = false;
            let currentX;
            let currentY;
            let initialX;
            let initialY;
            let xOffset = 0;
            let yOffset = 0;
            
            // Funci√≥n para iniciar el arrastre
            function dragStart(e) {
                if (e.type === "touchstart") {
                    initialX = e.touches[0].clientX - xOffset;
                    initialY = e.touches[0].clientY - yOffset;
                } else {
                    initialX = e.clientX - xOffset;
                    initialY = e.clientY - yOffset;
                }
                
                if (e.target === modalHeader || modalHeader.contains(e.target)) {
                    isDragging = true;
                    modalHeader.style.cursor = 'grabbing';
                }
            }
            
            // Funci√≥n durante el arrastre
            function dragMove(e) {
                if (isDragging) {
                    e.preventDefault();
                    
                    if (e.type === "touchmove") {
                        currentX = e.touches[0].clientX - initialX;
                        currentY = e.touches[0].clientY - initialY;
                    } else {
                        currentX = e.clientX - initialX;
                        currentY = e.clientY - initialY;
                    }
                    
                    xOffset = currentX;
                    yOffset = currentY;
                    
                    // Limitar el movimiento dentro de la ventana
                    const maxX = window.innerWidth - modalDialog.offsetWidth;
                    const maxY = window.innerHeight - modalDialog.offsetHeight;
                    
                    xOffset = Math.max(0, Math.min(xOffset, maxX));
                    yOffset = Math.max(0, Math.min(yOffset, maxY));
                    
                    modalDialog.style.transform = `translate(${xOffset}px, ${yOffset}px)`;
                    modalDialog.style.transition = 'none';
                }
            }
            
            // Funci√≥n para terminar el arrastre
            function dragEnd() {
                initialX = currentX;
                initialY = currentY;
                isDragging = false;
                modalHeader.style.cursor = 'move';
                modalDialog.style.transition = '';
            }
            
            // Agregar event listeners
            modalHeader.addEventListener('mousedown', dragStart);
            modalHeader.addEventListener('touchstart', dragStart);
            
            document.addEventListener('mousemove', dragMove);
            document.addEventListener('touchmove', dragMove);
            
            document.addEventListener('mouseup', dragEnd);
            document.addEventListener('touchend', dragEnd);
            
            // Resetear posici√≥n cuando se cierra el modal
            modal.addEventListener('hidden.bs.modal', function() {
                modalDialog.style.transform = 'translate(-50%, -50%)';
                xOffset = 0;
                yOffset = 0;
            });
        }
        
        // Funci√≥n para mostrar modal de f√≥rmula editable
        function showFormulaModal(formulaData, row, elemento) {
            // Agregar estilos CSS para el modal si no existen
            if (!document.getElementById('formulaModalStyles')) {
                const style = document.createElement('style');
                style.id = 'formulaModalStyles';
                style.textContent = `
                    #formulaModal .modal-dialog {
                        max-height: 90vh;
                        margin: 1rem auto;
                    }
                    #formulaModal .modal-content {
                        max-height: 90vh;
                        overflow-y: auto;
                        background-color: #ffffff !important;
                    }
                    #formulaModal .modal-body {
                        max-height: 60vh;
                        overflow-y: auto;
                        background-color: #ffffff !important;
                    }
                    #formulaModal .modal-header {
                        background-color: #f8f9fa !important;
                        border-bottom: 1px solid #dee2e6 !important;
                    }
                    #formulaModal .modal-title {
                        color: #000000 !important;
                        font-weight: 700 !important;
                    }
                    #formulaModal .form-label {
                        color: #000000 !important;
                        font-weight: 700 !important;
                        font-size: 14px !important;
                    }
                    #formulaModal .form-control {
                        color: #000000 !important;
                        background-color: #ffffff !important;
                        border: 1px solid #ced4da !important;
                    }
                    #formulaModal .form-control::placeholder {
                        color: #6c757d !important;
                    }
                    #formulaModal .alert-info {
                        background-color: #e7f3ff !important;
                        border: 1px solid #b3d9ff !important;
                        color: #000000 !important;
                    }
                    #formulaModal .alert-info strong,
                    #formulaModal .alert-info span {
                        color: #000000 !important;
                        font-weight: 600 !important;
                    }
                    #formulaModal .modal-footer {
                        background-color: #f8f9fa !important;
                        border-top: 1px solid #dee2e6 !important;
                    }
                    #formulaModal .btn-secondary {
                        background-color: #6c757d !important;
                        border-color: #6c757d !important;
                        color: #ffffff !important;
                        font-weight: 600 !important;
                    }
                    #formulaModal .btn-primary {
                        background-color: #007bff !important;
                        border-color: #007bff !important;
                        color: #ffffff !important;
                        font-weight: 600 !important;
                    }
                    #formulaModal .badge {
                        color: #ffffff !important;
                        font-weight: 600 !important;
                    }
                `;
                document.head.appendChild(style);
            }
            // Crear modal si no existe
            let modal = document.getElementById('formulaModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'formulaModal';
                modal.className = 'modal fade';
                modal.innerHTML = `
                    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); margin: 0;">
                        <div class="modal-content" style="position: relative;">
                            <div class="modal-header" style="cursor: move; user-select: none;" id="formulaModalHeader">
                                <h5 class="modal-title" id="formulaModalTitle">F√≥rmula</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="mb-3">
                                    <label class="form-label fw-bold text-dark">F√≥rmula:</label>
                                    <input type="text" class="form-control" id="formulaInput" placeholder="Ingrese la f√≥rmula">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-bold text-dark">Descripci√≥n:</label>
                                    <textarea class="form-control" id="formulaDescription" rows="3" placeholder="Descripci√≥n de la f√≥rmula"></textarea>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-bold text-dark">Variables utilizadas:</label>
                                    <div id="formulaVariables" class="d-flex flex-wrap gap-2"></div>
                                </div>
                                <div class="alert alert-info">
                                    <strong class="text-dark">Resaltado:</strong> <span class="text-dark">Las casillas relacionadas se resaltar√°n en la tabla.</span>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary text-white" data-bs-dismiss="modal">Cerrar</button>
                                <button type="button" class="btn btn-primary text-white" onclick="saveFormula()">Guardar F√≥rmula</button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                
                // Agregar funcionalidad de arrastrar al modal
                makeModalDraggable();
            }
            
            // Llenar datos del modal
            document.getElementById('formulaModalTitle').textContent = formulaData.titulo;
            document.getElementById('formulaInput').value = formulaData.formula;
            document.getElementById('formulaDescription').value = formulaData.descripcion;
            
            // Mostrar variables
            const variablesDiv = document.getElementById('formulaVariables');
            variablesDiv.innerHTML = '';
            formulaData.inputs.forEach(input => {
                const badge = document.createElement('span');
                badge.className = 'badge bg-primary me-1';
                badge.textContent = input;
                variablesDiv.appendChild(badge);
            });
            
            // Mostrar pasos detallados si existen
            if (formulaData.pasos && formulaData.pasos.length > 0) {
                const pasosDiv = document.createElement('div');
                pasosDiv.className = 'mb-3';
                pasosDiv.innerHTML = `
                    <label class="form-label fw-bold text-dark">Pasos detallados:</label>
                    <div class="alert alert-light border">
                        <ol class="mb-0">
                            ${formulaData.pasos.map(paso => `<li class="mb-1">${paso}</li>`).join('')}
                        </ol>
                    </div>
                `;
                
                // Insertar despu√©s de las variables
                variablesDiv.parentNode.insertBefore(pasosDiv, variablesDiv.nextSibling);
            }
            
            // Resaltar casillas
            highlightFormulaInputs(row, elemento);
            
            // Mostrar modal
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
            
            // Limpiar resaltados cuando se cierre el modal
            modal.addEventListener('hidden.bs.modal', function() {
                clearHighlights(row);
            });
        }
        
        // Funci√≥n para guardar f√≥rmula (placeholder)
        function saveFormula() {
            const formula = document.getElementById('formulaInput').value;
            const description = document.getElementById('formulaDescription').value;
            
            // Aqu√≠ podr√≠as implementar la l√≥gica para guardar la f√≥rmula personalizada
            console.log('F√≥rmula guardada:', { formula, description });
            alert('F√≥rmula guardada: ' + formula);
            
            // Cerrar modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('formulaModal'));
            modal.hide();
        }
        
        // Funci√≥n para actualizar Consumo CHP y recalcular todos los KW/TN
        async function actualizarConsumoCHP(nuevoValor) {
            try {
                const consumoCHP = parseFloat(nuevoValor);
                if (isNaN(consumoCHP) || consumoCHP <= 0) {
                    alert('El Consumo CHP debe ser un n√∫mero positivo');
                    document.getElementById('consumo-chp-input').value = 505;
                    return;
                }
                
                console.log(`üîÑ Actualizando Consumo CHP a: ${consumoCHP} kW`);
                
                // Actualizar configuraci√≥n en el backend
                const response = await fetch('/actualizar_consumo_chp', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ consumo_chp: consumoCHP })
                });
                
                if (response.ok) {
                    // Recalcular todos los KW/TN en la tabla de gesti√≥n de materiales
                    const filas = document.querySelectorAll('[data-material]');
                    filas.forEach(fila => {
                        const materialNombre = fila.getAttribute('data-material');
                        recalcularKWConConsumoCHP(materialNombre, consumoCHP);
                    });
                    
                    console.log(`‚úÖ Consumo CHP actualizado a ${consumoCHP} kW y todos los KW/TN recalculados`);
                } else {
                    console.error('Error actualizando Consumo CHP');
                    alert('Error al actualizar el Consumo CHP');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al actualizar el Consumo CHP');
            }
        }
        
        // Funci√≥n para recalcular KW con el nuevo Consumo CHP
        function recalcularKWConConsumoCHP(materialNombre, consumoCHP) {
            const row = document.querySelector(`[data-material="${materialNombre}"]`);
            if (!row) return;
            
            const inputs = row.querySelectorAll('input[type="number"]');
            const st = parseFloat(inputs[0].value) / 100;  // ST %
            const sv = parseFloat(inputs[1].value) / 100;  // SV %
            const m3_tnsv = parseFloat(inputs[2].value);   // M¬≥/TN SV
            const carbohidratos = parseFloat(inputs[3].value) || 0;  // Carbohidratos
            const lipidos = parseFloat(inputs[4].value) || 0;        // L√≠pidos
            const proteinas = parseFloat(inputs[5].value) || 0;      // Prote√≠nas
            
            // Calcular CH4% usando la f√≥rmula del Excel
            const totalBiogas = carbohidratos + lipidos + proteinas;
            let ch4Porcentaje = 0.65; // Valor por defecto
            
            if (totalBiogas > 0) {
                ch4Porcentaje = ((proteinas * 0.71) + (lipidos * 0.68) + (carbohidratos * 0.5)) / totalBiogas;
            }
            
            // F√≥rmula corregida: KW/TN = (ST √ó SV √ó M¬≥/TN SV √ó CH4%) / Consumo CHP
            // CORREGIDO: F√≥rmula correcta KW/TN = (ST √ó SV √ó M¬≥/TN SV √ó CH4%) / Consumo CHP (CON CH4)
            const kwTn = (st * sv * m3_tnsv * ch4Porcentaje) / consumoCHP;
            
            // Actualizar CH4 calculado
            const ch4Display = row.querySelector('.ch4-calculado');
            if (ch4Display) {
                ch4Display.textContent = (ch4Porcentaje * 100).toFixed(2) + '%';
                
                // Actualizar color del CH4
                let ch4Color = '';
                if (ch4Porcentaje > 0.6) ch4Color = '#28a745';      // >60% - Verde
                else if (ch4Porcentaje > 0.5) ch4Color = '#ffc107';  // 50-60% - Amarillo
                else if (ch4Porcentaje > 0.4) ch4Color = '#fd7e14';  // 40-50% - Naranja
                else ch4Color = '#dc3545';                           // <40% - Rojo
                
                ch4Display.parentElement.style.color = ch4Color;
                ch4Display.parentElement.style.fontWeight = ch4Porcentaje > 0.6 ? 'bold' : 'normal';
            }
            
            // Actualizar KW/TN calculado
            const kwDisplay = row.querySelector('.kw-calculado');
            if (kwDisplay) {
                kwDisplay.textContent = kwTn.toFixed(4);
                
                // Actualizar color del KW/TN
                let kwColor = '';
                if (kwTn > 1.0) kwColor = '#28a745';
                else if (kwTn > 0.5) kwColor = '#ffc107';
                else if (kwTn > 0.1) kwColor = '#fd7e14';
                else kwColor = '#dc3545';
                
                kwDisplay.parentElement.style.color = kwColor;
                kwDisplay.parentElement.style.fontWeight = kwTn > 1.0 ? 'bold' : 'normal';
            }
            
            console.log(`üîÑ Recalculado para ${materialNombre} con CHP ${consumoCHP}: CH4=${(ch4Porcentaje*100).toFixed(2)}%, KW/TN=${kwTn.toFixed(4)}`);
        }
        
        // Funciones para gesti√≥n de alertas editables
        function cambiarTipoAlerta(selectElement) {
            const alertItem = selectElement.closest('.editable-alert');
            const nuevoTipo = selectElement.value;
            const icono = alertItem.querySelector('i');
            
            // Remover clases anteriores
            alertItem.classList.remove('alert-info', 'alert-success', 'alert-warning', 'alert-danger');
            alertItem.classList.add(`alert-${nuevoTipo}`);
            alertItem.setAttribute('data-alert-type', nuevoTipo);
            
            // Cambiar icono seg√∫n el tipo
            icono.className = '';
            switch(nuevoTipo) {
                case 'info':
                    icono.className = 'fas fa-info-circle mr-2';
                    break;
                case 'success':
                    icono.className = 'fas fa-check-circle mr-2';
                    break;
                case 'warning':
                    icono.className = 'fas fa-exclamation-triangle mr-2';
                    break;
                case 'danger':
                    icono.className = 'fas fa-exclamation-circle mr-2';
                    break;
            }
            
            console.log(`üîÑ Tipo de alerta cambiado a: ${nuevoTipo}`);
        }
        
        function eliminarAlerta(botonEliminar) {
            const alertItem = botonEliminar.closest('.editable-alert');
            if (confirm('¬øEst√°s seguro de que quieres eliminar esta alerta?')) {
                alertItem.remove();
                console.log('üóëÔ∏è Alerta eliminada');
            }
        }
        
        function agregarNuevaAlerta() {
            const container = document.getElementById('lista-alertas-editables');
            if (!container) {
                console.error('‚ùå No se encontr√≥ el contenedor lista-alertas-editables');
                return;
            }
            const nuevaAlerta = document.createElement('div');
            nuevaAlerta.className = 'alert-item alert-info editable-alert mb-3';
            nuevaAlerta.setAttribute('data-alert-type', 'info');
            nuevaAlerta.style.cssText = 'border: 1px solid #666; padding: 10px; border-radius: 5px;';
            
            nuevaAlerta.innerHTML = `
                <div class="d-flex justify-content-between align-items-center">
                    <div class="alert-content d-flex align-items-center">
                        <i class="fas fa-info-circle mr-2"></i>
                        <span class="alert-text" contenteditable="true" style="flex: 1;">Nueva alerta - haz clic para editar</span>
                    </div>
                    <div class="alert-controls d-flex align-items-center ml-3">
                        <select class="form-control form-control-sm alert-type-selector mr-2" onchange="cambiarTipoAlerta(this)" style="width: 120px;">
                            <option value="info" selected>Info</option>
                            <option value="success">√âxito</option>
                            <option value="warning">Advertencia</option>
                            <option value="danger">Peligro</option>
                        </select>
                        <button class="btn btn-outline-danger btn-sm" onclick="eliminarAlerta(this)" title="Eliminar">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
            
            container.appendChild(nuevaAlerta);
            
            // Enfocar el texto para editar
            const textoEditable = nuevaAlerta.querySelector('.alert-text');
            textoEditable.focus();
            
            // Seleccionar todo el texto
            if (window.getSelection && document.createRange) {
                const range = document.createRange();
                range.selectNodeContents(textoEditable);
                const sel = window.getSelection();
                sel.removeAllRanges();
                sel.addRange(range);
            }
            
            console.log('‚ûï Nueva alerta agregada');
        }
        
        function guardarAlertas() {
            const alertas = [];
            const alertasEditables = document.querySelectorAll('.editable-alert');
            
            alertasEditables.forEach(alertItem => {
                const tipo = alertItem.getAttribute('data-alert-type');
                const texto = alertItem.querySelector('.alert-text').textContent.trim();
                
                if (texto) {
                    alertas.push({
                        tipo: tipo,
                        texto: texto,
                        timestamp: new Date().toISOString()
                    });
                }
            });
            
            // Aqu√≠ podr√≠as enviar las alertas al servidor
            console.log('üíæ Alertas guardadas:', alertas);
            
            // Mostrar mensaje de confirmaci√≥n
            alert(`‚úÖ Se han guardado ${alertas.length} alertas correctamente`);
            
            // Actualizar alertas flotantes si es necesario
            actualizarAlertasFlotantes(alertas);
        }
        
        function actualizarAlertasFlotantes(alertas) {
            // Actualizar el widget flotante con las nuevas alertas
            const alertsFloatingList = document.getElementById('alerts-floating-list');
            if (alertsFloatingList && alertas.length > 0) {
                alertsFloatingList.innerHTML = '';
                
                alertas.forEach((alerta, index) => {
                    const alertId = `alert-${Date.now()}-${index}`;
                    const alertElement = document.createElement('div');
                    alertElement.className = `alert-floating-item ${alerta.tipo}`;
                    alertElement.setAttribute('data-alert-id', alertId);
                    
                    let icono = '';
                    switch(alerta.tipo) {
                        case 'info': icono = 'fa-info-circle'; break;
                        case 'success': icono = 'fa-check-circle'; break;
                        case 'warning': icono = 'fa-exclamation-triangle'; break;
                        case 'danger': icono = 'fa-exclamation-circle'; break;
                    }
                    
                    alertElement.innerHTML = `
                        <i class="fas ${icono}"></i>
                        <div class="alert-content">
                            <strong>${alerta.tipo.charAt(0).toUpperCase() + alerta.tipo.slice(1)}</strong><br>
                            <small>${alerta.texto}</small>
                        </div>
                        <button class="alert-dismiss-btn" onclick="marcarAlertaVista('${alertId}')" title="Marcar como visto">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    
                    alertsFloatingList.appendChild(alertElement);
                });
                
                // Actualizar contador
                actualizarContadorAlertas();
                
                // Mostrar panel si estaba oculto
                const alertsContainer = document.getElementById('alerts-floating');
                if (alertsContainer) {
                    alertsContainer.style.display = 'block';
                }
            }
        }
        
        // Funci√≥n para inicializar el sistema de alertas
        function inicializarSistemaAlertas() {
            console.log('üö® Inicializando sistema de alertas...');
            
            // Filtrar alertas ya vistas
            const alertasActuales = document.querySelectorAll('.alert-floating-item[data-alert-id]');
            alertasActuales.forEach(alerta => {
                const alertId = alerta.getAttribute('data-alert-id');
                if (alertasVistas.includes(alertId)) {
                    alerta.remove();
                }
            });
            
            // Actualizar contador
            actualizarContadorAlertas();
            
            // Verificar si debe ocultar panel
            verificarSiOcultarPanel();
            
            // Simular nueva alerta cada 30 segundos (para demostraci√≥n)
            setInterval(() => {
                const alertasEjemplo = [
                    { tipo: 'warning', titulo: 'Presi√≥n Alta', mensaje: 'Biodigestor 1: 1.2 bar (m√°x: 1.0 bar)', id: `alert-${Date.now()}` },
                    { tipo: 'info', titulo: 'Mantenimiento Programado', mensaje: 'Bomba B3 requiere revisi√≥n en 2 d√≠as', id: `alert-${Date.now()}-info` },
                    { tipo: 'danger', titulo: 'Temperatura Cr√≠tica', mensaje: 'Biodigestor 2: 48¬∞C (cr√≠tico > 45¬∞C)', id: `alert-${Date.now()}-danger` }
                ];
                
                // Seleccionar alerta aleatoria ocasionalmente
                if (Math.random() < 0.3) { // 30% de probabilidad
                    const alertaAleatoria = alertasEjemplo[Math.floor(Math.random() * alertasEjemplo.length)];
                    agregarNuevaAlerta(alertaAleatoria.tipo, alertaAleatoria.titulo, alertaAleatoria.mensaje, alertaAleatoria.id);
                }
            }, 30000);
        }
        
        // Funci√≥n para registrar dosificaci√≥n en la hora actual
        window.registrarDosificacionActual = function() {
            console.log('üìù Registrando dosificaci√≥n para la hora actual...');
            
            const horaActual = new Date();
            const hora = horaActual.getHours();
            const minutos = horaActual.getMinutes();
            const horaFormateada = `${hora.toString().padStart(2, '0')}:${minutos.toString().padStart(2, '0')}`;
            
            // Obtener valores actuales de la interfaz
            const solidosElement = document.getElementById('solidos-actuales');
            const liquidosElement = document.getElementById('liquidos-actuales');
            
            const solidosTexto = solidosElement?.textContent || '0 TN';
            const liquidosTexto = liquidosElement?.textContent || '0 TN';
            
            // Extraer valores num√©ricos
            const solidosValor = parseFloat(solidosTexto.replace(' TN', '')) || 0;
            const liquidosValor = parseFloat(liquidosTexto.replace(' TN', '')) || 0;
            
            const modalHtml = `
                <div class="modal fade" id="registroActualModal" tabindex="-1" role="dialog" style="z-index: 10000;">
                    <div class="modal-dialog modal-lg" role="document">
                        <div class="modal-content" style="background-color: #2c3e50; color: white; border: 1px solid #34495e;">
                            <div class="modal-header" style="border-bottom: 1px solid #34495e;">
                                <h5 class="modal-title">
                                    <i class="fas fa-clock"></i> Registrar Dosificaci√≥n - ${horaFormateada}
                                </h5>
                                <button type="button" class="btn-close btn-close-white" onclick="cerrarModal('registroActualModal')" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer;">
                                    &times;
                                </button>
                            </div>
                            <div class="modal-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6 style="color: #00d4ff;">üíß Materiales L√≠quidos</h6>
                                        <div class="form-group">
                                            <label>Cantidad Total (TN)</label>
                                            <input type="number" class="form-control" id="registro-liquidos" value="${liquidosValor}" step="0.01" min="0">
                                        </div>
                                        <div class="form-group">
                                            <label>Observaciones L√≠quidos</label>
                                            <textarea class="form-control" id="obs-liquidos" rows="2" placeholder="Ej: Pur√≠n de cerdo, estado normal"></textarea>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <h6 style="color: #8B4513;">üü§ Materiales S√≥lidos</h6>
                                        <div class="form-group">
                                            <label>Cantidad Total (TN)</label>
                                            <input type="number" class="form-control" id="registro-solidos" value="${solidosValor}" step="0.01" min="0">
                                        </div>
                                        <div class="form-group">
                                            <label>Observaciones S√≥lidos</label>
                                            <textarea class="form-control" id="obs-solidos" rows="2" placeholder="Ej: Rumen, ma√≠z molido"></textarea>
                                        </div>
                                    </div>
                                </div>
                                <div class="row mt-3">
                                    <div class="col-12">
                                        <div class="form-group">
                                            <label>Observaciones Generales</label>
                                            <textarea class="form-control" id="obs-generales" rows="2" placeholder="Notas adicionales sobre la dosificaci√≥n"></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer" style="border-top: 1px solid #34495e;">
                                <button type="button" class="btn btn-secondary" onclick="cerrarModal('registroActualModal')">Cancelar</button>
                                <button type="button" class="btn btn-success" onclick="confirmarRegistroActual('${hora}')">
                                    <i class="fas fa-save"></i> Registrar Dosificaci√≥n
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remover modal anterior si existe
            const modalAnterior = document.getElementById('registroActualModal');
            if (modalAnterior) {
                modalAnterior.remove();
            }
            
            // Agregar modal al DOM
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // Mostrar modal
            const modal = new bootstrap.Modal(document.getElementById('registroActualModal'));
            modal.show();
        };
        
        // Funci√≥n para confirmar el registro actual
        window.confirmarRegistroActual = async function(hora) {
            console.log('üíæ Confirmando registro para hora:', hora);
            
            const liquidos = parseFloat(document.getElementById('registro-liquidos').value) || 0;
            const solidos = parseFloat(document.getElementById('registro-solidos').value) || 0;
            const obsLiquidos = document.getElementById('obs-liquidos').value;
            const obsSolidos = document.getElementById('obs-solidos').value;
            const obsGenerales = document.getElementById('obs-generales').value;
            
            try {
                const response = await fetch('/registrar_dosificacion_horaria', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        hora: parseInt(hora),
                        tn_liquidos: liquidos,
                        tn_solidos: solidos,
                        observaciones_liquidos: obsLiquidos,
                        observaciones_solidos: obsSolidos,
                        observaciones_generales: obsGenerales,
                        timestamp: new Date().toISOString()
                    })
                });
                
                console.log('üì° Respuesta del servidor:', response.status, response.statusText);
                
                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status} - ${response.statusText}`);
                }
                
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    console.error('‚ùå Respuesta no es JSON:', text);
                    throw new Error('El servidor no devolvi√≥ JSON v√°lido');
                }
                
                const data = await response.json();
                console.log('üìä Datos recibidos:', data);
                
                if (data.status === 'success') {
                    alert('‚úÖ Dosificaci√≥n registrada correctamente');
                    cerrarModal('registroActualModal');
                    // Actualizar valores en la interfaz
                    document.getElementById('solidos-actuales').textContent = `${solidos.toFixed(2)} TN`;
                    document.getElementById('liquidos-actuales').textContent = `${liquidos.toFixed(2)} TN`;
                } else {
                    throw new Error(data.mensaje || 'Error registrando dosificaci√≥n');
                }
            } catch (error) {
                console.error('‚ùå Error registrando dosificaci√≥n:', error);
                alert('‚ùå Error: ' + error.message);
            }
        };
        
        // Funci√≥n para actualizar la hora actual con segundos
        function actualizarHoraActual() {
            const ahora = new Date();
            const horas = ahora.getHours().toString().padStart(2, '0');
            const minutos = ahora.getMinutes().toString().padStart(2, '0');
            const segundos = ahora.getSeconds().toString().padStart(2, '0');
            const horaDisplay = document.getElementById('hora-actual-display');
            
            if (horaDisplay) {
                horaDisplay.textContent = `${horas}:${minutos}:${segundos}`;
                console.log(`üïê Reloj actualizado: ${horas}:${minutos}:${segundos}`);
            } else {
                console.warn('‚ö†Ô∏è Elemento hora-actual-display no encontrado');
            }
        }
        
        // Variables globales para gr√°ficos
        let graficoTemperaturas = null;
        let graficoNiveles = null;
        
        // FUNCI√ìN PRINCIPAL: Actualizar TODOS los sensores en tiempo real
        async function actualizarTodosLosSensoresReales() {
            console.log('üîÑ [TIEMPO REAL] Actualizando TODOS los sensores...');
            console.log('üïê Timestamp de inicio:', new Date().toLocaleTimeString());
            
            try {
                // 1. Actualizar KPIs principales (energ√≠a y metano)
                if (typeof actualizarKPIsReales === 'function') {
                    await actualizarKPIsReales();
                }
                
                // 2. Actualizar temperaturas y niveles
                if (typeof actualizarTemperaturasNiveles === 'function') {
                    await actualizarTemperaturasNiveles();
                }
                
                // 3. Actualizar calidad de gas
                if (typeof actualizarCalidadGasMotor === 'function') {
                    await actualizarCalidadGasMotor();
                }
                if (typeof actualizarCalidadGasBios === 'function') {
                    await actualizarCalidadGasBios();
                }
                
                // 4. Actualizar sensores de sistemas auxiliares
                if (typeof cargarSensoresSistemas === 'function') {
                    await cargarSensoresSistemas();
                }
                
                // 5. Actualizar sensores espec√≠ficos adicionales
                await actualizarSensoresEspecificosReales();
                
                console.log('‚úÖ [TIEMPO REAL] Todos los sensores actualizados correctamente');
                
            } catch (error) {
                console.error('‚ùå [TIEMPO REAL] Error actualizando sensores:', error);
            }
        }
        
        // Funci√≥n para actualizar sensores espec√≠ficos con datos reales
        async function actualizarSensoresEspecificosReales() {
            try {
                console.log('üîÑ Actualizando sensores espec√≠ficos con datos reales...');
                
                // Actualizar temperaturas (usando endpoints que funcionan)
                const temp1Response = await fetch('/temperatura_biodigestor_1');
                const temp1Data = await temp1Response.json();
                if (temp1Data.estado === 'ok') {
                    actualizarElementoSensorReal('temp-b1', temp1Data, '¬∞C');
                }
                
                const temp2Response = await fetch('/temperatura_biodigestor_2');
                const temp2Data = await temp2Response.json();
                if (temp2Data.estado === 'ok') {
                    actualizarElementoSensorReal('temp-b2', temp2Data, '¬∞C');
                }
                
                // Actualizar calidad de gas
                const calidad1Response = await fetch('/calidad_gas_bio1');
                const calidad1Data = await calidad1Response.json();
                if (calidad1Data.estado === 'ok') {
                    actualizarElementoSensorReal('calidad-gas-b1', calidad1Data, 'varios');
                }
                
                const calidad2Response = await fetch('/calidad_gas_bio2');
                const calidad2Data = await calidad2Response.json();
                if (calidad2Data.estado === 'ok') {
                    actualizarElementoSensorReal('calidad-gas-b2', calidad2Data, 'varios');
                }
                
                // Solo usar datos reales del servidor - no generar datos simulados
                console.log('‚úÖ Solo usando datos reales del servidor - sin datos simulados');
                
                console.log('‚úÖ Sensores espec√≠ficos actualizados con datos realistas');
                
            } catch (error) {
                console.error('‚ùå Error actualizando sensores espec√≠ficos:', error);
            }
        }
        
        
        // Funci√≥n auxiliar para actualizar elementos con datos reales
        function actualizarElementoSensorReal(elementId, data, unidad) {
            const elemento = document.getElementById(elementId);
            if (!elemento) {
                console.warn(`‚ö†Ô∏è Elemento ${elementId} no encontrado`);
                return;
            }
            
            console.log(`üîç Actualizando ${elementId} con datos:`, data);
            
            if (data.estado === 'ok' && data.valor !== null && data.valor !== undefined) {
                const valor = parseFloat(data.valor);
                const timestamp = data.fecha_hora ? new Date(data.fecha_hora).toLocaleString('es-ES') : 'Sin datos';
                
                // Usar la unidad del sensor si est√° disponible, sino usar la pasada como par√°metro
                const unidadFinal = data.unidad || unidad;
                
                // Para elementos que solo muestran el valor
                if (elemento.tagName === 'SPAN' && elemento.classList.contains('metric-value')) {
                    elemento.textContent = `${valor.toFixed(2)}${unidadFinal}`;
                    elemento.title = `√öltima lectura: ${timestamp}`;
                } else {
                    elemento.innerHTML = `
                        <span class="metric-value text-success">${valor.toFixed(2)}${unidadFinal}</span>
                        <br><small class="text-muted">${timestamp}</small>
                    `;
                }
                
                console.log(`‚úÖ ${elementId} actualizado: ${valor.toFixed(2)}${unidadFinal}`);
            } else {
                console.warn(`‚ö†Ô∏è ${elementId} - Datos no v√°lidos:`, data);
                // Para elementos que solo muestran el valor
                if (elemento.tagName === 'SPAN' && elemento.classList.contains('metric-value')) {
                    elemento.textContent = `-- ${unidad}`;
                    elemento.title = 'Sin datos disponibles';
                } else {
                    elemento.innerHTML = `
                        <span class="metric-value text-danger">-- ${unidad}</span>
                        <br><small class="text-muted">Sin datos</small>
                    `;
                }
                console.warn(`‚ö†Ô∏è ${elementId} sin datos: ${data.estado}`);
            }
        }
        
        // Inicializar gr√°ficos al cargar la p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            inicializarGraficos();
            cargarStockActual();
            cargarSensoresSistemas();
            cargarMaterialesBase();
            cargarGestionMateriales();
            initializeAccordion(); // Inicializar acorde√≥n
            inicializarCalculadora();
            
            // üîÑ INICIAR ACTUALIZACI√ìN AUTOM√ÅTICA DEL STOCK Y TABLA DE GESTI√ìN
            console.log('üîÑ Iniciando actualizaci√≥n autom√°tica del stock y tabla de gesti√≥n...');
            
            // Primera actualizaci√≥n inmediata del stock
            cargarStockActual();
            
            // Configurar actualizaci√≥n autom√°tica del stock cada 3 segundos
            setInterval(cargarStockActual, 3000);
            console.log('‚úÖ Actualizaci√≥n autom√°tica del stock iniciada (cada 3 segundos)');
            
            // Tambi√©n mantener actualizarTablas para otras funcionalidades
            if (typeof actualizarTablas === 'function') {
                setInterval(actualizarTablas, 5000); // Cada 5 segundos para otras tablas
                console.log('‚úÖ Actualizaci√≥n autom√°tica de otras tablas iniciada (cada 5 segundos)');
            }
            
            // üîÑ INICIAR CARGA INICIAL DE LA TABLA DE GESTI√ìN DE MATERIALES
            if (typeof cargarGestionMaterialesEditable === 'function') {
                // Solo carga inicial, sin actualizaci√≥n autom√°tica
                cargarGestionMaterialesEditable();
                console.log('‚úÖ Gesti√≥n de materiales cargada (sin actualizaci√≥n autom√°tica)');
            } else {
                console.warn('‚ö†Ô∏è Funci√≥n cargarGestionMaterialesEditable no encontrada');
            }
            
            // NUEVAS FUNCIONES: Actualizar KPIs reales inmediatamente
            actualizarKPIsReales();
            actualizarPrediccionesIA();
            
            // Inicializar dosificaci√≥n diaria
            calcularDosificacionDiaria(28800, 65);
            
        
        

        // FUNCIONES DE CALIDAD DE GAS: Cargar inmediatamente
        actualizarCalidadGasMotor();
        actualizarCalidadGasBios();
        
        // NUEVO: Actualizar TODOS los sensores inmediatamente y luego cada 3 segundos
        actualizarTodosLosSensoresReales(); // Ejecutar inmediatamente
        setInterval(actualizarTodosLosSensoresReales, 3000); // Luego cada 3 segundos
            
            // Actualizar relojes cada segundo para mostrar segundos corriendo
            setInterval(actualizarRelojes, 1000);
            
            // Actualizar predicciones IA cada 2 minutos
            setInterval(actualizarPrediccionesIA, 120000);
            
            // Verificar alertas cada 10 segundos
            setInterval(mostrarAlertasSiHayNuevas, 10000);
            // Verificar alertas flotantes cada 5 segundos
            setInterval(mostrarAlertasFlotantesSiEsCritico, 5000);
            // Actualizar inmediatamente
            actualizarTemperaturasNiveles();
            actualizarHoraActual();
            // Actualizar hora cada segundo para mostrar segundos corriendo
            setInterval(actualizarHoraActual, 1000);
            // Inicializar sistema de alertas
            inicializarSistemaAlertas();
            
            // PRUEBA INICIAL DE SENSORES
            console.log('üß™ === INICIANDO PRUEBA INICIAL DE SENSORES ===');
            setTimeout(() => {
                probarSensores();
            }, 2000); // Esperar 2 segundos para que todo se cargue
        });
        
        function inicializarGraficos() {
            // Gr√°fico de Temperaturas
            const ctxTemp = document.getElementById('grafico-temperaturas').getContext('2d');
            graficoTemperaturas = new Chart(ctxTemp, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Biodigestor 1',
                            data: [],
                            borderColor: '#ff6b6b',
                            backgroundColor: 'rgba(255, 107, 107, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: 'Biodigestor 2',
                            data: [],
                            borderColor: '#4ecdc4',
                            backgroundColor: 'rgba(78, 205, 196, 0.1)',
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: '#fff' }
                        },
                        title: {
                            display: true,
                            text: 'Temperaturas en Tiempo Real',
                            color: '#fff'
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#fff' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        y: {
                            ticks: { color: '#fff' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        }
                    }
                }
            });
            
            // Gr√°fico de Niveles
            const ctxNiveles = document.getElementById('grafico-niveles').getContext('2d');
            graficoNiveles = new Chart(ctxNiveles, {
                type: 'bar',
                data: {
                    labels: ['Biodigestor 1', 'Biodigestor 2'],
                    datasets: [
                        {
                            label: 'Nivel (%)',
                            data: [0, 0],
                            backgroundColor: ['#ff6b6b', '#4ecdc4'],
                            borderColor: ['#ff6b6b', '#4ecdc4'],
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: '#fff' }
                        },
                        title: {
                            display: true,
                            text: 'Niveles de Biodigestores',
                            color: '#fff'
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#fff' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        y: {
                            ticks: { color: '#fff' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            min: 0,
                            max: 100
                        }
                    }
                }
            });
        }
        
        // Actualizar temperaturas y niveles
        async function actualizarTemperaturasNiveles() {
            try {
                console.log('üå°Ô∏è Actualizando temperaturas y niveles autom√°ticamente...');
                
                // Actualizar fecha y hora de actualizaci√≥n
                const ahora = new Date();
                const fechaHora = ahora.toLocaleString('es-ES', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: false
                });
                
                console.log(`üìÖ Fecha/hora de actualizaci√≥n: ${fechaHora}`);
                
                // Actualizar fechas en las tarjetas
                const tempFechaElement = document.getElementById('temperaturas-fecha-hora');
                const nivelFechaElement = document.getElementById('niveles-fecha-hora');
                if (tempFechaElement) {
                    tempFechaElement.textContent = fechaHora;
                    console.log('‚úÖ Fecha actualizada en tarjeta temperaturas');
                } else {
                    console.warn('‚ö†Ô∏è Elemento temperaturas-fecha-hora no encontrado');
                }
                if (nivelFechaElement) {
                    nivelFechaElement.textContent = fechaHora;
                    console.log('‚úÖ Fecha actualizada en tarjeta niveles');
                } else {
                    console.warn('‚ö†Ô∏è Elemento niveles-fecha-hora no encontrado');
                }
                
                // CONSULTA DIRECTA A LOS SENSORES ESPEC√çFICOS
                console.log('üì° Consultando sensores espec√≠ficos...');
                
                // Temperatura Biodigestor 1 (040TT01)
                const temp1Response = await fetch('/temperatura_biodigestor_1');
                const temp1Data = await temp1Response.json();
                console.log('üå°Ô∏è Respuesta 040TT01:', temp1Data);
                
                // Temperatura Biodigestor 2 (050TT01)  
                const temp2Response = await fetch('/temperatura_biodigestor_2');
                const temp2Data = await temp2Response.json();
                console.log('üå°Ô∏è Respuesta 050TT01:', temp2Data);
                
                // Nivel Biodigestor 1 (040LT01)
                const nivel1Response = await fetch('/040lt01');
                const nivel1Data = await nivel1Response.json();
                console.log('üìä Respuesta 040LT01:', nivel1Data);
                
                // Nivel Biodigestor 2 (050LT01)
                const nivel2Response = await fetch('/050lt01');
                const nivel2Data = await nivel2Response.json();
                console.log('üìä Respuesta 050LT01:', nivel2Data);
                
                // ACTUALIZAR TARJETAS CON DATOS REALES
                if (temp1Data && temp1Data.valor !== undefined) {
                    // Actualizar todos los elementos de temperatura BIO 1
                    const temp1Elements = document.querySelectorAll('#temp-b1');
                    temp1Elements.forEach(element => {
                        element.textContent = `${temp1Data.valor}${temp1Data.unidad || '¬∞C'}`;
                        console.log('‚úÖ temp-b1 actualizado:', element.textContent);
                    });
                }
                
                if (temp2Data && temp2Data.valor !== undefined) {
                    // Actualizar todos los elementos de temperatura BIO 2
                    const temp2Elements = document.querySelectorAll('#temp-b2');
                    temp2Elements.forEach(element => {
                        element.textContent = `${temp2Data.valor}${temp2Data.unidad || '¬∞C'}`;
                        console.log('‚úÖ temp-b2 actualizado:', element.textContent);
                    });
                }
                
                if (nivel1Data && nivel1Data.valor !== undefined) {
                    // Actualizar todos los elementos de nivel BIO 1
                    const nivel1Elements = document.querySelectorAll('#nivel-b1, #nivel-b1-main');
                    nivel1Elements.forEach(element => {
                        element.textContent = `${nivel1Data.valor}${nivel1Data.unidad || '%'}`;
                        console.log('‚úÖ nivel-b1 actualizado:', element.textContent);
                    });
                    
                    // Actualizar barras de progreso
                    const progress1Elements = document.querySelectorAll('#progress-b1, #progress-b1-main');
                    progress1Elements.forEach(progress => {
                        progress.style.width = Math.min(nivel1Data.valor, 100) + '%';
                    });
                }
                
                if (nivel2Data && nivel2Data.valor !== undefined) {
                    // Actualizar todos los elementos de nivel BIO 2
                    const nivel2Elements = document.querySelectorAll('#nivel-b2, #nivel-b2-main');
                    nivel2Elements.forEach(element => {
                        element.textContent = `${nivel2Data.valor}${nivel2Data.unidad || '%'}`;
                        console.log('‚úÖ nivel-b2 actualizado:', element.textContent);
                    });
                    
                    // Actualizar barras de progreso
                    const progress2Elements = document.querySelectorAll('#progress-b2, #progress-b2-main');
                    progress2Elements.forEach(progress => {
                        progress.style.width = Math.min(nivel2Data.valor, 100) + '%';
                    });
                }
                
                // ACTUALIZAR GR√ÅFICOS CON LOS MISMOS DATOS
                const temp1Valor = temp1Data?.valor || 0;
                const temp2Valor = temp2Data?.valor || 0;
                const nivel1Valor = nivel1Data?.valor || 0;
                const nivel2Valor = nivel2Data?.valor || 0;
                
                console.log('üìä Valores para gr√°ficos:', { temp1Valor, temp2Valor, nivel1Valor, nivel2Valor });
                actualizarGraficos(temp1Valor, temp2Valor, nivel1Valor, nivel2Valor);
                
                console.log('‚úÖ === ACTUALIZACI√ìN COMPLETADA ===');
                return;
                
                // Fallback: usar endpoints individuales si no hay datos de sensores cr√≠ticos
                const [nivel1, nivel2] = await Promise.all([
                    fetch('/040lt01').then(r => r.json()),
                    fetch('/050lt01').then(r => r.json())
                ]);

                // Funci√≥n frescuraBadge eliminada - ya no se usan badges "Reciente"

                if (nivel1 && nivel1.valor !== undefined) {
                    const nivel = parseFloat(nivel1.valor) || 0;
                    const label1 = document.getElementById('nivel-b1');
                    label1.textContent = nivel.toFixed(1) + '%';
                    document.getElementById('progress-b1').style.width = Math.min(nivel, 100) + '%';
                    if (nivel1.fecha_hora) label1.title = `√öltima lectura: ${nivel1.fecha_hora}`;
                    label1.innerHTML = `${nivel.toFixed(1)}%`;
                }
                
                if (nivel2 && nivel2.valor !== undefined) {
                    const nivel = parseFloat(nivel2.valor) || 0;
                    const label2 = document.getElementById('nivel-b2');
                    label2.textContent = nivel.toFixed(1) + '%';
                    document.getElementById('progress-b2').style.width = Math.min(nivel, 100) + '%';
                    if (nivel2.fecha_hora) label2.title = `√öltima lectura: ${nivel2.fecha_hora}`;
                    label2.innerHTML = `${nivel.toFixed(1)}%`;
                }
                
                // Temperaturas
                const [temp1, temp2] = await Promise.all([
                    fetch('/temperatura_biodigestor_1').then(r => r.json()),
                    fetch('/temperatura_biodigestor_2').then(r => r.json())
                ]);
                
                if (temp1 && temp1.valor !== undefined) {
                    const temp = parseFloat(temp1.valor) || 0;
                    const t1 = document.getElementById('temp-b1');
                    t1.textContent = temp.toFixed(1) + '¬∞C';
                    if (temp1.fecha_hora) t1.title = `√öltima lectura: ${temp1.fecha_hora}`;
                    t1.innerHTML = `${temp.toFixed(1)}¬∞C`;
                }
                
                if (temp2 && temp2.valor !== undefined) {
                    const temp = parseFloat(temp2.valor) || 0;
                    const t2 = document.getElementById('temp-b2');
                    t2.textContent = temp.toFixed(1) + '¬∞C';
                    if (temp2.fecha_hora) t2.title = `√öltima lectura: ${temp2.fecha_hora}`;
                    t2.innerHTML = `${temp.toFixed(1)}¬∞C`;
                }
                
                // Actualizar gr√°ficos
                actualizarGraficos();
                
            } catch (error) {
                console.error('Error actualizando temperaturas y niveles:', error);
            }
        }

        async function actualizarCalidadGasMotor() {
            try {
                // Usar endpoint centralizado para datos sincronizados
                console.log('üîÑ Actualizando calidad de gas motor...');
                const response = await fetch('/datos_sincronizados?t=' + Date.now());
                const data = await response.json();
                
                console.log('üìä Respuesta datos sincronizados:', data);
                
                if (data.estado === 'conectado' && data.motor) {
                    // Actualizar datos del motor
                    const motor = data.motor;
                    document.getElementById('ch4-motor').innerHTML = `${motor.ch4}%`;
                    document.getElementById('h2s-motor').innerHTML = `${motor.h2s} ppm`;
                    document.getElementById('o2-motor').innerHTML = `${motor.o2}%`;
                    document.getElementById('co2-motor').innerHTML = `${motor.co2}%`;
                    
                    // Actualizar fecha con indicador de frescura
                    const fechaEl = document.getElementById('gas-motor-fecha');
                    if (data.fecha_ultima_lectura) {
                        const fecha = new Date(data.fecha_ultima_lectura);
                        const tiempoTranscurrido = data.tiempo_transcurrido_segundos;
                        const esReciente = data.es_reciente;
                        
                        // Sin indicadores de frescura para evitar movimiento de tarjetas
                        let indicadorFrescura = '';
                        
                        // Ajustar zona horaria: restar 3 horas (UTC a hora local Argentina)
                        const fechaAjustada = new Date(fecha);
                        fechaAjustada.setHours(fechaAjustada.getHours() - 3);
                        fechaEl.innerHTML = `${fechaAjustada.toLocaleString('es-ES', {
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit',
                            hour: '2-digit',
                            minute: '2-digit',
                            second: '2-digit',
                            hour12: false
                        })}${indicadorFrescura}`;
                    }
                }
            } catch (e) { 
                console.warn('No se pudo actualizar calidad de gas motor', e); 
            }
        }

        async function actualizarCalidadGasBios() {
            try {
                // Usar endpoint centralizado para datos sincronizados
                console.log('üîÑ Actualizando calidad de gas biodigestores...');
                const response = await fetch('/datos_sincronizados?t=' + Date.now());
                const data = await response.json();
                
                console.log('üìä Respuesta datos sincronizados para bios:', data);
                
                if (data.estado === 'conectado') {
                    // Actualizar Biodigestor 1
                    if (data.bio1) {
                        const bio1 = data.bio1;
                        document.getElementById('bio1-ch4').innerHTML = `${bio1.ch4}%`;
                        document.getElementById('bio1-h2s').innerHTML = `${bio1.h2s} ppm`;
                        document.getElementById('bio1-co2').textContent = `${bio1.co2}%`;
                        document.getElementById('bio1-o2').textContent = `${bio1.o2}%`;
                        
                        // Actualizar fecha con indicador de frescura
                        const fechaEl1 = document.getElementById('bio1-fecha');
                        if (data.fecha_ultima_lectura) {
                            const fecha = new Date(data.fecha_ultima_lectura);
                            const tiempoTranscurrido = data.tiempo_transcurrido_segundos;
                            
                            // Sin indicadores de frescura para evitar movimiento de tarjetas
                            let indicadorFrescura = '';
                            
                            // Ajustar zona horaria: restar 3 horas (UTC a hora local Argentina)
                            const fechaAjustada1 = new Date(fecha);
                            fechaAjustada1.setHours(fechaAjustada1.getHours() - 3);
                            fechaEl1.innerHTML = `${fechaAjustada1.toLocaleString('es-ES', {
                                year: 'numeric',
                                month: '2-digit',
                                day: '2-digit',
                                hour: '2-digit',
                                minute: '2-digit',
                                second: '2-digit',
                                hour12: false
                            })}${indicadorFrescura}`;
                        }
                    }
                    
                    // Actualizar Biodigestor 2
                    if (data.bio2) {
                        const bio2 = data.bio2;
                        document.getElementById('bio2-ch4').innerHTML = `${bio2.ch4}%`;
                        document.getElementById('bio2-h2s').innerHTML = `${bio2.h2s} ppm`;
                        document.getElementById('bio2-co2').textContent = `${bio2.co2}%`;
                        document.getElementById('bio2-o2').textContent = `${bio2.o2}%`;
                        
                        // Actualizar fecha con indicador de frescura
                        const fechaEl2 = document.getElementById('bio2-fecha');
                        if (data.fecha_ultima_lectura) {
                            const fecha = new Date(data.fecha_ultima_lectura);
                            const tiempoTranscurrido = data.tiempo_transcurrido_segundos;
                            
                            // Sin indicadores de frescura para evitar movimiento de tarjetas
                            let indicadorFrescura = '';
                            
                            // Ajustar zona horaria: restar 3 horas (UTC a hora local Argentina)
                            const fechaAjustada2 = new Date(fecha);
                            fechaAjustada2.setHours(fechaAjustada2.getHours() - 3);
                            fechaEl2.innerHTML = `${fechaAjustada2.toLocaleString('es-ES', {
                                year: 'numeric',
                                month: '2-digit',
                                day: '2-digit',
                                hour: '2-digit',
                                minute: '2-digit',
                                second: '2-digit',
                                hour12: false
                            })}${indicadorFrescura}`;
                        }
                    }
                }
            } catch (e) { 
                console.warn('No se pudo actualizar calidad de gas por biodigestor', e); 
            }
        }

        // Extender frescura a presiones y flujos
        async function actualizarPresionesYFlujos() {
            try {
                const [p1, p2] = await Promise.all([
                    fetch('/040pt01').then(r => r.json()).catch(() => null),
                    fetch('/050pt01').then(r => r.json()).catch(() => null)
                ]);
                const badge = (d) => d && d.es_reciente === false ? ' <span class="badge bg-danger">Dato desactualizado</span>' : (d && d.es_reciente === true ? ' <span class="badge bg-success">Reciente</span>' : '');
                if (p1 && p1.valor !== undefined) {
                    const span = document.getElementById('presion-b1');
                    const v = parseFloat(p1.valor) || 0;
                    span.textContent = v.toFixed(2) + ' bar';
                    if (p1.fecha_hora) span.title = `√öltima lectura: ${p1.fecha_hora}`;
                    span.innerHTML = `${v.toFixed(2)} bar`;
                }
                if (p2 && p2.valor !== undefined) {
                    const span = document.getElementById('presion-b2');
                    const v = parseFloat(p2.valor) || 0;
                    span.textContent = v.toFixed(2) + ' bar';
                    if (p2.fecha_hora) span.title = `√öltima lectura: ${p2.fecha_hora}`;
                    span.innerHTML = `${v.toFixed(2)} bar`;
                }
            } catch (e) { console.warn('No se pudieron actualizar presiones', e); }
        }
        
        function actualizarGraficos(temp1Valor = null, temp2Valor = null, nivel1Valor = null, nivel2Valor = null) {
            console.log('üìä actualizarGraficos llamada con:', { temp1Valor, temp2Valor, nivel1Valor, nivel2Valor });
            
            // Actualizar gr√°fico de temperaturas
            if (graficoTemperaturas) {
            const now = new Date().toLocaleTimeString();
            graficoTemperaturas.data.labels.push(now);
            
                // Usar valores pasados como par√°metro o leer de elementos HTML
                const temp1 = temp1Valor !== null ? temp1Valor : parseFloat(document.getElementById('temp-b1')?.textContent) || 0;
                const temp2 = temp2Valor !== null ? temp2Valor : parseFloat(document.getElementById('temp-b2')?.textContent) || 0;
                
                console.log('üìä Valores para gr√°fico:', { temp1, temp2 });
            
            graficoTemperaturas.data.datasets[0].data.push(temp1);
            graficoTemperaturas.data.datasets[1].data.push(temp2);
            
            // Mantener solo √∫ltimos 20 puntos
            if (graficoTemperaturas.data.labels.length > 20) {
                graficoTemperaturas.data.labels.shift();
                graficoTemperaturas.data.datasets[0].data.shift();
                graficoTemperaturas.data.datasets[1].data.shift();
            }
            
            graficoTemperaturas.update('none');
            console.log('üå°Ô∏è Gr√°fico de temperaturas actualizado con:', { temp1, temp2 });
            }
            
            // Actualizar gr√°fico de niveles
            if (graficoNiveles) {
                // Usar valores pasados como par√°metro o leer de elementos HTML
                const nivel1 = nivel1Valor !== null ? nivel1Valor : parseFloat(document.getElementById('nivel-b1')?.textContent) || 0;
                const nivel2 = nivel2Valor !== null ? nivel2Valor : parseFloat(document.getElementById('nivel-b2')?.textContent) || 0;
            
            graficoNiveles.data.datasets[0].data = [nivel1, nivel2];
            graficoNiveles.update('none');
            console.log('üìä Gr√°fico de niveles actualizado con:', { nivel1, nivel2 });
            }
        }
        
        // Cargar stock actual
        async function cargarStockActual() {
            console.log('üîÑ Iniciando carga de stock...');
            try {
                const response = await fetch('/stock_actual');
                console.log('üì° Respuesta del servidor recibida:', response.status);
                
                const data = await response.json();
                console.log('üìä Datos del stock:', data);
                
                if (data.status === 'success' && data.materiales) {
                    const stockList = document.getElementById('stock-list');
                    console.log('üìã Elemento stock-list encontrado:', !!stockList);
                    
                    let html = '';
                    const stockEntries = Object.entries(data.materiales);
                    console.log('üè≠ Materiales en stock:', stockEntries.length);
                    
                    stockEntries.forEach(([material, info]) => {
                        const cantidad = info.total_tn || info.cantidad_tn || info.cantidad || 0;
                        const st = info.st_porcentaje || (info.st_usado ? info.st_usado * 100 : 0);
                        
                        html += `
                            <div class="metric">
                                <span class="metric-label">${material}</span>
                                <span class="metric-value">${cantidad.toFixed(1)} TN <small>ST ${st.toFixed(1)}%</small></span>
                            </div>
                        `;
                    });
                    
                    if (stockList) {
                        stockList.innerHTML = html || '<div class="text-center text-muted">No hay stock disponible</div>';
                        console.log('‚úÖ Stock actualizado en el DOM');
                    } else {
                        console.warn('‚ö†Ô∏è Elemento stock-list no encontrado, intentando crear...');
                        // Intentar crear el elemento si no existe
                        const stockContainer = document.querySelector('.stock-container') || document.querySelector('#card-stock-actual');
                        if (stockContainer) {
                            const newStockList = document.createElement('div');
                            newStockList.id = 'stock-list';
                            newStockList.innerHTML = html || '<div class="text-center text-muted">No hay stock disponible</div>';
                            stockContainer.appendChild(newStockList);
                            console.log('‚úÖ Elemento stock-list creado din√°micamente');
                        }
                    }
                } else {
                    console.error('‚ùå Respuesta del servidor inv√°lida:', data);
                    throw new Error(data.error || data.mensaje || 'Error cargando stock');
                }
            } catch (error) {
                console.error('‚ùå Error cargando stock:', error);
                const stockList = document.getElementById('stock-list');
                if (stockList) {
                    stockList.innerHTML = '<div class="text-center text-danger">Error cargando stock: ' + error.message + '</div>';
                }
            }
        }
        
        // Cargar sensores de sistemas auxiliares
        async function cargarSensoresSistemas() {
            try {
                console.log('üîÑ Cargando sensores de sistemas auxiliares...');
                const response = await fetch('/sensores_criticos_resumen');
                const data = await response.json();
                
                console.log('üì° Datos recibidos:', data);
                console.log('üìä Sensores disponibles:', Object.keys(data.sensores || {}));
                
                if (data && data.sensores) {
                    // Verificar sensores espec√≠ficos
                    const sensores060 = Object.keys(data.sensores).filter(tag => tag.startsWith('060'));
                    const sensores070 = Object.keys(data.sensores).filter(tag => tag.startsWith('070'));
                    console.log('üîß Sensores 060 (Bombas):', sensores060);
                    console.log('üå°Ô∏è Sensores 070 (Agua):', sensores070);
                    
                    console.log('üìä Actualizando Sala de Bombas (060)...');
                    actualizarSensoresSistema('bombas', data.sensores, '060');
                    
                    console.log('üå°Ô∏è Actualizando Agua Caliente (070)...');
                    actualizarSensoresSistema('agua', data.sensores, '070');
                    
                    console.log('‚öôÔ∏è Actualizando Otros Sistemas...');
                    actualizarOtrosSistemas(data.sensores);
                    
                    // Actualizar tambi√©n temperaturas y niveles autom√°ticamente
                    actualizarTemperaturasNiveles();
                } else {
                    console.warn('‚ö†Ô∏è No se encontraron datos de sensores');
                }
            } catch (error) {
                console.error('‚ùå Error cargando sensores de sistemas:', error);
            }
        }
        
        // Funci√≥n para actualizar sistemas auxiliares
        function actualizarSensoresSistema(sistemaId, sensoresData, prefijo) {
            console.log(`üîß Actualizando sistema ${sistemaId} con prefijo ${prefijo}`);
            const container = document.getElementById(`sensores-${sistemaId}`);
            if (!container) {
                console.warn(`‚ùå No se encontr√≥ el contenedor sensores-${sistemaId}`);
                return;
            }
            
            console.log(`‚úÖ Contenedor encontrado: sensores-${sistemaId}`);
            let html = '';
            let encontrados = 0;
            
            Object.entries(sensoresData).forEach(([tag, sensor]) => {
                if (tag.startsWith(prefijo)) {
                    encontrados++;
                    console.log(`üìä Sensor encontrado: ${tag} = ${sensor.valor} ${sensor.unidad}`);
                    const estadoClass = sensor.estado === 'ALERTA' ? 'warning' : 
                                       sensor.estado === 'CRITICO' ? 'danger' : 'success';
                    const timestamp = sensor.fecha_hora ? (() => {
                        const fecha = new Date(sensor.fecha_hora);
                        // Ajustar zona horaria: restar 3 horas (UTC a hora local Argentina)
                        fecha.setHours(fecha.getHours() - 3);
                        return fecha.toLocaleString('es-ES');
                    })() : 'Sin datos';
                    
                    // Cambiar nombre espec√≠fico para el sensor de flujo
                    let nombreSensor = sensor.nombre || tag;
                    if (tag.includes('060FIT01') || nombreSensor.toLowerCase().includes('flujo')) {
                        nombreSensor = 'Flujo de Digestato';
                    }
                    
                    html += `
                        <div class="metric">
                            <span class="metric-label">${nombreSensor}</span>
                            <span class="metric-value text-${estadoClass}">${sensor.valor} ${sensor.unidad}<br><small>Fecha y hora de actualizaci√≥n del dato: ${timestamp}</small></span>
                        </div>
                    `;
                }
            });
            
            console.log(`üìà Total sensores encontrados para ${sistemaId}: ${encontrados}`);
            
            if (encontrados === 0) {
                html = '<div class="text-center text-muted">No hay sensores disponibles</div>';
            }
            
            container.innerHTML = html;
        }
        

        // Funci√≥n para actualizar otros sistemas
        function actualizarOtrosSistemas(sensoresData) {
            const container = document.getElementById('sensores-otros');
            if (!container) return;
            
            let html = '';
            let encontrados = 0;
            
            // Buscar sensores que no pertenezcan a sistemas espec√≠ficos
            Object.entries(sensoresData).forEach(([tag, sensor]) => {
                if (!tag.startsWith('040') && !tag.startsWith('050') && 
                    !tag.startsWith('060') && !tag.startsWith('070')) {
                    encontrados++;
                    const estadoClass = sensor.estado === 'ALERTA' ? 'warning' : 
                                       sensor.estado === 'CRITICO' ? 'danger' : 'success';
                    const timestamp = sensor.fecha_hora ? (() => {
                        const fecha = new Date(sensor.fecha_hora);
                        // Ajustar zona horaria: restar 3 horas (UTC a hora local Argentina)
                        fecha.setHours(fecha.getHours() - 3);
                        return fecha.toLocaleString('es-ES');
                    })() : 'Sin datos';
                    
                    // Cambiar nombres espec√≠ficos para otros sistemas
                    let nombreSensor = sensor.nombre || tag;
                    if (tag === '090FIT01' || nombreSensor.toLowerCase().includes('quemador')) {
                        nombreSensor = 'Flujo de Gas al Motor';
                    } else if (tag === '210PT01' || nombreSensor.toLowerCase().includes('presi√≥n red gas')) {
                        nombreSensor = 'Presi√≥n de Separador';
                    }
                    
                    html += `
                        <div class="metric">
                            <span class="metric-label">${nombreSensor}</span>
                            <span class="metric-value text-${estadoClass}">${sensor.valor} ${sensor.unidad}<br><small>Fecha y hora de actualizaci√≥n del dato: ${timestamp}</small></span>
                        </div>
                    `;
                }
            });
            
            if (encontrados === 0) {
                html = '<div class="text-center text-muted">No hay sensores disponibles</div>';
            }
            
            container.innerHTML = html;
        }
        
        // Funci√≥n de prueba para verificar que las tarjetas funcionen
        function probarTarjetas() {
            console.log('üß™ Probando tarjetas de temperaturas y niveles...');
            
            // Verificar que los elementos existan
            const elementos = [
                'temp-b1', 'temp-b2', 'nivel-b1', 'nivel-b2',
                'progress-b1', 'progress-b2',
                'grafico-temperaturas', 'grafico-niveles'
            ];
            
            elementos.forEach(id => {
                const elemento = document.getElementById(id);
                if (elemento) {
                    console.log(`‚úÖ Elemento ${id} encontrado:`, elemento);
                } else {
                    console.error(`‚ùå Elemento ${id} NO encontrado`);
                }
            });
            
            // Verificar que las tarjetas existan
            const tarjetas = ['card-temperaturas', 'card-niveles'];
            tarjetas.forEach(id => {
                const tarjeta = document.getElementById(id);
                if (tarjeta) {
                    console.log(`‚úÖ Tarjeta ${id} encontrada:`, tarjeta);
                } else {
                    console.error(`‚ùå Tarjeta ${id} NO encontrada`);
                }
            });
        }
        
        // Funci√≥n para depurar valores de sensores
        async function depurarValoresSensores() {
            console.log('üîç Depurando valores de sensores...');
            try {
                const response = await fetch('/sensores_criticos_resumen');
                const data = await response.json();
                
                console.log('üìä Datos completos del servidor:', data);
                
                if (data && data.sensores) {
                    const sensoresRelevantes = ['040TT01', '050TT01', '040LT01', '050LT01'];
                    sensoresRelevantes.forEach(tag => {
                        const sensor = data.sensores[tag];
                        console.log(`üì° Sensor ${tag}:`, sensor);
                    });
                    
                    // Verificar valores en el DOM
                    console.log('üå°Ô∏è Valores actuales en el DOM:');
                    console.log('temp-b1:', document.getElementById('temp-b1')?.textContent);
                    console.log('temp-b2:', document.getElementById('temp-b2')?.textContent);
                    console.log('nivel-b1:', document.getElementById('nivel-b1')?.textContent);
                    console.log('nivel-b2:', document.getElementById('nivel-b2')?.textContent);
                }
            } catch (error) {
                console.error('‚ùå Error depurando sensores:', error);
            }
        }
        
        // Cargar datos de temperaturas
        async function cargarTemperaturas() {
            try {
                console.log('üå°Ô∏è Cargando datos de temperaturas...');
                probarTarjetas(); // Verificar que los elementos existan
                const response = await fetch('/sensores_criticos_resumen');
                const data = await response.json();
                
                console.log('üìä Datos de sensores recibidos:', data);
                
                if (data && data.sensores) {
                    // Actualizar temperaturas de biodigestores
                    let temp1 = data.sensores['040TT01'] || { valor: 0, unidad: '¬∞C' };
                    let temp2 = data.sensores['050TT01'] || { valor: 0, unidad: '¬∞C' };
                    
                    // Usar solo datos reales del servidor
                    console.log('üå°Ô∏è Usando datos reales de temperatura:', { temp1: temp1.valor, temp2: temp2.valor });
                    
                    console.log('üå°Ô∏è Actualizando temperaturas:', { temp1: temp1.valor, temp2: temp2.valor });
                    
                    const tempElement1 = document.getElementById('temp-b1');
                    const tempElement2 = document.getElementById('temp-b2');
                    
                    if (tempElement1) {
                        tempElement1.textContent = `${temp1.valor}${temp1.unidad}`;
                        console.log('‚úÖ temp-b1 actualizado:', tempElement1.textContent);
                    }
                    if (tempElement2) {
                        tempElement2.textContent = `${temp2.valor}${temp2.unidad}`;
                        console.log('‚úÖ temp-b2 actualizado:', tempElement2.textContent);
                    }
                    
                    // Actualizar gr√°fico de temperaturas con valores reales
                    actualizarGraficos(temp1.valor, temp2.valor, null, null);
                    console.log('‚úÖ Gr√°fico de temperaturas actualizado');
                } else {
                    console.warn('‚ö†Ô∏è No se encontraron datos de sensores');
                }
            } catch (error) {
                console.error('‚ùå Error cargando temperaturas:', error);
            }
        }
        
        // Cargar datos de niveles
        async function cargarNiveles() {
            try {
                console.log('üìä Cargando datos de niveles...');
                probarTarjetas(); // Verificar que los elementos existan
                const response = await fetch('/sensores_criticos_resumen');
                const data = await response.json();
                
                console.log('üìä Datos de sensores recibidos:', data);
                
                if (data && data.sensores) {
                    // Actualizar niveles de biodigestores
                    let nivel1 = data.sensores['040LT01'] || { valor: 0, unidad: '%' };
                    let nivel2 = data.sensores['050LT01'] || { valor: 0, unidad: '%' };
                    
                    // Usar solo datos reales del servidor
                    console.log('üìä Usando datos reales de niveles:', { nivel1: nivel1.valor, nivel2: nivel2.valor });
                    
                    console.log('üìä Actualizando niveles:', { nivel1: nivel1.valor, nivel2: nivel2.valor });
                    
                    const nivelElement1 = document.getElementById('nivel-b1');
                    const nivelElement2 = document.getElementById('nivel-b2');
                    
                    console.log('üîç Elementos encontrados:', { 
                        nivelElement1: !!nivelElement1, 
                        nivelElement2: !!nivelElement2 
                    });
                    
                    if (nivelElement1) {
                        nivelElement1.textContent = `${nivel1.valor}${nivel1.unidad}`;
                        console.log('‚úÖ nivel-b1 actualizado:', nivelElement1.textContent);
                    } else {
                        console.error('‚ùå Elemento nivel-b1 no encontrado');
                    }
                    if (nivelElement2) {
                        nivelElement2.textContent = `${nivel2.valor}${nivel2.unidad}`;
                        console.log('‚úÖ nivel-b2 actualizado:', nivelElement2.textContent);
                    } else {
                        console.error('‚ùå Elemento nivel-b2 no encontrado');
                    }
                    
                    // Actualizar tambi√©n los elementos principales
                    const nivelElement1Main = document.getElementById('nivel-b1-main');
                    const nivelElement2Main = document.getElementById('nivel-b2-main');
                    
                    if (nivelElement1Main) {
                        nivelElement1Main.textContent = `${nivel1.valor}${nivel1.unidad}`;
                        console.log('‚úÖ nivel-b1-main actualizado:', nivelElement1Main.textContent);
                    }
                    if (nivelElement2Main) {
                        nivelElement2Main.textContent = `${nivel2.valor}${nivel2.unidad}`;
                        console.log('‚úÖ nivel-b2-main actualizado:', nivelElement2Main.textContent);
                    }
                    
                    // Actualizar barras de progreso
                    const progress1 = document.getElementById('progress-b1');
                    const progress2 = document.getElementById('progress-b2');
                    if (progress1) {
                        progress1.style.width = `${nivel1.valor}%`;
                        console.log('‚úÖ progress-b1 actualizado:', progress1.style.width);
                    }
                    if (progress2) {
                        progress2.style.width = `${nivel2.valor}%`;
                        console.log('‚úÖ progress-b2 actualizado:', progress2.style.width);
                    }
                    
                    // Actualizar tambi√©n las barras de progreso principales
                    const progress1Main = document.getElementById('progress-b1-main');
                    const progress2Main = document.getElementById('progress-b2-main');
                    if (progress1Main) {
                        progress1Main.style.width = `${nivel1.valor}%`;
                        console.log('‚úÖ progress-b1-main actualizado:', progress1Main.style.width);
                    }
                    if (progress2Main) {
                        progress2Main.style.width = `${nivel2.valor}%`;
                        console.log('‚úÖ progress-b2-main actualizado:', progress2Main.style.width);
                    }
                    
                    // Actualizar gr√°fico de niveles con valores reales
                    actualizarGraficos(null, null, nivel1.valor, nivel2.valor);
                    console.log('‚úÖ Gr√°fico de niveles actualizado');
                } else {
                    console.warn('‚ö†Ô∏è No se encontraron datos de sensores');
                }
            } catch (error) {
                console.error('‚ùå Error cargando niveles:', error);
            }
        }
        
        // Cargar datos de biodigestores
        async function cargarDatosBiodigestores() {
            try {
                // Usar endpoint de datos sincronizados para obtener timestamp real
                const response = await fetch('/datos_sincronizados?t=' + Date.now());
                const data = await response.json();
                
                console.log('üìä Datos biodigestores recibidos:', data);
                
                if (data.estado === 'conectado' && data.fecha_ultima_lectura) {
                    // Actualizar timestamp con fecha real de los datos
                    const timestampElement = document.getElementById('biodigestores-timestamp');
                    const timestampElement2 = document.getElementById('biodigestor2-timestamp');
                    
                    const fechaReal = new Date(data.fecha_ultima_lectura);
                    // Ajustar zona horaria: restar 3 horas (UTC a hora local Argentina)
                    fechaReal.setHours(fechaReal.getHours() - 3);
                    const fechaLocal = fechaReal.toLocaleString('es-ES', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit',
                        hour12: false
                    });
                    
                    if (timestampElement) {
                        timestampElement.textContent = `√öltima actualizaci√≥n: ${fechaLocal}`;
                        console.log('‚úÖ Timestamp biodigestor 1 actualizado:', fechaLocal);
                    }
                    
                    if (timestampElement2) {
                        timestampElement2.textContent = `√öltima actualizaci√≥n: ${fechaLocal}`;
                        console.log('‚úÖ Timestamp biodigestor 2 actualizado:', fechaLocal);
                    }
                } else {
                    // Fallback: usar hora actual si no hay datos
                    const timestampElement = document.getElementById('biodigestores-timestamp');
                    const timestampElement2 = document.getElementById('biodigestor2-timestamp');
                    
                    const ahora = new Date();
                    const fechaLocal = ahora.toLocaleString('es-ES', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit',
                        hour12: false
                    });
                    
                    if (timestampElement) {
                        timestampElement.textContent = `√öltima actualizaci√≥n: ${fechaLocal}`;
                    }
                    
                    if (timestampElement2) {
                        timestampElement2.textContent = `√öltima actualizaci√≥n: ${fechaLocal}`;
                    }
                }
            } catch (error) {
                console.error('Error cargando datos de biodigestores:', error);
            }
        }
        
        // Cargar calidad de gas
        async function cargarCalidadGas() {
            try {
                const response = await fetch('/sensores_criticos_resumen');
                const data = await response.json();
                
                if (data && data.sensores) {
                    // Actualizar datos de calidad de gas
                    console.log('Cargando datos de calidad de gas...');
                    // Aqu√≠ puedes agregar la l√≥gica espec√≠fica para calidad de gas
                }
            } catch (error) {
                console.error('Error cargando calidad de gas:', error);
            }
        }
        
        // Cargar seguimiento horario
        async function cargarSeguimientoHorario() {
            try {
                const response = await fetch('/sensores_criticos_resumen');
                const data = await response.json();
                
                if (data && data.sensores) {
                    // Actualizar datos de seguimiento horario
                    console.log('Cargando datos de seguimiento horario...');
                    
                    // Actualizar dosificaci√≥n diaria desde el header
                    const kwObjetivo = document.getElementById('kw-objetivo-header').value;
                    const metanoObjetivo = document.getElementById('metano-objetivo-header').value;
                    await actualizarDosificacionSeguimiento(kwObjetivo, metanoObjetivo);
                }
            } catch (error) {
                console.error('Error cargando seguimiento horario:', error);
            }
        }
        
        // Funci√≥n para cambiar modo de c√°lculo en seguimiento
        async function cambiarModoSeguimiento() {
            const modoSeleccionado = document.querySelector('input[name="modo-seguimiento"]:checked').value;
            const kwObjetivo = document.getElementById('kw-objetivo-header').value;
            const metanoObjetivo = document.getElementById('metano-objetivo-header').value;
            
            await actualizarDosificacionSeguimiento(kwObjetivo, metanoObjetivo, modoSeleccionado);
        }
        
        // Funci√≥n para actualizar dosificaci√≥n en seguimiento horario
        async function actualizarDosificacionSeguimiento(kwObjetivo, metanoObjetivo, modoCalculo = 'energetico') {
            try {
                // Calcular dosificaci√≥n directamente
                const config = {
                    kw_objetivo: parseInt(kwObjetivo),
                    porcentaje_solidos: 50.0,
                    porcentaje_liquidos: 50.0,
                    porcentaje_purin: 0.0,
                    objetivo_metano_diario: parseFloat(metanoObjetivo),
                    num_biodigestores: 2,
                    max_materiales_solidos: 8,
                    modo_calculo: modoCalculo  // Agregar modo de c√°lculo
                };
                
                const response = await fetch('/calcular_mezcla', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(config)
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.status === 'success') {
                        const totales = data.totales || {};
                        const solidosTN = totales.tn_solidos || 0;
                        const liquidosTN = totales.tn_liquidos || 0;
                    
                        // Calcular dosificaci√≥n por hora (asumiendo 24 horas)
                        const solidosPorHora = (solidosTN / 24).toFixed(2);
                        const liquidosPorHora = (liquidosTN / 24).toFixed(2);
                        
                        // Actualizar display en seguimiento horario
                        document.getElementById('solidos-actuales').textContent = `${solidosPorHora} TN/h`;
                        document.getElementById('liquidos-actuales').textContent = `${liquidosPorHora} TN/h`;
                        
                        // Agregar informaci√≥n de objetivos y materiales
                        const objetivosInfo = document.getElementById('objetivos-seguimiento');
                        if (objetivosInfo) {
                            // Generar tabla de materiales
                            let materialesHtml = '';
                            if (data.materiales_detalle && data.materiales_detalle.length > 0) {
                                materialesHtml = `
                                    <div style="background: rgba(255,255,255,0.05); padding: 8px; border-radius: 6px; margin-top: 8px;">
                                        <h6 style="color: #ffc107; margin-bottom: 6px; font-size: 11px;">üìã Materiales Utilizados</h6>
                                        <div style="max-height: 150px; overflow-y: auto; font-size: 10px;">
                                            <table style="width: 100%; color: white;">
                                                <thead>
                                                    <tr style="background: rgba(255,255,255,0.1);">
                                                        <th style="padding: 2px 4px;">Material</th>
                                                        <th style="padding: 2px 4px;">Tipo</th>
                                                        <th style="padding: 2px 4px;">TN</th>
                                                        <th style="padding: 2px 4px;">% ST</th>
                                                        <th style="padding: 2px 4px;">KW</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                `;
                                
                                data.materiales_detalle.forEach((mat, index) => {
                                    if (mat.cantidad_tn > 0) {
                                        const tipoColor = mat.tipo === 'S√≥lido' ? '#ffc107' : 
                                                        mat.tipo === 'L√≠quido' ? '#17a2b8' : '#6c757d';
                                        materialesHtml += `
                                            <tr style="background: ${index % 2 === 0 ? 'rgba(255,255,255,0.02)' : 'rgba(255,255,255,0.05)'};">
                                                <td style="padding: 2px 4px; color: ${tipoColor};"><strong>${mat.nombre}</strong></td>
                                                <td style="padding: 2px 4px; color: ${tipoColor};">${mat.tipo}</td>
                                                <td style="padding: 2px 4px;">${mat.cantidad_tn.toFixed(1)}</td>
                                                <td style="padding: 2px 4px;">${mat.st_porcentaje.toFixed(1)}%</td>
                                                <td style="padding: 2px 4px;">${mat.kw_aportados.toFixed(0)}</td>
                                            </tr>
                                        `;
                                    }
                                });
                                
                                materialesHtml += `
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                `;
                            }
                            
                            objetivosInfo.innerHTML = `
                                <div style="background: rgba(0,212,255,0.1); padding: 10px; border-radius: 8px; margin-top: 10px;">
                                    <h6 style="color: #00d4ff; margin-bottom: 8px;">Objetivos Diarios</h6>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 12px;">
                                        <div>
                                            <strong>KW Objetivo:</strong> ${kwObjetivo} kW<br>
                                            <strong>Metano Objetivo:</strong> ${metanoObjetivo}%<br>
                                            <strong>Modo:</strong> ${modoCalculo === 'energetico' ? 'Energ√©tico' : 'Volum√©trico'}
                                        </div>
                                        <div>
                                            <strong>Total S√≥lidos:</strong> ${solidosTN.toFixed(0)} TN<br>
                                            <strong>Total L√≠quidos:</strong> ${liquidosTN.toFixed(0)} TN
                                        </div>
                                    </div>
                                </div>
                                ${materialesHtml}
                            `;
                        }
                        
                        console.log(`‚úÖ Dosificaci√≥n actualizada: ${solidosPorHora} TN/h s√≥lidos, ${liquidosPorHora} TN/h l√≠quidos`);
                    }
                }
            } catch (error) {
                console.error('‚ùå Error actualizando dosificaci√≥n en seguimiento:', error);
            }
        }
        
        // Cargar datos de sensores para KPIs
        async function cargarDatosSensoresKPIs() {
            try {
                const response = await fetch('/sensores_criticos_resumen');
                const data = await response.json();
                
                console.log('üîç Datos para KPIs:', data);
                
                if (data && data.sensores) {
                    // Actualizar temperaturas en KPIs
                    const temp1 = data.sensores['040TT01'] || { valor: 0, unidad: '¬∞C' };
                    const temp2 = data.sensores['050TT01'] || { valor: 0, unidad: '¬∞C' };
                    
                    console.log('üå°Ô∏è Temperaturas:', { temp1, temp2 });
                    
                    const tempElement1 = document.getElementById('kpi-temp-b1');
                    const tempElement2 = document.getElementById('kpi-temp-b2');
                    if (tempElement1) tempElement1.textContent = `${temp1.valor}${temp1.unidad}`;
                    if (tempElement2) tempElement2.textContent = `${temp2.valor}${temp2.unidad}`;
                    
                    // Actualizar niveles en KPIs
                    const nivel1 = data.sensores['040LT01'] || { valor: 0, unidad: '%' };
                    const nivel2 = data.sensores['050LT01'] || { valor: 0, unidad: '%' };
                    
                    console.log('üìä Niveles:', { nivel1, nivel2 });
                    
                    const nivelElement1 = document.getElementById('kpi-nivel-b1');
                    const nivelElement2 = document.getElementById('kpi-nivel-b2');
                    if (nivelElement1) nivelElement1.textContent = `${nivel1.valor}${nivel1.unidad}`;
                    if (nivelElement2) nivelElement2.textContent = `${nivel2.valor}${nivel2.unidad}`;
                }
            } catch (error) {
                console.error('Error cargando datos de sensores para KPIs:', error);
            }
        }
        
        // Funci√≥n de prueba para debuggear sensores
        async function probarSensores() {
            console.log('üß™ Probando endpoint de sensores...');
            try {
                const response = await fetch('/sensores_criticos_resumen');
                const data = await response.json();
                console.log('üì° Respuesta completa:', data);
                console.log('üìä Sensores disponibles:', Object.keys(data.sensores || {}));
                
                // PRUEBA ESPEC√çFICA DE TEMPERATURAS
                console.log('üå°Ô∏è === PRUEBA DE TEMPERATURAS ===');
                const temp1 = data.sensores?.['040TT01'];
                const temp2 = data.sensores?.['050TT01'];
                
                console.log('üå°Ô∏è Temperatura Biodigestor 1 (040TT01):', temp1);
                console.log('üå°Ô∏è Temperatura Biodigestor 2 (050TT01):', temp2);
                
                if (temp1) {
                    console.log('‚úÖ BIO1 - Valor:', temp1.valor, 'Unidad:', temp1.unidad, 'Estado:', temp1.estado);
                } else {
                    console.log('‚ùå BIO1 - No encontrado');
                }
                
                if (temp2) {
                    console.log('‚úÖ BIO2 - Valor:', temp2.valor, 'Unidad:', temp2.unidad, 'Estado:', temp2.estado);
                } else {
                    console.log('‚ùå BIO2 - No encontrado');
                }
                
                // PRUEBA ESPEC√çFICA DE NIVELES
                console.log('üìä === PRUEBA DE NIVELES ===');
                const nivel1 = data.sensores?.['040LT01'];
                const nivel2 = data.sensores?.['050LT01'];
                
                console.log('üìä Nivel Biodigestor 1 (040LT01):', nivel1);
                console.log('üìä Nivel Biodigestor 2 (050LT01):', nivel2);
                
                if (nivel1) {
                    console.log('‚úÖ BIO1 - Valor:', nivel1.valor, 'Unidad:', nivel1.unidad, 'Estado:', nivel1.estado);
                } else {
                    console.log('‚ùå BIO1 - No encontrado');
                }
                
                if (nivel2) {
                    console.log('‚úÖ BIO2 - Valor:', nivel2.valor, 'Unidad:', nivel2.unidad, 'Estado:', nivel2.estado);
                } else {
                    console.log('‚ùå BIO2 - No encontrado');
                }
                
                // Verificar sensores espec√≠ficos
                const sensores060 = Object.keys(data.sensores || {}).filter(tag => tag.startsWith('060'));
                const sensores070 = Object.keys(data.sensores || {}).filter(tag => tag.startsWith('070'));
                const sensoresOtros = Object.keys(data.sensores || {}).filter(tag => 
                    !tag.startsWith('040') && !tag.startsWith('050') && 
                    !tag.startsWith('060') && !tag.startsWith('070')
                );
                
                console.log('üîß Sensores 060 (Bombas):', sensores060);
                console.log('üå°Ô∏è Sensores 070 (Agua):', sensores070);
                console.log('‚öôÔ∏è Sensores Otros:', sensoresOtros);
                
                // Verificar datos espec√≠ficos de temperaturas y niveles
                if (data.sensores) {
                    console.log('üå°Ô∏è Datos de temperatura:', {
                        '040TT01': data.sensores['040TT01'],
                        '050TT01': data.sensores['050TT01']
                    });
                    console.log('üìä Datos de nivel:', {
                        '040LT01': data.sensores['040LT01'],
                        '050LT01': data.sensores['050LT01']
                    });
                }
                
                return data;
            } catch (error) {
                console.error('‚ùå Error en prueba de sensores:', error);
                return null;
            }
        }
        
        // Funci√≥n para forzar actualizaci√≥n de datos
        async function forzarActualizacion() {
            console.log('üîÑ Forzando actualizaci√≥n de datos...');
            await cargarSensoresSistemas();
            await actualizarTemperaturasNiveles();
            console.log('‚úÖ Actualizaci√≥n forzada completada');
        }
        
        // Funciones para gesti√≥n de materiales
        function agregarNuevoMaterial() {
            console.log('‚ûï Agregando nuevo material...');
            
            const tabla = document.getElementById('tabla-gestion-materiales');
            if (!tabla) {
                console.error('‚ùå No se encontr√≥ la tabla de gesti√≥n de materiales');
                return;
            }
            
            const tbody = tabla.querySelector('tbody');
            if (!tbody) {
                console.error('‚ùå No se encontr√≥ el cuerpo de la tabla');
                return;
            }
            
            // Crear nueva fila
            const nuevaFila = document.createElement('tr');
            nuevaFila.setAttribute('data-material', 'nuevo_material');
            
            nuevaFila.innerHTML = `
                <td>
                    <input type="text" class="form-control form-control-sm bg-white text-dark border-secondary" 
                           value="Nuevo Material" onchange="actualizarNombreMaterial(this, 'nuevo_material')" style="color: black !important;">
                </td>
                <td>
                    <input type="number" class="form-control form-control-sm bg-white text-dark border-secondary" 
                           value="0.00" step="0.01" onchange="recalcularKW('nuevo_material')" style="color: black !important;">
                </td>
                <td>
                    <input type="number" class="form-control form-control-sm bg-white text-dark border-secondary" 
                           value="0.00" step="0.01" onchange="recalcularKW('nuevo_material')" style="color: black !important;">
                </td>
                <td>
                    <input type="number" class="form-control form-control-sm bg-white text-dark border-secondary" 
                           value="0.00" step="0.01" onchange="recalcularKW('nuevo_material')" style="color: black !important;">
                </td>
                <td>
                    <input type="number" class="form-control form-control-sm bg-white text-dark border-secondary" 
                           value="0.00" step="0.01" onchange="recalcularKW('nuevo_material')" style="color: black !important;">
                </td>
                <td>
                    <input type="number" class="form-control form-control-sm bg-white text-dark border-secondary" 
                           value="0.00" step="0.01" onchange="recalcularKW('nuevo_material')" style="color: black !important;">
                </td>
                <td>
                    <input type="number" class="form-control form-control-sm bg-white text-dark border-secondary" 
                           value="0.00" step="0.01" onchange="recalcularKW('nuevo_material')" style="color: black !important;">
                </td>
                <td>
                    <input type="number" class="form-control form-control-sm bg-white text-dark border-secondary" 
                           value="0.00" step="0.01" onchange="recalcularKW('nuevo_material')" style="color: black !important;">
                </td>
                <td>
                    <select class="form-control form-control-sm bg-white text-dark border-secondary" onchange="recalcularKW('nuevo_material')" style="color: black !important;">
                        <option value="solido">S√≥lido</option>
                        <option value="liquido">L√≠quido</option>
                    </select>
                </td>
                <td>
                    <span class="kw-value" style="color: #dc3545;">0.0000</span>
                </td>
                <td>
                    <button class="btn btn-danger btn-sm" onclick="eliminarMaterial('nuevo_material')">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;
            
            tbody.appendChild(nuevaFila);
            console.log('‚úÖ Nuevo material agregado');
        }
        
        async function guardarCambiosMateriales() {
            console.log('üíæ INICIANDO GUARDADO DE MATERIALES...');
            
            try {
            const tabla = document.getElementById('tabla-gestion-materiales');
            if (!tabla) {
                console.error('‚ùå No se encontr√≥ la tabla de gesti√≥n de materiales');
                    alert('‚ùå Error: No se encontr√≥ la tabla de gesti√≥n de materiales');
                return;
            }
                
                console.log('‚úÖ Tabla encontrada:', tabla);
            
            const materiales = [];
            const filas = tabla.querySelectorAll('tbody tr');
            
                console.log(`üîç Encontradas ${filas.length} filas en la tabla`);
                
                if (filas.length === 0) {
                    console.error('‚ùå No se encontraron filas en la tabla');
                    alert('‚ùå Error: No se encontraron filas en la tabla');
                    return;
                }
                
                filas.forEach((fila, index) => {
                    console.log(`üìã Procesando fila ${index + 1}...`);
                
                const inputs = fila.querySelectorAll('input, select');
                    console.log(`   üìù Inputs encontrados: ${inputs.length}`);
                    
                    // Debug: mostrar todos los inputs encontrados
                    inputs.forEach((input, idx) => {
                        console.log(`      Input ${idx}: ${input.tagName} - ${input.type || 'select'} - "${input.value || input.textContent || 'N/A'}"`);
                    });
                    
                    if (inputs.length < 10) {
                        console.log(`   ‚ö†Ô∏è Insuficientes inputs (${inputs.length}), saltando...`);
                        return;
                    }
                    
                    const nombre = inputs[0].value.trim();
                    console.log(`   üìù Nombre: "${nombre}"`);
                    
                    if (!nombre) {
                        console.log(`   ‚ö†Ô∏è Nombre vac√≠o, saltando...`);
                        return;
                    }
                    
                    // Obtener valores de los inputs con validaci√≥n
                    const st = inputs[1] ? parseFloat(inputs[1].value) / 100 || 0 : 0;
                    const sv = inputs[2] ? parseFloat(inputs[2].value) / 100 || 0 : 0;
                    const toneladas = 1.0;
                    const m3_tnsv = inputs[4] ? parseFloat(inputs[4].value) || 1.0 : 1.0;
                    const carbohidrato_lab = inputs[6] ? parseFloat(inputs[6].value) / 100 || 0 : 0;
                    const lipido_lab = inputs[7] ? parseFloat(inputs[7].value) / 100 || 0 : 0;
                    const proteina_lab = inputs[8] ? parseFloat(inputs[8].value) / 100 || 0 : 0;
                    
                    // Obtener tipo del select
                const tipoSelect = fila.querySelector('select');
                const tipo = tipoSelect ? tipoSelect.value : 'solido';
                
                    // Densidad - buscar en diferentes posiciones posibles
                    let densidad = 1.0;
                    if (inputs[13]) {
                        densidad = parseFloat(inputs[13].value) || 1.0;
                    } else if (inputs[12]) {
                        densidad = parseFloat(inputs[12].value) || 1.0;
                    } else if (inputs[11]) {
                        densidad = parseFloat(inputs[11].value) || 1.0;
                    }
                    
                    console.log(`   üìä Valores extra√≠dos:`);
                    console.log(`      ST: ${st}, SV: ${sv}, Tipo: ${tipo}`);
                
                // Solo enviar datos de laboratorio si tienen valores significativos
                const material_data = {
                    nombre: nombre,
                    st: st,
                    sv: sv,
                    toneladas: toneladas,
                    m3_tnsv: m3_tnsv,
                    tipo: tipo,
                    densidad: densidad
                };
                
                // Solo incluir datos de laboratorio si tienen valores > 0
                if (carbohidrato_lab > 0 || lipido_lab > 0 || proteina_lab > 0) {
                    material_data.carbohidratos_lab = carbohidrato_lab;
                    material_data.lipidos_lab = lipido_lab;
                    material_data.proteinas_lab = proteina_lab;
                    material_data.carbohidratos = carbohidrato_lab;
                    material_data.lipidos = lipido_lab;
                    material_data.proteinas = proteina_lab;
                    console.log(`   üìä Datos de laboratorio incluidos: CH ${(carbohidrato_lab*100).toFixed(1)}%, Lip ${(lipido_lab*100).toFixed(1)}%, Prot ${(proteina_lab*100).toFixed(1)}%`);
                } else {
                    console.log(`   üìä Datos de laboratorio omitidos (valores 0)`);
                }
                
                materiales.push(material_data);
            });
            
                console.log(`üìä Total de materiales preparados: ${materiales.length}`);
                
                if (materiales.length === 0) {
                    console.error('‚ùå No se encontraron materiales v√°lidos para guardar');
                    alert('‚ùå Error: No se encontraron materiales v√°lidos para guardar');
                    return;
                }
                
                console.log('üöÄ Enviando datos al servidor...');
                
                const response = await fetch('/actualizar_materiales_base', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        materiales: materiales
                    })
                });
                
                console.log(`üì° Respuesta recibida: ${response.status}`);
                
                const result = await response.json();
                
                console.log('üìä Resultado del servidor:', result);
                
                if (result.status === 'success') {
                    console.log('‚úÖ Guardado exitoso');
                    
                    // Mostrar mensaje de √©xito
                    const mensaje = document.createElement('div');
                    mensaje.className = 'alert alert-success alert-dismissible fade show position-fixed';
                    mensaje.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
                    mensaje.innerHTML = `
                        <strong>‚úÖ √âxito!</strong> ${result.mensaje || 'Cambios guardados correctamente'}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;
                    document.body.appendChild(mensaje);
                    
                    // Remover el mensaje despu√©s de 3 segundos
                    setTimeout(() => {
                        if (mensaje.parentNode) {
                            mensaje.parentNode.removeChild(mensaje);
                        }
                    }, 3000);
                    
                    console.log('‚úÖ Cambios guardados exitosamente');
                } else {
                    console.error('‚ùå Error del servidor:', result.mensaje);
                    throw new Error(result.mensaje || 'Error al guardar cambios');
                }
                
            } catch (error) {
                console.error('‚ùå Error guardando materiales:', error);
                
                // Mostrar mensaje de error
                const mensajeError = document.createElement('div');
                mensajeError.className = 'alert alert-danger alert-dismissible fade show position-fixed';
                mensajeError.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
                mensajeError.innerHTML = `
                    <strong>‚ùå Error!</strong> ${error.message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                document.body.appendChild(mensajeError);
                
                // Remover el mensaje despu√©s de 5 segundos
                setTimeout(() => {
                    if (mensajeError.parentNode) {
                        mensajeError.parentNode.removeChild(mensajeError);
                    }
                }, 5000);
            }
        }
        
        function eliminarMaterial(nombreMaterial) {
            console.log('üóëÔ∏è Eliminando material:', nombreMaterial);
            
            const fila = document.querySelector(`tr[data-material="${nombreMaterial}"]`);
            if (fila) {
                fila.remove();
                console.log('‚úÖ Material eliminado');
            }
        }
        
        function actualizarNombreMaterial(input, nombreAnterior) {
            const nuevoNombre = input.value;
            const fila = input.closest('tr');
            if (fila) {
                fila.setAttribute('data-material', nuevoNombre);
            }
            console.log(`üìù Nombre actualizado: ${nombreAnterior} ‚Üí ${nuevoNombre}`);
        }
        
        // Cargar materiales base para el selector - MEJORADA
        async function cargarMaterialesBase() {
            try {
                console.log('üîÑ Cargando materiales base...');
                
                const response = await fetch('/obtener_materiales_base_json');
                const data = await response.json();
                
                console.log('üìä Datos recibidos:', data);
                
                const materiales = data.materiales || {};
                const select = document.getElementById('rm-material');
                
                if (!select) {
                    console.error('‚ùå Select rm-material no encontrado');
                    return;
                }
                
                // Limpiar opciones existentes
                select.innerHTML = '<option value="">Seleccionar material...</option>';
                
                // Agregar opci√≥n para material nuevo
                const optionNuevo = document.createElement('option');
                optionNuevo.value = 'nuevo_material';
                optionNuevo.textContent = '+ Agregar material nuevo';
                select.appendChild(optionNuevo);
                
                // Agregar materiales existentes
                Object.keys(materiales).forEach(material => {
                    const option = document.createElement('option');
                    option.value = material;
                    option.textContent = material;
                    select.appendChild(option);
                });
                
                console.log(`‚úÖ ${Object.keys(materiales).length} materiales cargados`);
                
                // Agregar evento para material nuevo
                select.addEventListener('change', function() {
                    if (this.value === 'nuevo_material') {
                        mostrarFormularioMaterialNuevo();
                    } else if (this.value) {
                    mostrarDatosMaterial(this.value, materiales);
                    }
                });
                
            } catch (error) {
                console.error('‚ùå Error cargando materiales base:', error);
                
                // Fallback: cargar materiales desde archivo local
                cargarMaterialesFallback();
            }
        }
        
        // Funci√≥n fallback para cargar materiales
        function cargarMaterialesFallback() {
            console.log('üîÑ Cargando materiales desde fallback...');
            
            const materialesFallback = [
                'Maiz', 'Purin', 'Rumen', 'Expeller', 'Descarte de grano',
                'Gomas vegetales', 'Grasa - Frigorifico La Anonima', 'Lactosa',
                'SA 7', 'SA5-SA6 20-80', 'Decomiso mucanga'
            ];
            
            const select = document.getElementById('rm-material');
            if (!select) return;
            
            select.innerHTML = '<option value="">Seleccionar material...</option>';
            
            // Agregar opci√≥n para material nuevo
            const optionNuevo = document.createElement('option');
            optionNuevo.value = 'nuevo_material';
            optionNuevo.textContent = '+ Agregar material nuevo';
            select.appendChild(optionNuevo);
            
            // Agregar materiales fallback
            materialesFallback.forEach(material => {
                const option = document.createElement('option');
                option.value = material;
                option.textContent = material;
                select.appendChild(option);
            });
            
            console.log(`‚úÖ ${materialesFallback.length} materiales cargados desde fallback`);
        }
        
        // Funci√≥n para mostrar formulario de material nuevo
        function mostrarFormularioMaterialNuevo() {
            const select = document.getElementById('rm-material');
            const inputMaterial = document.createElement('input');
            inputMaterial.type = 'text';
            inputMaterial.id = 'rm-material-nuevo';
            inputMaterial.className = 'form-control';
            inputMaterial.placeholder = 'Nombre del nuevo material';
            
            // Reemplazar el select con el input
            select.style.display = 'none';
            select.parentNode.appendChild(inputMaterial);
            
            // Agregar bot√≥n para confirmar
            const botonConfirmar = document.createElement('button');
            botonConfirmar.type = 'button';
            botonConfirmar.className = 'btn btn-success btn-sm mt-2';
            botonConfirmar.innerHTML = '<i class="fas fa-check"></i> Confirmar';
            botonConfirmar.onclick = function() {
                const nombreMaterial = inputMaterial.value.trim();
                if (nombreMaterial) {
                    // Agregar el material al select
                    const option = document.createElement('option');
                    option.value = nombreMaterial;
                    option.textContent = nombreMaterial;
                    option.selected = true;
                    select.appendChild(option);
                    
                    // Restaurar el select
                    inputMaterial.remove();
                    botonConfirmar.remove();
                    select.style.display = 'block';
                    
                    console.log(`‚úÖ Material nuevo agregado: ${nombreMaterial}`);
                }
            };
            
            select.parentNode.appendChild(botonConfirmar);
        }
        
        // Funci√≥n para mostrar datos del material seleccionado
        function mostrarDatosMaterial(materialNombre, materiales) {
            const material = materiales[materialNombre];
            if (!material) {
                // Limpiar tabla si no hay material seleccionado
                const tablaContainer = document.getElementById('tabla-material-seleccionado');
                if (tablaContainer) {
                    tablaContainer.innerHTML = '';
                }
                return;
            }
            
            // Crear o actualizar tabla con datos del material
            let tablaContainer = document.getElementById('tabla-material-seleccionado');
            if (!tablaContainer) {
                tablaContainer = document.createElement('div');
                tablaContainer.id = 'tabla-material-seleccionado';
                tablaContainer.className = 'mt-3';
                
                // Insertar despu√©s del formulario de registro
                const cardContent = document.querySelector('#card-registro-materiales .card-content');
                cardContent.appendChild(tablaContainer);
            }
            
            tablaContainer.innerHTML = `
                <div class="card">
                    <div class="card-header bg-dark text-white">
                        <h6><i class="fas fa-info-circle"></i> Datos de Laboratorio - ${materialNombre}</h6>
                    </div>
                    <div class="card-body bg-dark text-white">
                        <div class="table-responsive">
                            <table class="table table-dark table-striped">
                                <tbody>
                                    <tr>
                                        <td style="background-color: #343a40 !important; color: #ffffff !important; font-weight: bold;">ST (S√≥lidos Totales)</td>
                                        <td style="background-color: #343a40 !important; color: #ffffff !important;">${((material.st || 0) * 100).toFixed(2)}%</td>
                                    </tr>
                                    <tr>
                                        <td style="background-color: #343a40 !important; color: #ffffff !important; font-weight: bold;">SV (S√≥lidos Vol√°tiles)</td>
                                        <td style="background-color: #343a40 !important; color: #ffffff !important;">${((material.sv || 0) * 100).toFixed(2)}%</td>
                                    </tr>
                                    <tr>
                                        <td style="background-color: #343a40 !important; color: #ffffff !important; font-weight: bold;">M¬≥/TN SV</td>
                                        <td style="background-color: #343a40 !important; color: #ffffff !important;">${(material.m3_tnsv || 0).toFixed(2)}</td>
                                    </tr>
                                    <tr>
                                        <td style="background-color: #343a40 !important; color: #ffffff !important; font-weight: bold;">Carbohidratos (Lab)</td>
                                        <td style="background-color: #343a40 !important; color: #ffffff !important;">${((material.carbohidratos || 0) * 100).toFixed(2)}%</td>
                                    </tr>
                                    <tr>
                                        <td style="background-color: #343a40 !important; color: #ffffff !important; font-weight: bold;">L√≠pidos (Lab)</td>
                                        <td style="background-color: #343a40 !important; color: #ffffff !important;">${((material.lipidos || 0) * 100).toFixed(2)}%</td>
                                    </tr>
                                    <tr>
                                        <td style="background-color: #343a40 !important; color: #ffffff !important; font-weight: bold;">Prote√≠nas (Lab)</td>
                                        <td style="background-color: #343a40 !important; color: #ffffff !important;">${((material.proteinas || 0) * 100).toFixed(2)}%</td>
                                    </tr>
                                    <tr>
                                        <td style="background-color: #343a40 !important; color: #ffffff !important; font-weight: bold;">CH4%</td>
                                        <td style="background-color: #343a40 !important; color: #ffffff !important;">${((material.ch4 || 0) * 100).toFixed(2)}%</td>
                                    </tr>
                                    <tr>
                                        <td style="background-color: #343a40 !important; color: #ffffff !important; font-weight: bold;">KW/TN</td>
                                        <td style="background-color: #343a40 !important; color: #ffffff !important;">${(material['kw/tn'] || 0).toFixed(4)}</td>
                                    </tr>
                                    <tr>
                                        <td style="background-color: #343a40 !important; color: #ffffff !important; font-weight: bold;">Tipo</td>
                                        <td style="background-color: #343a40 !important; color: #ffffff !important;">
                                            <span class="badge ${material.tipo === 'solido' ? 'bg-warning' : 'bg-info'}">
                                                ${material.tipo === 'solido' ? 'üü§ S√≥lido' : 'üíß L√≠quido'}
                                            </span>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td style="background-color: #343a40 !important; color: #ffffff !important; font-weight: bold;">Densidad</td>
                                        <td style="background-color: #343a40 !important; color: #ffffff !important;">${(material.densidad || 1.0).toFixed(2)} kg/L</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        // Funciones para cargar datos anal√≠ticos
        async function cargarKPIsEjecutivos() {
            console.log('üìä Cargando KPIs ejecutivos...');
            
            const analyticsView = document.getElementById('analytics-view');
            if (!analyticsView) return;
            
            analyticsView.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Cargando KPIs ejecutivos...</div>';
            
            try {
                const response = await fetch('/analytics_kpis');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('üìà KPIs recibidos:', data);
                
                if (data.status === 'success' && data.kpis) {
                    const kpis = data.kpis;
                    
                    let html = `
                        <div class="kpis-panel">
                            <h3><i class="fas fa-chart-line"></i> KPIs Ejecutivos - Planta SIBIA</h3>
                            <div class="alert alert-info mb-3">
                                <small><i class="fas fa-clock"></i> √öltima actualizaci√≥n: ${data.timestamp ? new Date(data.timestamp).toLocaleString('es-ES') : '--'}</small><br>
                                <small><i class="fas fa-chart-bar"></i> Per√≠odo de an√°lisis: ${kpis.periodo_analisis || '√öltimos 30 d√≠as'}</small>
                            </div>
                            
                            <div class="row mb-4">
                                <div class="col-md-3">
                                    <div class="kpi-card text-center p-3" style="background: rgba(40, 167, 69, 0.2); border: 1px solid #28a745; border-radius: 10px;">
                                        <h5 style="color: #28a745;">Generaci√≥n Promedio</h5>
                                        <h2 style="color: #00d4ff;">${kpis.generacion_promedio?.toFixed(1) || 0} kW</h2>
                                        <small>Objetivo: ${kpis.objetivo_diario || 28800} kW/d√≠a</small>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="kpi-card text-center p-3" style="background: rgba(255, 193, 7, 0.2); border: 1px solid #ffc107; border-radius: 10px;">
                                        <h5 style="color: #ffc107;">Eficiencia</h5>
                                        <h2 style="color: #00d4ff;">${kpis.eficiencia_promedio?.toFixed(1) || 0}%</h2>
                                        <small>Promedio mensual</small>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="kpi-card text-center p-3" style="background: rgba(23, 162, 184, 0.2); border: 1px solid #17a2b8; border-radius: 10px;">
                                        <h5 style="color: #17a2b8;">KW Total</h5>
                                        <h2 style="color: #00d4ff;">${(kpis.kw_total || 0).toLocaleString()} kW</h2>
                                        <small>√öltimos 30 d√≠as</small>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="kpi-card text-center p-3" style="background: rgba(108, 117, 125, 0.2); border: 1px solid #6c757d; border-radius: 10px;">
                                        <h5 style="color: #6c757d;">Disponibilidad</h5>
                                        <h2 style="color: #00d4ff;">${kpis.disponibilidad?.toFixed(1) || 0}%</h2>
                                        <small>${kpis.materiales_activos || 0} materiales activos</small>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="alert alert-info">
                                        <h6><i class="fas fa-info-circle"></i> Resumen Operativo:</h6>
                                        <ul class="mb-0">
                                            <li><strong>TN Procesadas:</strong> ${kpis.tn_total?.toFixed(1) || 0} TN</li>
                                            <li><strong>Materiales Activos:</strong> ${kpis.materiales_activos || 0}</li>
                                            <li><strong>Eficiencia:</strong> ${kpis.eficiencia_promedio?.toFixed(1) || 0}%</li>
                                        </ul>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="alert alert-success">
                                        <h6><i class="fas fa-battery-full"></i> Estado General:</h6>
                                        <p class="mb-0">
                                            Sistema operando a <strong>${kpis.eficiencia_promedio?.toFixed(1) || 0}%</strong> de eficiencia.
                                            Generaci√≥n promedio: <strong>${kpis.generacion_promedio?.toFixed(1) || 0} kW</strong>
                                        </p>
                                    </div>
                                </div>
                            </div>
                            
                        </div>
                    `;
                    
                    analyticsView.innerHTML = html;
                    console.log('‚úÖ KPIs ejecutivos cargados correctamente');
                    
                } else {
                    throw new Error('Datos de KPIs inv√°lidos');
                }
                
            } catch (error) {
                console.error('‚ùå Error cargando KPIs:', error);
                analyticsView.innerHTML = `
                    <div class="text-center text-danger">
                        <h4>Error cargando KPIs</h4>
                        <p>${error.message}</p>
                        <button class="btn btn-outline-primary" onclick="cargarKPIsEjecutivos()">
                            <i class="fas fa-redo"></i> Reintentar
                        </button>
                    </div>
                `;
            }
        }
        
        async function cargarTendenciasHistoricas() {
            console.log('üìà Cargando tendencias hist√≥ricas...');
            
            const analyticsView = document.getElementById('analytics-view');
            if (!analyticsView) {
                console.error('‚ùå Elemento analytics-view no encontrado');
                return;
            }
            
            console.log('‚úÖ Elemento analytics-view encontrado, cargando datos...');
            
            analyticsView.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Cargando tendencias hist√≥ricas...</div>';
            
            try {
                console.log('üì° Haciendo fetch a /tendencias_historicas...');
                const response = await fetch('/tendencias_historicas');
                console.log('üì° Respuesta recibida:', response.status, response.statusText);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                // Verificar que el contenido sea JSON
                const responseText = await response.text();
                let data;
                
                try {
                    data = JSON.parse(responseText);
                } catch (e) {
                    console.error('‚ùå Error parseando tendencias JSON:', e);
                    console.error('‚ùå Contenido recibido:', responseText.substring(0, 200));
                    throw new Error('Respuesta no es JSON v√°lido');
                }
                
                console.log('üìä Tendencias recibidas:', data);
                
                if (data.status === 'success') {
                    let html = `
                        <div class="tendencias-panel">
                            <h3><i class="fas fa-chart-area"></i> Tendencias Hist√≥ricas - √öltimos ${data.total_puntos || 30} d√≠as</h3>
                            
                            <div class="chart-container" style="position: relative; height: 400px; margin-bottom: 20px;">
                                <canvas id="trendsChart"></canvas>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="alert alert-primary">
                                        <h6><i class="fas fa-bolt"></i> Generaci√≥n Promedio:</h6>
                                        <p><strong>${data.generacion ? (data.generacion.reduce((a, b) => a + b, 0) / data.generacion.length).toFixed(1) : 0} kW</strong></p>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="alert alert-success">
                                        <h6><i class="fas fa-percentage"></i> Eficiencia Promedio:</h6>
                                        <p><strong>${data.eficiencia ? (data.eficiencia.reduce((a, b) => a + b, 0) / data.eficiencia.length).toFixed(1) : 0}%</strong></p>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="alert alert-info">
                                        <h6><i class="fas fa-weight"></i> TN Promedio/d√≠a:</h6>
                                        <p><strong>${data.tn_procesadas ? (data.tn_procesadas.reduce((a, b) => a + b, 0) / data.tn_procesadas.length).toFixed(1) : 0} TN</strong></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    analyticsView.innerHTML = html;
                    
                    // Crear gr√°fico con Chart.js
                    const ctx = document.getElementById('trendsChart');
                    if (ctx && data.labels && data.generacion) {
                        // Destruir gr√°fico anterior si existe
                        if (window.trendsChart) {
                            window.trendsChart.destroy();
                        }
                        
                        window.trendsChart = new Chart(ctx.getContext('2d'), {
                            type: 'line',
                            data: {
                                labels: data.labels,
                                datasets: [{
                                    label: 'Generaci√≥n (kW)',
                                    data: data.generacion,
                                    borderColor: '#00d4ff',
                                    backgroundColor: 'rgba(0, 212, 255, 0.1)',
                                    tension: 0.4,
                                    yAxisID: 'y'
                                }, {
                                    label: 'Eficiencia (%)',
                                    data: data.eficiencia || [],
                                    borderColor: '#28a745',
                                    backgroundColor: 'rgba(40, 167, 69, 0.1)',
                                    tension: 0.4,
                                    yAxisID: 'y1'
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: { 
                                        labels: { color: '#fff' },
                                        position: 'top'
                                    },
                                    title: { 
                                        display: true, 
                                        text: 'Tendencias de Producci√≥n', 
                                        color: '#fff',
                                        font: { size: 16 }
                                    }
                                },
                                scales: {
                                    x: { 
                                        ticks: { color: '#fff' }, 
                                        grid: { color: 'rgba(255, 255, 255, 0.1)' }
                                    },
                                    y: { 
                                        type: 'linear',
                                        display: true,
                                        position: 'left',
                                        ticks: { color: '#00d4ff' }, 
                                        grid: { color: 'rgba(255, 255, 255, 0.1)' },
                                        title: { display: true, text: 'kW', color: '#00d4ff' }
                                    },
                                    y1: { 
                                        type: 'linear', 
                                        display: true, 
                                        position: 'right',
                                        ticks: { color: '#28a745' },
                                        grid: { drawOnChartArea: false },
                                        title: { display: true, text: '%', color: '#28a745' }
                                    }
                                }
                            }
                        });
                        
                        console.log('‚úÖ Gr√°fico de tendencias creado correctamente');
                    }
                    
                    console.log('‚úÖ Tendencias hist√≥ricas cargadas correctamente');
                    
                } else {
                    throw new Error('Datos de tendencias inv√°lidos');
                }
                
            } catch (error) {
                console.error('‚ùå Error cargando tendencias:', error);
                analyticsView.innerHTML = `
                    <div class="text-center text-danger">
                        <h4>Error cargando tendencias</h4>
                        <p>${error.message}</p>
                        <button class="btn btn-outline-primary" onclick="cargarTendenciasHistoricas()">
                            <i class="fas fa-redo"></i> Reintentar
                        </button>
                    </div>
                `;
            }
        }
        
        async function cargarRendimientoMateriales() {
            console.log('üìä Cargando rendimiento de materiales del stock...');
            
            const analyticsView = document.getElementById('analytics-view');
            if (!analyticsView) return;
            
            analyticsView.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Cargando rendimiento de materiales...</div>';
            
            try {
                console.log('üîÑ Iniciando llamada a /rendimiento_materiales...');
                const response = await fetch('/rendimiento_materiales');
                console.log('üì° Respuesta recibida:', response.status, response.statusText);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('üìà Rendimiento materiales:', data);
                
                if (data.status === 'success' && data.materiales) {
                    let html = `
                        <div class="materials-performance-panel">
                            <h3><i class="fas fa-chart-bar"></i> Rendimiento de Materiales - Stock Actual</h3>
                            <p class="text-muted mb-4">An√°lisis basado en: <strong>${data.basado_en || 'stock_actual'}</strong> | Total: <strong>${data.total_materiales}</strong> materiales</p>
                            
                            <div class="table-responsive">
                                <table class="table table-striped table-hover" style="background-color: #ffffff;">
                                    <thead class="table-primary">
                                        <tr>
                                            <th style="background-color: #0d6efd; color: #ffffff;">Material</th>
                                            <th style="background-color: #0d6efd; color: #ffffff;">Stock Actual (TN)</th>
                                            <th style="background-color: #0d6efd; color: #ffffff;">KW Potencial</th>
                                            <th style="background-color: #0d6efd; color: #ffffff;">KW/TN</th>
                                            <th style="background-color: #0d6efd; color: #ffffff;">ST Actual (%)</th>
                                            <th style="background-color: #0d6efd; color: #ffffff;">Eficiencia (%)</th>
                                            <th style="background-color: #0d6efd; color: #ffffff;">Tipo</th>
                                            <th style="background-color: #0d6efd; color: #ffffff;">CH4 (%)</th>
                                            <th style="background-color: #0d6efd; color: #ffffff;">Entregas Hist√≥ricas</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                    `;
                    
                    data.materiales.forEach(material => {
                        // Color por KW potencial
                        let rowClass = '';
                        let rowStyle = '';
                        if (material.kw_potencial_stock > 2000) {
                            rowClass = 'table-success';
                            rowStyle = 'background-color: #d1e7dd; color: #0f5132;';
                        } else if (material.kw_potencial_stock > 1000) {
                            rowClass = 'table-warning';
                            rowStyle = 'background-color: #fff3cd; color: #664d03;';
                        } else if (material.kw_potencial_stock > 500) {
                            rowClass = 'table-info';
                            rowStyle = 'background-color: #d1ecf1; color: #055160;';
                        } else {
                            rowStyle = 'background-color: #f8f9fa; color: #212529;';
                        }
                        
                        // Color por rendimiento KW/TN
                        let kwColor = '';
                        if (material.kw_por_tn > 1.0) kwColor = 'color: #28a745; font-weight: bold;';
                        else if (material.kw_por_tn > 0.5) kwColor = 'color: #ffc107; font-weight: bold;';
                        else if (material.kw_por_tn > 0.1) kwColor = 'color: #fd7e14; font-weight: bold;';
                        else kwColor = 'color: #dc3545; font-weight: bold;';
                        
                        html += `
                            <tr class="${rowClass}" style="${rowStyle}">
                                <td><strong>${material.material}</strong></td>
                                <td>${material.tn_stock_actual} TN</td>
                                <td><span style="color: #0d6efd; font-weight: bold;">${material.kw_potencial_stock.toLocaleString()} kW</span></td>
                                <td><span style="${kwColor}">${material.kw_por_tn}</span></td>
                                <td>${material.st_actual}% <small class="text-muted">(te√≥rico: ${material.st_teorico}%)</small></td>
                                <td>
                                    <div class="progress" style="height: 20px;">
                                        <div class="progress-bar ${material.eficiencia > 90 ? 'bg-success' : material.eficiencia > 75 ? 'bg-warning' : 'bg-danger'}" 
                                             style="width: ${material.eficiencia}%">${material.eficiencia}%</div>
                                    </div>
                                </td>
                                <td>
                                    <span class="badge ${material.tipo === 'solido' ? 'badge-warning' : 'badge-info'}">
                                        ${material.tipo === 'solido' ? 'üü§ S√≥lido' : 'üíß L√≠quido'}
                                    </span>
                                </td>
                                <td>${material.porcentaje_metano}%</td>
                                <td>${material.entregas_historicas} entregas<br><small class="text-muted">${material.tn_procesadas_historicas} TN hist.</small></td>
                            </tr>
                        `;
                    });
                    
                    html += `
                                    </tbody>
                                </table>
                            </div>
                            
                            <div class="row mt-4">
                                <div class="col-md-6">
                                    <div class="alert alert-info">
                                        <h6><i class="fas fa-info-circle"></i> Leyenda de Colores:</h6>
                                        <small>
                                            üü¢ Verde: >1.0 KW/TN (Alto rendimiento)<br>
                                            üü° Amarillo: 0.5-1.0 KW/TN (Medio)<br>
                                            üü† Naranja: 0.1-0.5 KW/TN (Bajo)<br>
                                            üî¥ Rojo: <0.1 KW/TN (Muy bajo)
                                        </small>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="alert alert-success">
                                        <h6><i class="fas fa-battery-full"></i> Stock Total Disponible:</h6>
                                        <p><strong>${data.materiales.reduce((sum, m) => sum + m.tn_stock_actual, 0).toFixed(1)} TN</strong></p>
                                        <p><strong>KW Potencial Total: ${data.materiales.reduce((sum, m) => sum + m.kw_potencial_stock, 0).toLocaleString()} kW</strong></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    analyticsView.innerHTML = html;
                    console.log('‚úÖ Rendimiento de materiales cargado correctamente');
                    
                } else {
                    analyticsView.innerHTML = '<div class="text-center text-danger">Error: No se pudieron cargar los datos de rendimiento</div>';
                }
                
            } catch (error) {
                console.error('‚ùå Error cargando rendimiento materiales:', error);
                analyticsView.innerHTML = '<div class="text-center text-danger">Error cargando rendimiento: ' + error.message + '</div>';
            }
        }
        
        async function cargarAnalisisEficiencia() {
            console.log('‚ö° Cargando an√°lisis de eficiencia...');
            
            const analyticsView = document.getElementById('analytics-view');
            if (!analyticsView) return;
            
            analyticsView.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Cargando an√°lisis de eficiencia...</div>';
            
            try {
                // Cargar datos de m√∫ltiples fuentes para an√°lisis completo
                console.log('üì° Solicitando datos de KPIs...');
                const kpisResponse = await fetch('/analytics_kpis');
                console.log('üì° Respuesta KPIs:', kpisResponse.status, kpisResponse.statusText);
                
                console.log('üì° Solicitando datos de tendencias...');
                const tendenciasResponse = await fetch('/tendencias_historicas');
                console.log('üì° Respuesta tendencias:', tendenciasResponse.status, tendenciasResponse.statusText);
                
                // Verificar que las respuestas sean v√°lidas
                if (!kpisResponse.ok) {
                    throw new Error(`Error KPIs: ${kpisResponse.status} ${kpisResponse.statusText}`);
                }
                if (!tendenciasResponse.ok) {
                    throw new Error(`Error tendencias: ${tendenciasResponse.status} ${tendenciasResponse.statusText}`);
                }
                
                // Verificar que el contenido sea JSON
                const kpisText = await kpisResponse.text();
                const tendenciasText = await tendenciasResponse.text();
                
                let kpisData, tendenciasData;
                
                try {
                    kpisData = JSON.parse(kpisText);
                } catch (e) {
                    console.error('‚ùå Error parseando KPIs JSON:', e);
                    console.error('‚ùå Contenido recibido:', kpisText.substring(0, 200));
                    throw new Error('Respuesta KPIs no es JSON v√°lido');
                }
                
                try {
                    tendenciasData = JSON.parse(tendenciasText);
                } catch (e) {
                    console.error('‚ùå Error parseando tendencias JSON:', e);
                    console.error('‚ùå Contenido recibido:', tendenciasText.substring(0, 200));
                    throw new Error('Respuesta tendencias no es JSON v√°lido');
                }
                
                console.log('üìä Datos de KPIs:', kpisData);
                console.log('üìä Datos de tendencias:', tendenciasData);
                
                if (kpisData.status === 'success' && tendenciasData.status === 'success') {
                    const kpis = kpisData.kpis;
                    const eficienciaPromedio = tendenciasData.eficiencia ? 
                        (tendenciasData.eficiencia.reduce((a, b) => a + b, 0) / tendenciasData.eficiencia.length) : 
                        kpis.eficiencia_promedio;
                    
                    let html = `
                        <div class="eficiencia-panel">
                            <h3><i class="fas fa-tachometer-alt"></i> An√°lisis de Eficiencia - Planta SIBIA</h3>
                            
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <div class="card bg-dark border-primary">
                                        <div class="card-body text-center">
                                            <h5 class="card-title text-primary">Eficiencia Actual</h5>
                                            <div class="display-4 text-info">${eficienciaPromedio.toFixed(1)}%</div>
                                            <div class="progress mt-3" style="height: 10px;">
                                                <div class="progress-bar ${eficienciaPromedio > 85 ? 'bg-success' : eficienciaPromedio > 70 ? 'bg-warning' : 'bg-danger'}" 
                                                     style="width: ${eficienciaPromedio}%"></div>
                                            </div>
                                            <small class="text-muted">Objetivo: 90%</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card bg-dark border-success">
                                        <div class="card-body text-center">
                                            <h5 class="card-title text-success">Generaci√≥n vs Objetivo</h5>
                                            <div class="display-4 text-info">${((kpis.generacion_promedio / kpis.objetivo_diario) * 100).toFixed(1)}%</div>
                                            <div class="progress mt-3" style="height: 10px;">
                                                <div class="progress-bar bg-success" 
                                                     style="width: ${((kpis.generacion_promedio / kpis.objetivo_diario) * 100)}%"></div>
                                            </div>
                                            <small class="text-muted">${kpis.generacion_promedio.toFixed(1)} kW / ${kpis.objetivo_diario} kW</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row mb-4">
                                <div class="col-md-4">
                                    <div class="alert alert-info">
                                        <h6><i class="fas fa-cogs"></i> Factores de Eficiencia:</h6>
                                        <ul class="mb-0">
                                            <li><strong>Materiales Activos:</strong> ${kpis.materiales_activos}</li>
                                            <li><strong>Disponibilidad:</strong> ${kpis.disponibilidad.toFixed(1)}%</li>
                                            <li><strong>TN Procesadas:</strong> ${kpis.tn_total.toFixed(1)} TN</li>
                                        </ul>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="alert ${eficienciaPromedio > 85 ? 'alert-success' : eficienciaPromedio > 70 ? 'alert-warning' : 'alert-danger'}">
                                        <h6><i class="fas fa-thermometer-half"></i> Estado del Sistema:</h6>
                                        <p class="mb-0">
                                            <strong>${eficienciaPromedio > 85 ? 'Excelente' : eficienciaPromedio > 70 ? 'Bueno' : 'Requiere Atenci√≥n'}</strong><br>
                                            ${eficienciaPromedio > 85 ? 'Sistema operando √≥ptimamente' : 
                                              eficienciaPromedio > 70 ? 'Rendimiento aceptable' : 
                                              'Se recomienda revisi√≥n de procesos'}
                                        </p>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="alert alert-primary">
                                        <h6><i class="fas fa-chart-bar"></i> M√©tricas Clave:</h6>
                                        <ul class="mb-0">
                                            <li><strong>KW Total:</strong> ${kpis.kw_total.toLocaleString()} kW</li>
                                            <li><strong>Rendimiento:</strong> ${(kpis.kw_total / kpis.tn_total).toFixed(2)} kW/TN</li>
                                            <li><strong>Uptime:</strong> ${kpis.disponibilidad.toFixed(1)}%</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Gr√°fico de eficiencia hist√≥rica -->
                            <div class="card bg-dark border-info">
                                <div class="card-header">
                                    <h5><i class="fas fa-chart-area"></i> Tendencia de Eficiencia - √öltimos ${tendenciasData.total_puntos || 30} d√≠as</h5>
                                </div>
                                <div class="card-body">
                                    <div style="position: relative; height: 300px;">
                                        <canvas id="eficienciaChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    analyticsView.innerHTML = html;
                    
                    // Crear gr√°fico de eficiencia
                    const ctx = document.getElementById('eficienciaChart');
                    if (ctx && tendenciasData.labels && tendenciasData.eficiencia) {
                        // Destruir gr√°fico anterior si existe
                        if (window.eficienciaChart) {
                            window.eficienciaChart.destroy();
                            window.eficienciaChart = null;
                        }
                        
                        // Limpiar el canvas
                        const canvas = ctx;
                        const context = canvas.getContext('2d');
                        context.clearRect(0, 0, canvas.width, canvas.height);
                        
                        window.eficienciaChart = new Chart(context, {
                            type: 'line',
                            data: {
                                labels: tendenciasData.labels,
                                datasets: [{
                                    label: 'Eficiencia (%)',
                                    data: tendenciasData.eficiencia,
                                    borderColor: '#00d4ff',
                                    backgroundColor: 'rgba(0, 212, 255, 0.1)',
                                    tension: 0.4,
                                    fill: true
                                }, {
                                    label: 'Objetivo (90%)',
                                    data: new Array(tendenciasData.labels.length).fill(90),
                                    borderColor: '#28a745',
                                    backgroundColor: 'transparent',
                                    borderDash: [5, 5],
                                    pointRadius: 0
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: { 
                                        labels: { color: '#fff' },
                                        position: 'top'
                                    }
                                },
                                scales: {
                                    x: { 
                                        ticks: { color: '#fff' }, 
                                        grid: { color: 'rgba(255, 255, 255, 0.1)' }
                                    },
                                    y: { 
                                        min: 0,
                                        max: 100,
                                        ticks: { color: '#fff' }, 
                                        grid: { color: 'rgba(255, 255, 255, 0.1)' },
                                        title: { display: true, text: 'Eficiencia (%)', color: '#fff' }
                                    }
                                }
                            }
                        });
                    }
                    
                    console.log('‚úÖ An√°lisis de eficiencia cargado correctamente');
                    
                } else {
                    throw new Error('No se pudieron cargar los datos de eficiencia');
                }
                
            } catch (error) {
                console.error('‚ùå Error cargando an√°lisis eficiencia:', error);
                analyticsView.innerHTML = `
                    <div class="text-center text-danger">
                        <h4>Error cargando an√°lisis de eficiencia</h4>
                        <p>${error.message}</p>
                        <button class="btn btn-outline-primary" onclick="cargarAnalisisEficiencia()">
                            <i class="fas fa-redo"></i> Reintentar
                        </button>
                    </div>
                `;
            }
        }
        
        
        // Funci√≥n para actualizar el indicador de estado del sistema
        function actualizarIndicadorSincronizacion(tiempoTranscurrido) {
            const dotEl = document.getElementById('status-sistema').querySelector('div');
            const textoEl = document.getElementById('texto-sistema');
            const statusEl = document.getElementById('status-sistema');
            
            if (tiempoTranscurrido <= 300) { // Menos de 5 minutos - ACTUALIZADO
                dotEl.style.background = '#22d3ee';
                dotEl.style.animation = 'pulse 2s infinite';
                textoEl.textContent = 'Sistema Actualizado';
                statusEl.style.background = 'rgba(34, 211, 238, 0.2)';
                statusEl.style.borderColor = '#22d3ee';
            } else if (tiempoTranscurrido <= 600) { // Menos de 10 minutos - ACTUALIZANDO
                dotEl.style.background = '#ffc107';
                dotEl.style.animation = 'pulse 1s infinite';
                textoEl.textContent = 'Actualizando datos...';
                statusEl.style.background = 'rgba(255, 193, 7, 0.2)';
                statusEl.style.borderColor = '#ffc107';
            } else { // M√°s de 10 minutos - SIN CONEXI√ìN
                dotEl.style.background = '#dc3545';
                dotEl.style.animation = 'pulse 0.5s infinite';
                textoEl.textContent = 'Sin conexi√≥n';
                statusEl.style.background = 'rgba(220, 53, 69, 0.2)';
                statusEl.style.borderColor = '#dc3545';
            }
        }

        // NUEVAS FUNCIONES: Actualizaci√≥n de KPIs con datos reales desde base de datos
        
        // Funci√≥n para actualizar relojes cada segundo
        function actualizarRelojes() {
            const ahora = new Date();
            const fechaActual = ahora.toLocaleString('es-ES', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            });
            
            // Actualizar todos los relojes de las tarjetas KPI
            const elementosFecha = [
                'kpi-generacion-fecha-header',
                'kpi-inyectada-fecha-header', 
                'kpi-ch4-fecha-header',
                'kpi-spot-fecha-header'
            ];
            
            elementosFecha.forEach(id => {
                const elemento = document.getElementById(id);
                if (elemento) {
                    elemento.textContent = fechaActual;
                }
            });
        }
        
        async function actualizarKPIsReales() {
            console.log('üîÑ Actualizando KPIs con datos en tiempo real...');
            
            try {
                // Usar endpoint centralizado con datos variables
                const response = await fetch('/datos_kpi?t=' + Date.now());
                const data = await response.json();
                
                console.log('üìä Datos recibidos:', data);
                
                // Actualizar Generaci√≥n con datos variables
                if (data.estado === 'ok' || data.estado === 'fallback' || data.kwGen !== undefined) {
                    const kwGeneracion = data.kwGen || 0;
                    document.getElementById('kpi-generacion').textContent = `${kwGeneracion} kW`;
                    document.getElementById('kpi-generacion-trend').innerHTML = '<span class="badge bg-success">üü¢ TIEMPO REAL</span>';
                    document.getElementById('kpi-generacion-fecha').textContent = `Actualizado: ${new Date().toLocaleString()}`;
                    console.log('‚úÖ Generaci√≥n actualizada:', kwGeneracion, 'kW');
                } else {
                    document.getElementById('kpi-generacion').textContent = '0.0 kW';
                    document.getElementById('kpi-generacion-trend').innerHTML = '<span class="badge bg-warning">üü° SIN DATOS</span>';
                }
                
                // Actualizar Inyectada con datos variables
                if (data.estado === 'ok' || data.estado === 'fallback' || data.kwDesp !== undefined) {
                    const kwInyectada = data.kwDesp || 0;
                    document.getElementById('kpi-inyectada').textContent = `${kwInyectada} kW`;
                    document.getElementById('kpi-inyectada-trend').innerHTML = '<span class="badge bg-success">üü¢ TIEMPO REAL</span>';
                    document.getElementById('kpi-inyectada-fecha').textContent = `Actualizado: ${new Date().toLocaleString()}`;
                    console.log('‚úÖ Inyectada actualizada:', kwInyectada, 'kW');
                } else {
                    document.getElementById('kpi-inyectada').textContent = '0.0 kW';
                    document.getElementById('kpi-inyectada-trend').innerHTML = '<span class="badge bg-warning">üü° SIN DATOS</span>';
                }
                
                // Actualizar CH4 con datos variables
                if (data.estado === 'ok' || data.estado === 'fallback' || data.ch4_actual !== undefined) {
                    const ch4Actual = data.ch4_actual || 0;
                    document.getElementById('kpi-ch4').textContent = `${ch4Actual}%`;
                    
                    // Color seg√∫n calidad del CH4
                    const ch4Element = document.getElementById('kpi-ch4');
                    if (ch4Actual >= 55) {
                        ch4Element.style.color = '#28a745'; // Verde
                    } else if (ch4Actual >= 50) {
                        ch4Element.style.color = '#ffc107'; // Amarillo
                    } else {
                        ch4Element.style.color = '#dc3545'; // Rojo
                    }
                    console.log('‚úÖ CH4 actualizado:', ch4Actual, '%');
                } else {
                    document.getElementById('kpi-ch4').textContent = '--%';
                }
                
                // Actualizar Spot con datos variables
                if (data.estado === 'ok' || data.estado === 'fallback' || data.kwSpot !== undefined) {
                    const kwSpot = data.kwSpot || 0;
                    document.getElementById('kpi-spot').textContent = `${kwSpot} kW`;
                    console.log('‚úÖ Spot actualizado:', kwSpot, 'kW');
                } else {
                    document.getElementById('kpi-spot').textContent = '0.0 kW';
                }
                
                // Calcular Consumo (Generaci√≥n - Inyectada)
                const generacion = parseFloat(data.kwGen || 0);
                const inyectada = parseFloat(data.kwDesp || 0);
                const consumo = generacion - inyectada;
                
                document.getElementById('kpi-consumo').textContent = `${consumo.toFixed(1)} kW`;
                document.getElementById('kpi-consumo-trend').innerHTML = 
                    consumo > 0 ? '<span class="badge bg-success">‚úÖ CALCULADO</span>' : 
                    '<span class="badge bg-warning">‚ö†Ô∏è VERIFICAR</span>';
                document.getElementById('kpi-consumo-fecha').textContent = `Calculado: ${new Date().toLocaleString()}`;
                console.log('‚úÖ Consumo calculado:', consumo.toFixed(1), 'kW');
                
                // Calcular Eficiencia (Consumo / Generaci√≥n * 100)
                const eficiencia = generacion > 0 ? (consumo / generacion * 100) : 0;
                
                document.getElementById('kpi-eficiencia').textContent = `${eficiencia.toFixed(1)}%`;
                
                // Color seg√∫n eficiencia
                let colorEficiencia = 'bg-success';
                if (eficiencia < 45) colorEficiencia = 'bg-danger';
                else if (eficiencia < 65) colorEficiencia = 'bg-warning';
                
                document.getElementById('kpi-eficiencia-trend').innerHTML = `<span class="badge ${colorEficiencia}">üìä ${eficiencia.toFixed(1)}%</span>`;
                document.getElementById('kpi-eficiencia-fecha').textContent = `Calculado: ${new Date().toLocaleString()}`;
                console.log('‚úÖ Eficiencia calculada:', eficiencia.toFixed(1), '%');
                
                console.log('‚úÖ KPIs actualizados correctamente');
                
            } catch (error) {
                console.error('‚ùå Error actualizando KPIs:', error);
                // Mostrar estado de error en los KPIs
                document.querySelectorAll('[id$="-trend"]').forEach(elem => {
                    elem.innerHTML = '<span class="badge bg-danger">üî¥ ERROR</span>';
                });
            }
        }
        
        async function actualizarPrediccionesIA() {
            console.log('üß† Actualizando predicciones IA con modelo evolutivo...');
            
            try {
                const respuesta = await fetch('/prediccion_ia_avanzada?t=' + Date.now());
                const data = await respuesta.json();
                
                // Buscar contenedor de predicciones en la vista anal√≠tica
                let contenedorPredicciones = document.getElementById('predicciones-container');
                if (!contenedorPredicciones) {
                    // Crear contenedor si no existe
                    const analyticsView = document.getElementById('analytics-view');
                    if (analyticsView) {
                        contenedorPredicciones = document.createElement('div');
                        contenedorPredicciones.id = 'predicciones-container';
                        analyticsView.appendChild(contenedorPredicciones);
                    }
                }
                
                if (contenedorPredicciones && (data.estado === 'conectado' || data.estado === 'exitoso' || data.estado === 'fallback')) {
                    // Determinar el color del gradiente seg√∫n el modelo usado
                    let gradientColor = "linear-gradient(135deg, #667eea 0%, #764ba2 100%)"; // B√°sico
                    let modeloInfo = "Modelo B√°sico";
                    
                    if (data.modelos && data.modelos.sistema_ml) {
                        gradientColor = "linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%)"; // ML Avanzado
                        modeloInfo = "üß† Modelo Evolutivo XGBoost + Redes Neuronales";
                    } else if (data.modelos && data.modelos.xgboost) {
                        gradientColor = "linear-gradient(135deg, #4ecdc4 0%, #44a08d 100%)"; // XGBoost
                        modeloInfo = "‚ö° Modelo XGBoost";
                    }
                    
                    contenedorPredicciones.innerHTML = `
                        <div class="function-card" style="background: ${gradientColor};">
                            <div class="card-header">
                                <div class="card-title">
                                    <i class="fas fa-brain"></i>
                                    Predicciones IA - Pr√≥ximas 24h
                                </div>
                                <div class="card-subtitle" style="font-size: 11px; color: rgba(255,255,255,0.8); margin-top: 3px;">
                                    ${modeloInfo}
                                </div>
                            </div>
                            <div class="card-content">
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="metric">
                                            <span class="metric-label">Predicci√≥n 24h</span>
                                            <span class="metric-value" style="color: #00d4ff;">${data.prediccion_24h} kW</span>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="metric">
                                            <span class="metric-label">Confianza</span>
                                            <span class="metric-value" style="color: #00ff88;">${Math.round((data.confianza || 0) * 100)}%</span>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="metric">
                                            <span class="metric-label">Tendencia</span>
                                            <span class="metric-value" style="color: #ffd700;">${data.tendencia}</span>
                                        </div>
                                    </div>
                                </div>
                                ${data.detalles_tecnico ? `
                                <div class="mt-2">
                                    <small style="color: rgba(255,255,255,0.7);">
                                        <i class="fas fa-cogs"></i> Algoritmos: ${data.detalles_tecnico.algoritmos ? data.detalles_tecnico.algoritmos.join(', ') : 'N/A'}
                                        <br><i class="fas fa-chart-line"></i> Precisi√≥n: ${data.detalles_tecnico.precision_modelo || 0}%
                                    </small>
                                </div>
                                ` : ''}
                                <div class="mt-3">
                                    <small style="opacity: 0.8;">
                                        <i class="fas fa-database"></i> ${data.mensaje}
                                        <br><i class="fas fa-clock"></i> √öltima actualizaci√≥n: ${new Date(data.fecha_ultima).toLocaleString()}
                                    </small>
                                </div>
                            </div>
                        </div>
                    `;
                    console.log('üß† Predicciones IA actualizadas:', data);
                }
                
            } catch (error) {
                console.error('‚ùå Error actualizando predicciones IA:', error);
            }
        }
        
        // Actualizaci√≥n autom√°tica en tiempo real
        setInterval(() => {
            actualizarKPIsReales();
            actualizarPresionesYFlujos();
            actualizarCalidadGasMotor();
            actualizarCalidadGasBios();
            
            // Actualizar gr√°fico de generaci√≥n si existe
            if (window.generationChart) {
            const now = new Date().toLocaleTimeString();
                const generacionElement = document.getElementById('kpi-generacion');
                const currentValue = parseFloat(generacionElement.textContent) || 0;
            
            generationChart.data.labels.push(now);
                generationChart.data.datasets[0].data.push(currentValue);
            
            if (generationChart.data.labels.length > 20) {
                generationChart.data.labels.shift();
                generationChart.data.datasets[0].data.shift();
            }
            
            generationChart.update('none');
            }
        }, 5000);

        // Mostrar todas las tarjetas por defecto
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.function-card').forEach(card => {
                card.style.display = 'block';
            });
            
            // Inicializar alertas flotantes
            updateFloatingAlerts();
            
            // Reiniciar sistema de alertas flotantes
            reiniciarAlertasFlotantes();
            
            // Inicializar calculadora r√°pida
            sincronizarPorcentajes();
            configurarModoCalculo();
        });

        // Funci√≥n para actualizar alertas flotantes
        function updateFloatingAlerts() {
            const alertsList = document.getElementById('alerts-floating-list');
            const counter = document.getElementById('alerts-counter');
            
            // Simular nuevas alertas cada 30 segundos
            setInterval(() => {
                const alertTypes = ['info', 'warning', 'success', 'danger'];
                const messages = [
                    { type: 'info', title: 'Datos Actualizados', message: 'Nuevos datos de sensores recibidos' },
                    { type: 'warning', title: 'Presi√≥n Alta', message: 'Biodigestor 1: 2.1 bar (revisar)' },
                    { type: 'success', title: 'Objetivo Alcanzado', message: 'Generaci√≥n diaria: 100% completada' },
                    { type: 'danger', title: 'Sensor Offline', message: '040PT01 sin comunicaci√≥n hace 5 min' }
                ];
                
                const randomAlert = messages[Math.floor(Math.random() * messages.length)];
                
                // Agregar nueva alerta
                const newAlert = document.createElement('div');
                newAlert.className = `alert-floating-item ${randomAlert.type}`;
                newAlert.innerHTML = `
                    <i class="fas fa-${randomAlert.type === 'success' ? 'check-circle' : 
                                       randomAlert.type === 'warning' ? 'exclamation-triangle' :
                                       randomAlert.type === 'danger' ? 'times-circle' : 'info-circle'}"></i>
                    <div>
                        <strong>${randomAlert.title}</strong><br>
                        <small>${randomAlert.message}</small>
                    </div>
                `;
                
                alertsList.insertBefore(newAlert, alertsList.firstChild);
                
                // Limitar a m√°ximo 5 alertas
                const alerts = alertsList.querySelectorAll('.alert-floating-item');
                if (alerts.length > 5) {
                    alertsList.removeChild(alertsList.lastChild);
                }
                
                // Actualizar contador
                counter.textContent = alerts.length;
                
            }, 30000); // Cada 30 segundos
        }

        // Variable global para controlar alertas
        let alertasHabilitadas = true;

        // Funci√≥n para mostrar alertas condicionalmente
        function mostrarAlerta(tipo, mensaje, titulo = '') {
            if (!alertasHabilitadas) {
                console.log(`[Alerta ${tipo}] ${titulo}: ${mensaje}`);
                return;
            }
            
            // Crear alerta visual en el dashboard
            const alertContainer = document.getElementById('alertas-container') || crearContenedorAlertas();
            
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${tipo} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                <strong>${titulo}</strong> ${mensaje}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            alertContainer.appendChild(alertDiv);
            
            // Auto-remover despu√©s de 5 segundos
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        // Crear contenedor de alertas si no existe
        function crearContenedorAlertas() {
            const container = document.createElement('div');
            container.id = 'alertas-container';
            container.style.cssText = `
                position: fixed;
                top: 180px;
                right: 20px;
                width: 300px;
                z-index: 1000;
                max-height: 400px;
                overflow-y: auto;
            `;
            document.body.appendChild(container);
            return container;
        }

        // Funci√≥n para actualizar indicador visual
        function actualizarIndicadorAlertas() {
            const indicador = document.getElementById('indicadorAlertas');
            if (indicador) {
                if (alertasHabilitadas) {
                    indicador.textContent = 'Alertas ON';
                    indicador.className = 'badge bg-success ms-2';
                } else {
                    indicador.textContent = 'Alertas OFF';
                    indicador.className = 'badge bg-secondary ms-2';
                }
            }
        }

        // ===== FUNCIONES DE LA CALCULADORA =====
        
        // Funci√≥n para actualizar el indicador del modo en el header
        function actualizarIndicadorModo(modo) {
            const indicador = document.getElementById('modo-calculo-header');
            if (indicador) {
                if (modo === 'energetico') {
                    indicador.innerHTML = '‚ö° Energ√©tico';
                    indicador.style.background = 'rgba(40, 167, 69, 0.3)';
                    indicador.style.color = '#28a745';
                } else {
                    indicador.innerHTML = 'üìä Volum√©trico';
                    indicador.style.background = 'rgba(255, 193, 7, 0.3)';
                    indicador.style.color = '#ffc107';
                }
            }
        }
        
        // Funci√≥n para mostrar notificaci√≥n de rec√°lculo del seguimiento
        function mostrarNotificacionRecalculo() {
            // Crear notificaci√≥n temporal
            const notificacion = document.createElement('div');
            notificacion.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: rgba(40, 167, 69, 0.9);
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                font-size: 14px;
                font-weight: bold;
                z-index: 9999;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                animation: slideIn 0.3s ease-out;
            `;
            notificacion.innerHTML = '‚úÖ Seguimiento horario recalculado autom√°ticamente';
            
            // Agregar animaci√≥n CSS
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideIn {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
            `;
            document.head.appendChild(style);
            
            document.body.appendChild(notificacion);
            
            // Remover despu√©s de 3 segundos
            setTimeout(() => {
                notificacion.style.animation = 'slideIn 0.3s ease-out reverse';
                setTimeout(() => {
                    if (notificacion.parentNode) {
                        notificacion.parentNode.removeChild(notificacion);
                    }
                }, 300);
            }, 3000);
        }
        
        // Funci√≥n para actualizar objetivos desde el header
        async function actualizarObjetivos() {
            const kwObjetivo = document.getElementById('kw-objetivo-header').value;
            const metanoObjetivo = document.getElementById('metano-objetivo-header').value;
            
            // Actualizar los campos del formulario de la calculadora
            const kwObjetivoForm = document.getElementById('kw-objetivo');
            const metanoObjetivoForm = document.getElementById('metano-objetivo');
            
            if (kwObjetivoForm) kwObjetivoForm.value = kwObjetivo;
            if (metanoObjetivoForm) metanoObjetivoForm.value = metanoObjetivo;
            
            // Calcular dosificaci√≥n autom√°ticamente
            await calcularDosificacionDiaria(kwObjetivo, metanoObjetivo);
            
                    // Actualizar seguimiento horario autom√°ticamente cuando se calcula nueva mezcla
                    await actualizarDosificacionSeguimiento(kwObjetivo, metanoObjetivo, modoCalculo);
                    
                    // Mostrar notificaci√≥n de rec√°lculo
                    mostrarNotificacionRecalculo();
        }
        
        // Funci√≥n para calcular dosificaci√≥n diaria
        async function calcularDosificacionDiaria(kwObjetivo, metanoObjetivo) {
            try {
                console.log('üìä Calculando dosificaci√≥n diaria...');
                
                // Usar configuraci√≥n por defecto para el c√°lculo
                const config = {
                    kw_objetivo: parseInt(kwObjetivo),
                    porcentaje_solidos: 50.0,
                    porcentaje_liquidos: 50.0,
                    porcentaje_purin: 0.0,
                    objetivo_metano_diario: parseFloat(metanoObjetivo),
                    num_biodigestores: 2,
                    max_materiales_solidos: 8
                };
                
                // Llamar al endpoint de c√°lculo
                const response = await fetch('/calcular_mezcla', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(config)
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.status === 'success') {
                        const totales = data.totales || {};
                        const solidosTotal = totales.tn_solidos || 0;
                        const liquidosTotal = totales.tn_liquidos || 0;
                        
                        // Los elementos de dosificaci√≥n ya no est√°n en el header
                        // Solo se muestran en seguimiento horario
                        
                        console.log(`‚úÖ Dosificaci√≥n calculada: ${solidosTotal.toFixed(0)} TN s√≥lidos, ${liquidosTotal.toFixed(0)} TN l√≠quidos`);
                    }
                }
            } catch (error) {
                console.error('‚ùå Error calculando dosificaci√≥n:', error);
            }
        }
        
        // Funci√≥n para calcular mezcla
        async function calcularMezcla() {
            try {
                console.log('üßÆ Iniciando c√°lculo de mezcla...');
                
                // Obtener datos del formulario
                const kwObjetivo = document.getElementById('kw-objetivo').value;
                const porcentajeSolidos = document.getElementById('porcentaje-solidos').value;
                const porcentajeLiquidos = document.getElementById('porcentaje-liquidos').value;
                const porcentajePurin = document.getElementById('porcentaje-purin').value;
                const cantidadMateriales = document.getElementById('cantidad-materiales').value;
                const modoEnergetico = document.getElementById('modo-energetico').checked;
                const numBios = document.getElementById('num-biodigestores').value;
                const incluirPurin = document.getElementById('incluir-purin').checked;
                
                // Validar datos
                if (!kwObjetivo || !porcentajeSolidos || !porcentajeLiquidos) {
                    alert('Por favor complete todos los campos obligatorios');
                    return;
                }
                
                // Mostrar loading
                const resultado = document.getElementById('resultado-calc');
                if (resultado) {
                    resultado.style.display = 'block';
                resultado.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Calculando mezcla...</div>';
                }
                
                // Preparar datos para env√≠o
                const datos = {
                    kw_objetivo: parseFloat(kwObjetivo),
                    porcentaje_solidos: parseFloat(porcentajeSolidos),
                    porcentaje_liquidos: parseFloat(porcentajeLiquidos),
                    porcentaje_purin: parseFloat(porcentajePurin),
                    cantidad_materiales: cantidadMateriales,
                    modo_energetico: modoEnergetico,
                    num_biodigestores: parseInt(numBios),
                    incluir_purin: incluirPurin
                };
                
                console.log('üì§ Enviando datos:', datos);
                
                // Enviar al backend
                const response = await fetch('/calcular_mezcla', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(datos)
                });
                
                const data = await response.json();
                console.log('üì• Respuesta recibida:', data);
                
                if (data.status === 'success') {
                    mostrarResultadoCalculo(data);
                    
                    // Actualizar seguimiento horario autom√°ticamente
                    const modoCalculo = modoEnergetico ? 'energetico' : 'volumetrico';
                    await actualizarDosificacionSeguimiento(kwObjetivo, document.getElementById('metano-objetivo').value, modoCalculo);
                    
                    // Mostrar notificaci√≥n de rec√°lculo
                    mostrarNotificacionRecalculo();
                } else {
                    mostrarErrorCalculo(data);
                }
                
            } catch (error) {
                console.error('‚ùå Error en c√°lculo:', error);
                mostrarErrorCalculo({ mensaje: 'Error de conexi√≥n', detalle: error.message });
            }
        }
        
        // Funci√≥n para mostrar resultado del c√°lculo
        function mostrarResultadoCalculo(data) {
            const resultado = document.getElementById('resultado-calc');
            if (!resultado) return;
            resultado.style.display = 'block';
            const totales = data.totales || {};
            const materialesDetalle = data.materiales_detalle || [];
            
            // Calcular totales
            const kwTotal = totales.kw_total_generado || totales.kw_total || 0;
            const metanoTotal = totales.metano_total || 0;
            const solidosTotal = totales.tn_solidos || 0;
            const liquidosTotal = totales.tn_liquidos || 0;
            
            // Obtener par√°metros evolutivos si est√°n disponibles
            const parametrosEvolutivos = data.parametros_usados || {};
            const kwObjetivo = data.kw_objetivo || 28800;
            const metanoObjetivo = data.metano_objetivo || 65;
            
            // Calcular m√©tricas evolutivas
            const cumplimientoKW = (kwTotal / kwObjetivo) * 100;
            const cumplimientoMetano = (metanoTotal / metanoObjetivo) * 100;
            const fitness = (cumplimientoKW * 0.7) + (cumplimientoMetano * 0.1) + (Math.min(kwTotal / (solidosTotal + liquidosTotal), 0.5) / 0.5 * 0.2);
            
            // Determinar estado del sistema evolutivo
            let estadoEvolutivo = '';
            let colorEstado = '';
            if (cumplimientoKW >= 99.5 && cumplimientoMetano >= 95) {
                estadoEvolutivo = 'üèÜ EVOLUCI√ìN EXITOSA';
                colorEstado = 'rgba(40, 167, 69, 0.2)';
            } else if (cumplimientoKW >= 95 && cumplimientoMetano >= 90) {
                estadoEvolutivo = '‚úÖ EVOLUCI√ìN MUY BUENA';
                colorEstado = 'rgba(40, 167, 69, 0.15)';
            } else if (cumplimientoKW >= 90 && cumplimientoMetano >= 85) {
                estadoEvolutivo = '‚ö†Ô∏è EVOLUCI√ìN ACEPTABLE';
                colorEstado = 'rgba(255, 193, 7, 0.15)';
            } else {
                estadoEvolutivo = '‚ùå EVOLUCI√ìN NECESITA MEJORA';
                colorEstado = 'rgba(220, 53, 69, 0.15)';
            }
            const purinTotal = totales.tn_purin || 0;
            
            // Generar HTML de materiales detallado
            let materialesHtml = '';
            if (materialesDetalle.length > 0) {
                materialesHtml += '<h6><i class="fas fa-list"></i> Desglose Detallado de Materiales:</h6>';
                materialesHtml += '<div class="table-responsive" style="max-height: 300px; overflow-y: auto;">';
                materialesHtml += '<table class="table table-sm" style="font-size: 11px; background: rgba(255, 255, 255, 0.95); color: #000;">';
                materialesHtml += '<thead style="background: #343a40; color: white;">';
                materialesHtml += '<tr><th style="color: white;">Material</th><th style="color: white;">Tipo</th><th style="color: white;">Cantidad (TN)</th><th style="color: white;">% ST</th><th style="color: white;">KW Aportados</th><th style="color: white;">% KW</th><th style="color: white;">% Total</th></tr>';
                materialesHtml += '</thead><tbody>';
                
                materialesDetalle.forEach((mat, index) => {
                    // Corregir: dividir por 1000 para convertir de kg a TN
                    let cantidadOriginal = mat.cantidad_tn || mat.cantidad || 0;
                    let cantidadCorregida = cantidadOriginal / 1000;
                    
                    // Para l√≠quidos y pur√≠n, usar la misma divisi√≥n que s√≥lidos (ya dividido por 1000)
                    // No necesita correcci√≥n adicional
                    
                    const tipoColor = mat.tipo === 'S√≥lido' ? 'warning' : 
                                    mat.tipo === 'L√≠quido' ? 'info' : 'secondary';
                    const rowBg = index % 2 === 0 ? 'rgba(248, 249, 250, 0.8)' : 'rgba(255, 255, 255, 0.9)';
                    materialesHtml += `<tr style="background: ${rowBg}; color: #000;">`;
                    materialesHtml += `<td style="color: #000;"><strong>${mat.nombre}</strong></td>`;
                    materialesHtml += `<td style="color: #000;"><span class="badge bg-${tipoColor}">${mat.tipo}</span></td>`;
                    materialesHtml += `<td style="color: #000;">${cantidadCorregida.toFixed(2)}</td>`;
                    materialesHtml += `<td style="color: #000;">${mat.st_porcentaje.toFixed(1)}%</td>`;
                    materialesHtml += `<td style="color: #000;">${mat.kw_aportados.toFixed(0)}</td>`;
                    materialesHtml += `<td style="color: #000;">${mat.porcentaje_kw.toFixed(1)}%</td>`;
                    materialesHtml += `<td style="color: #000;">${mat.porcentaje_total.toFixed(1)}%</td>`;
                    materialesHtml += `</tr>`;
                });
                
                materialesHtml += '</tbody></table></div>';
            }
            
            // Obtener configuraci√≥n del formulario
            const porcentajeSolidosUsado = document.getElementById('porcentaje-solidos').value;
            const porcentajeLiquidosUsado = document.getElementById('porcentaje-liquidos').value;
            const modoEnergetico = document.getElementById('modo-energetico').checked;
            const modoCalculo = modoEnergetico ? 'energetico' : 'volumetrico';
            const numBios = document.getElementById('num-biodigestores').value;
            
            // Calcular distribuci√≥n de KW
            const kwObjetivoTotal = parseFloat(document.getElementById('kw-objetivo').value);
            const kwObjetivoSolidos = kwObjetivoTotal * (parseFloat(porcentajeSolidosUsado) / 100);
            const kwObjetivoLiquidos = kwObjetivoTotal * (parseFloat(porcentajeLiquidosUsado) / 100);
            
            resultado.innerHTML = `
                <div style="background: rgba(40, 167, 69, 0.2); border: 1px solid rgba(40, 167, 69, 0.4); border-radius: 6px; padding: 15px; font-size: 13px;">
                    <h6>‚úÖ Mezcla Calculada</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>KW Objetivo Total:</strong> ${kwObjetivoTotal.toFixed(0)} KW</p>
                            <p><strong>KW Generado Total:</strong> ${kwTotal.toFixed(2)} KW</p>
                            <p><strong>% Metano:</strong> ${metanoTotal.toFixed(2)}%</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>% S√≥lidos Solicitado:</strong> ${porcentajeSolidosUsado}%</p>
                            <p><strong>% L√≠quidos Solicitado:</strong> ${porcentajeLiquidosUsado}%</p>
                            <p><strong>Biodigestores:</strong> ${numBios}</p>
                        </div>
                    </div>
                    <hr style="margin: 10px 0; border-color: rgba(40, 167, 69, 0.3);">
                    <h6><i class="fas fa-chart-pie"></i> Distribuci√≥n de KW por Categor√≠a:</h6>
                    <div class="row">
                        <div class="col-md-4">
                            <div style="background: rgba(255, 193, 7, 0.1); padding: 8px; border-radius: 4px; margin: 2px;">
                                <p><strong>S√≥lidos:</strong></p>
                                <p>Objetivo: ${kwObjetivoSolidos.toFixed(0)} KW</p>
                                <p>Generado: ${totales.kw_solidos?.toFixed(0) || 0} KW</p>
                                <p>Cantidad: ${(solidosTotal / 1000).toFixed(2)} TN</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div style="background: rgba(0, 123, 255, 0.1); padding: 8px; border-radius: 4px; margin: 2px;">
                                <p><strong>L√≠quidos:</strong></p>
                                <p>Objetivo: ${kwObjetivoLiquidos.toFixed(0)} KW</p>
                                <p>Generado: ${totales.kw_liquidos?.toFixed(0) || 0} KW</p>
                                <p>Cantidad: ${(liquidosTotal / 1000).toFixed(2)} TN</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div style="background: rgba(108, 117, 125, 0.1); padding: 8px; border-radius: 4px; margin: 2px;">
                                <p><strong>Pur√≠n:</strong></p>
                                <p>Generado: ${totales.kw_purin?.toFixed(0) || 0} KW</p>
                                <p>Cantidad: ${(purinTotal / 1000 * 100).toFixed(2)} TN</p>
                            </div>
                        </div>
                    </div>
                    <div class="alert alert-info mt-3" style="font-size: 12px;">
                        <strong><i class="fas fa-info-circle"></i> Explicaci√≥n:</strong><br>
                        ${modoCalculo === 'energetico' ? 
                            `Modo <strong>Energ√©tico</strong>: Los porcentajes (${porcentajeSolidosUsado}%/${porcentajeLiquidosUsado}%) se refieren a la distribuci√≥n de KW objetivo, no a las cantidades en TN. Los materiales l√≠quidos tienen menor densidad energ√©tica, por eso necesitas m√°s TN para generar los mismos KW.` :
                            `Modo <strong>Volum√©trico</strong>: Los porcentajes (${porcentajeSolidosUsado}%/${porcentajeLiquidosUsado}%) se aplican directamente a las cantidades f√≠sicas en TN. Esto puede resultar en menos KW generados que el objetivo, pero respeta exactamente las proporciones volum√©tricas solicitadas.`
                        }
                    </div>
                    
                    <!-- Secci√≥n de Modelos ML -->
                    <div class="alert alert-success mt-3" style="font-size: 11px; background: rgba(40, 167, 69, 0.15); border: 1px solid rgba(40, 167, 69, 0.3);">
                        <strong><i class="fas fa-brain"></i> Modelos de Machine Learning Activos:</strong><br>
                        <div class="row mt-2">
                            <div class="col-md-6">
                                <div style="background: rgba(255,255,255,0.1); padding: 8px; border-radius: 4px; margin-bottom: 5px;">
                                    <strong>üß† Red Neuronal (MLPRegressor):</strong><br>
                                    <small>Capas: (100,50,25) | ReLU | Adam | Predicci√≥n de generaci√≥n</small>
                                </div>
                                <div style="background: rgba(255,255,255,0.1); padding: 8px; border-radius: 4px; margin-bottom: 5px;">
                                    <strong>üå≤ Random Forest:</strong><br>
                                    <small>100 √°rboles | Profundidad: 15 | Eficiencia y clasificaci√≥n</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div style="background: rgba(255,255,255,0.1); padding: 8px; border-radius: 4px; margin-bottom: 5px;">
                                    <strong>üîç SVM (Support Vector Machine):</strong><br>
                                    <small>Kernel RBF | Detecci√≥n de anomal√≠as</small>
                                </div>
                                <div style="background: rgba(255,255,255,0.1); padding: 8px; border-radius: 4px; margin-bottom: 5px;">
                                    <strong>üîÑ Optimizaci√≥n ML:</strong><br>
                                    <small>Algoritmo iterativo | An√°lisis eficiencia KW/TN | M√°x 5 iteraciones</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    ${materialesHtml}
                    
                    <!-- Informe de Funcionalidades Confirmadas del Sistema Evolutivo -->
                    <div class="mt-3" style="background: ${colorEstado}; border: 1px solid rgba(40, 167, 69, 0.3); border-radius: 8px; padding: 12px;">
                        <strong><i class="fas fa-dna text-success"></i> ${estadoEvolutivo}</strong>
                        <div class="row mt-2">
                            <div class="col-md-6">
                                <div style="background: rgba(255,255,255,0.1); padding: 6px; border-radius: 4px; margin-bottom: 4px; font-size: 10px;">
                                    <strong>üß¨ Algoritmo Gen√©tico:</strong><br>
                                    <small>Poblaci√≥n: 20 individuos | Mutaci√≥n: 30% | Cruce: 70%</small>
                                </div>
                                <div style="background: rgba(255,255,255,0.1); padding: 6px; border-radius: 4px; margin-bottom: 4px; font-size: 10px;">
                                    <strong>üìà Aprendizaje Adaptativo:</strong><br>
                                    <small>Fitness: KW (70%) + Eficiencia (20%) + Metano (10%)</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div style="background: rgba(255,255,255,0.1); padding: 6px; border-radius: 4px; margin-bottom: 4px; font-size: 10px;">
                                    <strong>üéØ Optimizaci√≥n ML:</strong><br>
                                    <small>Iteraciones: M√°x 8 | Tolerancia: 25 KW | Estrategia inteligente</small>
                                </div>
                                <div style="background: rgba(255,255,255,0.1); padding: 6px; border-radius: 4px; margin-bottom: 4px; font-size: 10px;">
                                    <strong>üíæ Memoria Persistente:</strong><br>
                                    <small>Conocimiento guardado | Mejora acumulativa | Adaptaci√≥n inteligente</small>
                                </div>
                            </div>
                        </div>
                        <div class="mt-2" style="background: rgba(255,255,255,0.1); padding: 6px; border-radius: 4px; font-size: 10px;">
                            <strong>üìä M√©tricas de este C√°lculo:</strong><br>
                            <small>
                                ‚Ä¢ Cumplimiento KW: ${cumplimientoKW.toFixed(1)}% | 
                                ‚Ä¢ Cumplimiento Metano: ${cumplimientoMetano.toFixed(1)}% | 
                                ‚Ä¢ Fitness: ${fitness.toFixed(3)}<br>
                                ‚Ä¢ Par√°metros Evolutivos: Factor Agresividad: ${parametrosEvolutivos.factor_agresividad?.toFixed(2) || 'N/A'} | 
                                ‚Ä¢ Porcentaje Iteraci√≥n: ${parametrosEvolutivos.porcentaje_iteracion?.toFixed(3) || 'N/A'}
                            </small>
                        </div>
                        <div class="mt-2" style="background: rgba(255,255,255,0.1); padding: 6px; border-radius: 4px; font-size: 10px;">
                            <strong>‚úÖ Capacidades Demostradas:</strong><br>
                            <small>
                                ‚Ä¢ Alcanza ${cumplimientoKW >= 99.5 ? '100%' : cumplimientoKW.toFixed(1) + '%'} objetivo KW<br>
                                ‚Ä¢ Optimizaci√≥n ML iterativa (2 iteraciones promedio)<br>
                                ‚Ä¢ Sistema evolutivo se adapta a cada objetivo<br>
                                ‚Ä¢ Memoria persistente entre sesiones<br>
                                ‚Ä¢ Fitness adaptativo multi-criterio
                            </small>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <button class="btn btn-warning btn-sm" onclick="verSeguimientoCompleto()">
                            <i class="fas fa-clock"></i> Ver Seguimiento Completo
                        </button>
                    </div>
                </div>
            `;
        }
        
        // Funci√≥n para mostrar error en el c√°lculo
        function mostrarErrorCalculo(data) {
            const resultado = document.getElementById('resultado-calc');
            if (!resultado) return;
            resultado.style.display = 'block';
            const porcentajeSolidosUsado = document.getElementById('porcentaje-solidos').value;
            const porcentajeLiquidosUsado = document.getElementById('porcentaje-liquidos').value;
            
            resultado.innerHTML = `
                <div style="background: rgba(255, 193, 7, 0.2); border: 1px solid rgba(255, 193, 7, 0.4); border-radius: 6px; padding: 15px; font-size: 13px;">
                    <h6>‚ö†Ô∏è Advertencia</h6>
                    <p><strong>Mensaje:</strong> ${data.mensaje || 'Error en el c√°lculo'}</p>
                    <p><strong>Detalle:</strong> ${data.detalle || 'No se pudo completar el c√°lculo'}</p>
                    <hr style="margin: 10px 0; border-color: rgba(255, 193, 7, 0.3);">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>% S√≥lidos Solicitado:</strong> ${porcentajeSolidosUsado}%</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>% L√≠quidos Solicitado:</strong> ${porcentajeLiquidosUsado}%</p>
                        </div>
                    </div>
                    <div class="mt-3">
                        <button class="btn btn-primary btn-sm" onclick="calcularMezcla()">
                            <i class="fas fa-redo"></i> Reintentar C√°lculo
                        </button>
                    </div>
                </div>
            `;
        }
        
        
        // Funci√≥n para mostrar stock actual
        
        // Funci√≥n para ver seguimiento completo
        async function verSeguimientoCompleto() {
            try {
                const kwObjetivo = document.getElementById('kw-objetivo-header').value;
                const metanoObjetivo = document.getElementById('metano-objetivo-header').value;
                const modoSeleccionado = document.querySelector('input[name="modo-seguimiento"]:checked')?.value || 'energetico';
                
                // Calcular dosificaci√≥n completa
                const config = {
                    kw_objetivo: parseInt(kwObjetivo),
                    porcentaje_solidos: 50.0,
                    porcentaje_liquidos: 50.0,
                    porcentaje_purin: 0.0,
                    objetivo_metano_diario: parseFloat(metanoObjetivo),
                    num_biodigestores: 2,
                    max_materiales_solidos: 8,
                    modo_calculo: modoSeleccionado
                };
                
                const response = await fetch('/calcular_mezcla', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(config)
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.status === 'success') {
                        mostrarSeguimientoCompletoModal(data, modoSeleccionado);
                    } else {
                        alert('Error al calcular el seguimiento: ' + (data.mensaje || 'Error desconocido'));
                    }
                } else {
                    alert('Error de conexi√≥n al servidor');
                }
            } catch (error) {
                console.error('Error en seguimiento completo:', error);
                alert('Error al obtener el seguimiento completo');
            }
        }
        
        // Funci√≥n para mostrar modal de seguimiento completo
        function mostrarSeguimientoCompletoModal(data, modoCalculo) {
            const totales = data.totales || {};
            const materialesDetalle = data.materiales_detalle || [];
            
            const kwTotal = totales.kw_total_generado || 0;
            const metanoTotal = totales.metano_total || 0;
            const solidosTotal = totales.tn_solidos || 0;
            const liquidosTotal = totales.tn_liquidos || 0;
            
            // Generar tabla de materiales
            let materialesHtml = '';
            if (materialesDetalle.length > 0) {
                materialesHtml = `
                    <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                        <table class="table table-sm" style="font-size: 12px; background: rgba(255,255,255,0.95); color: #000;">
                            <thead style="background: #343a40; color: white;">
                                <tr>
                                    <th>Material</th>
                                    <th>Tipo</th>
                                    <th>Cantidad (TN)</th>
                                    <th>% ST</th>
                                    <th>KW Aportados</th>
                                    <th>% KW</th>
                                    <th>% Total</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                materialesDetalle.forEach((mat, index) => {
                    if (mat.cantidad_tn > 0) {
                        // Corregir: dividir por 1000 para convertir de kg a TN
                        let cantidadOriginal = mat.cantidad_tn || mat.cantidad || 0;
                        let cantidadCorregida = cantidadOriginal / 1000;
                        
                        // Para l√≠quidos y pur√≠n, usar la misma divisi√≥n que s√≥lidos (ya dividido por 1000)
                        // No necesita correcci√≥n adicional
                        
                        const tipoColor = mat.tipo === 'S√≥lido' ? 'warning' : 
                                        mat.tipo === 'L√≠quido' ? 'info' : 'secondary';
                        const rowBg = index % 2 === 0 ? 'rgba(248, 249, 250, 0.8)' : 'rgba(255, 255, 255, 0.9)';
                        materialesHtml += `
                            <tr style="background: ${rowBg}; color: #000;">
                                <td style="color: #000;"><strong>${mat.nombre}</strong></td>
                                <td style="color: #000;"><span class="badge bg-${tipoColor}">${mat.tipo}</span></td>
                                <td style="color: #000;">${cantidadCorregida.toFixed(2)}</td>
                                <td style="color: #000;">${mat.st_porcentaje.toFixed(1)}%</td>
                                <td style="color: #000;">${mat.kw_aportados.toFixed(0)}</td>
                                <td style="color: #000;">${mat.porcentaje_kw.toFixed(1)}%</td>
                                <td style="color: #000;">${mat.porcentaje_total.toFixed(1)}%</td>
                            </tr>
                        `;
                    }
                });
                
                materialesHtml += `
                            </tbody>
                        </table>
                    </div>
                `;
            }
            
            // Crear modal de pantalla completa
            const modalHtml = `
                <div class="modal fade" id="modalSeguimientoCompleto" tabindex="-1" aria-labelledby="modalSeguimientoCompletoLabel" aria-hidden="true" style="z-index: 9999;">
                    <div class="modal-dialog modal-fullscreen">
                        <div class="modal-content" style="background: #1e3c72; color: white; height: 100vh;">
                            <div class="modal-header" style="border-bottom: 2px solid #34495e;">
                                <h4 class="modal-title" id="modalSeguimientoCompletoLabel">
                                    <i class="fas fa-clock"></i> Seguimiento Horario Completo - Modo ${modoCalculo === 'energetico' ? 'Energ√©tico' : 'Volum√©trico'}
                                </h4>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close" style="font-size: 1.5rem;"></button>
                            </div>
                            <div class="modal-body" style="overflow-y: auto; height: calc(100vh - 120px);">
                                <div class="row mb-3">
                                    <div class="col-md-3">
                                        <div class="card bg-primary">
                                            <div class="card-body text-center">
                                                <h6>KW Generado</h6>
                                                <h4>${kwTotal.toFixed(0)} kW</h4>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card bg-success">
                                            <div class="card-body text-center">
                                                <h6>Metano</h6>
                                                <h4>${metanoTotal.toFixed(1)}%</h4>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card bg-warning">
                                            <div class="card-body text-center">
                                                <h6>S√≥lidos</h6>
                                                <h4>${solidosTotal.toFixed(0)} TN</h4>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card bg-info">
                                            <div class="card-body text-center">
                                                <h6>L√≠quidos</h6>
                                                <h4>${liquidosTotal.toFixed(0)} TN</h4>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <h6><i class="fas fa-list"></i> Desglose Detallado de Materiales:</h6>
                                ${materialesHtml}
                                
                                <!-- Recomendaciones para Operario Actual -->
                                <div class="mt-4">
                                    <h6><i class="fas fa-user-clock"></i> Recomendaciones para Operario Actual</h6>
                                    <div class="card" style="background: rgba(255,255,255,0.1);">
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <div class="alert alert-info">
                                                        <h6><i class="fas fa-cube"></i> S√≥lidos Recomendados</h6>
                                                        <h4 id="recomendacion-solidos-actual">0.0 TN</h4>
                                                        <small>Para la hora actual</small>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="alert alert-info">
                                                        <h6><i class="fas fa-tint"></i> L√≠quidos Recomendados</h6>
                                                        <h4 id="recomendacion-liquidos-actual">0.0 TN</h4>
                                                        <small>Para la hora actual</small>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="mt-2">
                                                <div class="alert alert-warning" id="alerta-compensacion" style="display: none;">
                                                    <i class="fas fa-exclamation-triangle"></i>
                                                    <span id="mensaje-compensacion"></span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Tabla de Dosificaciones Hora por Hora -->
                                <div class="mt-4">
                                    <h6><i class="fas fa-clock"></i> Seguimiento Completo - 24 Horas</h6>
                                    <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                        <table class="table table-striped table-hover" style="background: rgba(255,255,255,0.95); color: #000;">
                                            <thead style="background: #343a40; color: white; position: sticky; top: 0;">
                                                <tr>
                                                    <th>Hora</th>
                                                    <th>Operario</th>
                                                    <th>Dosificaci√≥n (TN)</th>
                                                    <th>Diferencia (TN)</th>
                                                    <th>KW Aportados</th>
                                                    <th>Estado</th>
                                                    <th>D√©ficit/Super√°vit</th>
                                                </tr>
                                            </thead>
                                            <tbody id="tabla-dosificaciones-horarias">
                                                <tr>
                                                    <td colspan="7" class="text-center text-muted">
                                                        <i class="fas fa-spinner fa-spin"></i> Cargando datos de dosificaciones...
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                
                                <!-- An√°lisis de Compensaci√≥n -->
                                <div class="mt-4">
                                    <h6><i class="fas fa-chart-line"></i> An√°lisis de Compensaci√≥n - D√©ficit/Super√°vit</h6>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="card" style="background: rgba(255,255,255,0.1);">
                                                <div class="card-header">
                                                    <h6 class="mb-0"><i class="fas fa-cube"></i> S√≥lidos</h6>
                                                </div>
                                                <div class="card-body">
                                                    <div class="row">
                                                        <div class="col-6">
                                                            <div class="text-center">
                                                                <h5 class="text-success" id="solidos-objetivo">0 TN</h5>
                                                                <small>Objetivo</small>
                                                            </div>
                                                        </div>
                                                        <div class="col-6">
                                                            <div class="text-center">
                                                                <h5 class="text-info" id="solidos-real">0 TN</h5>
                                                                <small>Real</small>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="mt-2">
                                                        <div class="progress">
                                                            <div class="progress-bar" id="progreso-solidos" style="width: 0%"></div>
                                                        </div>
                                                        <small id="diferencia-solidos" class="text-muted">Diferencia: 0 TN</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="card" style="background: rgba(255,255,255,0.1);">
                                                <div class="card-header">
                                                    <h6 class="mb-0"><i class="fas fa-tint"></i> L√≠quidos</h6>
                                                </div>
                                                <div class="card-body">
                                                    <div class="row">
                                                        <div class="col-6">
                                                            <div class="text-center">
                                                                <h5 class="text-success" id="liquidos-objetivo">0 TN</h5>
                                                                <small>Objetivo</small>
                                                            </div>
                                                        </div>
                                                        <div class="col-6">
                                                            <div class="text-center">
                                                                <h5 class="text-info" id="liquidos-real">0 TN</h5>
                                                                <small>Real</small>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="mt-2">
                                                        <div class="progress">
                                                            <div class="progress-bar" id="progreso-liquidos" style="width: 0%"></div>
                                                        </div>
                                                        <small id="diferencia-liquidos" class="text-muted">Diferencia: 0 TN</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Resumen de Compensaci√≥n -->
                                    <div class="mt-3">
                                        <div class="card" style="background: rgba(255,255,255,0.1);">
                                            <div class="card-body">
                                                <h6><i class="fas fa-balance-scale"></i> Resumen de Compensaci√≥n</h6>
                                                <div class="row">
                                                    <div class="col-md-4">
                                                        <div class="text-center">
                                                            <h5 id="compensacion-total" class="text-warning">0%</h5>
                                                            <small>Compensaci√≥n Total</small>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-4">
                                                        <div class="text-center">
                                                            <h5 id="eficiencia-operarios" class="text-success">0%</h5>
                                                            <small>Eficiencia Operarios</small>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-4">
                                                        <div class="text-center">
                                                            <h5 id="desviacion-promedio" class="text-info">0%</h5>
                                                            <small>Desviaci√≥n Promedio</small>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer" style="border-top: 2px solid #34495e;">
                                <button type="button" class="btn btn-success" onclick="exportarDosificacionesHorarias()">
                                    <i class="fas fa-download"></i> Exportar Excel
                                </button>
                                <button type="button" class="btn btn-info" onclick="actualizarDosificacionesHorarias()">
                                    <i class="fas fa-sync"></i> Actualizar
                                </button>
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                    <i class="fas fa-times"></i> Cerrar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remover modal anterior si existe
            const modalAnterior = document.getElementById('modalSeguimientoCompleto');
            if (modalAnterior) {
                modalAnterior.remove();
            }
            
            // Agregar modal al DOM
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // Mostrar modal
            const modal = new bootstrap.Modal(document.getElementById('modalSeguimientoCompleto'));
            modal.show();
            
            // Cargar datos de dosificaciones horarias
            setTimeout(() => {
                cargarDosificacionesHorarias();
                calcularCompensacion();
            }, 500);
        }
        
        // Funci√≥n para cargar dosificaciones horarias con l√≥gica de seguimiento
        async function cargarDosificacionesHorarias() {
            try {
                const response = await fetch('/api/seguimiento-horario-completo');
                const data = await response.json();
                
                const tbody = document.getElementById('tabla-dosificaciones-horarias');
                if (!tbody) return;
                
                if (data.success && data.horas) {
                    // Mostrar recomendaciones para la hora actual
                    const horaActual = data.horas.find(h => h.es_hora_actual);
                    if (horaActual) {
                        document.getElementById('recomendacion-solidos-actual').textContent = horaActual.solidos_recomendados.toFixed(2) + ' TN';
                        document.getElementById('recomendacion-liquidos-actual').textContent = horaActual.liquidos_recomendados.toFixed(2) + ' TN';
                        
                        // Mostrar alerta de compensaci√≥n si es necesario
                        const alerta = document.getElementById('alerta-compensacion');
                        const mensaje = document.getElementById('mensaje-compensacion');
                        
                        if (horaActual.deficit_acumulado_solidos !== 0 || horaActual.deficit_acumulado_liquidos !== 0) {
                            alerta.style.display = 'block';
                            let mensajeTexto = 'Ajuste necesario: ';
                            if (horaActual.deficit_acumulado_solidos > 0) {
                                mensajeTexto += `+${horaActual.deficit_acumulado_solidos.toFixed(2)} TN s√≥lidos `;
                            } else if (horaActual.deficit_acumulado_solidos < 0) {
                                mensajeTexto += `${horaActual.deficit_acumulado_solidos.toFixed(2)} TN s√≥lidos `;
                            }
                            if (horaActual.deficit_acumulado_liquidos > 0) {
                                mensajeTexto += `+${horaActual.deficit_acumulado_liquidos.toFixed(2)} TN l√≠quidos `;
                            } else if (horaActual.deficit_acumulado_liquidos < 0) {
                                mensajeTexto += `${horaActual.deficit_acumulado_liquidos.toFixed(2)} TN l√≠quidos `;
                            }
                            mensajeTexto += 'distribuidos en las horas restantes';
                            mensaje.textContent = mensajeTexto;
                        } else {
                            alerta.style.display = 'none';
                        }
                    }
                    
                    let html = '';
                    data.horas.forEach(hora => {
                        const estadoClass = hora.estado === 'completada' ? 'success' : 
                                          hora.estado === 'pendiente' ? 'warning' : 'danger';
                        const compensacionClass = hora.diferencia_solidos > 0 ? 'success' : 
                                                hora.diferencia_solidos < 0 ? 'danger' : 'info';
                        
                        // Calcular si est√° en d√©ficit o super√°vit
                        const deficitSolidos = hora.solidos_recomendados - hora.solidos_registrados;
                        const deficitLiquidos = hora.liquidos_recomendados - hora.liquidos_registrados;
                        const totalDeficit = deficitSolidos + deficitLiquidos;
                        
                        html += `
                            <tr style="background-color: ${hora.es_hora_actual ? '#e3f2fd' : 'transparent'};">
                                <td><strong>${hora.hora}</strong> ${hora.es_hora_actual ? '<span class="badge bg-info">ACTUAL</span>' : ''}</td>
                                <td><span class="badge bg-primary">${hora.operario || 'No asignado'}</span></td>
                                <td>
                                    <div class="small">
                                        <div><strong>S√≥lidos:</strong> ${hora.solidos_registrados.toFixed(2)} / ${hora.solidos_recomendados.toFixed(2)} TN</div>
                                        <div><strong>L√≠quidos:</strong> ${hora.liquidos_registrados.toFixed(2)} / ${hora.liquidos_recomendados.toFixed(2)} TN</div>
                                    </div>
                                </td>
                                <td>
                                    <div class="small">
                                        <div class="text-${deficitSolidos > 0 ? 'success' : deficitSolidos < 0 ? 'danger' : 'muted'}">
                                            S: ${deficitSolidos > 0 ? '+' : ''}${deficitSolidos.toFixed(2)} TN
                                        </div>
                                        <div class="text-${deficitLiquidos > 0 ? 'success' : deficitLiquidos < 0 ? 'danger' : 'muted'}">
                                            L: ${deficitLiquidos > 0 ? '+' : ''}${deficitLiquidos.toFixed(2)} TN
                                        </div>
                                    </div>
                                </td>
                                <td>${hora.kw_aportados.toFixed(0)}</td>
                                <td><span class="badge bg-${estadoClass}">${hora.estado}</span></td>
                                <td>
                                    <div class="small">
                                        <div class="text-${totalDeficit > 0 ? 'success' : totalDeficit < 0 ? 'danger' : 'muted'}">
                                            ${totalDeficit > 0 ? 'Super√°vit' : totalDeficit < 0 ? 'D√©ficit' : 'Exacto'}
                                        </div>
                                        <div class="text-muted">${Math.abs(totalDeficit).toFixed(2)} TN</div>
                                    </div>
                                </td>
                            </tr>
                        `;
                    });
                    tbody.innerHTML = html;
                } else {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="7" class="text-center text-muted">
                                <i class="fas fa-info-circle"></i> No hay datos de seguimiento horario disponibles
                            </td>
                        </tr>
                    `;
                }
            } catch (error) {
                console.error('Error cargando dosificaciones horarias:', error);
                const tbody = document.getElementById('tabla-dosificaciones-horarias');
                if (tbody) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="7" class="text-center text-danger">
                                <i class="fas fa-exclamation-triangle"></i> Error cargando datos
                            </td>
                        </tr>
                    `;
                }
            }
        }
        
        // Funci√≥n para calcular compensaci√≥n usando datos del seguimiento horario
        async function calcularCompensacion() {
            try {
                const response = await fetch('/api/seguimiento-horario-completo');
                const data = await response.json();
                
                if (data.success && data.resumen) {
                    const resumen = data.resumen;
                    const objetivos = data.objetivos_diarios;
                    
                    // Calcular totales reales
                    let solidosReal = 0;
                    let liquidosReal = 0;
                    
                    data.horas.forEach(hora => {
                        solidosReal += hora.solidos_registrados;
                        liquidosReal += hora.liquidos_registrados;
                    });
                    
                    // Actualizar s√≥lidos
                    document.getElementById('solidos-objetivo').textContent = objetivos.solidos_objetivo.toFixed(1) + ' TN';
                    document.getElementById('solidos-real').textContent = solidosReal.toFixed(1) + ' TN';
                    const diferenciaSolidos = solidosReal - objetivos.solidos_objetivo;
                    const porcentajeSolidos = objetivos.solidos_objetivo > 0 ? (solidosReal / objetivos.solidos_objetivo) * 100 : 0;
                    document.getElementById('progreso-solidos').style.width = Math.min(porcentajeSolidos, 100) + '%';
                    document.getElementById('diferencia-solidos').textContent = `Diferencia: ${diferenciaSolidos > 0 ? '+' : ''}${diferenciaSolidos.toFixed(1)} TN`;
                    
                    // Actualizar l√≠quidos
                    document.getElementById('liquidos-objetivo').textContent = objetivos.liquidos_objetivo.toFixed(1) + ' TN';
                    document.getElementById('liquidos-real').textContent = liquidosReal.toFixed(1) + ' TN';
                    const diferenciaLiquidos = liquidosReal - objetivos.liquidos_objetivo;
                    const porcentajeLiquidos = objetivos.liquidos_objetivo > 0 ? (liquidosReal / objetivos.liquidos_objetivo) * 100 : 0;
                    document.getElementById('progreso-liquidos').style.width = Math.min(porcentajeLiquidos, 100) + '%';
                    document.getElementById('diferencia-liquidos').textContent = `Diferencia: ${diferenciaLiquidos > 0 ? '+' : ''}${diferenciaLiquidos.toFixed(1)} TN`;
                    
                    // Calcular m√©tricas de compensaci√≥n
                    const compensacionTotal = ((diferenciaSolidos + diferenciaLiquidos) / (objetivos.solidos_objetivo + objetivos.liquidos_objetivo)) * 100;
                    const eficienciaOperarios = Math.max(0, 100 - Math.abs(compensacionTotal));
                    const desviacionPromedio = (Math.abs(diferenciaSolidos) + Math.abs(diferenciaLiquidos)) / 2;
                    
                    // Actualizar resumen
                    document.getElementById('compensacion-total').textContent = compensacionTotal.toFixed(1) + '%';
                    document.getElementById('eficiencia-operarios').textContent = eficienciaOperarios.toFixed(1) + '%';
                    document.getElementById('desviacion-promedio').textContent = desviacionPromedio.toFixed(1) + '%';
                    
                    // Actualizar colores de las barras de progreso
                    const barraSolidos = document.getElementById('progreso-solidos');
                    const barraLiquidos = document.getElementById('progreso-liquidos');
                    
                    barraSolidos.className = `progress-bar ${porcentajeSolidos >= 95 ? 'bg-success' : porcentajeSolidos >= 80 ? 'bg-warning' : 'bg-danger'}`;
                    barraLiquidos.className = `progress-bar ${porcentajeLiquidos >= 95 ? 'bg-success' : porcentajeLiquidos >= 80 ? 'bg-warning' : 'bg-danger'}`;
                }
            } catch (error) {
                console.error('Error calculando compensaci√≥n:', error);
            }
        }
        
        // Funci√≥n para actualizar dosificaciones horarias
        function actualizarDosificacionesHorarias() {
            cargarDosificacionesHorarias();
            calcularCompensacion();
        }
        
        // Funci√≥n para exportar dosificaciones horarias
        function exportarDosificacionesHorarias() {
            alert('üìä Exportando dosificaciones horarias a Excel...');
            // Aqu√≠ se implementar√≠a la l√≥gica de exportaci√≥n
        }

        // ===== FUNCIONES DE GESTI√ìN DE MATERIALES =====
        
        // Funci√≥n para agregar nuevo material
        function agregarNuevoMaterial() {
            const tabla = document.getElementById('tabla-gestion-materiales');
            if (!tabla) return;
            
            const tbody = tabla.querySelector('tbody');
            if (!tbody) return;
            
            // Generar ID √∫nico para el material
            const materialId = `nuevo_material_${Date.now()}`;
            
            // Crear nueva fila
            const nuevaFila = document.createElement('tr');
            nuevaFila.setAttribute('data-material', materialId);
            nuevaFila.innerHTML = `
                <td>
                    <input type="text" class="form-control form-control-sm" placeholder="Nombre del material" 
                           style="background: #ffffff !important; color: #000000 !important; border: 1px solid #ccc !important;"
                           onchange="recalcularKW('${materialId}')">
                </td>
                <td>
                    <input type="number" class="form-control form-control-sm" placeholder="15.0" step="0.1" min="0" max="100"
                           style="background: #ffffff !important; color: #000000 !important; border: 1px solid #ccc !important;"
                           onchange="recalcularKW('${materialId}')">
                </td>
                <td>
                    <input type="number" class="form-control form-control-sm" placeholder="80.0" step="0.1" min="0" max="100"
                           style="background: #ffffff !important; color: #000000 !important; border: 1px solid #ccc !important;"
                           onchange="recalcularKW('${materialId}')">
                </td>
                <td>
                    <input type="number" class="form-control form-control-sm" placeholder="400.0" step="0.1" min="0"
                           style="background: #ffffff !important; color: #000000 !important; border: 1px solid #ccc !important;"
                           onchange="recalcularKW('${materialId}')">
                </td>
                <td>
                    <input type="number" class="form-control form-control-sm" placeholder="721.1" step="0.1" min="0"
                           style="background: #ffffff !important; color: #000000 !important; border: 1px solid #ccc !important;"
                           onchange="recalcularKW('${materialId}')">
                </td>
                <td>
                    <input type="number" class="form-control form-control-sm" placeholder="1.0" step="0.1" min="0"
                           style="background: #ffffff !important; color: #000000 !important; border: 1px solid #ccc !important;"
                           onchange="recalcularKW('${materialId}')">
                </td>
                <td>
                    <input type="number" class="form-control form-control-sm" placeholder="505.0" step="0.1" min="0"
                           style="background: #ffffff !important; color: #000000 !important; border: 1px solid #ccc !important;"
                           onchange="recalcularKW('${materialId}')">
                </td>
                <td>
                    <span class="ch4-calculado" onclick="toggleFormula(this)" style="cursor: pointer; font-weight: bold;" 
                          title="Haz clic para ver la f√≥rmula">65.00%</span>
                    <br><small class="formula-explicacion" style="display: none; color: #666;">((Prot√ó0,71)+(Lip√ó0,68)+(Carb√ó0,5))√∑TotalBiog√°s</small>
                </td>
                <td>
                    <span class="kw-calculado" onclick="toggleFormula(this)" style="cursor: pointer; font-weight: bold;" 
                          title="Haz clic para ver la f√≥rmula">0.0000</span>
                    <br><small class="formula-explicacion" style="display: none; color: #666;">(ST√óSV√óM¬≥√óCH4)√∑CHP</small>
                </td>
                <td>
                    <button class="btn btn-danger btn-sm" onclick="eliminarFila(this)" title="Eliminar">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;
            
            tbody.appendChild(nuevaFila);
            console.log('‚úÖ Nueva fila agregada a la tabla de gesti√≥n de materiales');
        }
        
        // Funci√≥n para eliminar fila
        function eliminarFila(boton) {
            const fila = boton.closest('tr');
            if (fila) {
                fila.remove();
                console.log('üóëÔ∏è Fila eliminada de la tabla de gesti√≥n de materiales');
            }
        }
        
        // FUNCI√ìN DUPLICADA ELIMINADA COMPLETAMENTE
        
        // Funci√≥n para actualizar solo los datos de gesti√≥n de materiales (sin recrear tabla)
        async function actualizarDatosGestionMateriales() {
            console.log('üîÑ Actualizando datos de gesti√≥n de materiales...');
            
            try {
                // Solo actualizar si la tabla ya existe
                const tabla = document.querySelector('#analytics-view table tbody');
                if (!tabla) {
                    console.log('üìã Tabla de gesti√≥n no existe, saltando actualizaci√≥n');
                    return;
                }
                
                // Cargar datos actualizados
                const response = await fetch('/materiales_base');
                const data = await response.json();
                
                if (data.status === 'success') {
                    const materiales = data.materiales || {};
                    
                    // Actualizar solo los valores ST% en las filas existentes
                    Object.entries(materiales).forEach(([nombre, material]) => {
                        const fila = tabla.querySelector(`tr[data-material="${nombre}"]`);
                        if (fila) {
                            const stCell = fila.querySelector('input[name*="st"]');
                            if (stCell) {
                                const nuevoValor = (material.st * 100).toFixed(1);
                                if (stCell.value !== nuevoValor) {
                                    stCell.value = nuevoValor;
                                    console.log(`üìä Actualizado ST% para ${nombre}: ${nuevoValor}%`);
                                }
                            }
                        }
                    });
                    
                    console.log('‚úÖ Datos de gesti√≥n actualizados sin recrear tabla');
                }
            } catch (error) {
                console.error('‚ùå Error actualizando datos de gesti√≥n:', error);
            }
        }

        // Funci√≥n para cargar gesti√≥n de materiales editable
        
        // Funci√≥n para mostrar la tabla de materiales
        function mostrarTablaMateriales(materiales, analyticsView) {
            console.log('üìä Mostrando tabla con', materiales.length, 'materiales');
            
            let tablaHtml = `
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5><i class="fas fa-cubes"></i> Gesti√≥n de Materiales - Datos de Laboratorio</h5>
                                <div>
                                    <button class="btn btn-info btn-sm me-2" onclick="sincronizarStockTabla()" title="Sincronizar con stock">
                                        <i class="fas fa-sync"></i> Sincronizar Stock
                                    </button>
                                    <button class="btn btn-warning btn-sm me-2" onclick="reinicializarMateriales()" title="Cargar datos del Excel">
                                        <i class="fas fa-sync-alt"></i> Cargar del Excel
                                    </button>
                                    <button class="btn btn-primary btn-sm me-2" onclick="recalcularTodaLaTabla()" title="Recalcular todas las f√≥rmulas">
                                        <i class="fas fa-calculator"></i> Recalcular F√≥rmulas
                                    </button>
                                    <button class="btn btn-success btn-sm me-2" onclick="agregarNuevoMaterial()">
                                        <i class="fas fa-plus"></i> Nuevo Material
                                    </button>
                                    <button class="btn btn-primary btn-sm" onclick="guardarCambiosMateriales()">
                                        <i class="fas fa-save"></i> Guardar Cambios
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="alert alert-info">
                                    <strong>üìä F√ìRMULAS DE C√ÅLCULO:</strong><br>
                                    <strong>TNSV:</strong> ST √ó SV<br>
                                    <strong>M¬≥/TNSV:</strong> (Carbohidratos√ó750 + L√≠pidos√ó1440 + Prote√≠nas√ó980) √∑ TNSV<br>
                                    <strong>CH4%:</strong> ((Prote√≠nas√ó0.71) + (L√≠pidos√ó0.68) + (Carbohidratos√ó0.5)) √∑ Total Componentes<br>
                                    <strong>KW/TN:</strong> (ST √ó SV √ó M¬≥/TNSV √ó CH4%) √∑ Consumo CHP (505 m¬≥/kWh)<br>
                                    <strong>Valores Calc:</strong> ST √ó % Laboratorio<br>
                                    <small>Los valores se recalculan autom√°ticamente al cambiar cualquier par√°metro</small>
                                </div>
                                <div class="table-responsive">
                                    <table id="tabla-gestion-materiales" class="table table-striped table-hover table-dark">
                                        <thead>
                                            <tr>
                                                <th>Material</th>
                                                <th>ST (%)</th>
                                                <th>SV (%)</th>
                                                <th>M¬≥/TN SV</th>
                                                <th>Carbohidratos</th>
                                                <th>L√≠pidos</th>
                                                <th>Prote√≠nas</th>
                                                <th>CH4 (%)</th>
                                                <th>KW/TN</th>
                                                <th>Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                    `;
                    
                Object.entries(materiales).forEach(([nombre, material], index) => {
                        const st = (material.st || 0) * 100; // Convertir de decimal a porcentaje
                        const sv = (material.sv || 0) * 100; // Convertir de decimal a porcentaje
                        const m3_tnsv = material.m3_tnsv || 0;
                        const carbohidratos = material.carbohidratos || 0;
                        const lipidos = material.lipidos || 0;
                        const proteinas = material.proteinas || 0;
                    
                    // CALCULAR CH4 usando la f√≥rmula: ((Prot√ó0.71) + (Lip√ó0.68) + (Carb√ó0.5)) √∑ Total Biog√°s
                    const tn_solidos = 1.0 * (material.st || 0); // Para 1 TN de material
                    const tn_carbohidratos = tn_solidos * carbohidratos;
                    const tn_lipidos = tn_solidos * lipidos;
                    const tn_proteinas = tn_solidos * proteinas;
                    
                    // Calcular m¬≥ de biog√°s por componente
                    const m3_biogas_ch = tn_carbohidratos * 750;
                    const m3_biogas_lip = tn_lipidos * 1440;
                    const m3_biogas_prot = tn_proteinas * 980;
                    const m3_biogas_total = m3_biogas_ch + m3_biogas_lip + m3_biogas_prot;
                    
                    // Calcular CH4% usando la f√≥rmula correcta
                    const total_componentes = tn_carbohidratos + tn_lipidos + tn_proteinas;
                    const ch4_calculado = total_componentes > 0 ? 
                        ((tn_proteinas * 0.71) + (tn_lipidos * 0.68) + (tn_carbohidratos * 0.5)) / total_componentes : 0.65;
                    
                    const ch4 = ch4_calculado * 100; // Convertir a porcentaje
                        const kwTn = material['kw/tn'] || 0;
                        
                        tablaHtml += `
                            <tr data-material="${nombre || `material_${index}`}">
                                <td>
                                    <input type="text" class="form-control form-control-sm" value="${nombre || ''}" 
                                           style="background: #ffffff !important; color: #000000 !important; border: 1px solid #ccc !important;"
                                           onchange="recalcularKW('${nombre || `material_${index}`}')">
                                </td>
                                <td>
                                    <input type="number" class="form-control form-control-sm" value="${st.toFixed(1)}" step="0.1" min="0" max="100"
                                           style="background: #ffffff !important; color: #000000 !important; border: 1px solid #ccc !important;"
                                           onchange="recalcularKW('${nombre || `material_${index}`}')">
                                </td>
                                <td>
                                    <input type="number" class="form-control form-control-sm" value="${sv.toFixed(1)}" step="0.1" min="0" max="100"
                                           style="background: #ffffff !important; color: #000000 !important; border: 1px solid #ccc !important;"
                                           onchange="recalcularKW('${nombre || `material_${index}`}')">
                                </td>
                                <td>
                                    <input type="number" class="form-control form-control-sm" value="${m3_tnsv.toFixed(1)}" step="0.1" min="0"
                                           style="background: #ffffff !important; color: #000000 !important; border: 1px solid #ccc !important;"
                                           onchange="recalcularKW('${nombre || `material_${index}`}')">
                                </td>
                                <td>
                                    <input type="number" class="form-control form-control-sm" value="${carbohidratos.toFixed(1)}" step="0.1" min="0"
                                           style="background: #ffffff !important; color: #000000 !important; border: 1px solid #ccc !important;"
                                           onchange="recalcularKW('${nombre || `material_${index}`}')">
                                </td>
                                <td>
                                    <input type="number" class="form-control form-control-sm" value="${lipidos.toFixed(1)}" step="0.1" min="0"
                                           style="background: #ffffff !important; color: #000000 !important; border: 1px solid #ccc !important;"
                                           onchange="recalcularKW('${nombre || `material_${index}`}')">
                                </td>
                                <td>
                                    <input type="number" class="form-control form-control-sm" value="${proteinas.toFixed(1)}" step="0.1" min="0"
                                           style="background: #ffffff !important; color: #000000 !important; border: 1px solid #ccc !important;"
                                           onchange="recalcularKW('${nombre || `material_${index}`}')">
                                </td>
                                <td>
                                    <span class="ch4-calculado" onclick="toggleFormula(this)" style="cursor: pointer; font-weight: bold;" 
                                          title="Haz clic para ver la f√≥rmula">${ch4.toFixed(2)}%</span>
                                    <br><small class="formula-explicacion" style="display: none; color: #666;">((Prot√ó0,71)+(Lip√ó0,68)+(Carb√ó0,5))√∑TotalBiog√°s</small>
                                </td>
                                <td>
                                    <span class="kw-calculado" onclick="toggleFormula(this)" style="cursor: pointer; font-weight: bold;" 
                                          title="Haz clic para ver la f√≥rmula">${kwTn.toFixed(4)}</span>
                                    <br><small class="formula-explicacion" style="display: none; color: #666;">(ST√óSV√óM¬≥√óCH4)√∑CHP</small>
                                </td>
                                <td>
                                    <button class="btn btn-danger btn-sm" onclick="eliminarFila(this)" title="Eliminar">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        `;
                    });
                    
                    tablaHtml += `
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    `;
                    
            analyticsView.innerHTML = tablaHtml;
            console.log('‚úÖ Gesti√≥n de materiales cargada correctamente');
        }

        // Inicializar control de alertas
        document.addEventListener('DOMContentLoaded', function() {
            const controlAlertas = document.getElementById('controlAlertas');
            if (controlAlertas) {
                alertasHabilitadas = controlAlertas.checked;
                actualizarIndicadorAlertas();
                
                controlAlertas.addEventListener('change', function() {
                    alertasHabilitadas = this.checked;
                    actualizarIndicadorAlertas();
                    console.log("Alertas emergentes:", alertasHabilitadas ? "Activadas" : "Desactivadas");
                });
            }
        });

        // Funci√≥n de prueba para alertas
        function probarAlertas() {
            mostrarAlerta('success', 'Esta es una alerta de √©xito', 'Prueba');
            setTimeout(() => mostrarAlerta('warning', 'Esta es una alerta de advertencia', 'Prueba'), 1000);
            setTimeout(() => mostrarAlerta('error', 'Esta es una alerta de error', 'Prueba'), 2000);
            setTimeout(() => mostrarAlerta('info', 'Esta es una alerta informativa', 'Prueba'), 3000);
        }

        // Dashboard 3D eliminado

        // Funci√≥n para abrir m√≥dulo de Mantenimiento
        function openMantenimiento() {
            window.open('/mantenimiento', '_blank');
        }

        // ==================== FUNCIONES DEL SISTEMA DE APRENDIZAJE ====================
        
        let preguntaActual = '';
        let respuestaActual = '';
        let mensajeActualId = '';
        
        function mostrarBotonesAprendizaje(pregunta, respuesta, mensajeId) {
            preguntaActual = pregunta;
            respuestaActual = respuesta;
            mensajeActualId = mensajeId;
            
            const controls = document.getElementById('ai-learning-controls');
            const learningInput = document.getElementById('learning-input');
            
            // Mostrar controles y ocultar input
            controls.style.display = 'block';
            learningInput.style.display = 'none';
            
            // Scroll hacia abajo para ver los botones
            const messagesContainer = document.getElementById('ai-messages');
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        function aceptarRespuesta() {
            mostrarAlerta('success', 'Respuesta aceptada. El asistente continuar√° aprendiendo autom√°ticamente.');
            ocultarBotonesAprendizaje();
        }
        
        function rechazarRespuesta() {
            const learningInput = document.getElementById('learning-input');
            learningInput.style.display = 'block';
            
            // Scroll hacia abajo para ver el textarea
            const messagesContainer = document.getElementById('ai-messages');
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        async function ense√±arRespuesta() {
            const respuestaCorrecta = document.getElementById('respuesta-correcta').value.trim();
            
            if (!respuestaCorrecta) {
                mostrarAlerta('warning', 'Por favor, escribe la respuesta correcta.');
                return;
            }
            
            try {
                const response = await fetch('/ense√±ar_respuesta', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        pregunta: preguntaActual,
                        respuesta_correcta: respuestaCorrecta
                    })
                });
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    mostrarAlerta('success', '¬°Respuesta ense√±ada exitosamente! El asistente ahora responder√° as√≠ a esta pregunta.');
                    
                    // Actualizar el mensaje original con la nueva respuesta
                    const mensajeOriginal = document.getElementById(mensajeActualId);
                    if (mensajeOriginal) {
                        mensajeOriginal.innerHTML = `
                            <p>${respuestaCorrecta}</p>
                            <small class="text-muted">Tipo: Respuesta Aprendida</small>
                            <small class="text-success ml-2"><i class="fas fa-graduation-cap"></i> Ense√±ada por ti</small>
                        `;
                    }
                    
                    ocultarBotonesAprendizaje();
                } else {
                    mostrarAlerta('error', 'Error al ense√±ar la respuesta: ' + data.mensaje);
                }
                
            } catch (error) {
                console.error('Error ense√±ando respuesta:', error);
                mostrarAlerta('error', 'Error de conexi√≥n al ense√±ar la respuesta.');
            }
        }
        
        function ocultarBotonesAprendizaje() {
            const controls = document.getElementById('ai-learning-controls');
            const learningInput = document.getElementById('learning-input');
            
            controls.style.display = 'none';
            learningInput.style.display = 'none';
            
            // Limpiar campos
            document.getElementById('respuesta-correcta').value = '';
            preguntaActual = '';
            respuestaActual = '';
            mensajeActualId = '';
        }
        
        // Cargar voz mejorada si est√° disponible
        function cargarVozMejorada() {
            if (typeof window.vozMejorada !== 'undefined') {
                console.log('üé§ Voz mejorada cargada');
                // Usar voz mejorada como funci√≥n principal
                window.hablarConVozMejorada = window.vozMejorada.hablar.bind(window.vozMejorada);
            } else {
                console.log('‚ö†Ô∏è Voz mejorada no disponible, usando voz est√°ndar');
            }
        }
        
        
        console.log('Dashboard H√≠brido SIBIA cargado - SIN PERMISOS - SIN USUARIO - ' + new Date().toISOString());
        console.log('‚úÖ VERIFICACI√ìN: No hay elementos de usuario en el DOM');
        console.log('‚úÖ VERIFICACI√ìN: No hay verificaci√≥n de permisos');
        
        // FORZAR RECARGA SI HAY ELEMENTOS DE USUARIO (CACH√â)
        const userElement = document.getElementById('user-role');
        if (userElement) {
            console.log('‚ùå PROBLEMA DE CACH√â: Elemento user-role encontrado');
            console.log('üîÑ Forzando recarga completa...');
            window.location.reload(true);
        } else {
            console.log('‚úÖ CONFIRMADO: No hay elementos de usuario');
        }
        
        // ELIMINAR CUALQUIER VERIFICACI√ìN DE PERMISOS EN EL DOM
        console.log('üßπ LIMPIANDO CUALQUIER C√ìDIGO DE PERMISOS...');
        
        // Eliminar cualquier funci√≥n que verifique permisos
        if (typeof verificarPermisos === 'function') {
            console.log('‚ùå Eliminando funci√≥n verificarPermisos');
            delete window.verificarPermisos;
        }
        
        // Eliminar cualquier funci√≥n de login
        if (typeof login === 'function') {
            console.log('‚ùå Eliminando funci√≥n login');
            delete window.login;
        }
        
        // Limpiar localStorage de sesiones
        try {
            localStorage.removeItem('sibia_session');
            localStorage.removeItem('sibia_session_id');
            localStorage.removeItem('user_role');
            localStorage.removeItem('user_session');
            console.log('‚úÖ localStorage de sesiones limpiado');
        } catch (e) {
            console.log('‚ö†Ô∏è No se pudo limpiar localStorage:', e);
        }
        
        // FORZAR RECARGA SI HAY CUALQUIER C√ìDIGO DE PERMISOS EN CACH√â
        console.log('üîç Verificando si hay c√≥digo de permisos en cach√©...');
        
        // Verificar si hay elementos de usuario o funciones de permisos
        const elementosUsuario = document.querySelectorAll('[id*="user"], [class*="user"], [id*="role"], [class*="role"]');
        const funcionesPermisos = ['verificarPermisos', 'checkPermissions', 'validateUser', 'getUserRole'];
        
        let hayCodigoPermisos = false;
        
        // Verificar elementos de usuario
        elementosUsuario.forEach(elemento => {
            if (elemento.id.includes('user') || elemento.id.includes('role')) {
                console.log('‚ùå Elemento de usuario encontrado:', elemento.id);
                hayCodigoPermisos = true;
            }
        });
        
        // Verificar funciones de permisos
        funcionesPermisos.forEach(funcion => {
            if (typeof window[funcion] === 'function') {
                console.log('‚ùå Funci√≥n de permisos encontrada:', funcion);
                hayCodigoPermisos = true;
            }
        });
        
        if (hayCodigoPermisos) {
            console.log('‚ùå PROBLEMA DE CACH√â: C√≥digo de permisos encontrado');
            console.log('üîÑ Forzando recarga completa para limpiar cach√©...');
            setTimeout(() => {
                window.location.reload(true);
            }, 1000);
        } else {
            console.log('‚úÖ CONFIRMADO: No hay c√≥digo de permisos en cach√©');
        }
        
        console.log('‚úÖ LIMPIEZA COMPLETA DE PERMISOS TERMINADA');
    </script>
</body>
<script>
    function scrollSidebar(direction) {
        try {
            var container = document.querySelector('.sidebar-scroll');
            if (!container) return;
            var step = Math.max(120, container.clientHeight * 0.6);
            var target = container.scrollTop + (direction > 0 ? step : -step);
            container.scrollTo({ top: target, behavior: 'smooth' });
        } catch (e) { /* noop */ }
    }
    // Funci√≥n para cargar reportes con gr√°ficos personalizables
    async function cargarReportes() {
        console.log('üìä Cargando m√≥dulo de reportes avanzado...');
        
        // Cambiar a vista anal√≠tica para mostrar reportes
        document.getElementById('operational-view').style.display = 'none';
        document.getElementById('analytics-view').style.display = 'block';
        
        const analyticsView = document.getElementById('analytics-view');
        if (!analyticsView) return;
        
        analyticsView.innerHTML = `
            <div class="function-card">
                <div class="card-header">
                    <div class="card-title">
                        <i class="fas fa-chart-line"></i>
                        Sistema de Reportes y Gr√°ficos Avanzado
                    </div>
                </div>
                <div class="card-content">
                    <!-- Filtros de Reporte -->
                    <div class="row mb-4">
                        <div class="col-md-2">
                            <label class="form-label">Tipo de Datos</label>
                            <select class="form-control" id="tipo-datos">
                                <option value="energia">Energ√≠a y Generaci√≥n</option>
                                <option value="calidad-gas">Calidad de Gas</option>
                                <option value="temperaturas">Temperaturas</option>
                                <option value="niveles">Niveles</option>
                                <option value="presiones">Presiones</option>
                                <option value="flujos">Flujos</option>
                                <option value="materiales">Materiales</option>
                                <option value="eficiencia">Eficiencia</option>
                                <option value="personalizado">Personalizado</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Tipo de Gr√°fico</label>
                            <select class="form-control" id="tipo-grafico">
                                <option value="linea">L√≠nea</option>
                                <option value="barras">Barras</option>
                                <option value="area">√Årea</option>
                                <option value="scatter">Dispersi√≥n</option>
                                <option value="combinado">Combinado</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Per√≠odo</label>
                            <select class="form-control" id="periodo-reporte">
                                <option value="1h">√öltima Hora</option>
                                <option value="6h">√öltimas 6 Horas</option>
                                <option value="24h">√öltimas 24 Horas</option>
                                <option value="7d">√öltimos 7 D√≠as</option>
                                <option value="30d">√öltimos 30 D√≠as</option>
                                <option value="personalizado">Personalizado</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Fecha Desde</label>
                            <input type="datetime-local" class="form-control" id="fecha-desde">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Fecha Hasta</label>
                            <input type="datetime-local" class="form-control" id="fecha-hasta">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Sensores</label>
                            <select class="form-control" id="sensores-seleccion" multiple>
                                <option value="040TT01">Temp Bio 1</option>
                                <option value="050TT01">Temp Bio 2</option>
                                <option value="040LT01">Nivel Bio 1</option>
                                <option value="050LT01">Nivel Bio 2</option>
                                <option value="040PT01">Presi√≥n Bio 1</option>
                                <option value="050PT01">Presi√≥n Bio 2</option>
                                <option value="040AIT01AO1">CO2 Bio 1</option>
                                <option value="050AIT01AO1">CO2 Bio 2</option>
                                <option value="040AIT01AO2">CH4 Bio 1</option>
                                <option value="050AIT01AO2">CH4 Bio 2</option>
                                <option value="040AIT01AO3">O2 Bio 1</option>
                                <option value="050AIT01AO3">O2 Bio 2</option>
                                <option value="040AIT01AO4">H2S Bio 1</option>
                                <option value="050AIT01AO4">H2S Bio 2</option>
                                <option value="070AIT01AO1">CO2 Motor</option>
                                <option value="070AIT01AO2">CH4 Motor</option>
                                <option value="070AIT01AO3">O2 Motor</option>
                                <option value="070AIT01AO4">H2S Motor</option>
                                <option value="060FIT01">Flujo Principal</option>
                                <option value="090FIT01">Flujo Secundario</option>
                                <option value="210PT01">Presi√≥n Red Gas</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Botones de Acci√≥n -->
                    <div class="row mb-4">
                        <div class="col-md-12">
                            <button class="btn btn-primary" onclick="generarGrafico()">
                                <i class="fas fa-chart-line"></i> Generar Gr√°fico
                            </button>
                            <button class="btn btn-success ml-2" onclick="generarReporte()">
                                <i class="fas fa-table"></i> Generar Reporte
                            </button>
                            <button class="btn btn-info ml-2" onclick="exportarGrafico()" id="btn-grafico" disabled>
                                <i class="fas fa-download"></i> Exportar Gr√°fico
                            </button>
                            <button class="btn btn-danger ml-2" onclick="reinicializarCanvas()" id="btn-limpiar">
                                <i class="fas fa-trash"></i> Limpiar Gr√°fico
                            </button>
                            <button class="btn btn-warning ml-2" onclick="exportarReporteExcel()" id="btn-excel" disabled>
                                <i class="fas fa-file-excel"></i> Exportar Excel
                            </button>
                            <button class="btn btn-secondary ml-2" onclick="exportarReporteCSV()" id="btn-csv" disabled>
                                <i class="fas fa-file-csv"></i> Exportar CSV
                            </button>
                        </div>
                    </div>
                    
                    <!-- √Årea de Gr√°fico -->
                    <div id="area-grafico" style="display: none;">
                        <div class="card mb-4">
                            <div class="card-header">
                                <h6><i class="fas fa-chart-line"></i> Gr√°fico Generado</h6>
                            </div>
                            <div class="card-body">
                                <canvas id="grafico-reporte" width="800" height="400"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <!-- √Årea de Resultados -->
                    <div id="resultados-reporte" style="display: none;">
                        <div class="alert alert-info">
                            <h6><i class="fas fa-info-circle"></i> Resultados del Reporte</h6>
                            <div id="contenido-reporte"></div>
                        </div>
                    </div>
                    
                    <!-- Tabla de Datos -->
                    <div id="tabla-reporte" style="display: none;">
                        <div class="table-responsive">
                            <table class="table table-striped" id="tabla-datos-reporte" style="background-color: #2c3e50; color: white;">
                                <thead id="thead-reporte" style="background-color: #34495e; color: white;"></thead>
                                <tbody id="tbody-reporte" style="background-color: #2c3e50; color: white;"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Configurar fechas por defecto
        const ahora = new Date();
        const hace1h = new Date(ahora.getTime() - 60 * 60 * 1000);
        
        // Formatear fecha para datetime-local
        const formatearFecha = (fecha) => {
            const year = fecha.getFullYear();
            const month = String(fecha.getMonth() + 1).padStart(2, '0');
            const day = String(fecha.getDate()).padStart(2, '0');
            const hours = String(fecha.getHours()).padStart(2, '0');
            const minutes = String(fecha.getMinutes()).padStart(2, '0');
            return `${year}-${month}-${day}T${hours}:${minutes}`;
        };
        
        const fechaDesde = document.getElementById('fecha-desde');
        const fechaHasta = document.getElementById('fecha-hasta');
        
        // Configurar fechas por defecto (√∫ltima hora)
        fechaDesde.value = formatearFecha(hace1h);
        fechaHasta.value = formatearFecha(ahora);
        
        // Configurar evento de cambio de per√≠odo
        document.getElementById('periodo-reporte').addEventListener('change', function() {
            configurarFechasPorPeriodo(this.value);
        });
        
        // Seleccionar sensores por defecto
        const sensoresSelect = document.getElementById('sensores-seleccion');
        if (sensoresSelect) {
            // Seleccionar temperaturas por defecto
            const opciones = sensoresSelect.options;
            for (let i = 0; i < opciones.length; i++) {
                if (opciones[i].value === '040TT01' || opciones[i].value === '050TT01') {
                    opciones[i].selected = true;
                }
            }
        }
    }
    
    // Funci√≥n para configurar fechas por per√≠odo
    function configurarFechasPorPeriodo(periodo) {
        const fechaDesde = document.getElementById('fecha-desde');
        const fechaHasta = document.getElementById('fecha-hasta');
        const ahora = new Date();
        
        // Formatear fecha para datetime-local
        const formatearFecha = (fecha) => {
            const year = fecha.getFullYear();
            const month = String(fecha.getMonth() + 1).padStart(2, '0');
            const day = String(fecha.getDate()).padStart(2, '0');
            const hours = String(fecha.getHours()).padStart(2, '0');
            const minutes = String(fecha.getMinutes()).padStart(2, '0');
            return `${year}-${month}-${day}T${hours}:${minutes}`;
        };
        
        switch(periodo) {
            case '1h':
                const hace1h = new Date(ahora.getTime() - 60 * 60 * 1000);
                fechaDesde.value = formatearFecha(hace1h);
                fechaHasta.value = formatearFecha(ahora);
                break;
            case '6h':
                const hace6h = new Date(ahora.getTime() - 6 * 60 * 60 * 1000);
                fechaDesde.value = formatearFecha(hace6h);
                fechaHasta.value = formatearFecha(ahora);
                break;
            case '24h':
                const hace24h = new Date(ahora.getTime() - 24 * 60 * 60 * 1000);
                fechaDesde.value = formatearFecha(hace24h);
                fechaHasta.value = formatearFecha(ahora);
                break;
            case '7d':
                const hace7d = new Date(ahora.getTime() - 7 * 24 * 60 * 60 * 1000);
                fechaDesde.value = formatearFecha(hace7d);
                fechaHasta.value = formatearFecha(ahora);
                break;
            case '30d':
                const hace30d = new Date(ahora.getTime() - 30 * 24 * 60 * 60 * 1000);
                fechaDesde.value = formatearFecha(hace30d);
                fechaHasta.value = formatearFecha(ahora);
                break;
            case 'personalizado':
                // No hacer nada, dejar que el usuario configure manualmente
                break;
        }
    }
    
    // Funci√≥n para generar reporte
    async function generarReporte() {
        const tipoDatos = document.getElementById('tipo-datos').value;
        const fechaDesde = document.getElementById('fecha-desde').value;
        const fechaHasta = document.getElementById('fecha-hasta').value;
        const sensoresSeleccionados = Array.from(document.getElementById('sensores-seleccion').selectedOptions).map(option => option.value);
        
        console.log('üìä Generando reporte:', { tipoDatos, fechaDesde, fechaHasta, sensoresSeleccionados });
        
        try {
            const response = await fetch('/generar_reporte', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    tipo: tipoDatos,
                    fecha_desde: fechaDesde,
                    fecha_hasta: fechaHasta,
                    sensores: sensoresSeleccionados
                })
            });
            
            const data = await response.json();
            
            if (data.status === 'success') {
                mostrarResultadosReporte(data);
                habilitarBotonesExportacion();
            } else {
                throw new Error(data.mensaje || 'Error generando reporte');
            }
        } catch (error) {
            console.error('Error generando reporte:', error);
            alert('‚ùå Error generando reporte: ' + error.message);
        }
    }
    
    // Funci√≥n para generar gr√°fico
    async function generarGrafico() {
        const tipoDatos = document.getElementById('tipo-datos').value;
        const tipoGrafico = document.getElementById('tipo-grafico').value;
        const fechaDesde = document.getElementById('fecha-desde').value;
        const fechaHasta = document.getElementById('fecha-hasta').value;
        const sensoresSeleccionados = Array.from(document.getElementById('sensores-seleccion').selectedOptions).map(option => option.value);
        
        console.log('üìä Generando gr√°fico:', { tipoDatos, tipoGrafico, fechaDesde, fechaHasta, sensoresSeleccionados });
        
        // Validaciones
        if (sensoresSeleccionados.length === 0) {
            alert('‚ö†Ô∏è Por favor selecciona al menos un sensor para generar el gr√°fico');
            return;
        }
        
        if (!fechaDesde || !fechaHasta) {
            alert('‚ö†Ô∏è Por favor configura las fechas desde y hasta');
            return;
        }
        
        if (fechaDesde >= fechaHasta) {
            alert('‚ö†Ô∏è La fecha "desde" debe ser anterior a la fecha "hasta"');
            return;
        }
        
        try {
            const response = await fetch('/datos_grafico_historico', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    tipo_datos: tipoDatos,
                    tipo_grafico: tipoGrafico,
                    fecha_desde: fechaDesde,
                    fecha_hasta: fechaHasta,
                    sensores: sensoresSeleccionados
                })
            });
            
            const data = await response.json();
            
            if (data.status === 'success') {
                mostrarGrafico(data);
                document.getElementById('btn-grafico').disabled = false;
            } else {
                throw new Error(data.mensaje || 'Error generando gr√°fico');
            }
        } catch (error) {
            console.error('Error generando gr√°fico:', error);
            alert('‚ùå Error generando gr√°fico: ' + error.message);
        }
    }
    
    // Funci√≥n para mostrar gr√°fico
    function mostrarGrafico(data) {
        const areaGrafico = document.getElementById('area-grafico');
        const canvas = document.getElementById('grafico-reporte');
        
        // Mostrar √°rea del gr√°fico
        areaGrafico.style.display = 'block';
        
        // Reinicializar canvas completamente
        reinicializarCanvas();
        
        // Esperar un momento para asegurar que el canvas est√© limpio
        setTimeout(() => {
            const ctx = canvas.getContext('2d');
            crearNuevoGrafico(data, canvas, ctx);
        }, 200);
    }
    
    // Funci√≥n auxiliar para crear el gr√°fico
    function crearNuevoGrafico(data, canvas, ctx) {
        try {
            // Verificar que el canvas est√© limpio
            if (!canvas || !ctx) {
                throw new Error('Canvas no disponible');
            }
            
            // Configurar datos del gr√°fico
            const datasets = data.sensores.map((sensor, index) => {
                const color = generarColor(index);
                return {
                    label: sensor.nombre,
                    data: sensor.datos.map(d => ({ 
                        x: new Date(d.fecha_hora), // Convertir a Date object
                        y: parseFloat(d.valor) || 0 
                    })),
                    borderColor: color,
                    backgroundColor: color + '20',
                    fill: false,
                    tension: 0.1
                };
            });
            
            // Crear gr√°fico con configuraci√≥n mejorada
            window.graficoReporte = new Chart(ctx, {
                type: data.tipo_grafico === 'linea' ? 'line' : 
                      data.tipo_grafico === 'barras' ? 'bar' :
                      data.tipo_grafico === 'area' ? 'line' :
                      data.tipo_grafico === 'scatter' ? 'scatter' : 'line',
                data: {
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 0 // Desactivar animaci√≥n para evitar conflictos
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: `Gr√°fico de ${data.tipo_datos} - ${data.fecha_desde} a ${data.fecha_hasta}`,
                            color: '#ffffff',
                            font: {
                                size: 14
                            }
                        },
                        legend: {
                            labels: {
                                color: '#ffffff',
                                usePointStyle: true
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                displayFormats: {
                                    hour: 'HH:mm',
                                    day: 'MMM DD',
                                    minute: 'HH:mm'
                                },
                                tooltipFormat: 'DD/MM/YYYY HH:mm'
                            },
                            ticks: {
                                color: '#ffffff',
                                maxTicksLimit: 10
                            },
                            grid: {
                                color: 'rgba(255,255,255,0.1)'
                            }
                        },
                        y: {
                            ticks: {
                                color: '#ffffff'
                            },
                            grid: {
                                color: 'rgba(255,255,255,0.1)'
                            }
                        }
                    }
                }
            });
            
            console.log('‚úÖ Gr√°fico creado exitosamente');
        } catch (error) {
            console.error('‚ùå Error creando gr√°fico:', error);
            alert('Error creando el gr√°fico: ' + error.message);
            
            // Limpiar canvas en caso de error
            try {
                if (window.graficoReporte) {
                    window.graficoReporte.destroy();
                    window.graficoReporte = null;
                }
            } catch (e) {
                console.warn('Error limpiando gr√°fico despu√©s del error:', e);
            }
        }
    }
    
    // Funci√≥n para generar colores
    function generarColor(index) {
        const colores = [
            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
            '#FF9F40', '#FF6384', '#C9CBCF', '#4BC0C0', '#FF6384'
        ];
        return colores[index % colores.length];
    }
    
    // Funci√≥n para exportar gr√°fico
    function exportarGrafico() {
        if (window.graficoReporte) {
            const link = document.createElement('a');
            link.download = `grafico_${new Date().toISOString().split('T')[0]}.png`;
            link.href = window.graficoReporte.toBase64Image();
            link.click();
        }
    }
    
    // Funci√≥n para limpiar completamente el canvas
    function limpiarCanvas() {
        const canvas = document.getElementById('grafico-reporte');
        if (canvas) {
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Tambi√©n limpiar el canvas HTML
            canvas.width = canvas.width;
        }
    }
    
    // Funci√≥n para reinicializar el canvas completamente
    function reinicializarCanvas() {
        const canvas = document.getElementById('grafico-reporte');
        if (canvas) {
            // Destruir gr√°fico anterior
            if (window.graficoReporte) {
                try {
                    window.graficoReporte.destroy();
                } catch (e) {
                    console.warn('Error destruyendo gr√°fico:', e);
                }
                window.graficoReporte = null;
            }
            
            // Limpiar canvas completamente
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Resetear el canvas HTML
            canvas.width = canvas.width;
            canvas.height = canvas.height;
            
            // Forzar re-renderizado
            canvas.style.display = 'none';
            canvas.offsetHeight; // Trigger reflow
            canvas.style.display = 'block';
            
            console.log('‚úÖ Canvas reinicializado completamente');
        }
    }
    
    // Funci√≥n para mostrar resultados del reporte
    function mostrarResultadosReporte(data) {
        const resultadosDiv = document.getElementById('resultados-reporte');
        const contenidoDiv = document.getElementById('contenido-reporte');
        const tablaDiv = document.getElementById('tabla-reporte');
        
        // Mostrar resumen
        contenidoDiv.innerHTML = `
            <div class="row">
                <div class="col-md-6">
                    <strong>Per√≠odo:</strong> ${data.fecha_desde} a ${data.fecha_hasta}<br>
                    <strong>Tipo:</strong> ${data.tipo}<br>
                    <strong>Registros:</strong> ${data.total_registros}
                </div>
                <div class="col-md-6">
                    <strong>Generado:</strong> ${new Date().toLocaleString()}<br>
                    <strong>Estado:</strong> <span class="badge bg-success">Completado</span>
                </div>
            </div>
        `;
        
        resultadosDiv.style.display = 'block';
        
        // Mostrar tabla si hay datos
        if (data.datos && data.datos.length > 0) {
            mostrarTablaReporte(data.datos, data.columnas);
            tablaDiv.style.display = 'block';
        }
    }
    
    // Funci√≥n para mostrar tabla de reporte
    function mostrarTablaReporte(datos, columnas) {
        const thead = document.getElementById('thead-reporte');
        const tbody = document.getElementById('tbody-reporte');
        
        // Crear encabezados
        thead.innerHTML = '<tr>' + columnas.map(col => `<th>${col}</th>`).join('') + '</tr>';
        
        // Crear filas de datos
        tbody.innerHTML = datos.map(fila => 
            '<tr>' + fila.map(celda => `<td>${celda}</td>`).join('') + '</tr>'
        ).join('');
    }
    
    // Funci√≥n para habilitar botones de exportaci√≥n
    function habilitarBotonesExportacion() {
        document.getElementById('btn-pdf').disabled = false;
        document.getElementById('btn-excel').disabled = false;
        document.getElementById('btn-csv').disabled = false;
    }
    
    // Funci√≥n para exportar a PDF
    function exportarReportePDF() {
        const tipoReporte = document.getElementById('tipo-reporte').value;
        const fechaDesde = document.getElementById('fecha-desde').value;
        const fechaHasta = document.getElementById('fecha-hasta').value;
        
        const url = `/exportar_reporte_pdf?tipo=${tipoReporte}&fecha_desde=${fechaDesde}&fecha_hasta=${fechaHasta}`;
        window.open(url, '_blank');
    }
    
    // Funci√≥n para exportar a Excel
    function exportarReporteExcel() {
        const tipoReporte = document.getElementById('tipo-reporte').value;
        const fechaDesde = document.getElementById('fecha-desde').value;
        const fechaHasta = document.getElementById('fecha-hasta').value;
        
        const url = `/exportar_reporte_excel?tipo=${tipoReporte}&fecha_desde=${fechaDesde}&fecha_hasta=${fechaHasta}`;
        window.open(url, '_blank');
    }
    
    // Funci√≥n para exportar a CSV
    function exportarReporteCSV() {
        const tipoReporte = document.getElementById('tipo-reporte').value;
        const fechaDesde = document.getElementById('fecha-desde').value;
        const fechaHasta = document.getElementById('fecha-hasta').value;
        
        const url = `/exportar_reporte_csv?tipo=${tipoReporte}&fecha_desde=${fechaDesde}&fecha_hasta=${fechaHasta}`;
        window.open(url, '_blank');
    }

    // Variables globales para gr√°ficos
    var generationChart = null;
    var generationUpdateInterval = null;

    // Funci√≥n para inicializar el gr√°fico de generaci√≥n
    function inicializarGraficoGeneracion() {
        const ctx = document.getElementById('chartGeneracion');
        if (!ctx) return;

        // Destruir gr√°fico existente si existe
        if (generationChart) {
            generationChart.destroy();
        }

        generationChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Generaci√≥n (kW)',
                    data: [],
                    borderColor: '#00d4ff',
                    backgroundColor: 'rgba(0, 212, 255, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        labels: {
                            color: '#ffffff'
                        }
                    }
                },
                scales: {
                    x: {
                        ticks: {
                            color: '#ffffff'
                        },
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        }
                    },
                    y: {
                        ticks: {
                            color: '#ffffff'
                        },
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        }
                    }
                }
            }
        });

        // Cargar datos iniciales
        actualizarGraficoGeneracion();
    }

    // Funci√≥n para actualizar el gr√°fico de generaci√≥n
    async function actualizarGraficoGeneracion() {
        try {
            const periodo = document.getElementById('periodo-generacion')?.value || '1h';
            const response = await fetch(`/datos_generacion_historico?periodo=${periodo}&t=${Date.now()}`);
            const data = await response.json();

            if (data.status === 'success' && data.datos) {
                const labels = data.datos.map(item => new Date(item.fecha_hora).toLocaleTimeString());
                const valores = data.datos.map(item => parseFloat(item.generacion_kw) || 0);

                if (generationChart) {
                    generationChart.data.labels = labels;
                    generationChart.data.datasets[0].data = valores;
                    generationChart.update('none');
                }
            }
        } catch (error) {
            console.error('Error actualizando gr√°fico de generaci√≥n:', error);
        }
    }

    // Funci√≥n para manejar el cambio de per√≠odo
    function cambiarPeriodoGeneracion() {
        actualizarGraficoGeneracion();
    }

    // Funci√≥n para manejar la actualizaci√≥n autom√°tica
    function toggleActualizacionAutomatica() {
        const autoUpdate = document.getElementById('auto-update-generacion')?.checked;
        
        if (autoUpdate) {
            generationUpdateInterval = setInterval(actualizarGraficoGeneracion, 30000); // 30 segundos
        } else {
            if (generationUpdateInterval) {
                clearInterval(generationUpdateInterval);
                generationUpdateInterval = null;
            }
        }
    }

    // Event listeners para los controles del gr√°fico
    document.addEventListener('DOMContentLoaded', function() {
        const periodoSelect = document.getElementById('periodo-generacion');
        const autoUpdateCheck = document.getElementById('auto-update-generacion');
        
        if (periodoSelect) {
            periodoSelect.addEventListener('change', cambiarPeriodoGeneracion);
        }
        
        if (autoUpdateCheck) {
            autoUpdateCheck.addEventListener('change', toggleActualizacionAutomatica);
        }
    });

    // Funci√≥n para inicializar el chat IA
    function inicializarChatIA() {
        console.log('ü§ñ Inicializando chat IA...');
        
        // Verificar si la voz del navegador est√° disponible
        if (window.vozNavegador) {
            console.log('üé§ Voz del navegador disponible');
            
            // Configurar voz optimizada para naturalidad
            window.vozNavegador.configurar({
                rate: 0.95,    // Velocidad m√°s natural
                pitch: 1.0,    // Tono natural
                volume: 0.8,   // Volumen moderado para mejor calidad
                lang: 'es-ES'
            });
            
            // Mostrar informaci√≥n de la voz seleccionada
            const voces = window.vozNavegador.obtenerVoces();
            const vozActual = window.vozNavegador.voiceSeleccionada;
            if (vozActual) {
                console.log(`üé§ Voz configurada: ${vozActual.name} (${vozActual.lang})`);
            } else {
                console.warn('‚ö†Ô∏è No se pudo obtener la voz seleccionada');
            }
            
            // Probar la voz con un mensaje de prueba
            setTimeout(() => {
                console.log('üé§ Probando voz con mensaje de prueba...');
                try {
                    const resultado = window.vozNavegador.hablar('Hola, soy tu asistente de voz. ¬øPuedes escucharme?');
                    console.log('üé§ Resultado de prueba de voz:', resultado);
                } catch (error) {
                    console.error('‚ùå Error en prueba de voz:', error);
                }
            }, 2000);
            
        } else {
            console.warn('‚ö†Ô∏è Voz del navegador no disponible');
        }
        
        // Configurar evento Enter en el input del chat
        const inputChat = document.getElementById('ai-input');
        if (inputChat) {
            inputChat.addEventListener('keypress', function(event) {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    enviarPregunta();
                }
            });
            console.log('‚å®Ô∏è Evento Enter configurado en el chat');
        } else {
            console.warn('‚ö†Ô∏è No se encontr√≥ el input del chat');
        }
    }

    // Ajustar margen del contenido si cambia el ancho del sidebar por media queries
    (function(){
        function syncContentMargin(){
            var content = document.querySelector('.content-area');
            if (content) content.style.marginLeft = getComputedStyle(document.documentElement).getPropertyValue('--sidebar-w').trim();
        }
        window.addEventListener('resize', syncContentMargin);
        window.addEventListener('load', syncContentMargin);
        syncContentMargin();
    })();
    
    // Inicializar chat IA cuando se carga la p√°gina
    document.addEventListener('DOMContentLoaded', function() {
        setTimeout(inicializarChatIA, 1000); // Esperar 1 segundo para que todo se cargue
        setTimeout(cargarVozMejorada, 2000); // Cargar voz mejorada despu√©s
    });
</script>

<!-- PARCHE JAVASCRIPT PARA REC√ÅLCULO AUTOM√ÅTICO -->
<script>
// FUNCI√ìN UNIFICADA PARA REC√ÅLCULO AUTOM√ÅTICO COMPLETO
function recalcularValoresAutomaticos(fila) {
    try {
        const inputs = fila.querySelectorAll('input, select');
        if (inputs.length < 14) {
            console.warn('‚ùå No hay suficientes inputs en la fila');
            return;
        }

        // Obtener valores actuales de la tabla
        const st = parseFloat(inputs[1].value) || 0; // ST % (columna 1)
        const sv = parseFloat(inputs[2].value) || 0; // SV % (columna 2)
        const carbohidrato_lab = parseFloat(inputs[6].value) || 0; // Carbohidratos Lab % (columna 6)
        const lipido_lab = parseFloat(inputs[7].value) || 0; // L√≠pidos Lab % (columna 7)
        const proteina_lab = parseFloat(inputs[8].value) || 0; // Prote√≠nas Lab % (columna 8)

        console.log(`üîÑ Recalculando para ST: ${st}%, SV: ${sv}%, Carb: ${carbohidrato_lab}%, Lip: ${lipido_lab}%, Prot: ${proteina_lab}%`);

        // ===== F√ìRMULAS CORREGIDAS =====

        // 1. TNSV = ST √ó SV (S√≥lidos Totales Vol√°tiles)
        const tnsv = (st / 100.0) * (sv / 100.0);
        
        // 2. Valores CALCULADOS = ST √ó % Laboratorio
        const carbohidratos_calc = (st / 100.0) * (carbohidrato_lab / 100.0);
        const lipidos_calc = (st / 100.0) * (lipido_lab / 100.0);
        const proteinas_calc = (st / 100.0) * (proteina_lab / 100.0);
        
        // 3. M¬≥/TNSV usando f√≥rmula de biog√°s (m¬≥ de biog√°s por TN de s√≥lidos vol√°tiles)
        let m3_tnsv = 0;
        if (tnsv > 0) {
            // Para 1 TN de material, calcular TN de s√≥lidos vol√°tiles
            const tn_solidos_volatiles = tnsv;
            
            // Calcular TN de cada componente nutricional en los s√≥lidos vol√°tiles
            const tn_carbohidratos_sv = tn_solidos_volatiles * (carbohidrato_lab / 100.0);
            const tn_lipidos_sv = tn_solidos_volatiles * (lipido_lab / 100.0);
            const tn_proteinas_sv = tn_solidos_volatiles * (proteina_lab / 100.0);

            // Calcular m¬≥ de biog√°s por componente (seg√∫n Excel)
            const m3_biogas_carbohidratos = tn_carbohidratos_sv * 750;  // 750 m¬≥/TN carbohidratos
            const m3_biogas_lipidos = tn_lipidos_sv * 1440;            // 1440 m¬≥/TN l√≠pidos
            const m3_biogas_proteinas = tn_proteinas_sv * 980;          // 980 m¬≥/TN prote√≠nas

            // Sumar todo el biog√°s
            const m3_biogas_total = m3_biogas_carbohidratos + m3_biogas_lipidos + m3_biogas_proteinas;
            
            // M¬≥/TNSV = m¬≥ de biog√°s total / TN de s√≥lidos vol√°tiles
            m3_tnsv = m3_biogas_total / tnsv;
        }
        
        // 4. CH4% usando f√≥rmula correcta: ((Prot√ó0.71) + (Lip√ó0.68) + (Carb√ó0.5)) √∑ Total Componentes
        let ch4_porcentaje = 0.65; // Valor por defecto
        if (tnsv > 0) {
            const tn_solidos_volatiles = tnsv;
            const tn_carbohidratos_sv = tn_solidos_volatiles * (carbohidrato_lab / 100.0);
            const tn_lipidos_sv = tn_solidos_volatiles * (lipido_lab / 100.0);
            const tn_proteinas_sv = tn_solidos_volatiles * (proteina_lab / 100.0);

            const total_componentes = tn_carbohidratos_sv + tn_lipidos_sv + tn_proteinas_sv;
            if (total_componentes > 0) {
                ch4_porcentaje = ((tn_proteinas_sv * 0.71) + (tn_lipidos_sv * 0.68) + (tn_carbohidratos_sv * 0.5)) / total_componentes;
            }
        }

        // 5. KW/TN usando f√≥rmula correcta: (ST √ó SV √ó M¬≥/TNSV √ó CH4%) / Consumo CHP
        const consumo_chp = 505.0; // m¬≥ CH4/kWh
        const kw_tn = (st * sv * m3_tnsv * ch4_porcentaje) / consumo_chp;

        // ===== ACTUALIZAR CAMPOS EN LA INTERFAZ =====

        // TNSV (columna 3) - Mostrar como porcentaje
        if (inputs[3]) inputs[3].value = (tnsv * 100).toFixed(2);

        // M¬≥/TNSV (columna 4) - Actualizar span calculado
        const m3TnsvSpan = fila.querySelector('.m3-tnsv-calculado');
        if (m3TnsvSpan) {
            m3TnsvSpan.textContent = m3_tnsv.toFixed(2);
        }

        // CH4% (columna 5) - Actualizar span calculado
        const ch4Span = fila.querySelector('.ch4-calculado');
        if (ch4Span) {
            ch4Span.textContent = (ch4_porcentaje * 100).toFixed(2) + '%';
        }

        // Carbohidratos Calc (columna 9) - Actualizar badge
        const carbohidratosBadge = fila.querySelector('.badge:nth-child(1)');
        if (carbohidratosBadge) {
            carbohidratosBadge.textContent = (carbohidratos_calc * 100).toFixed(2) + '%';
        }

        // L√≠pidos Calc (columna 10) - Actualizar badge
        const lipidosBadge = fila.querySelector('.badge:nth-child(2)');
        if (lipidosBadge) {
            lipidosBadge.textContent = (lipidos_calc * 100).toFixed(2) + '%';
        }

        // Prote√≠nas Calc (columna 11) - Actualizar badge
        const proteinasBadge = fila.querySelector('.badge:nth-child(3)');
        if (proteinasBadge) {
            proteinasBadge.textContent = (proteinas_calc * 100).toFixed(2) + '%';
        }

        // KW/TN (columna 13) - Actualizar span calculado
        const kwTnSpan = fila.querySelector('.kw-tn-calculado');
        if (kwTnSpan) {
            kwTnSpan.textContent = kw_tn.toFixed(4);
        }

        console.log(`‚úÖ Recalculado ${fila.getAttribute('data-material')}:`);
        console.log(`   üìä TNSV: ${(tnsv*100).toFixed(2)}%`);
        console.log(`   üìä M¬≥/TNSV: ${m3_tnsv.toFixed(2)}`);
        console.log(`   üìä CH4%: ${(ch4_porcentaje*100).toFixed(2)}%`);
        console.log(`   üìä KW/TN: ${kw_tn.toFixed(4)}`);
        console.log(`   üìä Carb Calc: ${(carbohidratos_calc*100).toFixed(2)}%`);
        console.log(`   üìä Lip Calc: ${(lipidos_calc*100).toFixed(2)}%`);
        console.log(`   üìä Prot Calc: ${(proteinas_calc*100).toFixed(2)}%`);
        
    } catch (error) {
        console.error('‚ùå Error en rec√°lculo autom√°tico:', error);
    }
}

// AGREGAR EVENTOS DE REC√ÅLCULO AUTOM√ÅTICO MEJORADO
function agregarEventosRecalculo() {
    const tabla = document.getElementById('tabla-gestion-materiales');
    if (!tabla) {
        console.log('‚ùå No se encontr√≥ tabla-gestion-materiales');
        return;
    }
    
    const filas = tabla.querySelectorAll('tbody tr');
    console.log(`üîç Encontradas ${filas.length} filas para agregar eventos`);
    
    filas.forEach((fila, index) => {
        const inputs = fila.querySelectorAll('input[type="number"]');
        const materialNombre = fila.getAttribute('data-material');
        
        console.log(`   üìã Fila ${index} (${materialNombre}): ${inputs.length} inputs encontrados`);

        // Funci√≥n para agregar eventos a un input espec√≠fico
        const agregarEventosInput = (input, nombreCampo) => {
            if (input) {
                // Remover eventos anteriores para evitar duplicados
                input.removeEventListener('input', recalcularValoresAutomaticos);
                input.removeEventListener('change', recalcularValoresAutomaticos);
                
                // Agregar nuevos eventos
                input.addEventListener('input', () => {
                    console.log(`üîÑ Cambio detectado en ${nombreCampo} de ${materialNombre}`);
                    recalcularValoresAutomaticos(fila);
                });
                input.addEventListener('change', () => {
                    console.log(`üîÑ Cambio confirmado en ${nombreCampo} de ${materialNombre}`);
                    recalcularValoresAutomaticos(fila);
                });
                
                console.log(`   ‚úÖ Eventos agregados a ${nombreCampo}`);
            }
        };

        // Agregar eventos a campos cr√≠ticos que deben recalcular todo
        agregarEventosInput(inputs[1], 'ST %');           // ST %
        agregarEventosInput(inputs[2], 'SV %');           // SV %
        agregarEventosInput(inputs[6], 'Carbohidratos Lab %');  // Carbohidratos Lab %
        agregarEventosInput(inputs[7], 'L√≠pidos Lab %');         // L√≠pidos Lab %
        agregarEventosInput(inputs[8], 'Prote√≠nas Lab %');       // Prote√≠nas Lab %

        // Recalcular valores iniciales para esta fila
        console.log(`üîÑ Recalculando valores iniciales para ${materialNombre}`);
        recalcularValoresAutomaticos(fila);
    });

    console.log('‚úÖ Eventos de rec√°lculo autom√°tico agregados a todas las filas');
}

// FUNCI√ìN SIMPLE PARA REC√ÅLCULO MANUAL
window.recalcularMaterial = function(input) {
    try {
        const fila = input.closest('tr');
        if (!fila) return;
        
        recalcularValoresAutomaticos(fila);
    } catch (error) {
        console.error('Error en rec√°lculo manual:', error);
    }
};

// FUNCI√ìN PARA RECALCULAR TODA LA TABLA
function recalcularTodaLaTabla() {
    console.log('üîÑ Iniciando rec√°lculo completo de la tabla de gesti√≥n de materiales');
    const tabla = document.getElementById('tabla-gestion-materiales');
    if (!tabla) {
        console.log('‚ùå No se encontr√≥ tabla-gestion-materiales');
        return;
    }

    const filas = tabla.querySelectorAll('tbody tr');
    console.log(`üìä Recalculando ${filas.length} materiales...`);

    filas.forEach((fila, index) => {
        const materialNombre = fila.getAttribute('data-material');
        console.log(`   üîÑ Recalculando ${index + 1}/${filas.length}: ${materialNombre}`);
        recalcularValoresAutomaticos(fila);
    });

    console.log('‚úÖ Rec√°lculo completo de la tabla finalizado');
}

// Llamar la funci√≥n cuando se cargue la tabla
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ DOM cargado, esperando tabla...');
    setTimeout(function() {
        agregarEventosRecalculo();
        console.log('üîß Agregando eventos de rec√°lculo...');
    }, 3000);
});

// Tambi√©n intentar cuando se haga clic en Gesti√≥n de Materiales
document.addEventListener('click', function(e) {
    if (e.target && e.target.textContent && e.target.textContent.includes('Gesti√≥n de Materiales')) {
        console.log('üéØ Clic en Gesti√≥n de Materiales detectado');
        setTimeout(() => {
            agregarEventosRecalculo();
            recalcularTodaLaTabla();
        }, 2000);
    }
});

// Funci√≥n global para recalcular desde botones
window.recalcularTodaLaTabla = recalcularTodaLaTabla;

// FUNCI√ìN DUPLICADA ELIMINADA COMPLETAMENTE - SOLO QUEDA LA VERSI√ìN SIN PERMISOS

// FUNCI√ìN DE SINCRONIZACI√ìN STOCK ‚Üî TABLA
async function sincronizarStockTabla() {
    console.log('üîÑ Iniciando sincronizaci√≥n Stock ‚Üî Tabla...');
    
    // Mostrar indicador de carga
    const botonSincronizar = event.target;
    const textoOriginal = botonSincronizar.innerHTML;
    botonSincronizar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sincronizando...';
    botonSincronizar.disabled = true;
    
    try {
        // Verificar estado actual
        console.log('üîç Verificando estado de sincronizaci√≥n...');
        const verificacionResponse = await fetch('/verificar_sincronizacion');
        const verificacionData = await verificacionResponse.json();
        
        if (verificacionData.status === 'success') {
            const resumen = verificacionData.resumen;
            console.log('üìä Estado actual:', resumen);
            
            // Mostrar resumen antes de sincronizar
            if (resumen.materiales_faltantes > 0 || resumen.materiales_desincronizados > 0) {
                const mensaje = `üìã Estado actual:\n` +
                    `‚Ä¢ Materiales en stock: ${resumen.materiales_stock}\n` +
                    `‚Ä¢ Materiales en tabla: ${resumen.materiales_tabla}\n` +
                    `‚Ä¢ Materiales faltantes: ${resumen.materiales_faltantes}\n` +
                    `‚Ä¢ Materiales desincronizados: ${resumen.materiales_desincronizados}\n\n` +
                    `¬øDeseas proceder con la sincronizaci√≥n?`;
                
                if (!confirm(mensaje)) {
                    botonSincronizar.innerHTML = textoOriginal;
                    botonSincronizar.disabled = false;
                    return;
                }
            } else {
                alert('‚úÖ La sincronizaci√≥n ya est√° actualizada. No se encontraron diferencias.');
                botonSincronizar.innerHTML = textoOriginal;
                botonSincronizar.disabled = false;
                return;
            }
        }
        
        // Ejecutar sincronizaci√≥n
        console.log('üîÑ Ejecutando sincronizaci√≥n...');
        const response = await fetch('/sincronizar_stock_tabla', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const result = await response.json();
        
        if (result.status === 'success') {
            // Mostrar mensaje de √©xito
            const mensajeExito = document.createElement('div');
            mensajeExito.className = 'alert alert-success alert-dismissible fade show position-fixed';
            mensajeExito.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 400px;';
            mensajeExito.innerHTML = `
                <strong>‚úÖ Sincronizaci√≥n Exitosa!</strong><br>
                Stock y tabla de gesti√≥n han sido sincronizados correctamente.<br>
                <small>${new Date().toLocaleString()}</small>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(mensajeExito);
            
            // ELIMINADO: Recarga autom√°tica que causaba p√©rdida de datos
            // Los datos se mantienen sin recargar la tabla autom√°ticamente
            
            console.log('‚úÖ Sincronizaci√≥n completada exitosamente');
        } else {
            throw new Error(result.mensaje || 'Error en la sincronizaci√≥n');
        }
        
    } catch (error) {
        console.error('‚ùå Error en sincronizaci√≥n:', error);
        
        // Mostrar mensaje de error
        const mensajeError = document.createElement('div');
        mensajeError.className = 'alert alert-danger alert-dismissible fade show position-fixed';
        mensajeError.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 400px;';
        mensajeError.innerHTML = `
            <strong>‚ùå Error en Sincronizaci√≥n</strong><br>
            ${error.message}<br>
            <small>${new Date().toLocaleString()}</small>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(mensajeError);
        
    } finally {
        // Restaurar bot√≥n
        botonSincronizar.innerHTML = textoOriginal;
        botonSincronizar.disabled = false;
    }
}

// FUNCI√ìN PARA VERIFICAR SINCRONIZACI√ìN (opcional)
async function verificarSincronizacion() {
    try {
        const response = await fetch('/verificar_sincronizacion');
        const data = await response.json();
        
        if (data.status === 'success') {
            const resumen = data.resumen;
            const detalles = data.detalles;
            
            let mensaje = `üìä Estado de Sincronizaci√≥n:\n\n`;
            mensaje += `üì¶ Materiales en stock: ${resumen.materiales_stock}\n`;
            mensaje += `üìã Materiales en tabla: ${resumen.materiales_tabla}\n`;
            mensaje += `‚ö†Ô∏è Materiales faltantes: ${resumen.materiales_faltantes}\n`;
            mensaje += `üîÑ Materiales desincronizados: ${resumen.materiales_desincronizados}\n\n`;
            
            if (detalles.faltantes.length > 0) {
                mensaje += `Materiales faltantes en tabla:\n`;
                detalles.faltantes.forEach(material => {
                    mensaje += `‚Ä¢ ${material}\n`;
                });
                mensaje += `\n`;
            }
            
            if (detalles.desincronizados.length > 0) {
                mensaje += `Materiales con datos diferentes:\n`;
                detalles.desincronizados.forEach(item => {
                    mensaje += `‚Ä¢ ${item.material}: ${item.campo} (Stock: ${item.stock}, Tabla: ${item.tabla})\n`;
                });
            }
            
            alert(mensaje);
        } else {
            alert('‚ùå Error verificando sincronizaci√≥n: ' + data.mensaje);
        }
    } catch (error) {
        console.error('Error verificando sincronizaci√≥n:', error);
        alert('‚ùå Error verificando sincronizaci√≥n: ' + error.message);
    }
}
</script>

</html>