{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <h2>Configuración de WhatsApp</h2>
    
    <div class="card">
        <div class="card-body">
            <h5 class="card-title">Configuración General</h5>
            <form id="whatsappConfigForm">
                <div class="mb-3">
                    <label for="phoneNumberId" class="form-label">ID de Número de Teléfono</label>
                    <input type="text" class="form-control" id="phoneNumberId" name="phone_number_id">
                </div>
                <div class="mb-3">
                    <label for="accessToken" class="form-label">Token de Acceso</label>
                    <input type="password" class="form-control" id="accessToken" name="access_token">
                </div>
                <div class="mb-3">
                    <label for="webhookUrl" class="form-label">URL del Webhook</label>
                    <input type="text" class="form-control" id="webhookUrl" name="webhook_url">
                </div>
                <div class="mb-3">
                    <label for="webhookToken" class="form-label">Token de Verificación del Webhook</label>
                    <input type="text" class="form-control" id="webhookToken" name="webhook_verify_token">
                </div>
            </form>
        </div>
    </div>

    <div class="card mt-4">
        <div class="card-body">
            <h5 class="card-title">Empresas de Transporte</h5>
            <div id="transportCompanies">
                <!-- Las empresas se cargarán aquí dinámicamente -->
            </div>
            <button class="btn btn-primary mt-3" onclick="addTransportCompany()">
                Agregar Empresa
            </button>
        </div>
    </div>

    <div class="card mt-4">
        <div class="card-body">
            <h5 class="card-title">Plantillas de Mensajes</h5>
            <div class="mb-3">
                <label for="initialMessage" class="form-label">Mensaje Inicial</label>
                <textarea class="form-control" id="initialMessage" rows="4"></textarea>
                <small class="text-muted">Variables disponibles: {origen}, {destino}, {material}, {fecha}</small>
            </div>
            <div id="confirmationQuestions">
                <h6>Preguntas de Confirmación</h6>
                <!-- Las preguntas se cargarán aquí dinámicamente -->
            </div>
            <button class="btn btn-primary mt-3" onclick="addQuestion()">
                Agregar Pregunta
            </button>
        </div>
    </div>

    <div class="text-center mt-4 mb-4">
        <button class="btn btn-success" onclick="saveConfig()">Guardar Configuración</button>
    </div>
</div>

<script>
let config = null;

// Cargar configuración actual
async function loadConfig() {
    try {
        const response = await fetch('/whatsapp/config');
        config = await response.json();
        populateForm();
    } catch (error) {
        console.error('Error cargando configuración:', error);
        alert('Error al cargar la configuración');
    }
}

// Poblar el formulario con la configuración actual
function populateForm() {
    if (!config) return;

    document.getElementById('phoneNumberId').value = config.phone_number_id || '';
    document.getElementById('accessToken').value = config.access_token || '';
    document.getElementById('webhookUrl').value = config.webhook_url || '';
    document.getElementById('webhookToken').value = config.webhook_verify_token || '';
    document.getElementById('initialMessage').value = config.message_template?.initial_message || '';

    // Cargar empresas de transporte
    const companiesContainer = document.getElementById('transportCompanies');
    companiesContainer.innerHTML = '';
    (config.transport_companies || []).forEach((company, index) => {
        companiesContainer.innerHTML += createTransportCompanyHTML(company, index);
    });

    // Cargar preguntas de confirmación
    const questionsContainer = document.getElementById('confirmationQuestions');
    questionsContainer.innerHTML = '';
    (config.message_template?.confirmation_questions || []).forEach((question, index) => {
        questionsContainer.innerHTML += createQuestionHTML(question, index);
    });
}

// Crear HTML para empresa de transporte
function createTransportCompanyHTML(company, index) {
    return `
        <div class="card mb-3" id="company-${index}">
            <div class="card-body">
                <div class="mb-2">
                    <label class="form-label">Nombre de la Empresa</label>
                    <input type="text" class="form-control" value="${company.name || ''}" 
                           onchange="updateCompany(${index}, 'name', this.value)">
                </div>
                <div class="mb-2">
                    <label class="form-label">Número de WhatsApp</label>
                    <input type="text" class="form-control" value="${company.phone_number || ''}"
                           onchange="updateCompany(${index}, 'phone_number', this.value)">
                </div>
                <div class="mb-2">
                    <label class="form-label">Persona de Contacto</label>
                    <input type="text" class="form-control" value="${company.contact_person || ''}"
                           onchange="updateCompany(${index}, 'contact_person', this.value)">
                </div>
                <div class="mb-2">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-control" value="${company.email || ''}"
                           onchange="updateCompany(${index}, 'email', this.value)">
                </div>
                <button class="btn btn-danger" onclick="removeCompany(${index})">Eliminar</button>
            </div>
        </div>
    `;
}

// Crear HTML para pregunta de confirmación
function createQuestionHTML(question, index) {
    return `
        <div class="mb-3" id="question-${index}">
            <div class="input-group">
                <input type="text" class="form-control" value="${question}"
                       onchange="updateQuestion(${index}, this.value)">
                <button class="btn btn-danger" onclick="removeQuestion(${index})">Eliminar</button>
            </div>
        </div>
    `;
}

// Agregar nueva empresa de transporte
function addTransportCompany() {
    const newCompany = {
        name: '',
        phone_number: '',
        contact_person: '',
        email: ''
    };
    config.transport_companies = config.transport_companies || [];
    config.transport_companies.push(newCompany);
    
    const companiesContainer = document.getElementById('transportCompanies');
    companiesContainer.innerHTML += createTransportCompanyHTML(newCompany, config.transport_companies.length - 1);
}

// Agregar nueva pregunta
function addQuestion() {
    config.message_template = config.message_template || {};
    config.message_template.confirmation_questions = config.message_template.confirmation_questions || [];
    config.message_template.confirmation_questions.push('');
    
    const questionsContainer = document.getElementById('confirmationQuestions');
    questionsContainer.innerHTML += createQuestionHTML('', config.message_template.confirmation_questions.length - 1);
}

// Actualizar datos de empresa
function updateCompany(index, field, value) {
    if (!config.transport_companies) config.transport_companies = [];
    if (!config.transport_companies[index]) config.transport_companies[index] = {};
    config.transport_companies[index][field] = value;
}

// Actualizar pregunta
function updateQuestion(index, value) {
    if (!config.message_template) config.message_template = {};
    if (!config.message_template.confirmation_questions) config.message_template.confirmation_questions = [];
    config.message_template.confirmation_questions[index] = value;
}

// Eliminar empresa
function removeCompany(index) {
    config.transport_companies.splice(index, 1);
    document.getElementById(`company-${index}`).remove();
}

// Eliminar pregunta
function removeQuestion(index) {
    config.message_template.confirmation_questions.splice(index, 1);
    document.getElementById(`question-${index}`).remove();
}

// Guardar configuración
async function saveConfig() {
    // Actualizar config con valores actuales del formulario
    config.phone_number_id = document.getElementById('phoneNumberId').value;
    config.access_token = document.getElementById('accessToken').value;
    config.webhook_url = document.getElementById('webhookUrl').value;
    config.webhook_verify_token = document.getElementById('webhookToken').value;
    config.message_template = config.message_template || {};
    config.message_template.initial_message = document.getElementById('initialMessage').value;

    try {
        const response = await fetch('/whatsapp/config', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(config)
        });

        const result = await response.json();
        if (result.status === 'success') {
            alert('Configuración guardada correctamente');
        } else {
            alert('Error al guardar la configuración: ' + result.message);
        }
    } catch (error) {
        console.error('Error guardando configuración:', error);
        alert('Error al guardar la configuración');
    }
}

// Cargar configuración al iniciar
document.addEventListener('DOMContentLoaded', loadConfig);
</script>
{% endblock %} 