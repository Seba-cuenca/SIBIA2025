<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard ML - SIBIA</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 20px;
            color: #333;
        }
        
        .ml-dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid #4f46e5;
        }
        
        .dashboard-header h1 {
            color: #4f46e5;
            font-size: 2.5em;
            margin: 0;
        }
        
        .refresh-btn {
            background: #10b981;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .refresh-btn:hover {
            background: #059669;
            transform: translateY(-2px);
        }
        
        .ml-metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }
        
        .ml-card {
            background: linear-gradient(135deg, #fff 0%, #f8fafc 100%);
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-left: 5px solid;
            transition: transform 0.3s;
        }
        
        .ml-card:hover {
            transform: translateY(-5px);
        }
        
        .ml-card.dios { border-left-color: #8b5cf6; }
        .ml-card.xgboost { border-left-color: #f59e0b; }
        .ml-card.neural { border-left-color: #06b6d4; }
        .ml-card.genetic { border-left-color: #10b981; }
        
        .ml-card h3 {
            margin: 0 0 20px 0;
            font-size: 1.4em;
            color: #1e293b;
        }
        
        .metric {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            padding: 8px 0;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .metric-label {
            font-weight: 600;
            color: #475569;
        }
        
        .metric-value {
            font-weight: bold;
            color: #1e293b;
        }
        
        .speed-comparison {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .speed-bar {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px;
            background: #f8fafc;
            border-radius: 8px;
        }
        
        .speed-model {
            min-width: 150px;
            font-weight: 600;
        }
        
        .speed-progress {
            flex: 1;
            height: 20px;
            background: #e2e8f0;
            border-radius: 10px;
            margin: 0 15px;
            overflow: hidden;
        }
        
        .speed-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #059669);
            border-radius: 10px;
            transition: width 0.5s ease;
        }
        
        .speed-time {
            font-weight: bold;
            color: #1e293b;
        }
        
        .resources-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 25px;
        }
        
        .resource-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .resource-bar {
            margin-bottom: 20px;
        }
        
        .resource-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        .progress-bar {
            height: 25px;
            background: #e2e8f0;
            border-radius: 12px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            border-radius: 12px;
            transition: width 0.5s ease;
        }
        
        .cpu-fill { background: linear-gradient(90deg, #f59e0b, #d97706); }
        .memory-fill { background: linear-gradient(90deg, #8b5cf6, #7c3aed); }
        
        .recommendations {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .recommendation {
            background: #f0f9ff;
            border-left: 4px solid #0ea5e9;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 0 8px 8px 0;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-active { background: #10b981; }
        .status-warning { background: #f59e0b; }
        .status-error { background: #ef4444; }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }
        
        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            justify-content: center;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .btn-primary { background: #4f46e5; color: white; }
        .btn-secondary { background: #6b7280; color: white; }
        .btn-success { background: #10b981; color: white; }
        
        .btn:hover { transform: translateY(-2px); opacity: 0.9; }
        
        /* Estilos para gráficos en tiempo real */
        .real-time-charts {
            margin: 30px 0;
            background: linear-gradient(135deg, #fff 0%, #f8fafc 100%);
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .chart-container {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .chart-container h4 {
            margin: 0 0 15px 0;
            color: #4f46e5;
            font-size: 16px;
        }
        
        /* Estilos para selector de modelos */
        .model-selector {
            margin: 30px 0;
            background: linear-gradient(135deg, #fff 0%, #f8fafc 100%);
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .selector-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .function-selector, .model-checkboxes, .evaluation-results {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .function-selector h4, .model-checkboxes h4, .evaluation-results h4 {
            margin: 0 0 15px 0;
            color: #4f46e5;
            font-size: 16px;
        }
        
        .function-selector select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .model-checkboxes label {
            display: block;
            margin: 8px 0;
            cursor: pointer;
        }
        
        .model-checkboxes input[type="checkbox"] {
            margin-right: 8px;
        }
        
        .evaluation-results p {
            margin: 8px 0;
            font-size: 14px;
        }
        
        .evaluation-results span {
            font-weight: bold;
            color: #4f46e5;
        }
        
        /* Estilos para configuración actual */
        .current-config {
            margin: 30px 0;
            background: linear-gradient(135deg, #fff 0%, #f8fafc 100%);
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .current-config h3 {
            margin: 0 0 20px 0;
            color: #4f46e5;
            font-size: 24px;
        }
        
        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .config-function {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 4px solid #4f46e5;
        }
        
        .config-function h4 {
            margin: 0 0 10px 0;
            color: #4f46e5;
            font-size: 18px;
        }
        
        .config-models {
            margin: 10px 0;
        }
        
        .config-model {
            display: inline-block;
            background: #e0e7ff;
            color: #3730a3;
            padding: 4px 8px;
            border-radius: 4px;
            margin: 2px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .config-model.principal {
            background: #dcfce7;
            color: #166534;
        }
        
        .config-model.fallback {
            background: #fef3c7;
            color: #92400e;
        }
        
        .config-loading {
            text-align: center;
            color: #6b7280;
            font-style: italic;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.min.js"></script>
</head>
<body>
    <div class="ml-dashboard-container">
        <div class="dashboard-header">
            <h1>🧠 Dashboard de Monitoreo ML en Tiempo Real</h1>
            <button class="refresh-btn" onclick="loadMLDashboard()">🔄 Actualizar</button>
        </div>
        
        <div id="loading" class="loading">
            <h3>Cargando datos de modelos ML...</h3>
        </div>
        
        <div id="dashboard-content" style="display: none;">
            <!-- Métricas de Modelos -->
            <div class="ml-metrics-grid">
                <div class="ml-card dios">
                    <h3><span class="status-indicator" id="dios-status"></span>🧠 Sistema CAIN SIBIA</h3>
                    <div class="metric">
                        <span class="metric-label">Tiempo de Respuesta:</span>
                        <span id="dios-tiempo" class="metric-value">-- ms</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Sensores Monitoreados:</span>
                        <span id="dios-sensores" class="metric-value">--</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Problemas Detectados:</span>
                        <span id="dios-problemas" class="metric-value">--</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Eficiencia:</span>
                        <span id="dios-eficiencia" class="metric-value">--</span>
                    </div>
                </div>
                
                <div class="ml-card xgboost">
                    <h3><span class="status-indicator" id="xgboost-status"></span>🌟 XGBoost Calculadora</h3>
                    <div class="metric">
                        <span class="metric-label">Tiempo de Respuesta:</span>
                        <span id="xgboost-tiempo" class="metric-value">-- ms</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Precisión R²:</span>
                        <span id="xgboost-precision" class="metric-value">--</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">MSE:</span>
                        <span id="xgboost-mse" class="metric-value">--</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">⭐ Es Estrella:</span>
                        <span id="xgboost-estrella" class="metric-value">--</span>
                    </div>
                </div>
                
                <div class="ml-card neural">
                    <h3><span class="status-indicator" id="neural-status"></span>🧠 Redes Neuronales</h3>
                    <div class="metric">
                        <span class="metric-label">Tiempo de Respuesta:</span>
                        <span id="neural-tiempo" class="metric-value">-- ms</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Capas Ocultas:</span>
                        <span id="neural-capas" class="metric-value">--</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Neuronas Total:</span>
                        <span id="neural-neuronas" class="metric-value">--</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Optimización:</span>
                        <span id="neural-optimizacion" class="metric-value">--</span>
                    </div>
                </div>
                
                <div class="ml-card genetic">
                    <h3><span class="status-indicator" id="genetic-status"></span>🧬 Algoritmo Genético</h3>
                    <div class="metric">
                        <span class="metric-label">Población:</span>
                        <span id="genetic-poblacion" class="metric-value">--</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Generaciones:</span>
                        <span id="genetic-generaciones" class="metric-value">--</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Mejor Fitness:</span>
                        <span id="genetic-fitness" class="metric-value">--</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Info Transferida:</span>
                        <span id="genetic-transferida" class="metric-value">--</span>
                    </div>
                </div>
            </div>
            
            <!-- Comparación de Velocidades -->
            <div class="speed-comparison">
                <h3>⚡ Comparación de Velocidades de Modelos</h3>
                <div id="speed-bars"></div>
            </div>
            
            <!-- Recursos del Sistema -->
            <div class="resources-section">
                <div class="resource-card">
                    <h3>💻 Uso de CPU</h3>
                    <div class="resource-bar">
                        <div class="resource-label">
                            <span>CPU</span>
                            <span id="cpu-percent">--%</span>
                        </div>
                        <div class="progress-bar">
                            <div id="cpu-progress" class="progress-fill cpu-fill"></div>
                        </div>
                    </div>
                </div>
                
                <div class="resource-card">
                    <h3>🧠 Uso de Memoria</h3>
                    <div class="resource-bar">
                        <div class="resource-label">
                            <span>Memoria</span>
                            <span id="memory-percent">--%</span>
                        </div>
                        <div class="progress-bar">
                            <div id="memory-progress" class="progress-fill memory-fill"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Gráficos en Tiempo Real -->
            <div class="real-time-charts">
                <h3>📊 Gráficos en Tiempo Real</h3>
                <div class="charts-grid">
                    <div class="chart-container">
                        <h4>Tiempo de Respuesta</h4>
                        <canvas id="tiempoRespuestaChart" width="400" height="200"></canvas>
                    </div>
                    <div class="chart-container">
                        <h4>Aprendizaje por Iteración</h4>
                        <canvas id="aprendizajeChart" width="400" height="200"></canvas>
                    </div>
                    <div class="chart-container">
                        <h4>Eficiencia de Modelos</h4>
                        <canvas id="eficienciaChart" width="400" height="200"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- Configuración Actual -->
            <div class="current-config">
                <h3>📋 Configuración Actual de Funciones</h3>
                <div id="current-config-display">
                    <div class="config-loading">Cargando configuración actual...</div>
                </div>
            </div>
            
            <!-- Selector de Combinaciones de Modelos -->
            <div class="model-selector">
                <h3>🎯 Configurar Combinaciones de Modelos</h3>
                <div class="selector-grid">
                    <div class="function-selector">
                        <h4>Función:</h4>
                        <select id="funcion-selector">
                            <option value="asistente_ia">Asistente IA</option>
                            <option value="calculadora_energia">Calculadora Energía</option>
                            <option value="prediccion_sensores">Predicción Sensores</option>
                            <option value="optimizacion_genetica">Optimización Genética</option>
                        </select>
                    </div>
                    <div class="model-checkboxes">
                        <h4>Modelos Disponibles:</h4>
                        <label><input type="checkbox" value="cain_sibia" checked> CAIN SIBIA</label>
                        <label><input type="checkbox" value="xgboost_calculadora" checked> XGBoost</label>
                        <label><input type="checkbox" value="redes_neuronales"> Redes Neuronales</label>
                        <label><input type="checkbox" value="algoritmo_genetico"> Algoritmo Genético</label>
                        <label><input type="checkbox" value="random_forest"> Random Forest</label>
                        <label><input type="checkbox" value="optimizacion_bayesiana"> Optimización Bayesiana</label>
                    </div>
                    <div class="evaluation-results">
                        <h4>Evaluación en Vivo:</h4>
                        <div id="evaluation-display">
                            <p>Velocidad Promedio: <span id="velocidad-promedio">--</span> ms</p>
                            <p>Precisión Estimada: <span id="precision-estimada">--</span>%</p>
                            <p>Eficiencia: <span id="eficiencia-combinada">--</span>%</p>
                            <p>Recomendación: <span id="recomendacion">--</span></p>
                        </div>
                        <button onclick="configurarCombinacion()" class="btn btn-primary">Configurar Combinación</button>
                    </div>
                </div>
            </div>
            
            <!-- Recomendaciones -->
            <div class="recommendations">
                <h3>�� Recomendaciones de Optimización</h3>
                <div id="recommendations-list">
                    <div class="recommendation">
                        Cargando recomendaciones...
                    </div>
                </div>
            </div>
            
            <!-- Botones de Acción -->
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="testVelocidad()">🚀 Test de Velocidad</button>
                <button class="btn btn-secondary" onclick="loadMLDashboard()">🔄 Actualizar Todo</button>
                <button class="btn btn-success" onclick="exportReport()">📊 Exportar Reporte</button>
            </div>
        </div>
    </div>
    
    <script>
        let updateInterval;
        
        // Cargar dashboard al inicio
        document.addEventListener('DOMContentLoaded', function() {
            loadMLDashboard();
            cargarConfiguracionActual();
            // Actualizar cada 10 segundos
            updateInterval = setInterval(loadMLDashboard, 10000);
        });
        
        async function loadMLDashboard() {
            try {
                const response = await fetch('/ml_monitoring_dashboard');
                const data = await response.json();
                
                if (data.status === 'success') {
                    updateDashboard(data.modelos_ml);
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('dashboard-content').style.display = 'block';
                } else {
                    console.error('Error loading ML dashboard:', data.mensaje);
                }
            } catch (error) {
                console.error('Error fetching ML dashboard:', error);
            }
        }
        
        function updateDashboard(data) {
            // Actualizar Sistema CAIN SIBIA
            if (data.sistema_cain && data.sistema_cain.disponible) {
                document.getElementById('dios-status').className = 'status-indicator status-active';
                document.getElementById('dios-tiempo').textContent = data.sistema_cain.tiempo_respuesta_ms + ' ms';
                document.getElementById('dios-sensores').textContent = data.sistema_cain.sensores_monitoreados;
                document.getElementById('dios-problemas').textContent = data.sistema_cain.problemas_detectados;
                document.getElementById('dios-eficiencia').textContent = data.sistema_cain.eficiencia;
            } else {
                document.getElementById('dios-status').className = 'status-indicator status-error';
            }
            
            // Actualizar XGBoost
            if (data.xgboost_calculadora && data.xgboost_calculadora.disponible) {
                document.getElementById('xgboost-status').className = 'status-indicator status-active';
                document.getElementById('xgboost-tiempo').textContent = data.xgboost_calculadora.tiempo_respuesta_ms + ' ms';
                document.getElementById('xgboost-precision').textContent = data.xgboost_calculadora.precision_r2;
                document.getElementById('xgboost-mse').textContent = data.xgboost_calculadora.mse;
                document.getElementById('xgboost-estrella').textContent = data.xgboost_calculadora.es_estrella ? '⭐ SÍ' : '❌ NO';
            } else {
                document.getElementById('xgboost-status').className = 'status-indicator status-error';
            }
            
            // Actualizar Redes Neuronales
            if (data.redes_neuronales && data.redes_neuronales.disponible) {
                document.getElementById('neural-status').className = 'status-indicator status-active';
                document.getElementById('neural-tiempo').textContent = data.redes_neuronales.tiempo_respuesta_ms + ' ms';
                document.getElementById('neural-capas').textContent = data.redes_neuronales.capas_ocultas;
                document.getElementById('neural-neuronas').textContent = data.redes_neuronales.neuronas_total;
                document.getElementById('neural-optimizacion').textContent = data.redes_neuronales.algoritmo_optimizacion;
            } else {
                document.getElementById('neural-status').className = 'status-indicator status-error';
            }
            
            // Actualizar Algoritmo Genético
            if (data.algoritmo_genetico && data.algoritmo_genetico.disponible) {
                document.getElementById('genetic-status').className = 'status-indicator status-active';
                document.getElementById('genetic-poblacion').textContent = data.algoritmo_genetico.poblacion_actual;
                document.getElementById('genetic-generaciones').textContent = data.algoritmo_genetico.generaciones;
                document.getElementById('genetic-fitness').textContent = data.algoritmo_genetico.mejor_fitness;
                document.getElementById('genetic-transferida').textContent = data.algoritmo_genetico.informacion_transferida;
            } else {
                document.getElementById('genetic-status').className = 'status-indicator status-error';
            }
            
            // Actualizar comparación de velocidades
            updateSpeedComparison(data.comparacion_velocidades);
            
            // Actualizar recursos
            updateResources(data.uso_recursos);
            
            // Actualizar recomendaciones
            updateRecommendations(data.recomendaciones);
        }
        
        function updateSpeedComparison(speedData) {
            const container = document.getElementById('speed-bars');
            container.innerHTML = '';
            
            if (speedData.ranking) {
                const maxTime = Math.max(...speedData.ranking.map(r => r[1]));
                
                speedData.ranking.forEach((item, index) => {
                    const [model, time] = item;
                    const percentage = (time / maxTime) * 100;
                    
                    const speedBar = document.createElement('div');
                    speedBar.className = 'speed-bar';
                    speedBar.innerHTML = 
                        `<div class="speed-model">${model}</div>
                        <div class="speed-progress">
                            <div class="speed-fill" style="width: ${100 - percentage}%"></div>
                        </div>
                        <div class="speed-time">${time} ms</div>`;
                    container.appendChild(speedBar);
                });
            }
        }
        
        function updateResources(resources) {
            if (resources) {
                document.getElementById('cpu-percent').textContent = resources.cpu_percent + '%';
                document.getElementById('cpu-progress').style.width = resources.cpu_percent + '%';
                
                document.getElementById('memory-percent').textContent = resources.memoria_percent + '%';
                document.getElementById('memory-progress').style.width = resources.memoria_percent + '%';
            }
        }
        
        function updateRecommendations(recommendations) {
            const container = document.getElementById('recommendations-list');
            container.innerHTML = '';
            
            if (recommendations && recommendations.length > 0) {
                recommendations.forEach(rec => {
                    const div = document.createElement('div');
                    div.className = 'recommendation';
                    div.textContent = rec;
                    container.appendChild(div);
                });
            } else {
                container.innerHTML = '<div class="recommendation">✅ No hay recomendaciones específicas en este momento.</div>';
            }
        }
        
        async function testVelocidad() {
            try {
                const response = await fetch('/ml_test_velocidad');
                const data = await response.json();
                
                if (data.status === 'success') {
                    alert('Test de velocidad completado. Revisa los resultados en la consola.');
                    console.log('Resultados del test de velocidad:', data.test_velocidad);
                    loadMLDashboard(); // Actualizar dashboard
                }
            } catch (error) {
                console.error('Error en test de velocidad:', error);
            }
        }
        
        function exportReport() {
            const data = {
                timestamp: new Date().toISOString(),
                dashboard: 'ML Monitoring',
                status: 'exported'
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'ml_report_' + new Date().toISOString().split('T')[0] + '.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // Variables para gráficos en tiempo real
        let tiempoRespuestaChart, aprendizajeChart, eficienciaChart;
        
        // Inicializar gráficos
        function inicializarGraficos() {
            // Gráfico de tiempo de respuesta
            const tiempoCtx = document.getElementById('tiempoRespuestaChart').getContext('2d');
            tiempoRespuestaChart = new Chart(tiempoCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {label: 'CAIN SIBIA', data: [], borderColor: '#ef4444', backgroundColor: 'rgba(239, 68, 68, 0.1)'},
                        {label: 'XGBoost', data: [], borderColor: '#10b981', backgroundColor: 'rgba(16, 185, 129, 0.1)'},
                        {label: 'Redes Neuronales', data: [], borderColor: '#3b82f6', backgroundColor: 'rgba(59, 130, 246, 0.1)'},
                        {label: 'Algoritmo Genético', data: [], borderColor: '#8b5cf6', backgroundColor: 'rgba(139, 92, 246, 0.1)'},
                        {label: 'Random Forest', data: [], borderColor: '#f59e0b', backgroundColor: 'rgba(245, 158, 11, 0.1)'},
                        {label: 'Optimización Bayesiana', data: [], borderColor: '#06b6d4', backgroundColor: 'rgba(6, 182, 212, 0.1)'}
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {beginAtZero: true, title: {display: true, text: 'Tiempo (ms)'}}
                    }
                }
            });
            
            // Gráfico de aprendizaje
            const aprendizajeCtx = document.getElementById('aprendizajeChart').getContext('2d');
            aprendizajeChart = new Chart(aprendizajeCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {label: 'CAIN SIBIA', data: [], borderColor: '#ef4444', backgroundColor: 'rgba(239, 68, 68, 0.1)'},
                        {label: 'XGBoost', data: [], borderColor: '#10b981', backgroundColor: 'rgba(16, 185, 129, 0.1)'},
                        {label: 'Redes Neuronales', data: [], borderColor: '#3b82f6', backgroundColor: 'rgba(59, 130, 246, 0.1)'},
                        {label: 'Algoritmo Genético', data: [], borderColor: '#8b5cf6', backgroundColor: 'rgba(139, 92, 246, 0.1)'},
                        {label: 'Random Forest', data: [], borderColor: '#f59e0b', backgroundColor: 'rgba(245, 158, 11, 0.1)'},
                        {label: 'Optimización Bayesiana', data: [], borderColor: '#06b6d4', backgroundColor: 'rgba(6, 182, 212, 0.1)'}
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {beginAtZero: true, title: {display: true, text: 'Aprendizaje por Iteración'}}
                    }
                }
            });
            
            // Gráfico de eficiencia
            const eficienciaCtx = document.getElementById('eficienciaChart').getContext('2d');
            eficienciaChart = new Chart(eficienciaCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {label: 'CAIN SIBIA', data: [], borderColor: '#ef4444', backgroundColor: 'rgba(239, 68, 68, 0.1)'},
                        {label: 'XGBoost', data: [], borderColor: '#10b981', backgroundColor: 'rgba(16, 185, 129, 0.1)'},
                        {label: 'Redes Neuronales', data: [], borderColor: '#3b82f6', backgroundColor: 'rgba(59, 130, 246, 0.1)'},
                        {label: 'Algoritmo Genético', data: [], borderColor: '#8b5cf6', backgroundColor: 'rgba(139, 92, 246, 0.1)'},
                        {label: 'Random Forest', data: [], borderColor: '#f59e0b', backgroundColor: 'rgba(245, 158, 11, 0.1)'},
                        {label: 'Optimización Bayesiana', data: [], borderColor: '#06b6d4', backgroundColor: 'rgba(6, 182, 212, 0.1)'}
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {beginAtZero: true, max: 1, title: {display: true, text: 'Eficiencia'}}
                    }
                }
            });
        }
        
        // Actualizar gráficos con datos en tiempo real
        function actualizarGraficosTiempoReal() {
            fetch('/ml_datos_tiempo_real')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        const timestamp = new Date().toLocaleTimeString();
                        const modelos = data.datos.modelos;
                        
                        // Actualizar gráfico de tiempo de respuesta
                        tiempoRespuestaChart.data.labels.push(timestamp);
                        tiempoRespuestaChart.data.datasets[0].data.push(modelos.cain_sibia.tiempo_respuesta);
                        tiempoRespuestaChart.data.datasets[1].data.push(modelos.xgboost_calculadora.tiempo_respuesta);
                        tiempoRespuestaChart.data.datasets[2].data.push(modelos.redes_neuronales.tiempo_respuesta);
                        tiempoRespuestaChart.data.datasets[3].data.push(modelos.algoritmo_genetico.tiempo_respuesta);
                        tiempoRespuestaChart.data.datasets[4].data.push(modelos.random_forest.tiempo_respuesta);
                        tiempoRespuestaChart.data.datasets[5].data.push(modelos.optimizacion_bayesiana.tiempo_respuesta);
                        
                        // Actualizar gráfico de aprendizaje
                        aprendizajeChart.data.labels.push(timestamp);
                        aprendizajeChart.data.datasets[0].data.push(modelos.cain_sibia.aprendizaje_iteracion);
                        aprendizajeChart.data.datasets[1].data.push(modelos.xgboost_calculadora.aprendizaje_iteracion);
                        aprendizajeChart.data.datasets[2].data.push(modelos.redes_neuronales.aprendizaje_iteracion);
                        aprendizajeChart.data.datasets[3].data.push(modelos.algoritmo_genetico.aprendizaje_iteracion);
                        aprendizajeChart.data.datasets[4].data.push(modelos.random_forest.aprendizaje_iteracion);
                        aprendizajeChart.data.datasets[5].data.push(modelos.optimizacion_bayesiana.aprendizaje_iteracion);
                        
                        // Actualizar gráfico de eficiencia
                        eficienciaChart.data.labels.push(timestamp);
                        eficienciaChart.data.datasets[0].data.push(modelos.cain_sibia.eficiencia);
                        eficienciaChart.data.datasets[1].data.push(modelos.xgboost_calculadora.eficiencia);
                        eficienciaChart.data.datasets[2].data.push(modelos.redes_neuronales.eficiencia);
                        eficienciaChart.data.datasets[3].data.push(modelos.algoritmo_genetico.eficiencia);
                        eficienciaChart.data.datasets[4].data.push(modelos.random_forest.eficiencia);
                        eficienciaChart.data.datasets[5].data.push(modelos.optimizacion_bayesiana.eficiencia);
                        
                        // Mantener solo los últimos 20 puntos
                        if (tiempoRespuestaChart.data.labels.length > 20) {
                            tiempoRespuestaChart.data.labels.shift();
                            aprendizajeChart.data.labels.shift();
                            eficienciaChart.data.labels.shift();
                            
                            tiempoRespuestaChart.data.datasets.forEach(dataset => dataset.data.shift());
                            aprendizajeChart.data.datasets.forEach(dataset => dataset.data.shift());
                            eficienciaChart.data.datasets.forEach(dataset => dataset.data.shift());
                        }
                        
                        // Actualizar gráficos
                        tiempoRespuestaChart.update();
                        aprendizajeChart.update();
                        eficienciaChart.update();
                    }
                })
                .catch(error => console.error('Error actualizando gráficos:', error));
        }
        
        // Configurar combinación de modelos
        function configurarCombinacion() {
            const funcion = document.getElementById('funcion-selector').value;
            const checkboxes = document.querySelectorAll('.model-checkboxes input[type="checkbox"]:checked');
            const modelos = Array.from(checkboxes).map(cb => cb.value);
            
            if (modelos.length === 0) {
                alert('Selecciona al menos un modelo');
                return;
            }
            
            fetch('/ml_configurar_combinacion', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    funcion: funcion,
                    modelos: modelos
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    const evaluacion = data.evaluacion;
                    
                    // Actualizar evaluación en vivo
                    document.getElementById('velocidad-promedio').textContent = evaluacion.velocidad_promedio.toFixed(1);
                    document.getElementById('precision-estimada').textContent = (evaluacion.precision_estimada * 100).toFixed(1);
                    document.getElementById('eficiencia-combinada').textContent = (evaluacion.eficiencia_combinada * 100).toFixed(1);
                    document.getElementById('recomendacion').textContent = evaluacion.recomendacion;
                    
                    alert(`Combinación configurada para ${funcion}:\n${modelos.join(', ')}\n\n${evaluacion.recomendacion}`);
                    
                    // Recargar configuración actual para mostrar los cambios
                    cargarConfiguracionActual();
                } else {
                    alert('Error configurando combinación: ' + data.mensaje);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error configurando combinación');
            });
        }
        
        // Evaluación en vivo automática
        function evaluacionEnVivo() {
            const checkboxes = document.querySelectorAll('.model-checkboxes input[type="checkbox"]:checked');
            const modelos = Array.from(checkboxes).map(cb => cb.value);
            
            if (modelos.length > 0) {
                // Simular evaluación rápida
                const velocidades = {
                    'cain_sibia': 662,
                    'xgboost_calculadora': 45,
                    'redes_neuronales': 120,
                    'algoritmo_genetico': 200
                };
                
                const velocidadPromedio = modelos.reduce((sum, modelo) => sum + velocidades[modelo], 0) / modelos.length;
                const precisionEstimada = modelos.includes('xgboost_calculadora') ? 95 : 85;
                const eficiencia = modelos.length <= 2 ? 90 : 80;
                
                document.getElementById('velocidad-promedio').textContent = velocidadPromedio.toFixed(1);
                document.getElementById('precision-estimada').textContent = precisionEstimada.toFixed(1);
                document.getElementById('eficiencia-combinada').textContent = eficiencia.toFixed(1);
                document.getElementById('recomendacion').textContent = eficiencia >= 90 ? 'Excelente combinación' : 'Considera reducir modelos';
            }
        }
        
        // Cargar configuración actual
        function cargarConfiguracionActual() {
            fetch('/ml_configuracion_actual')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        mostrarConfiguracionActual(data.configuracion);
                    } else {
                        document.getElementById('current-config-display').innerHTML = 
                            '<div class="config-loading">Error cargando configuración</div>';
                    }
                })
                .catch(error => {
                    console.error('Error cargando configuración:', error);
                    document.getElementById('current-config-display').innerHTML = 
                        '<div class="config-loading">Error cargando configuración</div>';
                });
        }
        
        // Mostrar configuración actual
        function mostrarConfiguracionActual(config) {
            // La configuración viene directamente, no en un objeto funciones
            const funciones = config.funciones || config;
            const modelos = config.modelos_disponibles || {
                'cain_sibia': {nombre: 'CAIN SIBIA'},
                'xgboost_calculadora': {nombre: 'XGBoost Calculadora'},
                'redes_neuronales': {nombre: 'Redes Neuronales'},
                'algoritmo_genetico': {nombre: 'Algoritmo Genético'},
                'random_forest': {nombre: 'Random Forest'},
                'optimizacion_bayesiana': {nombre: 'Optimización Bayesiana'}
            };
            
            let html = '<div class="config-grid">';
            
            for (const [funcionId, funcion] of Object.entries(funciones)) {
                const nombreFuncion = funcionId.replace('_', ' ').toUpperCase();
                html += `
                    <div class="config-function">
                        <h4>${nombreFuncion}</h4>
                        <div class="config-models">
                            <strong>Modelos Activos:</strong><br>
                `;
                
                // Mostrar modelo principal
                if (funcion.modelo_principal) {
                    const modelo = modelos[funcion.modelo_principal];
                    html += `<span class="config-model principal">${modelo.nombre} (Principal)</span> `;
                }
                
                // Mostrar fallback
                if (funcion.fallback) {
                    const modelo = modelos[funcion.fallback];
                    html += `<span class="config-model fallback">${modelo.nombre} (Fallback)</span> `;
                }
                
                // Mostrar otros modelos activos
                funcion.modelos_activos.forEach(modeloId => {
                    if (modeloId !== funcion.modelo_principal && modeloId !== funcion.fallback) {
                        const modelo = modelos[modeloId];
                        html += `<span class="config-model">${modelo.nombre}</span> `;
                    }
                });
                
                html += `
                        </div>
                        <small>Última actualización: ${new Date(funcion.ultima_actualizacion).toLocaleString()}</small>
                    </div>
                `;
            }
            
            html += '</div>';
            document.getElementById('current-config-display').innerHTML = html;
        }
        
        // Event listeners para evaluación en vivo
        document.addEventListener('DOMContentLoaded', function() {
            // Cargar configuración actual
            cargarConfiguracionActual();
            
            // Inicializar gráficos solo si Chart.js está disponible
            if (typeof Chart !== 'undefined') {
                inicializarGraficos();
                // Actualizar gráficos cada 5 segundos
                setInterval(actualizarGraficosTiempoReal, 5000);
            } else {
                console.error('Chart.js no está disponible');
                document.querySelectorAll('.chart-container').forEach(container => {
                    container.innerHTML = '<p>Chart.js no está disponible. Recarga la página.</p>';
                });
            }
            
            // Evaluación en vivo cuando cambian los checkboxes
            document.querySelectorAll('.model-checkboxes input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', evaluacionEnVivo);
            });
            
            // Evaluación inicial
            evaluacionEnVivo();
        });
    </script>
</body>
</html>
