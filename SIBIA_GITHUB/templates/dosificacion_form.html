<!-- Formulario de registro de dosificación -->
<div class="row">
    <div class="col-md-6">
        <form id="dosificacionForm">
            <div class="mb-3">
                <label for="hora" class="form-label">Hora</label>
                <input type="number" class="form-control" id="hora" name="hora" value="{{ hora_actual|default(0) }}" min="0" max="23" required>
            </div>
            <div class="mb-3">
                <label for="biodigestor" class="form-label">Biodigestor</label>
                <select class="form-select" id="biodigestor" name="biodigestor" required>
                    {% for i in range(1, (num_biodigestores|default(1)) + 1) %}
                    <option value="{{ i }}">Biodigestor {{ i }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="mb-3">
                <label for="solidos_reales" class="form-label">Sólidos Reales (TN)</label>
                <input type="number" step="0.01" class="form-control" id="solidos_reales" name="solidos_reales" required>
            </div>
            <div class="mb-3">
                <label for="liquidos_reales" class="form-label">Líquidos Reales (TN)</label>
                <input type="number" step="0.01" class="form-control" id="liquidos_reales" name="liquidos_reales" required>
            </div>
            <button type="submit" class="btn btn-success w-100">
                <i class="fas fa-check-circle me-2"></i>Registrar Dosificación
            </button>
        </form>
    </div>

    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-warning text-dark">
                <i class="fas fa-history me-2"></i>Compensaciones Pendientes
            </div>
            <div class="card-body">
                {% if compensaciones %}
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Tipo</th>
                            <th>Cantidad</th>
                            <th>Horas Rest.</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Sólidos</td>
                            <td>{{ compensaciones.get('solidos', 0)|round(2) }} TN</td>
                            <td>{{ compensaciones.get('horas_restantes', 24) }}</td>
                        </tr>
                        <tr>
                            <td>Líquidos</td>
                            <td>{{ compensaciones.get('liquidos', 0)|round(2) }} TN</td>
                            <td>{{ compensaciones.get('horas_restantes', 24) }}</td>
                        </tr>
                    </tbody>
                </table>
                {% else %}
                <p class="text-muted mb-0">No hay compensaciones pendientes</p>
                {% endif %}
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-header bg-info text-white">
                <i class="fas fa-tasks me-2"></i>Dosificación Objetivo
            </div>
            <div class="card-body">
                {% if distribucion_horaria %}
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Material</th>
                            <th>Por Hora</th>
                            <th>Eficiencia</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for material in distribucion_horaria %}
                        <tr>
                            <td>{{ material.get('nombre', '-') }}</td>
                            <td>{{ material.get('cantidad', 0)|round(2) }} TN</td>
                            <td>
                                <div class="progress">
                                    <div class="progress-bar bg-success" 
                                         role="progressbar" 
                                         style="width: {{ material.get('eficiencia', 0)|round }}%"
                                         aria-valuenow="{{ material.get('eficiencia', 0)|round }}" 
                                         aria-valuemin="0" 
                                         aria-valuemax="100">
                                        {{ material.get('eficiencia', 0)|round }}%
                                    </div>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <p class="text-muted mb-0">No hay datos de distribución disponibles</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Tabla de comparación -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0">Comparación Planificado vs Real</h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th>Biodigestor</th>
                        <th>Hora</th>
                        <th>Sólidos Planificados</th>
                        <th>Sólidos Reales</th>
                        <th>Diferencia Sólidos</th>
                        <th>Líquidos Planificados</th>
                        <th>Líquidos Reales</th>
                        <th>Diferencia Líquidos</th>
                        <th>Compensación Pendiente</th>
                    </tr>
                </thead>
                <tbody>
                    {% for bio_num in range(1, (num_biodigestores|default(1)) + 1) %}
                    {% set bio_data = datos_planificacion.get('biodigestores', {}).get(bio_num, {
                        'actual': {'solidos': {'total': 0, 'real': 0}, 'liquidos': {'total': 0, 'real': 0}},
                        'diferencias': {'solidos': 0, 'liquidos': 0},
                        'compensacion': {'solidos': 0, 'liquidos': 0}
                    }) %}
                    <tr>
                        <td>{{ bio_num }}</td>
                        <td>{{ hora_actual|default(0) }}:00</td>
                        <td>{{ bio_data.actual.solidos.total|default(0)|round(3) }}</td>
                        <td>{{ bio_data.actual.solidos.real|default(0)|round(3) if bio_data.actual.solidos.real else "-" }}</td>
                        <td class="{{ 'text-danger' if bio_data.diferencias.solidos|default(0) < 0 else 'text-success' }}">
                            {{ bio_data.diferencias.solidos|default(0)|round(3) }}
                        </td>
                        <td>{{ bio_data.actual.liquidos.total|default(0)|round(3) }}</td>
                        <td>{{ bio_data.actual.liquidos.real|default(0)|round(3) if bio_data.actual.liquidos.real else "-" }}</td>
                        <td class="{{ 'text-danger' if bio_data.diferencias.liquidos|default(0) < 0 else 'text-success' }}">
                            {{ bio_data.diferencias.liquidos|default(0)|round(3) }}
                        </td>
                        <td>
                            S: {{ bio_data.compensacion.solidos|default(0)|round(3) }}<br>
                            L: {{ bio_data.compensacion.liquidos|default(0)|round(3) }}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
document.getElementById('dosificacionForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const data = {
        hora: parseInt(formData.get('hora')),
        biodigestor: parseInt(formData.get('biodigestor')),
        solidos_reales: parseFloat(formData.get('solidos_reales')),
        liquidos_reales: parseFloat(formData.get('liquidos_reales'))
    };

    fetch('/registrar_dosificacion', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error al registrar dosificación: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error al registrar la dosificación');
    });
});
</script> 